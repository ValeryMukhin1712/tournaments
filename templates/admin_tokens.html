{% extends "base.html" %}

{% block title %}Управление токенами - Турнирный Ассистент{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-key me-2"></i>Управление токенами</h2>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Назад к панели
                </a>
            </div>

            <!-- Статистика -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="total-tokens">0</h4>
                                    <small>Всего токенов</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-key fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="pending-tokens">0</h4>
                                    <small>Ожидают отправки</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="manual-tokens">0</h4>
                                    <small>Неотправленные</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-hand-paper fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="sent-tokens">0</h4>
                                    <small>Отправлены</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Фильтры -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="status-filter" class="form-label">Фильтр по статусу:</label>
                            <select class="form-select" id="status-filter">
                                <option value="all">Все токены</option>
                                <option value="pending">Ожидают отправки</option>
                                <option value="manual">Ручная отправка</option>
                                <option value="sent">Отправлены</option>
                                <option value="failed">Ошибка отправки</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search-input" class="form-label">Поиск по email или имени:</label>
                            <input type="text" class="form-control" id="search-input" placeholder="Введите email или имя...">
                        </div>
                        <div class="col-md-2">
                            <label for="max-tokens" class="form-label">Макс. токенов:</label>
                            <input type="number" class="form-control" id="max-tokens" value="4" min="1" max="100">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary me-2" onclick="loadTokens()">
                                <i class="fas fa-sync-alt me-1"></i>Обновить
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Таблица токенов -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Список токенов
                        <small class="text-muted" id="showing-info">(загрузка...)</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tokens-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Токен</th>
                                    <th>Имя</th>
                                    <th>Email</th>
                                    <th>Создан</th>
                                    <th>Статус email</th>
                                    <th>Использован</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="tokens-tbody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для ручной отправки -->
<div class="modal fade" id="sendTokenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ручная отправка токена</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sendTokenForm">
                    <input type="hidden" id="token-id" name="token_id">
                    <div class="mb-3">
                        <label for="token-value" class="form-label">Токен:</label>
                        <input type="text" class="form-control" id="token-value" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="token-name" class="form-label">Имя получателя:</label>
                        <input type="text" class="form-control" id="token-name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="token-email" class="form-label">Email получателя:</label>
                        <input type="email" class="form-control" id="token-email" name="email">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Внимание:</strong> Если email не указан, будет использован оригинальный email получателя.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="sendTokenManually()">
                    <i class="fas fa-paper-plane me-1"></i>Отправить токен
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let tokensData = [];

// Загрузка токенов
function loadTokens() {
    console.log('Загрузка токенов...');
    const maxTokens = document.getElementById('max-tokens').value;
    console.log('Максимальное количество токенов:', maxTokens);
    
    fetch(`/api/admin/tokens?max=${maxTokens}`)
        .then(response => response.json())
        .then(data => {
            console.log('Получены данные токенов:', data);
            if (data.success) {
                tokensData = data.tokens;
                console.log('Токены сохранены в tokensData:', tokensData);
                updateStatistics(data);
                renderTokensTable(data.tokens);
            } else {
                showAlert('Ошибка при загрузке токенов: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showAlert('Ошибка при загрузке токенов', 'danger');
        });
}

// Загрузка текущего значения максимального количества токенов
function loadMaxTokensSetting() {
    console.log('Загрузка настройки максимального количества токенов...');
    
    fetch('/api/admin/tokens?max=1') // Загружаем минимальное количество для получения настройки
        .then(response => response.json())
        .then(data => {
            if (data.success && data.max_tokens) {
                document.getElementById('max-tokens').value = data.max_tokens;
                console.log('Установлено максимальное количество токенов:', data.max_tokens);
                // После загрузки настройки загружаем токены с правильным лимитом
                loadTokens();
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке настройки:', error);
            // В случае ошибки все равно загружаем токены
            loadTokens();
        });
}

// Обновление статистики
function updateStatistics(data) {
    document.getElementById('total-tokens').textContent = data.total;
    document.getElementById('pending-tokens').textContent = data.pending;
    document.getElementById('manual-tokens').textContent = data.manual;
    document.getElementById('sent-tokens').textContent = data.sent;
    
    // Обновляем заголовок карточки "Ручная отправка" чтобы показать общее количество неотправленных
    const unsentCount = data.pending + data.manual + data.failed;
    document.getElementById('manual-tokens').textContent = unsentCount;
    
    // Обновляем информацию о количестве отображаемых токенов
    const showingInfo = document.getElementById('showing-info');
    if (data.showing !== undefined) {
        showingInfo.textContent = `(показано ${data.showing} из ${data.total})`;
    } else {
        showingInfo.textContent = `(показано ${data.tokens.length} из ${data.total})`;
    }
}

// Отображение таблицы токенов
function renderTokensTable(tokens) {
    console.log('renderTokensTable вызвана с токенами:', tokens);
    const tbody = document.getElementById('tokens-tbody');
    const statusFilter = document.getElementById('status-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    
    // Фильтрация токенов
    let filteredTokens = tokens;
    
    if (statusFilter !== 'all') {
        filteredTokens = filteredTokens.filter(token => token.email_status === statusFilter);
    }
    
    if (searchTerm) {
        filteredTokens = filteredTokens.filter(token => 
            token.email.toLowerCase().includes(searchTerm) || 
            token.name.toLowerCase().includes(searchTerm)
        );
    }
    
    if (filteredTokens.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Токены не найдены</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredTokens.map(token => `
        <tr>
            <td>${token.id}</td>
            <td><span class="badge bg-primary">${token.token}</span></td>
            <td>${token.name}</td>
            <td>${token.email}</td>
            <td>${token.created_at}</td>
            <td>${getStatusBadge(token.email_status)}</td>
            <td>${token.is_used ? 
                `<span class="badge bg-success">Да</span><br><small class="text-muted">${token.used_at}</small>` : 
                '<span class="badge bg-secondary">Нет</span>'
            }</td>
            <td>
                ${token.email_status === 'pending' || token.email_status === 'manual' || token.email_status === 'failed' ? 
                    `<button class="btn btn-sm btn-warning" onclick="openSendModal(${token.id})">
                        <i class="fas fa-paper-plane me-1"></i>Отправить
                    </button>` : 
                    '<span class="text-muted">-</span>'
                }
            </td>
        </tr>
    `).join('');
}

// Получение бейджа статуса
function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Ожидает</span>',
        'manual': '<span class="badge bg-info">Ручная отправка</span>',
        'sent': '<span class="badge bg-success">Отправлен</span>',
        'failed': '<span class="badge bg-danger">Ошибка</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Неизвестно</span>';
}

// Открытие модального окна для отправки
function openSendModal(tokenId) {
    console.log('openSendModal вызвана с tokenId:', tokenId);
    const token = tokensData.find(t => t.id === tokenId);
    console.log('Найденный токен:', token);
    
    if (!token) {
        console.error('Токен не найден для ID:', tokenId);
        return;
    }
    
    document.getElementById('token-id').value = token.id;
    document.getElementById('token-value').value = token.token;
    document.getElementById('token-name').value = token.name;
    document.getElementById('token-email').value = token.email;
    
    console.log('Поля формы заполнены');
    
    try {
        const modal = new bootstrap.Modal(document.getElementById('sendTokenModal'));
        modal.show();
        console.log('Модальное окно открыто');
    } catch (error) {
        console.error('Ошибка при открытии модального окна:', error);
    }
}

// Ручная отправка токена
function sendTokenManually() {
    const tokenId = document.getElementById('token-id').value;
    const email = document.getElementById('token-email').value;
    
    console.log('sendTokenManually вызвана с tokenId:', tokenId, 'email:', email);
    
    if (!email) {
        showAlert('Пожалуйста, укажите email получателя', 'warning');
        return;
    }
    
    const button = document.querySelector('#sendTokenModal .btn-primary');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Отправка...';
    button.disabled = true;
    
    // Получаем CSRF токен из мета-тега
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    console.log('CSRF токен:', csrfToken);
    
    fetch('/api/admin/send-token-manually', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify({
            token_id: tokenId,
            email: email
        })
    })
    .then(response => {
        console.log('Ответ сервера:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('Данные ответа:', data);
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('sendTokenModal')).hide();
            loadTokens(); // Обновляем список
        } else {
            // Если обычная отправка не удалась, пробуем внешний сервис
            console.log('Обычная отправка не удалась, пробуем внешний сервис...');
            tryExternalEmailService(tokenId, email);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showAlert('Ошибка при отправке токена', 'danger');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Попытка отправки через внешний сервис
function tryExternalEmailService(tokenId, email) {
    console.log('Попытка отправки через внешний сервис...');
    
    const token = tokensData.find(t => t.id == tokenId);
    if (!token) {
        showAlert('Токен не найден', 'danger');
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    fetch('/api/admin/send-email-external', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify({
            email: email,
            name: token.name,
            token: token.token
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Ответ внешнего сервиса:', data);
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('sendTokenModal')).hide();
            loadTokens(); // Обновляем список
        } else {
            showAlert(`Внешний сервис: ${data.error || data.message}`, 'warning');
        }
    })
    .catch(error => {
        console.error('Ошибка внешнего сервиса:', error);
        showAlert('Внешний сервис недоступен. Токен сохранен для ручной отправки.', 'warning');
    });
}

// Показ уведомления
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Автоматически скрыть через 5 секунд
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Фильтрация при изменении
document.getElementById('status-filter').addEventListener('change', () => renderTokensTable(tokensData));
document.getElementById('search-input').addEventListener('input', () => renderTokensTable(tokensData));
document.getElementById('max-tokens').addEventListener('change', () => {
    updateMaxTokensSetting();
    loadTokens();
});

// Обновление настройки максимального количества токенов
function updateMaxTokensSetting() {
    const maxTokens = document.getElementById('max-tokens').value;
    console.log('Обновление максимального количества токенов на:', maxTokens);
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    fetch('/api/admin/update-max-tokens', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify({
            max_tokens: parseInt(maxTokens)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Настройка обновлена:', data.message);
            showAlert(data.message, 'success');
        } else {
            console.error('Ошибка обновления настройки:', data.error);
            showAlert('Ошибка при обновлении настройки: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showAlert('Ошибка при обновлении настройки', 'danger');
    });
}

// Загрузка при открытии страницы
document.addEventListener('DOMContentLoaded', () => {
    loadMaxTokensSetting();
});
</script>
{% endblock %}
