{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Турнирная система{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Турниры</a></li>
                <li class="breadcrumb-item active">{{ tournament.name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">{{ tournament.name }}</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-table-tennis me-1"></i>{{ tournament.sport_type }} • 
                    <i class="fas fa-calendar me-1"></i>{{ tournament.start_date.strftime('%d.%m.%Y') }} - {{ tournament.end_date.strftime('%d.%m.%Y') }}
                </p>
            </div>
            <div class="d-flex gap-2">

                                 {% if current_user.is_authenticated %}
                     {% if current_user.role in ['администратор', 'доверенный_участник'] %}
                     <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addParticipantModal">
                         <i class="fas fa-user-plus me-2"></i>Добавить участника
                     </button>
                     {% endif %}
                     {% if current_user.role == 'администратор' %}
                     {% if has_missing_matches %}
                     <button class="btn btn-info me-2" onclick="createMissingMatches()">
                         <i class="fas fa-plus-circle me-2"></i>Создать недостающие матчи
                     </button>
                     {% endif %}
                     <button class="btn btn-secondary me-2" onclick="debugChessboard()">
                         <i class="fas fa-bug me-2"></i>Отладка таблицы
                     </button>
                     <button class="btn btn-warning" onclick="rescheduleTournament()">
                         <i class="fas fa-sync-alt me-2"></i>Пересчитать расписание
                     </button>
                     {% endif %}
                 {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Статистика участников -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Статистика участников</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                                                 <thead>
                             <tr>
                                 <th>Место</th>
                                 <th>Участник</th>
                                 <th>Игр</th>
                                 <th>Побед</th>
                                 <th>Ничьих</th>
                                 <th>Поражений</th>
                                 <th>Очки</th>
                                 <th>Разница мячей</th>
                                 <th>Действия</th>
                             </tr>
                         </thead>
                        <tbody>
                            {% for participant in participants %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ participant.name }}</strong>
                                    {% if participant.is_team %}
                                        <span class="badge bg-info ms-2">Команда</span>
                                    {% endif %}
                                </td>
                                                                 <td>{{ statistics[participant.id]['games'] }}</td>
                                 <td>{{ statistics[participant.id]['wins'] }}</td>
                                 <td>{{ statistics[participant.id]['draws'] }}</td>
                                 <td>{{ statistics[participant.id]['losses'] }}</td>
                                 <td>{{ statistics[participant.id]['points'] }}</td>
                                 <td>{{ statistics[participant.id]['goal_difference'] }}</td>
                                <td>
                                    {% if current_user.is_authenticated and current_user.role in ['администратор', 'доверенный_участник'] %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteParticipant({{ participant.id }}, '{{ participant.name }}')" title="Удалить участника">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Турнирная таблица -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Турнирная таблица</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th class="bg-light">Участник</th>
                                <th class="text-center bg-light">Очки</th>
                                <th class="text-center bg-light">Место</th>
                                {% for participant in participants %}
                                <th class="text-center bg-light">{{ participant.name[:15] }}{% if participant.name|length > 15 %}...{% endif %}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for p1_data in participants_with_stats %}
                            {% set p1 = p1_data.participant %}
                            {% set p1_stats = p1_data.stats %}
                            {% set p1_position = p1_data.position %}
                            <tr>
                                <td class="bg-light fw-bold">{{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}</td>
                                <td class="text-center bg-light fw-bold text-primary">{{ p1_stats.points }}</td>
                                <td class="text-center bg-light fw-bold text-success">{{ p1_position }}</td>
                                {% for p2 in participants %}
                                <td class="text-center position-relative" style="height: 80px; width: 120px; vertical-align: middle;">
                                    {% if p1.id == p2.id %}
                                        <span class="text-muted">—</span>
                                    {% else %}
                                        {% set cell_data = chessboard[p1.id][p2.id] %}
                                        {% if cell_data.type == 'result' %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="badge bg-success mb-1">{{ cell_data.value }}</span>
                                                {% if cell_data.editable %}
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        onclick="editMatchResult({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')"
                                                        title="Редактировать результат">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        {% elif cell_data.type == 'upcoming' %}
                                              {% set court_colors = {
                                                  1: 'primary',
                                                  2: 'info', 
                                                  3: 'success',
                                                  4: 'warning',
                                                  5: 'danger',
                                                  6: 'secondary',
                                                  7: 'dark',
                                                  8: 'light'
                                              } %}
                                              {% set court_color = court_colors.get(cell_data.court, 'secondary') %}
                                              
                                              <div class="text-center position-relative">
                                                  <!-- Основной контейнер с цветом площадки -->
                                                  <div class="{% if cell_data.is_next %}border border-warning border-1 rounded p-1 bg-warning bg-opacity-15 shadow-sm{% elif cell_data.is_second %}border border-success border-1 rounded p-1 bg-success bg-opacity-15 shadow-sm{% else %}border border-{{ court_color }} border-1 rounded p-1 bg-{{ court_color }} bg-opacity-10{% endif %}" style="height: 70px; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                                      <!-- Верхняя часть -->
                                                      <div>
                                                          <!-- Номер корта крупным полупрозрачным шрифтом -->
                                                          <div class="text-center mb-1">
                                                              <span style="font-size: 1.5rem; font-weight: bold; opacity: 0.3; color: {{ court_color }};">{{ cell_data.court }}</span>
                                                          </div>
                                                      </div>
                                                      
                                                      <!-- Время матча - внизу -->
                                                      <div class="mt-auto">
                                                          <small class="d-block text-dark fw-bold text-center" style="font-size: 0.6rem; background-color: rgba(255, 255, 255, 0.95); padding: 1px 3px; border-radius: 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ cell_data.date.strftime('%d.%m') }} {{ cell_data.time.strftime('%H:%M') }}</small>
                                                      </div>
                                                  </div>
                                                  
                                                  <!-- Дополнительные индикаторы для ближайших матчей -->
                                                  {% if cell_data.is_next %}
                                                      <div class="position-absolute top-0 start-0 translate-middle">
                                                          <span class="badge bg-warning text-dark rounded-pill" style="font-size: 0.6rem; padding: 2px 6px;">1</span>
                                                      </div>
                                                  {% elif cell_data.is_second %}
                                                      <div class="position-absolute top-0 start-0 translate-middle">
                                                          <span class="badge bg-success text-white rounded-pill" style="font-size: 0.6rem; padding: 2px 6px;">2</span>
                                                      </div>
                                                  {% endif %}
                                              </div>
                                        {% elif cell_data.type == 'empty' %}
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="openMatchModal({{ p1.id }}, {{ p2.id }}, '{{ p1.name }}', '{{ p2.name }}')"
                                                    style="min-width: 60px;">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Расписание матчей -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Расписание матчей</h5>
            </div>
            <div class="card-body">
                {% if schedule_display %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">№</th>
                                    <th style="width: 100px;">Время</th>
                                    <th style="width: 80px;">Площадка</th>
                                    <th>Участники</th>
                                    <th style="width: 100px;">Счет</th>
                                    <th style="width: 120px;">Статус</th>
                                    <th style="width: 80px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date_str, day_data in schedule_display.items() %}
                                <tr class="table-info">
                                    <td colspan="7" class="fw-bold text-center py-2">
                                        <i class="fas fa-calendar-day me-2"></i>{{ day_data.date_display }}
                                    </td>
                                </tr>
                                {% for match in day_data.matches %}
                                <tr>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ match.global_number }}</span>
                                    </td>
                                    <td class="fw-bold text-primary">{{ match.time }}</td>
                                    <td class="text-center">
                                        {% if match.court > 0 %}
                                            {% set court_colors = {
                                                1: 'primary',
                                                2: 'info', 
                                                3: 'success',
                                                4: 'warning',
                                                5: 'danger',
                                                6: 'secondary',
                                                7: 'dark',
                                                8: 'light'
                                            } %}
                                            {% set court_color = court_colors.get(match.court, 'secondary') %}
                                            <span class="badge bg-{{ court_color }}">
                                                Пл. {{ match.court }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ match.participant1 }}</strong> vs <strong>{{ match.participant2 }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {% if match.score %}
                                            <span class="badge bg-success">{{ match.score }}</span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if match.status == 'завершен' %}bg-success
                                            {% elif match.status == 'в процессе' %}bg-warning
                                            {% elif match.status == 'запланирован' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ match.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if match.status == 'запланирован' or match.status == 'в процессе' %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="openMatchResultModal({{ match.id }}, '{{ match.participant1 }}', '{{ match.participant2 }}', 0, 0)"
                                                title="Редактировать матч">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="mb-0">Расписание матчей пока не составлено</p>
                        <small>Нажмите "Пересчитать расписание" для создания расписания</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для ввода результата матча -->
<div class="modal fade" id="matchResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Результат матча</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="matchResultForm">
                    <input type="hidden" id="participant1Id" name="participant1_id">
                    <input type="hidden" id="participant2Id" name="participant2_id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Участник 1</label>
                            <input type="text" class="form-control" id="participant1Name" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Участник 2</label>
                            <input type="text" class="form-control" id="participant2Name" readonly>
                        </div>
                    </div>
                    
                                         <div class="row mb-3">
                         <div class="col-6">
                             <label for="score1" class="form-label">Счет участника 1</label>
                             <input type="number" class="form-control" id="score1" name="score1" min="0" required>
                         </div>
                         <div class="col-6">
                             <label for="score2" class="form-label">Счет участника 2</label>
                             <input type="number" class="form-control" id="score2" name="score2" min="0" required>
                         </div>
                     </div>
                     <div class="mb-3">
                         <small class="text-muted">
                             <i class="fas fa-info-circle me-1"></i>
                             Максимум очков для победы в матче: <strong>{{ tournament.points_to_win }}</strong>
                         </small>
                     </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="matchDate" class="form-label">Дата матча</label>
                            <input type="date" class="form-control" id="matchDate" name="match_date">
                        </div>
                        <div class="col-6">
                            <label for="matchTime" class="form-label">Время матча</label>
                            <input type="time" class="form-control" id="matchTime" name="match_time">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="courtNumber" class="form-label">Площадка</label>
                        <select class="form-select" id="courtNumber" name="court_number">
                            <option value="">Выберите площадку</option>
                            {% for i in range(1, tournament.court_count + 1) %}
                            <option value="{{ i }}">Площадка {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="matchResultForm" class="btn btn-primary">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования результата матча -->
<div class="modal fade" id="editMatchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать результат матча</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId" name="match_id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Участник 1</label>
                            <input type="text" class="form-control" id="editParticipant1Name" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Участник 2</label>
                            <input type="text" class="form-control" id="editParticipant2Name" readonly>
                        </div>
                    </div>
                    
                                         <div class="row mb-3">
                         <div class="col-6">
                             <label for="editScore1" class="form-label">Счет участника 1</label>
                             <input type="number" class="form-control" id="editScore1" name="score1" min="0" required>
                         </div>
                         <div class="col-6">
                             <label for="editScore2" class="form-label">Счет участника 2</label>
                             <input type="number" class="form-control" id="editScore2" name="score2" min="0" required>
                         </div>
                     </div>
                     <div class="mb-3">
                         <small class="text-muted">
                             <i class="fas fa-info-circle me-1"></i>
                             Максимум очков для победы в матче: <strong>{{ tournament.points_to_win }}</strong>
                         </small>
                     </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="editMatchDate" class="form-label">Дата матча</label>
                            <input type="date" class="form-control" id="editMatchDate" name="match_date">
                        </div>
                        <div class="col-6">
                            <label for="editMatchTime" class="form-label">Время матча</label>
                            <input type="time" class="form-control" id="editMatchTime" name="match_time">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCourtNumber" class="form-label">Площадка</label>
                        <select class="form-select" id="editCourtNumber" name="court_number">
                            <option value="">Выберите площадку</option>
                            {% for i in range(1, tournament.court_count + 1) %}
                            <option value="{{ i }}">Площадка {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="editMatchForm" class="btn btn-primary">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления участника -->
{% if current_user.is_authenticated and current_user.role in ['администратор', 'доверенный_участник'] %}
<div class="modal fade" id="addParticipantModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить участника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Вкладки для разных способов добавления -->
                <ul class="nav nav-tabs" id="addParticipantTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                            <i class="fas fa-edit me-2"></i>Ручной ввод
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Из списка пользователей
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="addParticipantTabContent">
                    <!-- Вкладка ручного ввода -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel">
                        <form id="addParticipantForm">
                            <div class="mb-3">
                                <label for="participantName" class="form-label">Имя участника или название команды</label>
                                <input type="text" class="form-control" id="participantName" required>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isTeam">
                                    <label class="form-check-label" for="isTeam">
                                        Это команда
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Вкладка выбора из списка пользователей -->
                    <div class="tab-pane fade" id="users" role="tabpanel">
                        <div class="mb-3">
                            <label for="userSearch" class="form-label">Поиск пользователей</label>
                            <input type="text" class="form-control" id="userSearch" placeholder="Введите имя пользователя для поиска...">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isTeamFromUser">
                                <label class="form-check-label" for="isTeamFromUser">
                                    Добавлять как команду
                                </label>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-hover" id="usersTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Выбрать</th>
                                        <th>Имя пользователя</th>
                                        <th>Роль</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="noUsersMessage" class="text-center text-muted py-3" style="display: none;">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <p>Пользователи не найдены</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" id="addSelectedUsersBtn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-plus me-2"></i>Добавить выбранных
                </button>
                <button type="submit" form="addParticipantForm" class="btn btn-primary">Добавить</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно регистрации пользователя -->
<div class="modal fade" id="registerUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Регистрация нового пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Имя пользователя</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="registerUserForm" class="btn btn-primary">Зарегистрироваться</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Добавляем обработчики кликов на все ячейки шахматки
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.table-bordered');
    if (table) {
        table.addEventListener('click', function(e) {
            const cell = e.target.closest('td');
            if (cell && !cell.querySelector('button')) {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const cellIndex = cell.cellIndex;
                
                if (rowIndex > 0 && cellIndex > 2) { // Пропускаем заголовки и столбцы "Очки" и "Место"
                    const participants = {{ participants_data|tojson }};
                    const p1 = participants[rowIndex - 1];
                    const p2 = participants[cellIndex - 3]; // Учитываем сдвиг на 2 столбца (Очки и Место)
                    
                    if (p1 && p2 && p1.id !== p2.id) {
                        openMatchModal(p1.id, p2.id, p1.name, p2.name);
                    }
                }
            }
        });
    }
});

function openMatchModal(p1Id, p2Id, p1Name, p2Name) {
    // Сначала проверяем, существует ли уже матч между этими участниками
    const participants = {{ participants_data|tojson }};
    const matches = {{ matches_data|tojson }};
    
    // Ищем существующий матч
    const existingMatch = matches.find(m => 
        (m.participant1_id === p1Id && m.participant2_id === p2Id) ||
        (m.participant1_id === p2Id && m.participant2_id === p1Id)
    );
    
    if (existingMatch) {
        // Если матч существует, открываем форму редактирования
        editMatchResult(existingMatch.id, p1Name, p2Name);
    } else {
        // Если матча нет, создаем новый
        document.getElementById('participant1Id').value = p1Id;
        document.getElementById('participant2Id').value = p2Id;
        document.getElementById('participant1Name').value = p1Name;
        document.getElementById('participant2Name').value = p2Name;
        
        // Установка значений по умолчанию
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const currentTime = now.toTimeString().slice(0, 5); // HH:MM формат
        const defaultScore = {{ tournament.points_to_win }};
        
        document.getElementById('matchDate').value = today;
        document.getElementById('matchTime').value = currentTime;
        document.getElementById('score1').value = defaultScore;
        document.getElementById('score2').value = defaultScore;
        
        new bootstrap.Modal(document.getElementById('matchResultModal')).show();
    }
}

function editMatchResult(matchId, p1Name, p2Name) {
    // Заполняем форму редактирования
    document.getElementById('editMatchId').value = matchId;
    document.getElementById('editParticipant1Name').value = p1Name;
    document.getElementById('editParticipant2Name').value = p2Name;
    
    // Получаем текущие данные матча
    fetch(`/api/matches/${matchId}`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Устанавливаем значения по умолчанию для счета, если они пустые
                const defaultScore = {{ tournament.points_to_win }};
                document.getElementById('editScore1').value = data.match.score1 || defaultScore;
                document.getElementById('editScore2').value = data.match.score2 || defaultScore;
                document.getElementById('editMatchDate').value = data.match.match_date || '';
                document.getElementById('editMatchTime').value = data.match.match_time || '';
                document.getElementById('editCourtNumber').value = data.match.court_number || '';
                
                // Если дата не указана, устанавливаем текущую
                if (!data.match.match_date) {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('editMatchDate').value = today;
                }
                
                // Если время не указано, устанавливаем текущее
                if (!data.match.match_time) {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5);
                    document.getElementById('editMatchTime').value = currentTime;
                }
            }
        });
    
    new bootstrap.Modal(document.getElementById('editMatchModal')).show();
}

function editMatch(matchId) {
    // Редактирование матча из расписания
    // Получаем данные матча для отображения имен участников
    fetch(`/api/matches/${matchId}`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Находим участников по ID
                const participants = {{ participants_data|tojson }};
                const p1 = participants.find(p => p.id === data.match.participant1_id);
                const p2 = participants.find(p => p.id === data.match.participant2_id);
                
                if (p1 && p2) {
                    editMatchResult(matchId, p1.name, p2.name);
                } else {
                    editMatchResult(matchId, 'Участник 1', 'Участник 2');
                }
            }
        })
        .catch(error => {
            editMatchResult(matchId, 'Участник 1', 'Участник 2');
        });
}

// Обработка формы результата матча
document.addEventListener('DOMContentLoaded', function() {
    const matchResultForm = document.getElementById('matchResultForm');
    if (matchResultForm) {
        matchResultForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                tournament_id: {{ tournament.id }},
                participant1_id: parseInt(document.getElementById('participant1Id').value),
                participant2_id: parseInt(document.getElementById('participant2Id').value),
                score1: parseInt(document.getElementById('score1').value),
                score2: parseInt(document.getElementById('score2').value),
                match_date: document.getElementById('matchDate').value,
                match_time: document.getElementById('matchTime').value,
                court_number: document.getElementById('courtNumber').value ? parseInt(document.getElementById('courtNumber').value) : null
            };
            
            fetch('/api/matches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при сохранении результата: ' + error);
            });
        });
    }
});

// Обработка формы добавления участника
document.addEventListener('DOMContentLoaded', function() {
    const addParticipantForm = document.getElementById('addParticipantForm');
    if (addParticipantForm) {
        addParticipantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('participantName').value,
                is_team: document.getElementById('isTeam').checked
            };
            
            fetch('/api/tournaments/{{ tournament.id }}/participants', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Участник добавлен!');
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при добавлении участника: ' + error);
            });
        });
    }
    
    // Инициализация функциональности добавления пользователей из списка
    initializeUserSelection();
});

// Функция инициализации выбора пользователей
function initializeUserSelection() {
    const usersTab = document.getElementById('users-tab');
    const userSearch = document.getElementById('userSearch');
    const addSelectedUsersBtn = document.getElementById('addSelectedUsersBtn');
    
    if (usersTab) {
        // Загружаем пользователей при переключении на вкладку
        usersTab.addEventListener('click', function() {
            loadUsers();
        });
        
        // Поиск пользователей
        if (userSearch) {
            userSearch.addEventListener('input', function() {
                filterUsers(this.value);
            });
        }
        
        // Добавление выбранных пользователей
        if (addSelectedUsersBtn) {
            addSelectedUsersBtn.addEventListener('click', function() {
                addSelectedUsers();
            });
        }
    }
}

// Загрузка списка пользователей
function loadUsers() {
        fetch('/api/users?tournament_id={{ tournament.id }}', {
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Ошибка сервера: ' + response.status);
            }
        })
        .then(data => {
            displayUsers(data);
        })
        .catch(error => {
            console.error('Ошибка при загрузке пользователей:', error);
            alert('Ошибка при загрузке пользователей: ' + error.message);
        });
}

// Отображение пользователей в таблице
function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    const noUsersMessage = document.getElementById('noUsersMessage');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (users.length === 0) {
        noUsersMessage.style.display = 'block';
        return;
    }
    
    noUsersMessage.style.display = 'none';
    
    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}" data-username="${user.username}">
            </td>
            <td>${user.username}</td>
            <td><span class="badge bg-secondary">${user.role}</span></td>
        `;
        tbody.appendChild(row);
    });
    
    // Добавляем обработчики для чекбоксов
    const checkboxes = tbody.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAddButton);
    });
}

// Фильтрация пользователей
function filterUsers(searchTerm) {
    const rows = document.getElementById('usersTableBody').querySelectorAll('tr');
    const noUsersMessage = document.getElementById('noUsersMessage');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        if (username.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    noUsersMessage.style.display = visibleCount === 0 ? 'block' : 'none';
}

// Обновление кнопки добавления
function updateAddButton() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const addSelectedUsersBtn = document.getElementById('addSelectedUsersBtn');
    
    if (addSelectedUsersBtn) {
        if (checkboxes.length > 0) {
            addSelectedUsersBtn.style.display = 'inline-block';
            addSelectedUsersBtn.textContent = `Добавить выбранных (${checkboxes.length})`;
        } else {
            addSelectedUsersBtn.style.display = 'none';
        }
    }
}

// Добавление выбранных пользователей
function addSelectedUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const isTeam = document.getElementById('isTeamFromUser').checked;
    
    if (checkboxes.length === 0) {
        alert('Выберите хотя бы одного пользователя');
        return;
    }
    
    const selectedUsers = Array.from(checkboxes).map(checkbox => ({
        id: checkbox.value,
        username: checkbox.dataset.username
    }));
    
    // Добавляем пользователей параллельно
    const promises = selectedUsers.map(user => {
        const formData = {
            user_id: user.id,
            name: user.username,
            is_team: isTeam
        };
        
        return fetch('/api/tournaments/{{ tournament.id }}/participants', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Ошибка сервера: ' + response.status);
                });
            }
        })
        .then(data => {
            return { success: true, user: user.username };
        })
        .catch(error => {
            console.error(`Ошибка добавления ${user.username}:`, error);
            return { success: false, user: user.username, error: error.message };
        });
    });
    
    // Ждем завершения всех запросов
    Promise.all(promises).then(results => {
        const addedCount = results.filter(r => r.success).length;
        const errorCount = results.filter(r => !r.success).length;
        const errors = results.filter(r => !r.success);
        
        let message = '';
        if (addedCount > 0) {
            message += `Успешно добавлено: ${addedCount} пользователей. `;
        }
        if (errorCount > 0) {
            message += `Ошибок: ${errorCount}. `;
            // Показываем детали ошибок
            const duplicateErrors = errors.filter(e => e.error && e.error.includes('уже существует'));
            const userExistsErrors = errors.filter(e => e.error && e.error.includes('уже участвует'));
            
            if (duplicateErrors.length > 0) {
                message += `Дубликаты: ${duplicateErrors.map(e => e.user).join(', ')}. `;
            }
            if (userExistsErrors.length > 0) {
                message += `Уже в турнире: ${userExistsErrors.map(e => e.user).join(', ')}. `;
            }
        }
        
        if (message) {
            alert(message);
        }
        
        if (addedCount > 0) {
            location.reload();
        }
    });
}

// Обработка формы редактирования матча
document.addEventListener('DOMContentLoaded', function() {
    const editMatchForm = document.getElementById('editMatchForm');
    if (editMatchForm) {
        editMatchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const matchId = document.getElementById('editMatchId').value;
            const formData = {
                score1: parseInt(document.getElementById('editScore1').value),
                score2: parseInt(document.getElementById('editScore2').value),
                match_date: document.getElementById('editMatchDate').value,
                match_time: document.getElementById('editMatchTime').value,
                court_number: document.getElementById('editCourtNumber').value ? parseInt(document.getElementById('editCourtNumber').value) : null
            };
            
            fetch(`/api/matches/${matchId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при обновлении результата: ' + error);
            });
        });
    }
});

// Функция удаления матча
function deleteMatch(matchId) {
    if (confirm('Вы уверены, что хотите удалить этот матч? Это действие нельзя отменить.')) {
        fetch(`/api/matches/${matchId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Матч успешно удален!');
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка при удалении матча: ' + error);
        });
    }
}

// Функция создания недостающих матчей
function createMissingMatches() {
    if (confirm('Создать все недостающие матчи для турнира? Это добавит матчи между участниками, которые еще не играли друг с другом.')) {
        fetch(`/api/tournaments/{{ tournament.id }}/create-missing-matches`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при создании матчей');
        });
    }
}

// Функция отладки турнирной таблицы
function debugChessboard() {
    fetch(`/api/tournaments/{{ tournament.id }}/debug-chessboard`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при создании отладочного файла');
    });
}

// Функция пересчета расписания
function rescheduleTournament() {
    if (confirm('Вы уверены, что хотите пересчитать расписание? Все существующие матчи будут удалены и созданы заново. Это действие нельзя отменить.')) {
        fetch(`/api/tournaments/{{ tournament.id }}/reschedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Ошибка сервера: ' + response.status);
                });
            }
        })
        .then(data => {
            alert(data.message || 'Расписание успешно пересчитано!');
            location.reload();
        })
        .catch(error => {
            console.error('Ошибка при пересчете расписания:', error);
            alert('Ошибка при пересчете расписания: ' + error.message);
        });
    }
}

// Функция удаления участника
function deleteParticipant(participantId, participantName) {
    if (confirm(`Вы уверены, что хотите удалить участника "${participantName}"? Это действие нельзя отменить.`)) {
        fetch(`/api/tournaments/{{ tournament.id }}/participants/${participantId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Ошибка сервера: ' + response.status);
            }
        })
        .then(data => {
            alert('Участник успешно удален!');
            location.reload();
        })
        .catch(error => {
            console.error('Ошибка при удалении участника:', error);
            alert('Ошибка при удалении участника: ' + error.message);
        });
    }
}

// Обработка формы регистрации пользователя
document.addEventListener('DOMContentLoaded', function() {
    const registerUserForm = document.getElementById('registerUserForm');
    if (registerUserForm) {
        registerUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }
            
            const formData = {
                username: document.getElementById('username').value,
                password: password
            };
            
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Пользователь успешно создан! Теперь вы можете войти в систему.');
                    bootstrap.Modal.getInstance(document.getElementById('registerUserModal')).hide();
                    // Перенаправляем на страницу входа
                    window.location.href = '/login';
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при регистрации: ' + error);
            });
        });
    }
});
</script>
{% endblock %}
