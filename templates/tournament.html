{% extends "base.html" %}

{% block title %}{{ tournament.name }} - –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">–¢—É—Ä–Ω–∏—Ä—ã</a></li>
                <li class="breadcrumb-item active">{{ tournament.name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">{{ tournament.name }}</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-table-tennis me-1"></i>{{ tournament.sport_type }} ‚Ä¢ 
                    <i class="fas fa-calendar me-1"></i>{{ tournament.start_date.strftime('%d.%m.%Y') }} - {{ tournament.end_date.strftime('%d.%m.%Y') }}
                </p>
            </div>
            <div class="d-flex gap-2">
                <span class="badge bg-{{ 'success' if tournament.status == '–∞–∫—Ç–∏–≤–µ–Ω' else 'warning' if tournament.status == '—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' else 'secondary' }} fs-6">
                    {{ tournament.status }}
                </span>
                {% if current_user.is_authenticated %}
                    {% if current_user.role in ['–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', '–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫'] %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addParticipantModal">
                        <i class="fas fa-user-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    </button>
                    {% endif %}
                {% else %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#registerUserModal">
                        <i class="fas fa-user-plus me-2"></i>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>–ú–µ—Å—Ç–æ</th>
                                <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                <th>–ò–≥—Ä</th>
                                <th>–ü–æ–±–µ–¥</th>
                                <th>–ü–æ—Ä–∞–∂–µ–Ω–∏–π</th>
                                <th>–û—á–∫–∏</th>
                                <th>–†–∞–∑–Ω–∏—Ü–∞ –º—è—á–µ–π</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ participant.name }}</strong>
                                    {% if participant.is_team %}
                                        <span class="badge bg-info ms-2">–ö–æ–º–∞–Ω–¥–∞</span>
                                    {% endif %}
                                </td>
                                <td>{{ statistics[participant.id]['games'] }}</td>
                                <td>{{ statistics[participant.id]['wins'] }}</td>
                                <td>{{ statistics[participant.id]['losses'] }}</td>
                                <td>{{ statistics[participant.id]['points'] }}</td>
                                <td>{{ statistics[participant.id]['goal_difference'] }}</td>
                                <td>
                                    {% if current_user.is_authenticated and current_user.role in ['–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', '–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫'] %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteParticipant({{ participant.id }}, '{{ participant.name }}')" title="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –®–∞—Ö–º–∞—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>–®–∞—Ö–º–∞—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th class="bg-light">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                {% for participant in participants %}
                                <th class="text-center bg-light">{{ participant.name[:15] }}{% if participant.name|length > 15 %}...{% endif %}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for p1 in participants %}
                            <tr>
                                <td class="bg-light fw-bold">{{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}</td>
                                {% for p2 in participants %}
                                <td class="text-center position-relative">
                                    {% if p1.id == p2.id %}
                                        <span class="text-muted">‚Äî</span>
                                    {% else %}
                                        {% set cell_data = chessboard[p1.id][p2.id] %}
                                        {% if cell_data.type == 'result' %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="badge bg-success mb-1">{{ cell_data.value }}</span>
                                                {% if cell_data.editable %}
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        onclick="editMatchResult({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')"
                                                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                                                                 {% elif cell_data.type == 'upcoming' %}
                                             <div class="text-center {% if cell_data.is_next %}border border-warning border-3 rounded p-2 bg-warning bg-opacity-10{% endif %}">
                                                 <div class="badge {% if cell_data.is_next %}bg-warning text-dark{% else %}bg-info{% endif %} mb-1">
                                                     {% if cell_data.is_next %}üî• –°–õ–ï–î–£–Æ–©–ê–Ø –ò–ì–†–ê{% else %}{{ cell_data.value }}{% endif %}
                                                 </div>
                                                 <small class="d-block text-muted">–ü–ª–æ—â–∞–¥–∫–∞ {{ cell_data.court }}</small>
                                                 {% if cell_data.is_next %}
                                                 <small class="d-block text-warning fw-bold">{{ cell_data.value }}</small>
                                                 {% endif %}
                                             </div>
                                        {% elif cell_data.type == 'empty' %}
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="openMatchModal({{ p1.id }}, {{ p2.id }}, '{{ p1.name }}', '{{ p2.name }}')"
                                                    style="min-width: 60px;">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–ü–ª–æ—â–∞–¥–∫–∞</th>
                                <th>–£—á–∞—Å—Ç–Ω–∏–∫ 1</th>
                                <th>–£—á–∞—Å—Ç–Ω–∏–∫ 2</th>
                                <th>–°—á–µ—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if matches %}
                                {% for match in matches %}
                                <tr>
                                    <td>{{ match.match_date.strftime('%d.%m.%Y') if match.match_date else '‚Äî' }}</td>
                                    <td>{{ match.match_time.strftime('%H:%M') if match.match_time else '‚Äî' }}</td>
                                    <td>
                                        {% if match.court_number %}
                                            <span class="badge bg-info">–ü–ª–æ—â–∞–¥–∫–∞ {{ match.court_number }}</span>
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                    <td>{{ match.participant1.name if match.participant1 else '‚Äî' }}</td>
                                    <td>{{ match.participant2.name if match.participant2 else '‚Äî' }}</td>
                                    <td>
                                        {% if match.score1 is not none and match.score2 is not none %}
                                            <span class="badge bg-success">{{ match.score1 }}:{{ match.score2 }}</span>
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if match.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' else 'warning' if match.status == '–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ' else 'secondary' }}">
                                            {{ match.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if current_user.is_authenticated and current_user.role in ['–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', '–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫'] %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="editMatch({{ match.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% elif current_user.is_authenticated and (current_user.id == match.participant1.user_id or current_user.id == match.participant2.user_id) %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="editMatch({{ match.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% endif %}
                                            {% if current_user.is_authenticated and current_user.role in ['–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', '–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫'] %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMatch({{ match.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                        <p class="mb-0">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞ -->
<div class="modal fade" id="matchResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="matchResultForm">
                    <input type="hidden" id="participant1Id" name="participant1_id">
                    <input type="hidden" id="participant2Id" name="participant2_id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">–£—á–∞—Å—Ç–Ω–∏–∫ 1</label>
                            <input type="text" class="form-control" id="participant1Name" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">–£—á–∞—Å—Ç–Ω–∏–∫ 2</label>
                            <input type="text" class="form-control" id="participant2Name" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="score1" class="form-label">–°—á–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ 1</label>
                            <input type="number" class="form-control" id="score1" name="score1" min="0" required>
                        </div>
                        <div class="col-6">
                            <label for="score2" class="form-label">–°—á–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ 2</label>
                            <input type="number" class="form-control" id="score2" name="score2" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="matchDate" class="form-label">–î–∞—Ç–∞ –º–∞—Ç—á–∞</label>
                            <input type="date" class="form-control" id="matchDate" name="match_date">
                        </div>
                        <div class="col-6">
                            <label for="matchTime" class="form-label">–í—Ä–µ–º—è –º–∞—Ç—á–∞</label>
                            <input type="time" class="form-control" id="matchTime" name="match_time">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="courtNumber" class="form-label">–ü–ª–æ—â–∞–¥–∫–∞</label>
                        <select class="form-select" id="courtNumber" name="court_number">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—â–∞–¥–∫—É</option>
                            {% for i in range(1, tournament.court_count + 1) %}
                            <option value="{{ i }}">–ü–ª–æ—â–∞–¥–∫–∞ {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" form="matchResultForm" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞ -->
<div class="modal fade" id="editMatchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId" name="match_id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">–£—á–∞—Å—Ç–Ω–∏–∫ 1</label>
                            <input type="text" class="form-control" id="editParticipant1Name" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">–£—á–∞—Å—Ç–Ω–∏–∫ 2</label>
                            <input type="text" class="form-control" id="editParticipant2Name" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="editScore1" class="form-label">–°—á–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ 1</label>
                            <input type="number" class="form-control" id="editScore1" name="score1" min="0" required>
                        </div>
                        <div class="col-6">
                            <label for="editScore2" class="form-label">–°—á–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ 2</label>
                            <input type="number" class="form-control" id="editScore2" name="score2" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="editMatchDate" class="form-label">–î–∞—Ç–∞ –º–∞—Ç—á–∞</label>
                            <input type="date" class="form-control" id="editMatchDate" name="match_date">
                        </div>
                        <div class="col-6">
                            <label for="editMatchTime" class="form-label">–í—Ä–µ–º—è –º–∞—Ç—á–∞</label>
                            <input type="time" class="form-control" id="editMatchTime" name="match_time">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCourtNumber" class="form-label">–ü–ª–æ—â–∞–¥–∫–∞</label>
                        <select class="form-select" id="editCourtNumber" name="court_number">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—â–∞–¥–∫—É</option>
                            {% for i in range(1, tournament.court_count + 1) %}
                            <option value="{{ i }}">–ü–ª–æ—â–∞–¥–∫–∞ {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" form="editMatchForm" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
{% if current_user.is_authenticated and current_user.role in ['–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', '–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫'] %}
<div class="modal fade" id="addParticipantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addParticipantForm">
                    <div class="mb-3">
                        <label for="participantName" class="form-label">–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</label>
                        <input type="text" class="form-control" id="participantName" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isTeam">
                            <label class="form-check-label" for="isTeam">
                                –≠—Ç–æ –∫–æ–º–∞–Ω–¥–∞
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" form="addParticipantForm" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="registerUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" form="registerUserForm" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –≤—Å–µ —è—á–µ–π–∫–∏ —à–∞—Ö–º–∞—Ç–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.table-bordered');
    if (table) {
        table.addEventListener('click', function(e) {
            const cell = e.target.closest('td');
            if (cell && !cell.querySelector('button')) {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const cellIndex = cell.cellIndex;
                
                if (rowIndex > 0 && cellIndex > 0) { // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    const participants = {{ participants_data|tojson }};
                    const p1 = participants[rowIndex - 1];
                    const p2 = participants[cellIndex - 1];
                    
                    if (p1 && p2 && p1.id !== p2.id) {
                        openMatchModal(p1.id, p2.id, p1.name, p2.name);
                    }
                }
            }
        });
    }
});

function openMatchModal(p1Id, p2Id, p1Name, p2Name) {
    document.getElementById('participant1Id').value = p1Id;
    document.getElementById('participant2Id').value = p2Id;
    document.getElementById('participant1Name').value = p1Name;
    document.getElementById('participant2Name').value = p2Name;
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –∏ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5); // HH:MM —Ñ–æ—Ä–º–∞—Ç
    
    document.getElementById('matchDate').value = today;
    document.getElementById('matchTime').value = currentTime;
    
    new bootstrap.Modal(document.getElementById('matchResultModal')).show();
}

function editMatchResult(matchId, p1Name, p2Name) {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('editMatchId').value = matchId;
    document.getElementById('editParticipant1Name').value = p1Name;
    document.getElementById('editParticipant2Name').value = p2Name;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞
    fetch(`/api/matches/${matchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('editScore1').value = data.match.score1 || '';
                document.getElementById('editScore2').value = data.match.score2 || '';
                document.getElementById('editMatchDate').value = data.match.match_date || '';
                document.getElementById('editMatchTime').value = data.match.match_time || '';
                document.getElementById('editCourtNumber').value = data.match.court_number || '';
                
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é
                if (!data.match.match_date) {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('editMatchDate').value = today;
                }
                
                // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ
                if (!data.match.match_time) {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5);
                    document.getElementById('editMatchTime').value = currentTime;
                }
            }
        });
    
    new bootstrap.Modal(document.getElementById('editMatchModal')).show();
}

function editMatch(matchId) {
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    fetch(`/api/matches/${matchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –ù–∞—Ö–æ–¥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ ID
                const participants = {{ participants_data|tojson }};
                const p1 = participants.find(p => p.id === data.match.participant1_id);
                const p2 = participants.find(p => p.id === data.match.participant2_id);
                
                if (p1 && p2) {
                    editMatchResult(matchId, p1.name, p2.name);
                } else {
                    editMatchResult(matchId, '–£—á–∞—Å—Ç–Ω–∏–∫ 1', '–£—á–∞—Å—Ç–Ω–∏–∫ 2');
                }
            }
        })
        .catch(error => {
            editMatchResult(matchId, '–£—á–∞—Å—Ç–Ω–∏–∫ 1', '–£—á–∞—Å—Ç–Ω–∏–∫ 2');
        });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞
document.addEventListener('DOMContentLoaded', function() {
    const matchResultForm = document.getElementById('matchResultForm');
    if (matchResultForm) {
        matchResultForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                tournament_id: {{ tournament.id }},
                participant1_id: parseInt(document.getElementById('participant1Id').value),
                participant2_id: parseInt(document.getElementById('participant2Id').value),
                score1: parseInt(document.getElementById('score1').value),
                score2: parseInt(document.getElementById('score2').value),
                match_date: document.getElementById('matchDate').value,
                match_time: document.getElementById('matchTime').value,
                court_number: document.getElementById('courtNumber').value ? parseInt(document.getElementById('courtNumber').value) : null
            };
            
            fetch('/api/matches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ' + error);
            });
        });
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
document.addEventListener('DOMContentLoaded', function() {
    const addParticipantForm = document.getElementById('addParticipantForm');
    if (addParticipantForm) {
        addParticipantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('participantName').value,
                is_team: document.getElementById('isTeam').checked
            };
            
            fetch('/api/tournaments/{{ tournament.id }}/participants', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ' + error);
            });
        });
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ç—á–∞
document.addEventListener('DOMContentLoaded', function() {
    const editMatchForm = document.getElementById('editMatchForm');
    if (editMatchForm) {
        editMatchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const matchId = document.getElementById('editMatchId').value;
            const formData = {
                score1: parseInt(document.getElementById('editScore1').value),
                score2: parseInt(document.getElementById('editScore2').value),
                match_date: document.getElementById('editMatchDate').value,
                match_time: document.getElementById('editMatchTime').value,
                court_number: document.getElementById('editCourtNumber').value ? parseInt(document.getElementById('editCourtNumber').value) : null
            };
            
            fetch(`/api/matches/${matchId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ' + error);
            });
        });
    }
});

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ç—á–∞
function deleteMatch(matchId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç—á? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        fetch(`/api/matches/${matchId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ú–∞—Ç—á —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ç—á–∞: ' + error);
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
function deleteParticipant(participantId, participantName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ "${participantName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        fetch(`/api/tournaments/{{ tournament.id }}/participants/${participantId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–£—á–∞—Å—Ç–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ' + error);
        });
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.addEventListener('DOMContentLoaded', function() {
    const registerUserForm = document.getElementById('registerUserForm');
    if (registerUserForm) {
        registerUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                return;
            }
            
            const formData = {
                username: document.getElementById('username').value,
                password: password
            };
            
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.');
                    bootstrap.Modal.getInstance(document.getElementById('registerUserModal')).hide();
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                    window.location.href = '/login';
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error);
            });
        });
    }
});
</script>
{% endblock %}
