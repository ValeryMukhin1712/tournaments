
{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Турнирный Ассистент v2.1{% endblock %}

{% block content %}
<style>
/* Стили для фиксации первого столбца при горизонтальном скролле */
#tournament-table {
    position: relative;
}

#tournament-table thead th:first-child,
#tournament-table tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    background-color: #f8f9fa !important;
    border-right: 2px solid #dee2e6;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* Для мобильных устройств - более агрессивная фиксация */
@media (max-width: 768px) {
    #tournament-table thead th:first-child,
    #tournament-table tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 15;
        background-color: #f8f9fa !important;
        border-right: 2px solid #dee2e6;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        min-width: 80px;
        max-width: 120px;
    }
    
    /* Убеждаемся, что фиксированный столбец не перекрывается */
    #tournament-table thead th:nth-child(2),
    #tournament-table tbody td:nth-child(2) {
        position: relative;
        z-index: 5;
    }
}

/* Для очень маленьких экранов */
@media (max-width: 550px) {
    #tournament-table thead th:first-child,
    #tournament-table tbody td:first-child {
        min-width: 60px;
        max-width: 100px;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}

.main-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px var(--shadow-color);
    margin: 2rem auto;
    padding: 2rem;
    transition: all 0.3s ease;
}

.hero-title {
    background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px var(--shadow-color);
}

.card-modern {
    background: linear-gradient(145deg, var(--bg-card), var(--bg-primary));
    border: 2px solid var(--border-color);
    border-radius: 15px;
    box-shadow: 0 10px 30px var(--shadow-color);
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.card-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.card-modern:hover::before {
    transform: scaleX(1);
}

.card-modern:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px var(--shadow-hover);
    background: linear-gradient(145deg, var(--bg-card-hover), var(--bg-secondary));
}

.icon-gradient {
    background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.btn-gradient {
    background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
    border: none;
    border-radius: 25px;
    color: white;
    padding: 0.5rem 1.5rem;
    transition: all 0.3s ease;
}

.btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px var(--shadow-strong);
    color: white;
}

.btn-primary {
    background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
    border: none;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px var(--shadow-strong);
}

.btn-info {
    background: linear-gradient(45deg, var(--info-color), var(--accent-color));
    border: none;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(23, 162, 184, 0.3);
}

.btn-success {
    background: linear-gradient(45deg, var(--success-color), #20c997);
    border: none;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
}

.btn-warning {
    background: linear-gradient(45deg, var(--warning-color), #fd7e14);
    border: none;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(255, 193, 7, 0.3);
}

.table-modern {
    background: linear-gradient(145deg, var(--bg-card), var(--bg-primary));
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px var(--shadow-color);
    border: 2px solid var(--border-color);
}

.table-modern thead th {
    background: transparent;
    color: black;
    border: none;
    font-weight: 600;
    padding: 1rem;
}

.table-modern tbody tr {
    transition: all 0.3s ease;
}

.table-modern tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.1);
    transform: scale(1.01);
}

.table-modern tbody td {
    border: none;
    padding: 1rem;
    vertical-align: middle;
}

.floating-elements {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

.floating-circle {
    position: absolute;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

.floating-circle:nth-child(1) {
    width: 80px;
    height: 80px;
    top: 20%;
    left: 10%;
    animation-delay: 0s;
}

.floating-circle:nth-child(2) {
    width: 60px;
    height: 60px;
    top: 60%;
    right: 15%;
    animation-delay: 2s;
}

.floating-circle:nth-child(3) {
    width: 40px;
    height: 40px;
    bottom: 20%;
    left: 20%;
    animation-delay: 4s;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
}

/* Стили для строк таблицы расписания */
.match-row {
    transition: all 0.3s ease;
}

.match-row:hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
}

.match-row:hover td {
    border-color: rgba(13, 110, 253, 0.3);
}

/* Адаптивные размеры для мобильных устройств */
@media (max-width: 576px) {
    .main-container {
        margin: 1rem;
        padding: 1rem;
    }
    
    .table-modern {
        font-size: 0.875rem;
    }
    
    .table-modern thead th,
    .table-modern tbody td {
        padding: 0.5rem;
    }
    
    .match-row:hover {
        transform: none; /* Отключаем масштабирование на мобильных */
    }
}

/* Оптимизация турнирной таблицы для мобильных устройств (ширина > 500px) */
@media (min-width: 501px) and (max-width: 768px) {
    /* Уменьшаем размер шрифта таблицы */
    .table-modern {
        font-size: 0.7rem;
    }
    
    /* Уменьшаем отступы в ячейках */
    .table-modern thead th,
    .table-modern tbody td {
        padding: 0.2rem 0.1rem;
    }
    
    /* Специальные стили для колонок "Очки" и "Место" */
    .table-modern th:nth-child(2), /* Колонка "Очки" */
    .table-modern td:nth-child(2) {
        width: 35px !important;
        min-width: 35px !important;
        max-width: 35px !important;
        padding: 0.2rem 0.1rem !important;
        font-size: 0.7rem;
        text-align: center;
    }
    
    .table-modern th:nth-child(3), /* Колонка "Место" */
    .table-modern td:nth-child(3) {
        width: 35px !important;
        min-width: 35px !important;
        max-width: 35px !important;
        padding: 0.2rem 0.1rem !important;
        font-size: 0.7rem;
        text-align: center;
    }
    
    /* Уменьшаем ширину ячеек с результатами матчей */
    .table-modern td[style*="width: 120px"] {
        width: 50px !important;
        min-width: 50px !important;
        max-width: 50px !important;
        height: 45px !important;
    }
    
    /* Уменьшаем размер бейджей в ячейках */
    .table-modern .badge {
        font-size: 0.55rem;
        padding: 0.1rem 0.2rem;
        line-height: 1;
    }
    
    /* Уменьшаем размер текста в ячейках */
    .table-modern small {
        font-size: 0.5rem;
        line-height: 1;
    }
    
    /* Оптимизируем колонку "Участник" */
    .table-modern th:first-child,
    .table-modern td:first-child {
        width: 70px !important;
        min-width: 70px !important;
        max-width: 70px !important;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.7rem;
        padding: 0.2rem 0.1rem !important;
    }
    
    /* Вертикальные заголовки для колонок участников */
    .table-modern th:nth-child(n+4) {
        transform: rotate(-90deg);
        background-color: transparent !important;
        width: 30px !important;
        min-width: 30px !important;
        max-width: 30px !important;
        padding: 0.1rem 0.05rem !important;
        font-size: 0.6rem;
        line-height: 1.2;
        height: 80px;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    /* Уменьшаем ширину ячеек участников */
    .table-modern td:nth-child(n+4) {
        width: 50px !important;
        min-width: 50px !important;
        max-width: 50px !important;
        height: 45px !important;
        padding: 0.1rem 0.05rem !important;
    }
    
    /* Специальные стили для flex-контейнеров в ячейках */
    .table-modern .d-flex {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    /* Убираем отступы между элементами в ячейках */
    .table-modern .d-flex .badge {
        margin-bottom: 0.1rem;
    }
}

/* Ультра-агрессивная оптимизация для очень маленьких экранов (550px и меньше) */
@media (max-width: 550px) {
    /* Уменьшаем размер шрифта таблицы до минимума */
    .table-modern {
        font-size: 0.6rem;
    }
    
    /* Минимальные отступы в ячейках */
    .table-modern thead th,
    .table-modern tbody td {
        padding: 0.1rem 0.05rem;
    }
    
    /* Поворачиваем заголовки колонок "Очки" и "Место" на 90° против часовой стрелки */
    .table-modern th:nth-child(2), /* Колонка "Очки" */
    .table-modern th:nth-child(3) { /* Колонка "Место" */
        transform: rotate(-90deg);
        background-color: transparent !important;
        width: 25px !important;
        min-width: 25px !important;
        max-width: 25px !important;
        padding: 0.1rem 0.05rem !important;
        font-size: 0.6rem;
        text-align: center;
        white-space: nowrap;
        height: 60px;
        vertical-align: middle;
    }
    
    /* Уменьшаем ячейки "Очки" и "Место" */
    .table-modern td:nth-child(2), /* Колонка "Очки" */
    .table-modern td:nth-child(3) { /* Колонка "Место" */
        width: 25px !important;
        min-width: 25px !important;
        max-width: 25px !important;
        padding: 0.1rem 0.05rem !important;
        font-size: 0.6rem;
        text-align: center;
    }
    
    /* Еще больше уменьшаем ячейки с результатами матчей */
    .table-modern td[style*="width: 120px"] {
        width: 35px !important;
        min-width: 35px !important;
        max-width: 35px !important;
        height: 35px !important;
    }
    
    /* Минимальный размер бейджей */
    .table-modern .badge {
        font-size: 0.5rem;
        padding: 0.05rem 0.1rem;
        line-height: 1;
    }
    
    /* Минимальный размер текста */
    .table-modern small {
        font-size: 0.45rem;
        line-height: 1;
    }
    
    /* Максимально сжимаем колонку "Участник" */
    .table-modern th:first-child,
    .table-modern td:first-child {
        width: 50px !important;
        min-width: 50px !important;
        max-width: 50px !important;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.6rem;
        padding: 0.1rem 0.05rem !important;
    }
    
    /* Еще больше уменьшаем заголовки колонок участников */
    .table-modern th:nth-child(n+4) {
        transform: rotate(-90deg);
        background-color: transparent !important;
        width: 25px !important;
        min-width: 25px !important;
        max-width: 25px !important;
        padding: 0.05rem 0.02rem !important;
        font-size: 0.5rem;
        line-height: 1.1;
        height: 60px;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    /* Еще больше уменьшаем ячейки участников */
    .table-modern td:nth-child(n+4) {
        width: 35px !important;
        min-width: 35px !important;
        max-width: 35px !important;
        height: 35px !important;
        padding: 0.05rem 0.02rem !important;
    }
    
    /* Оптимизируем flex-контейнеры */
    .table-modern .d-flex {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 0.05rem;
    }
    
    /* Убираем все отступы между элементами */
    .table-modern .d-flex .badge {
        margin-bottom: 0.05rem;
    }
}

    
    /* Стили для турнирной таблицы на маленьких экранах */
    #tournament-table thead th,
    #tournament-table tbody td {
        background-color: transparent !important;
        background: transparent !important;
        color: black !important;
    }
    
    /* Максимально специфичные селекторы для турнирной таблицы */
    table#tournament-table.table.table-modern.table-bordered.table-sm thead th,
    table#tournament-table.table.table-modern.table-bordered.table-sm tbody td {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* Переопределяем все Bootstrap фоновые классы для турнирной таблицы */
    #tournament-table thead th.bg-light,
    #tournament-table thead th.bg-secondary,
    #tournament-table thead th.bg-primary,
    #tournament-table tbody td.bg-light,
    #tournament-table tbody td.bg-secondary,
    #tournament-table tbody td.bg-primary {
        background-color: transparent !important;
        background: transparent !important;
    }
}
</style>

<div class="floating-elements">
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
</div>

<div class="container">
    <div class="main-container">
        
        <div class="text-center mb-5">
            <h1 class="hero-title display-4">
                <i class="fas fa-trophy me-3"></i>
                {{ tournament.name }}
            </h1>
            <p class="lead text-muted">
                <i class="fas fa-trophy me-2"></i>{{ tournament.sport_type }} • 
                <i class="fas fa-calendar me-2"></i>
                {% if tournament.start_date %}
                    {{ tournament.start_date.strftime('%d.%m.%Y') }}
                {% else %}
                    Дата не указана
                {% endif %}
                {% if tournament.end_date %}
                    - {{ tournament.end_date.strftime('%d.%m.%Y') }}
                {% endif %}
            </p>
            
            <!-- Статус турнира -->
            <div class="mb-3">
                {% if tournament.status == 'завершен' %}
                    <span class="badge bg-success fs-6 px-3 py-2">
                        <i class="fas fa-flag-checkered me-2"></i>Турнир завершен
                    </span>
                {% elif tournament.status == 'активен' %}
                    <span class="badge bg-warning fs-6 px-3 py-2">
                        <i class="fas fa-play me-2"></i>Турнир активен
                    </span>
                {% else %}
                    <span class="badge bg-info fs-6 px-3 py-2">
                        <i class="fas fa-user-plus me-2"></i>Регистрация участников
                    </span>
                {% endif %}
            </div>
        </div>
        
        <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center mb-5">

                     {% if current_user.is_authenticated and (current_user.role == 'системный администратор' or current_user.role == 'администратор турнира') %}
                     {% set has_active_matches = matches | selectattr('status', 'in', ['завершен', 'в процессе', 'играют']) | list | length > 0 %}
                     {% if not has_active_matches %}
                     <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addParticipantModal">
                         <i class="fas fa-user-plus me-1"></i><span class="d-none d-sm-inline">Добавить участника</span><span class="d-sm-none">Добавить</span>
                     </button>
                     {% endif %}
                     <button class="btn btn-info btn-sm" onclick="generateSchedule()">
                         <i class="fas fa-calendar-alt me-1"></i><span class="d-none d-sm-inline">Составить расписание заново</span><span class="d-sm-none">Расписание</span>
                     </button>
                     <a href="{{ url_for('export_tournament', tournament_id=tournament.id) }}" class="btn btn-success btn-sm" download>
                         <i class="fas fa-file-excel me-1"></i><span class="d-none d-sm-inline">Выгрузить в Excel</span><span class="d-sm-none">Excel</span>
                     </a>
                     {% else %}
                     <button class="btn btn-primary btn-sm" disabled title="Доступно только создателю турнира и администратору системы">
                         <i class="fas fa-user-plus me-1"></i><span class="d-none d-sm-inline">Добавить участника</span><span class="d-sm-none">Добавить</span>
                     </button>
                     <button class="btn btn-info btn-sm" disabled title="Доступно только создателю турнира и администратору системы">
                         <i class="fas fa-calendar-alt me-1"></i><span class="d-none d-sm-inline">Составить расписание</span><span class="d-sm-none">Расписание</span>
                     </button>
                     {% if has_active_matches %}
                     <button class="btn btn-warning btn-sm" disabled title="Доступно только создателю турнира и администратору системы">
                         <i class="fas fa-user-clock me-1"></i><span class="d-none d-sm-inline">Добавить опоздавшего участника</span><span class="d-sm-none">Опоздавший</span>
                     </button>
                     {% endif %}
                     {% endif %}
                     {% if current_user.role == 'системный администратор' %}
                     {% if has_missing_matches %}
                     <button class="btn btn-info me-2" onclick="createMissingMatches()">
                         <i class="fas fa-plus-circle me-2"></i>Создать недостающие матчи
                     </button>
                     {% endif %}
                     {% endif %}
            </div>
        </div>
    </div>
</div>

        <!-- Статистика участников -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-modern">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Статистика участников
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-modern" id="statisticsTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="position">
                                            Место <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-column="name">
                                            Участник <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-column="games">
                                            Игр <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-column="wins">
                                            Побед <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        {% if tournament.sport_type not in ['пинг-понг', 'бадминтон', 'волейбол'] %}
                                        <th class="sortable" data-column="draws">
                                            Ничьих <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        {% endif %}
                                        <th class="sortable" data-column="losses">
                                            Поражений <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-column="points">
                                            Очки<br><small>в турнире</small> <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-column="sets_difference">
                                            Разница +/-<br><small>сетов</small> <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-column="goal_difference">
                                            Разница очков<br><small>в сетах</small> <i class="fas fa-sort ms-1"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p1_data in participants_with_stats %}
                                    {% set participant = p1_data.participant %}
                                    {% set participant_stats = p1_data.stats %}
                                    {% set participant_position = p1_data.position %}
                                    <tr class="{% if p1_data.is_late_participant %}table-warning{% endif %}">
                                        <td>{{ participant_position }}</td>
                                        <td>
                                            <strong>{{ participant.name }}</strong>
                                            {% if participant.is_team %}
                                                <span class="badge bg-info ms-2">Команда</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ participant_stats.games }}</td>
                                        <td>{{ participant_stats.wins }}</td>
                                        {% if tournament.sport_type not in ['пинг-понг', 'бадминтон', 'волейбол'] %}
                                        <td>{{ participant_stats.draws }}</td>
                                        {% endif %}
                                        <td>{{ participant_stats.losses }}</td>
                                        <td>{{ participant_stats.points }}</td>
                                        <td>
                                            {% if participant_stats.sets_difference > 0 %}+{% endif %}{{ participant_stats.sets_difference }}
                                        </td>
                                        <td>
                                            {% if participant_stats.goal_difference > 0 %}+{% endif %}{{ participant_stats.goal_difference }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Турнирная таблица -->
        <div class="row">
            <div class="col-12">
                <div class="card card-modern">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Турнирная таблица
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-modern table-bordered table-sm" id="tournament-table">
                        <thead>
                            <tr>
                                <th class="bg-light">Участник</th>
                                <th class="text-center bg-light">Очки</th>
                                <th class="text-center bg-light">Место</th>
                                {% for participant_data in participants_with_stats_chessboard %}
                                {% set participant = participant_data.participant %}
                                <th class="text-center {% if participant_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %}">
                                    {{ participant.name[:15] }}{% if participant.name|length > 15 %}...{% endif %}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for p1_data in participants_with_stats_chessboard %}
                            {% set p1 = p1_data.participant %}
                            {% set p1_stats = p1_data.stats %}
                            {% set p1_position = p1_data.position %}
                            <tr>
                                <td class="{% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold">
                                    {{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}
                                </td>
                                <td class="text-center {% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold text-primary">{{ p1_stats.points }}</td>
                                <td class="text-center {% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold text-success">{{ p1_position }}</td>
                                {% for p2_data in participants_with_stats_chessboard %}
                                {% set p2 = p2_data.participant %}
                                <td class="text-center position-relative {% if p1_data.is_late_participant or p2_data.is_late_participant %}bg-success bg-opacity-25{% endif %}" style="height: 80px; width: 120px; vertical-align: middle;">
                                    {% if p1.id == p2.id %}
                                        <span class="text-muted">—</span>
                                    {% else %}
                                        {% set cell_data = chessboard[p1.id][p2.id] %}
                                        {% if cell_data.type == 'result' %}
                                            <div class="d-flex flex-column align-items-center" 
                                                 onclick="openMatchResultModal({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')" 
                                                 style="cursor: pointer;" 
                                                 title="Нажмите для редактирования результата">
                                                {% if cell_data.is_winner %}
                                                    <span class="badge bg-success text-white mb-1">{{ cell_data.value }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger text-white mb-1">{{ cell_data.value }}</span>
                                                {% endif %}
                                                {% if cell_data.sets_details %}
                                                <small class="text-muted">{{ cell_data.sets_details }}</small>
                                                {% endif %}
                                            </div>
                                        {% elif cell_data.type == 'in_progress' %}
                                            <div class="d-flex flex-column align-items-center" 
                                                 onclick="openMatchResultModal({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')" 
                                                 style="cursor: pointer;" 
                                                 title="Нажмите для редактирования результата">
                                                <span class="badge bg-warning text-dark mb-1" style="background-color: #ffc107 !important;">{{ cell_data.value }}</span>
                                                {% if cell_data.sets_details %}
                                                <small class="text-muted">{{ cell_data.sets_details }}</small>
                                                {% endif %}
                                            </div>
                                        {% elif cell_data.type == 'upcoming' %}
                                              {% set court_colors = {
                                                  1: 'primary',
                                                  2: 'info', 
                                                  3: 'success',
                                                  4: 'warning',
                                                  5: 'danger',
                                                  6: 'secondary',
                                                  7: 'dark',
                                                  8: 'light'
                                              } %}
                                              {% set is_next_match = cell_data.get('is_next_match', False) %}
                                              {% set court_color = court_colors.get(cell_data.court, 'secondary') %}
                                              
                                              <div class="text-center position-relative {% if is_next_match %}border border-warning border-3 rounded bg-warning bg-opacity-10{% endif %}" 
                                                   onclick="openMatchResultModal({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')" 
                                                   style="cursor: pointer; {% if is_next_match %}animation: pulse 2s infinite;{% endif %}" 
                                                   title="{% if is_next_match %}Ближайший матч! {% endif %}Нажмите для редактирования результата">
                                                  <!-- Основной контейнер с цветом площадки -->
                                                  <div class="{% if cell_data.is_next %}border border-warning border-1 rounded p-1 bg-warning bg-opacity-15 shadow-sm{% elif cell_data.is_second %}border border-success border-1 rounded p-1 bg-success bg-opacity-15 shadow-sm{% else %}border border-{{ court_color }} border-1 rounded p-1 bg-{{ court_color }} bg-opacity-10{% endif %}" style="height: 70px; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                                      <!-- Верхняя часть -->
                                                      <div>
                                                          <!-- Номер корта крупным полупрозрачным шрифтом -->
                                                          <div class="text-center mb-1">
                                                              <span style="font-size: 1.5rem; font-weight: bold; opacity: 0.3; color: {{ court_color }};">{{ cell_data.court }}</span>
                                                          </div>
                                                      </div>
                                                      
                                                      <!-- Время матча - внизу -->
                                                      <div class="mt-auto">
                                                          <small class="d-block text-dark fw-bold text-center" style="font-size: 0.6rem; background-color: rgba(255, 255, 255, 0.95); padding: 1px 3px; border-radius: 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                              {% if cell_data.time %}
                                                                  {{ cell_data.time.strftime('%H:%M') }}
                                                              {% else %}
                                                                  Время не указано
                                                              {% endif %}
                                                          </small>
                                                      </div>
                                                  </div>
                                                  
                                              </div>
                                        {% elif cell_data.type == 'empty' %}
                                            <div class="d-flex flex-column align-items-center" 
                                                 onclick="openMatchResultModal(null, '{{ p1.name }}', '{{ p2.name }}')" 
                                                 style="cursor: pointer; height: 70px; display: flex; align-items: center; justify-content: center;" 
                                                 title="Нажмите для создания матча">
                                                <span class="text-muted" style="font-size: 1.2rem;">+</span>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Сообщение о завершении турнира -->
{% if tournament.status == 'завершен' and not has_unfinished %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                    <h1 class="display-4 fw-bold text-success mb-3" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                        🏆 Турнир завершён! 🏆
                    </h1>
                    <p class="lead text-muted">Все матчи сыграны. Итоговые результаты:</p>
                </div>
                
                <!-- Список победителей -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-success">
                                    <tr>
                                        <th class="text-center" style="width: 60px;">Место</th>
                                        <th>Участник</th>
                                        <th class="text-center">Очки</th>
                                        <th class="text-center">Побед</th>
                                        <th class="text-center">Ничьих</th>
                                        <th class="text-center">Поражений</th>
                                        <th class="text-center">Разница очков</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participant_data in participants_with_stats %}
                                    {% set participant = participant_data.participant %}
                                    {% set stats = participant_data.stats %}
                                    {% set position = participant_data.position %}
                                    <tr class="{% if position == 1 %}table-warning fw-bold{% elif position <= 3 %}table-light{% endif %}">
                                        <td class="text-center">
                                            {% if position == 1 %}
                                                <span class="badge bg-warning text-dark fs-6">🥇</span>
                                            {% elif position == 2 %}
                                                <span class="badge bg-secondary fs-6">🥈</span>
                                            {% elif position == 3 %}
                                                <span class="badge bg-warning text-dark fs-6">🥉</span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">{{ position }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold">{{ participant.name }}</td>
                                        <td class="text-center fw-bold text-primary">{{ stats.points }}</td>
                                        <td class="text-center">{{ stats.wins }}</td>
                                        <td class="text-center">{{ stats.draws }}</td>
                                        <td class="text-center">{{ stats.losses }}</td>
                                        <td class="text-center {% if stats.goal_difference > 0 %}text-success{% elif stats.goal_difference < 0 %}text-danger{% endif %}">
                                            {{ stats.goal_difference }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Поздравление победителя -->
                {% if participants_with_stats|length > 0 %}
                {% set winner = participants_with_stats[0] %}
                <div class="mt-4">
                    <div class="alert alert-warning border-warning">
                        <h4 class="alert-heading mb-3">
                            <i class="fas fa-crown me-2"></i>
                            Поздравляем победителя!
                        </h4>
                        <h3 class="text-warning fw-bold mb-2">{{ winner.participant.name }}</h3>
                        <p class="mb-0">с победой в турнире "{{ tournament.name }}"!</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Расписание матчей -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Расписание матчей</h5>
            </div>
            <div class="card-body">
                {% if schedule_display %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th class="d-none d-sm-table-cell" style="width: 60px;">№</th>
                                    <th class="d-none d-md-table-cell" style="width: 100px;">Время</th>
                                    <th class="d-none d-lg-table-cell" style="width: 80px;">Площадка</th>
                                    <th>Участники</th>
                                    <th class="d-none d-sm-table-cell" style="width: 100px;">Счет</th>
                                    <th class="d-none d-md-table-cell" style="width: 120px;">Статус</th>
                                    <th style="width: 80px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date_str, day_data in schedule_display.items() %}
                                <tr class="table-info">
                                    <td colspan="7" class="fw-bold text-center py-2">
                                        <i class="fas fa-calendar-day me-2"></i>{{ day_data.date_display }}
                                    </td>
                                </tr>
                                {% for match in day_data.matches %}
                                <tr class="match-row" 
                                    data-match-id="{{ match.id }}"
                                    data-participant1="{{ match.participant1 }}"
                                    data-participant2="{{ match.participant2 }}"
                                    data-score1="{{ match.score1 or 0 }}"
                                    data-score2="{{ match.score2 or 0 }}"
                                    style="cursor: pointer;"
                                    onclick="openMatchResultModal({{ match.id }}, '{{ match.participant1 }}', '{{ match.participant2 }}', {{ match.score1 or 0 }}, {{ match.score2 or 0 }})">
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ match.global_number }}</span>
                                    </td>
                                    <td class="fw-bold text-primary">{{ match.time }}</td>
                                    <td class="text-center">
                                        {% if match.court > 0 %}
                                            {% set court_colors = {
                                                1: 'primary',
                                                2: 'info', 
                                                3: 'success',
                                                4: 'warning',
                                                5: 'danger',
                                                6: 'secondary',
                                                7: 'dark',
                                                8: 'light'
                                            } %}
                                            {% set court_color = court_colors.get(match.court, 'secondary') %}
                                            <span class="badge bg-{{ court_color }}">
                                                Пл. {{ match.court }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ match.participant1 }}</strong> vs <strong>{{ match.participant2 }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {% if match.score and match.status != 'запланирован' %}
                                            {% if match.status == 'завершен' %}
                                                {% set score_parts = match.score.split(':') %}
                                                {% set score1 = score_parts[0]|int %}
                                                {% set score2 = score_parts[1]|int %}
                                                {% if score1 > score2 %}
                                                    <span class="badge bg-success text-white">{{ match.score }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger text-white">{{ match.score }}</span>
                                                {% endif %}
                                            {% elif match.status in ['в процессе', 'играют'] %}
                                                <span class="badge bg-warning text-dark" style="background-color: #ffc107 !important; color: #000 !important;">{{ match.score }}</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">{{ match.score }}</span>
                                            {% endif %}
                                            {% if match.sets_details %}
                                            <br><small class="text-muted">{{ match.sets_details }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if match.status == 'завершен' %}bg-success
                                            {% elif match.status == 'запланирован' %}bg-info
                                            {% else %}bg-secondary{% endif %}"
                                            {% if match.status in ['в процессе', 'играют'] %}style="background-color: #ffc107 !important; color: #000 !important;"{% endif %}>
                                            {{ match.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if current_user.is_authenticated and (current_user.role == 'системный администратор' or current_user.role == 'администратор турнира') %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="event.stopPropagation(); openMatchResultModal({{ match.id }}, '{{ match.participant1 }}', '{{ match.participant2 }}', {{ match.score1 or 0 }}, {{ match.score2 or 0 }})"
                                                title="Ввести результат матча">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="mb-0">Расписание матчей пока не составлено</p>
                        <small>Нажмите "Пересчитать расписание" для создания расписания</small>
                    </div>
                {% endif %}
                
                {% if schedule_display %}
                <div class="text-center text-muted mt-3">
                    <small><i class="fas fa-info-circle me-1"></i>Кликните по строке матча для ввода результата</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Модальное окно для ввода результата матча -->
<div class="modal fade" id="matchResultModal" tabindex="-1" data-match-id="">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Результат</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" form="matchResultForm" class="btn btn-primary btn-sm">Сохранить</button>
                </div>
            </div>
            <div class="modal-body">
                <form id="matchResultForm">
                    <input type="hidden" id="matchId" name="match_id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Участник 1</label>
                            <input type="text" class="form-control" id="participant1Name" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Участник 2</label>
                            <input type="text" class="form-control" id="participant2Name" readonly>
                        </div>
                    </div>
                    
                    <!-- Сет 1 -->
                    <div class="mb-3" id="set1Container">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">Сет 1</span>
                            <small class="text-muted">Очки для победы: {{ tournament.points_to_win }}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set1Score1" name="set1_score1" min="0" value="{{ tournament.points_to_win }}">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set1Score2" name="set1_score2" min="0" value="{{ tournament.points_to_win }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Сет 2 -->
                    <div class="mb-3" id="set2Container">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-info me-2">Сет 2</span>
                            <small class="text-muted">Очки для победы: {{ tournament.points_to_win }}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set2Score1" name="set2_score1" min="0" value="{{ tournament.points_to_win }}">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set2Score2" name="set2_score2" min="0" value="{{ tournament.points_to_win }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Сет 3 -->
                    <div class="mb-3" id="set3Container">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-warning me-2">Сет 3</span>
                            <small class="text-muted">Очки для победы: {{ tournament.points_to_win }}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set3Score1" name="set3_score1" min="0" value="">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set3Score2" name="set3_score2" min="0" value="">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Сетов для победы: <strong>{{ tournament.sets_to_win }}</strong> | Очков для победы в сете: <strong>{{ tournament.points_to_win }}</strong>
                        </small>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления участника -->
{% if current_user.is_authenticated and (current_user.role == 'системный администратор' or current_user.role == 'администратор турнира') %}
<div class="modal fade" id="addParticipantModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить участника в турнир</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Вкладки для разных способов добавления -->
                <ul class="nav nav-tabs" id="addParticipantTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                            <i class="fas fa-edit me-2"></i>Ручной ввод
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab">
                            <i class="fas fa-list me-2"></i>Добавить из списка
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="waiting-tab" data-bs-toggle="tab" data-bs-target="#waiting" type="button" role="tab">
                            <i class="fas fa-clock me-2"></i>Лист ожидания
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="addParticipantTabContent">
                    <!-- Вкладка ручного ввода -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel">
                        <form id="addParticipantForm">
                            <div class="mb-3">
                                <label for="participantName" class="form-label">Имя участника</label>
                                <input type="text" class="form-control" id="participantName" required>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Вкладка добавления из списка игроков -->
                    <div class="tab-pane fade" id="players" role="tabpanel">
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Список игроков:</strong> Выберите игроков из списка ранее добавленных участников.
                            </div>
                        </div>
                        
                        <!-- Поиск игроков -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="playerSearchInput" placeholder="Поиск игроков...">
                            </div>
                        </div>
                        
                        <!-- Список игроков -->
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-hover" id="playersListTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllPlayers" class="form-check-input">
                                        </th>
                                        <th>Имя игрока</th>
                                        <th>Последнее участие</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="playersListTableBody">
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="noPlayersMessage" class="text-center text-muted py-3" style="display: none;">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <p>Список игроков пуст</p>
                            <small>Игроки будут добавлены в список автоматически при добавлении участников в турниры</small>
                        </div>
                        
                        <!-- Кнопки действий -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="addSelectedPlayersBtn" disabled>
                                <i class="fas fa-user-plus me-2"></i>Добавить выбранных игроков (<span id="selectedCount">0</span>)
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearPlayerSelectionBtn">
                                <i class="fas fa-times me-2"></i>Очистить выбор
                            </button>
                        </div>
                    </div>
                    
                    <!-- Вкладка листа ожидания -->
                    <div class="tab-pane fade" id="waiting" role="tabpanel">
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Лист ожидания:</strong> Здесь отображаются заявки на участие в турнире. Вы можете принять или отклонить заявки.
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-hover" id="waitingListTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Выбрать</th>
                                        <th>Имя</th>
                                        <th>Уровень навыков</th>
                                        <th>Дата подачи</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="waitingListTableBody">
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="noWaitingListMessage" class="text-center text-muted py-3" style="display: none;">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>Лист ожидания пуст</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" id="addManualParticipantBtn" class="btn btn-primary">
                    <i class="fas fa-user-plus me-2"></i>Добавить
                </button>
                <button type="button" id="addSelectedWaitingBtn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-check me-2"></i>Принять выбранных
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления опоздавшего участника -->
<div class="modal fade" id="addLateParticipantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-clock me-2"></i>Добавить опоздавшего участника
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Информация:</strong> Опоздавший участник будет добавлен в турнир без изменения расписания. Результаты прошедших матчей сохранятся.
                </div>
                <form id="addLateParticipantForm">
                    <div class="mb-3">
                        <label for="lateParticipantName" class="form-label">Имя участника</label>
                        <input type="text" class="form-control" id="lateParticipantName" placeholder="Введите имя участника" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-warning" onclick="addLateParticipant()">
                    <i class="fas fa-user-plus me-2"></i>Добавить участника
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно регистрации пользователя -->
<div class="modal fade" id="registerUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Регистрация нового пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Имя пользователя</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="registerUserForm" class="btn btn-primary">Зарегистрироваться</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        // Версия скрипта для принудительного обновления кэша
        console.log('Загружен скрипт валидации v2.5 - исправлено условие для 12:11');

// Инициализация сортировки таблицы статистики
document.addEventListener('DOMContentLoaded', function() {
    initializeTableSorting();
});

// Функция инициализации сортировки таблицы
function initializeTableSorting() {
    const table = document.getElementById('statisticsTable');
    if (!table) return;
    
    const sortableHeaders = table.querySelectorAll('.sortable');
    let currentSort = { column: null, direction: 'asc' };
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            
            // Определяем направление сортировки
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.direction = 'asc';
            }
            currentSort.column = column;
            
            // Обновляем визуальные индикаторы
            updateSortIndicators(sortableHeaders, column, currentSort.direction);
            
            // Сортируем таблицу
            sortTable(table, column, currentSort.direction);
        });
    });
}

// Функция обновления визуальных индикаторов сортировки
function updateSortIndicators(headers, activeColumn, direction) {
    headers.forEach(header => {
        header.classList.remove('sorted', 'sorted-asc', 'sorted-desc');
        if (header.dataset.column === activeColumn) {
            header.classList.add('sorted', `sorted-${direction}`);
        }
    });
}

// Функция сортировки таблицы
function sortTable(table, column, direction) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (column) {
            case 'position':
                aValue = parseInt(a.cells[0].textContent) || 0;
                bValue = parseInt(b.cells[0].textContent) || 0;
                break;
            case 'name':
                aValue = a.cells[1].textContent.trim();
                bValue = b.cells[1].textContent.trim();
                break;
            case 'games':
                aValue = parseInt(a.cells[2].textContent) || 0;
                bValue = parseInt(b.cells[2].textContent) || 0;
                break;
            case 'wins':
                aValue = parseInt(a.cells[3].textContent) || 0;
                bValue = parseInt(b.cells[3].textContent) || 0;
                break;
            case 'draws':
                aValue = parseInt(a.cells[4].textContent) || 0;
                bValue = parseInt(b.cells[4].textContent) || 0;
                break;
            case 'losses':
                aValue = parseInt(a.cells[5].textContent) || 0;
                bValue = parseInt(b.cells[5].textContent) || 0;
                break;
            case 'points':
                aValue = parseInt(a.cells[6].textContent) || 0;
                bValue = parseInt(b.cells[6].textContent) || 0;
                break;
            case 'goal_difference':
                aValue = parseInt(a.cells[7].textContent) || 0;
                bValue = parseInt(b.cells[7].textContent) || 0;
                break;
            default:
                return 0;
        }
        
        // Сравнение значений
        if (column === 'name') {
            // Для текстовых значений
            return direction === 'asc' 
                ? aValue.localeCompare(bValue, 'ru')
                : bValue.localeCompare(aValue, 'ru');
        } else {
            // Для числовых значений
            return direction === 'asc' ? aValue - bValue : bValue - aValue;
        }
    });
    
    // Очищаем tbody и добавляем отсортированные строки
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// Добавляем обработчики кликов на все ячейки шахматки
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.table-bordered');
    if (table) {
        table.addEventListener('click', function(e) {
            const cell = e.target.closest('td');
            if (cell && !cell.querySelector('button')) {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const cellIndex = cell.cellIndex;
                
                if (rowIndex > 0 && cellIndex > 2) { // Пропускаем заголовки и столбцы "Очки" и "Место"
                    const participants = {{ participants_data|tojson }};
                    const p1 = participants[rowIndex - 1];
                    const p2 = participants[cellIndex - 3]; // Учитываем сдвиг на 2 столбца (Очки и Место)
                    
                    if (p1 && p2 && p1.id !== p2.id) {
                        openMatchModal(p1.id, p2.id, p1.name, p2.name);
                    }
                }
            }
        });
    }
});

function openMatchResultModal(matchId, p1Name, p2Name) {
    console.log('Открытие формы результата матча:', p1Name, 'vs', p2Name, 'matchId:', matchId);
    
    // Устанавливаем ID матча в модальном окне
    document.getElementById('matchResultModal').setAttribute('data-match-id', matchId || '');
    
    // Заполняем форму
    document.getElementById('matchId').value = matchId || '';
    document.getElementById('participant1Name').value = p1Name;
    document.getElementById('participant2Name').value = p2Name;
    
    // Сброс формы сетов
    resetSetsForm();
    
    // Если matchId null, это новый матч - просто показываем форму
    if (!matchId) {
        console.log('Создание нового матча');
        new bootstrap.Modal(document.getElementById('matchResultModal')).show();
        return;
    }
    
    // Получаем данные матча
    fetch(`/api/matches/${matchId}`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Заполняем сеты данными из матча
                const defaultScore = {{ tournament.points_to_win }};
                
                // Если есть существующие результаты, заполняем их
                if (data.match.score1 !== null && data.match.score2 !== null) {
                    console.log('Загружаем существующие результаты:', data.match.score1, ':', data.match.score2);
                    console.log('Результат матча:', data.match.score);
                    console.log('Выигранные сеты:', data.match.sets_won_1, ':', data.match.sets_won_2);
                    console.log('Match participant1_id:', data.match.participant1_id, 'participant2_id:', data.match.participant2_id);
                    console.log('Form participant1:', p1Name, 'participant2:', p2Name);
                    
                    // Получаем данные участников из турнира для определения их ID
                    const participants = {{ participants_data|tojson }};
                    const p1 = participants.find(p => p.name === p1Name);
                    const p2 = participants.find(p => p.name === p2Name);
                    
                    console.log('P1 ID from form:', p1?.id, 'P2 ID from form:', p2?.id);
                    
                    // Определяем, нужно ли менять местами счет
                    const needSwap = p1 && p2 && data.match.participant1_id !== p1.id;
                    console.log('Need to swap scores:', needSwap);
                    
                    // Заполняем все сеты данными из базы с учетом порядка участников
                    if (needSwap) {
                        // Участник 1 в форме = participant2 в матче, меняем местами
                        document.getElementById('set1Score1').value = data.match.set1_score2 || data.match.score2 || defaultScore;
                        document.getElementById('set1Score2').value = data.match.set1_score1 || data.match.score1 || defaultScore;
                        
                        if (data.match.set2_score1 !== null && data.match.set2_score2 !== null) {
                            document.getElementById('set2Score1').value = data.match.set2_score2;
                            document.getElementById('set2Score2').value = data.match.set2_score1;
                        } else {
                            document.getElementById('set2Score1').value = defaultScore;
                            document.getElementById('set2Score2').value = defaultScore;
                        }
                        
                        if (data.match.set3_score1 !== null && data.match.set3_score2 !== null) {
                            document.getElementById('set3Score1').value = data.match.set3_score2;
                            document.getElementById('set3Score2').value = data.match.set3_score1;
                        } else {
                            document.getElementById('set3Score1').value = '';
                            document.getElementById('set3Score2').value = '';
                        }
                    } else {
                        // Участник 1 в форме = participant1 в матче, оставляем как есть
                        document.getElementById('set1Score1').value = data.match.set1_score1 || data.match.score1 || defaultScore;
                        document.getElementById('set1Score2').value = data.match.set1_score2 || data.match.score2 || defaultScore;
                        
                        if (data.match.set2_score1 !== null && data.match.set2_score2 !== null) {
                            document.getElementById('set2Score1').value = data.match.set2_score1;
                            document.getElementById('set2Score2').value = data.match.set2_score2;
                        } else {
                            document.getElementById('set2Score1').value = defaultScore;
                            document.getElementById('set2Score2').value = defaultScore;
                        }
                        
                        if (data.match.set3_score1 !== null && data.match.set3_score2 !== null) {
                            document.getElementById('set3Score1').value = data.match.set3_score1;
                            document.getElementById('set3Score2').value = data.match.set3_score2;
                        } else {
                            document.getElementById('set3Score1').value = '';
                            document.getElementById('set3Score2').value = '';
                        }
                    }
                    
                    // Показываем все сеты для редактирования
                    document.getElementById('set2Container').style.display = 'block';
                    document.getElementById('set3Container').style.display = 'block';
                } else {
                    console.log('Нет существующих результатов, используем значения по умолчанию');
                    // Иначе используем значения по умолчанию для всех сетов
                    const defaultScore = {{ tournament.points_to_win }};
                    document.getElementById('set1Score1').value = defaultScore;
                    document.getElementById('set1Score2').value = defaultScore;
                    document.getElementById('set2Score1').value = defaultScore;
                    document.getElementById('set2Score2').value = defaultScore;
                    document.getElementById('set3Score1').value = '';
                    document.getElementById('set3Score2').value = '';
                }
                
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке данных матча:', error);
            // В случае ошибки используем значения по умолчанию для всех сетов
            const defaultScore = {{ tournament.points_to_win }};
            document.getElementById('set1Score1').value = defaultScore;
            document.getElementById('set1Score2').value = defaultScore;
            document.getElementById('set2Score1').value = defaultScore;
            document.getElementById('set2Score2').value = defaultScore;
            document.getElementById('set3Score1').value = '';
            document.getElementById('set3Score2').value = '';
        });
    
    // Сбрасываем флаг предложения сохранения для нового матча
    resetMatchCompletionPrompt();
    
    // Принудительно разблокируем все поля при открытии модального окна
    setTimeout(() => {
        for (let i = 1; i <= 3; i++) {
            const score1Input = document.getElementById(`set${i}Score1`);
            const score2Input = document.getElementById(`set${i}Score2`);
            if (score1Input && score2Input) {
                score1Input.readOnly = false;
                score2Input.readOnly = false;
                score1Input.classList.remove('bg-light');
                score2Input.classList.remove('bg-light');
            }
        }
    }, 100);
    
    new bootstrap.Modal(document.getElementById('matchResultModal')).show();
}


function editMatch(matchId) {
    // Редактирование матча из расписания
    // Получаем данные матча для отображения имен участников
    fetch(`/api/matches/${matchId}`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Находим участников по ID
                const participants = {{ participants_data|tojson }};
                const p1 = participants.find(p => p.id === data.match.participant1_id);
                const p2 = participants.find(p => p.id === data.match.participant2_id);
                
                if (p1 && p2) {
                    openMatchResultModal(matchId, p1.name, p2.name);
                } else {
                    openMatchResultModal(matchId, 'Участник 1', 'Участник 2');
                }
            }
        })
        .catch(error => {
            openMatchResultModal(matchId, 'Участник 1', 'Участник 2');
        });
}


// Обработка формы добавления участника
document.addEventListener('DOMContentLoaded', function() {
    const addParticipantForm = document.getElementById('addParticipantForm');
    if (addParticipantForm) {
        addParticipantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('participantName').value,
                is_team: false  // Всегда false, так как чекбокс удален
            };
            
            fetch('/api/tournaments/{{ tournament.id }}/participants', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('1. Преобразование response.json() - статус:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('2. Данные ответа:', data);
                if (data.success) {
                    console.log('3. СТАРТ ВЕТКИ "УСПЕШНЫЙ СЦЕНАРИЙ"');
                    location.reload();
                } else {
                    console.log('4. СЦЕНАРИЙ ОШИБОК - data.success = false, error:', data.error);
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                console.log('5. СЦЕНАРИЙ ОШИБОК - catch блок, error:', error);
                alert('Ошибка при добавлении участника: ' + error);
            });
        });
    }
    
    // Инициализация функциональности листа ожидания
    initializeWaitingList();
});


// Функция инициализации листа ожидания
function initializeWaitingList() {
    const waitingTab = document.getElementById('waiting-tab');
    const addSelectedWaitingBtn = document.getElementById('addSelectedWaitingBtn');
    
    if (waitingTab) {
        // Загружаем лист ожидания при переключении на вкладку
        waitingTab.addEventListener('click', function() {
            loadWaitingList();
        });
        
        // Принятие выбранных заявок
        if (addSelectedWaitingBtn) {
            addSelectedWaitingBtn.addEventListener('click', function() {
                acceptSelectedWaiting();
            });
        }
    }
}

// Управление видимостью кнопок в модальном окне добавления участника
document.addEventListener('DOMContentLoaded', function() {
    const manualTab = document.getElementById('manual-tab');
    const waitingTab = document.getElementById('waiting-tab');
    const addManualBtn = document.getElementById('addManualParticipantBtn');
    const addWaitingBtn = document.getElementById('addSelectedWaitingBtn');
    
    if (manualTab && waitingTab && addManualBtn && addWaitingBtn) {
        // Обработчик для вкладки "Ручной ввод"
        manualTab.addEventListener('shown.bs.tab', function() {
            addManualBtn.style.display = 'inline-block';
            addWaitingBtn.style.display = 'none';
        });
        
        // Обработчик для вкладки "Лист ожидания"
        waitingTab.addEventListener('shown.bs.tab', function() {
            addManualBtn.style.display = 'none';
            addWaitingBtn.style.display = 'inline-block';
        });
        
        // Обработчик для кнопки "Добавить" (ручной ввод)
        addManualBtn.addEventListener('click', function() {
            const addParticipantForm = document.getElementById('addParticipantForm');
            if (addParticipantForm) {
                addParticipantForm.dispatchEvent(new Event('submit'));
            }
        });
    }
});

// Загрузка листа ожидания
function loadWaitingList() {
    fetch(`/api/tournaments/{{ tournament.id }}/waiting-list`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayWaitingList(data.waiting_list);
        } else {
            console.error('Ошибка загрузки листа ожидания:', data.error);
            showNoWaitingListMessage();
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showNoWaitingListMessage();
    });
}

// Отображение листа ожидания
function displayWaitingList(waitingList) {
    const tbody = document.getElementById('waitingListTableBody');
    const noMessage = document.getElementById('noWaitingListMessage');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (waitingList.length === 0) {
        showNoWaitingListMessage();
        return;
    }
    
    noMessage.style.display = 'none';
    
    waitingList.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input waiting-checkbox" value="${entry.id}">
            </td>
            <td>${entry.name}</td>
            <td>
                <span class="badge bg-info">${entry.skill_level}</span>
            </td>
            <td>${entry.created_at}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="rejectSingleWaiting(${entry.id})" title="Отклонить заявку">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Добавляем обработчики для чекбоксов
    const checkboxes = document.querySelectorAll('.waiting-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateWaitingAddButton);
    });
}

// Показать сообщение о пустом листе ожидания
function showNoWaitingListMessage() {
    const tbody = document.getElementById('waitingListTableBody');
    const noMessage = document.getElementById('noWaitingListMessage');
    const addBtn = document.getElementById('addSelectedWaitingBtn');
    
    if (tbody) tbody.innerHTML = '';
    if (noMessage) noMessage.style.display = 'block';
    if (addBtn) addBtn.style.display = 'none';
}

// Обновление кнопки принятия заявок
function updateWaitingAddButton() {
    const checkboxes = document.querySelectorAll('.waiting-checkbox:checked');
    const addSelectedWaitingBtn = document.getElementById('addSelectedWaitingBtn');
    
    if (addSelectedWaitingBtn) {
        if (checkboxes.length > 0) {
            addSelectedWaitingBtn.style.display = 'inline-block';
            addSelectedWaitingBtn.innerHTML = `<i class="fas fa-check me-2"></i>Принять выбранных (${checkboxes.length})`;
        } else {
            addSelectedWaitingBtn.style.display = 'none';
        }
    }
}

// Принятие выбранных заявок
function acceptSelectedWaiting() {
    const checkboxes = document.querySelectorAll('.waiting-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Выберите хотя бы одну заявку');
        return;
    }
    
    const waitingIds = Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
    
    const addBtn = document.getElementById('addSelectedWaitingBtn');
    const originalText = addBtn.innerHTML;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Принимаем...';
    addBtn.disabled = true;
    
    fetch(`/api/tournaments/{{ tournament.id }}/accept-waiting`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ waiting_ids: waitingIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadWaitingList(); // Перезагружаем лист ожидания
            location.reload(); // Перезагружаем страницу для обновления списка участников
        } else {
            alert('Ошибка при принятии заявок: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка при принятии заявок. Попробуйте еще раз.');
    })
    .finally(() => {
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
    });
}

// Принятие одной заявки
function acceptSingleWaiting(waitingId) {
    if (confirm('Принять эту заявку?')) {
        acceptSelectedWaiting.call({ value: waitingId });
    }
}

// Отклонение одной заявки
function rejectSingleWaiting(waitingId) {
    if (confirm('Отклонить эту заявку?')) {
        // Здесь можно добавить API для отклонения заявки
        alert('Функция отклонения заявки будет добавлена позже');
    }
}

// Функция для проверки осмысленности счета
function isMeaningfulScore(score1, score2, pointsToWin) {
    // Осмысленный счет: только если оба участника набрали очки для победы
    // И НЕ считаем осмысленным счет, если оба значения равны pointsToWin (значение по умолчанию)
    // И НЕ считаем осмысленным счет, если одно из значений равно 0 (начальное состояние)
    // И НЕ считаем осмысленным счет 0:0 (начальное состояние)
    // И НЕ считаем осмысленным счет, если разница меньше 2 (сет еще не завершен)
    const difference = Math.abs(score1 - score2);
    return (score1 >= pointsToWin && score2 >= pointsToWin && 
            !(score1 === pointsToWin && score2 === pointsToWin) &&
            !(score1 === 0 || score2 === 0) &&
            !(score1 === 0 && score2 === 0) &&
            difference >= 2);
}

// Функция для блокировки редактирования предыдущих сетов
function updateSetEditability() {
    const pointsToWin = {{ tournament.points_to_win }};
    console.log('updateSetEditability вызвана, pointsToWin:', pointsToWin);
    
    for (let i = 1; i <= 3; i++) {
        const score1Input = document.getElementById(`set${i}Score1`);
        const score2Input = document.getElementById(`set${i}Score2`);
        
        if (score1Input && score2Input) {
            const score1 = parseInt(score1Input.value) || 0;
            const score2 = parseInt(score2Input.value) || 0;
            
            console.log(`Сет ${i}: score1=${score1}, score2=${score2}`);
            
            // Проверяем, есть ли осмысленный счет в следующем сете
            let hasNextMeaningfulScore = false;
            if (i < 3) {
                const nextScore1 = parseInt(document.getElementById(`set${i+1}Score1`).value) || 0;
                const nextScore2 = parseInt(document.getElementById(`set${i+1}Score2`).value) || 0;
                hasNextMeaningfulScore = isMeaningfulScore(nextScore1, nextScore2, pointsToWin);
                console.log(`Следующий сет ${i+1}: score1=${nextScore1}, score2=${nextScore2}, isMeaningful=${hasNextMeaningfulScore}`);
            }
            
            // Блокируем редактирование, если есть осмысленный счет в следующем сете
            // НО НЕ блокируем, если текущий сет имеет значения по умолчанию
            // И НЕ блокируем третий сет, если он активно редактируется
            const isCurrentSetDefault = (score1 === pointsToWin && score2 === pointsToWin);
            const isThirdSet = (i === 3);
            const isThirdSetActive = isThirdSet && (score1 > 0 || score2 > 0);
            
            if (hasNextMeaningfulScore && !isCurrentSetDefault && !isThirdSetActive) {
                console.log(`Блокируем сет ${i} (есть осмысленный счет в следующем сете)`);
                score1Input.readOnly = true;
                score2Input.readOnly = true;
                score1Input.classList.add('bg-light');
                score2Input.classList.add('bg-light');
            } else {
                console.log(`Разблокируем сет ${i} (нет блокировки или значения по умолчанию или активный третий сет)`);
                score1Input.readOnly = false;
                score2Input.readOnly = false;
                score1Input.classList.remove('bg-light');
                score2Input.classList.remove('bg-light');
            }
        }
    }
}

// Обработка формы результата матча
document.addEventListener('DOMContentLoaded', function() {
    const matchResultForm = document.getElementById('matchResultForm');
    if (matchResultForm) {
        matchResultForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const matchId = document.getElementById('matchId').value;
            
            // Собираем данные сетов и рассчитываем результат
            const setsData = [];
            let setsWon1 = 0;
            let setsWon2 = 0;
            const pointsToWin = {{ tournament.points_to_win }};
            
            for (let i = 1; i <= 3; i++) {
                const score1 = parseInt(document.getElementById(`set${i}Score1`).value) || 0;
                const score2 = parseInt(document.getElementById(`set${i}Score2`).value) || 0;
                console.log(`Основная валидация: сет ${i}, score1=${score1}, score2=${score2}`);
                
                if (score1 > 0 || score2 > 0) {
                    // Проверяем валидность счета
                    const difference = Math.abs(score1 - score2);
                    
                    // Проверяем, можно ли ввести такой счет
                    if (score1 > pointsToWin || score2 > pointsToWin) {
                        const maxScore = Math.max(score1, score2);
                        const minScore = Math.min(score1, score2);
                        
                        console.log(`Проверяем счет: ${score1}:${score2}, pointsToWin: ${pointsToWin}, difference: ${difference}`);
                        
                        // Специальное правило: если оба участника набрали "очков для победы", то это равный счет (например, 11:11)
                        if (score1 === pointsToWin && score2 === pointsToWin) {
                            // Равный счет разрешен, но не будет отображаться в таблице
                            console.log(`Равный счет ${score1}:${score2} разрешен, но не будет отображаться в таблице`);
                        } else if ((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1))) {
                            // Специальное правило: если один участник набрал "очков для победы", а другой на 1 меньше, то сет продолжается (например, 11:10)
                            console.log(`Счет ${score1}:${score2} разрешен - сет продолжается (один участник набрал ${pointsToWin}, другой на 1 меньше)`);
                        } else if (((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) {
                            // Специальное правило: если оба участника набрали больше или равно "очков для победы" и разница = 1, то сет продолжается (например, 12:11)
                            console.log(`Счет ${score1}:${score2} разрешен - сет продолжается`);
                        } else if (minScore >= (pointsToWin - 1) && !(((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) && !((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1)))) {
                            // Если у проигравшего очков больше или равно ("очков для победы" - 1), то разница должна быть ровно 2
                            if (difference !== 2) {
                                // Автоматически исправляем счет - делаем разницу ровно 2
                                const correctMaxScore = minScore + 2;
                                const correctMinScore = minScore;
                                
                                alert(`Неверный счет! Если у проигравшего (${minScore}) очков больше или равно (${pointsToWin - 1}), то разница должна быть ровно 2 очка. Исправлено на ${correctMaxScore}:${correctMinScore}`);
                                
                                // Обновляем значения в форме
                                if (score1 > score2) {
                                    document.getElementById(`set${i}Score1`).value = correctMaxScore;
                                    document.getElementById(`set${i}Score2`).value = correctMinScore;
                                } else {
                                    document.getElementById(`set${i}Score1`).value = correctMinScore;
                                    document.getElementById(`set${i}Score2`).value = correctMaxScore;
                                }
                                
                                // Обновляем переменные для дальнейшей обработки
                                score1 = parseInt(document.getElementById(`set${i}Score1`).value);
                                score2 = parseInt(document.getElementById(`set${i}Score2`).value);
                                
                                // Пересчитываем разницу после исправления
                                difference = Math.abs(score1 - score2);
                            }
                        } else {
                            // Если у проигравшего очков меньше ("очков для победы" - 1), то максимальный счет должен быть равен "очков для победы"
                            if (maxScore > pointsToWin) {
                                const correctMaxScore = pointsToWin;
                                const correctMinScore = minScore;
                                
                                alert(`Неверный счет! Если у проигравшего (${minScore}) очков меньше (${pointsToWin - 1}), то максимальный счет победителя должен быть ${pointsToWin}. Исправлено на ${correctMaxScore}:${correctMinScore}`);
                                
                                // Обновляем значения в форме
                                if (score1 > score2) {
                                    document.getElementById(`set${i}Score1`).value = correctMaxScore;
                                    document.getElementById(`set${i}Score2`).value = correctMinScore;
                                } else {
                                    document.getElementById(`set${i}Score1`).value = correctMinScore;
                                    document.getElementById(`set${i}Score2`).value = correctMaxScore;
                                }
                                
                                // Обновляем переменные для дальнейшей обработки
                                score1 = parseInt(document.getElementById(`set${i}Score1`).value);
                                score2 = parseInt(document.getElementById(`set${i}Score2`).value);
                                
                                // Пересчитываем разницу после исправления
                                difference = Math.abs(score1 - score2);
                            }
                        }
                    }
                    
                    // Проверяем, завершен ли сет
                    // Сет завершен, если кто-то набрал необходимое количество очков И разница больше 1
                    // Равный счет (например, 11:11) не считается завершенным
                    // Счет с разницей 1 (например, 11:10, 12:11) не считается завершенным
                    const setCompleted = (score1 >= pointsToWin || score2 >= pointsToWin) && 
                                       difference > 1 && 
                                       !(score1 === pointsToWin && score2 === pointsToWin) &&
                                       !(((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) &&
                                       !((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1)));
                    
                    if (setCompleted) {
                        if (score1 > score2) {
                            setsWon1++;
                        } else {
                            setsWon2++;
                        }
                    }
                    
                    setsData.push({
                        set_number: i,
                        score1: score1,
                        score2: score2,
                        completed: setCompleted
                    });
                }
            }
            
            // Получаем ID участников из формы для правильного сопоставления
            const participant1Name = document.getElementById('participant1Name').value;
            const participant2Name = document.getElementById('participant2Name').value;
            
            // Получаем данные участников из турнира для определения их ID
            const participants = {{ participants_data|tojson }};
            console.log('Все участники:', participants);
            console.log('Ищем участника 1:', participant1Name);
            console.log('Ищем участника 2:', participant2Name);
            
            const p1 = participants.find(p => p.name === participant1Name);
            const p2 = participants.find(p => p.name === participant2Name);
            
            console.log('Найденный участник 1:', p1);
            console.log('Найденный участник 2:', p2);
            
            if (!p1 || !p2) {
                alert('Ошибка: не удалось найти участников');
                console.error('Не найдены участники:', {p1, p2, participant1Name, participant2Name});
                return;
            }
            
            // Если это новый матч (matchId пустой), создаем его
            if (!matchId) {
                const formData = {
                    tournament_id: {{ tournament.id }},
                    participant1_id: p1.id,
                    participant2_id: p2.id,
                    sets: setsData,
                    result: `${setsWon1}:${setsWon2}`,
                    sets_won_1: setsWon1,
                    sets_won_2: setsWon2
                };
                
                console.log('Создание нового матча:', formData);
                console.log('Данные сетов:', setsData);
                console.log('Результат:', `${setsWon1}:${setsWon2}`);
                
                return fetch('/api/matches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    console.log('Статус ответа:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Данные ответа:', data);
                    if (data.success) {
                        alert('Матч создан и результат сохранен!');
                        location.reload();
                    } else {
                        alert('Ошибка при создании матча: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при создании матча. Попробуйте еще раз.');
                });
            }
            
            // Определяем правильный порядок sets_won на основе ID участников в матче
            let sets_won_participant1, sets_won_participant2;
            if (p1 && p2) {
                // Получаем данные матча для определения participant1_id и participant2_id
                fetch(`/api/matches/${matchId}`, {
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                })
                .then(response => response.json())
                .then(matchData => {
                    if (matchData.success) {
                        const match = matchData.match;
                        
                        // Определяем правильный порядок sets_won
                        if (match.participant1_id === p1.id) {
                            // Участник 1 в форме = participant1 в матче
                            sets_won_participant1 = setsWon1;
                            sets_won_participant2 = setsWon2;
                        } else {
                            // Участник 1 в форме = participant2 в матче
                            sets_won_participant1 = setsWon2;
                            sets_won_participant2 = setsWon1;
                        }
                        
                        // Формируем результат матча в формате "2:1" или "2:0"
                        const matchResult = `${sets_won_participant1}:${sets_won_participant2}`;
                        
                        // Корректируем данные сетов для правильного сопоставления с базой данных
                        const correctedSetsData = setsData.map(setData => {
                            const correctedSet = { ...setData };
                            
                            // Если участник 1 в форме = participant2 в матче, меняем местами счет
                            if (match.participant1_id !== p1.id) {
                                const temp = correctedSet.score1;
                                correctedSet.score1 = correctedSet.score2;
                                correctedSet.score2 = temp;
                            }
                            
                            return correctedSet;
                        });
                        
                        const formData = {
                            sets: correctedSetsData,
                            result: matchResult,
                            sets_won_1: sets_won_participant1,
                            sets_won_2: sets_won_participant2
                        };
                        
                        console.log('Отправка данных:', formData);
                        console.log('Match ID:', matchId);
                        console.log('Participant1 ID:', match.participant1_id, 'Name:', participant1Name);
                        console.log('Participant2 ID:', match.participant2_id, 'Name:', participant2Name);
                        console.log('P1 ID from form:', p1.id);
                        console.log('P2 ID from form:', p2.id);
                        console.log('Sets data before correction:', setsData);
                        console.log('Corrected sets data:', correctedSetsData);
                        
                        // Отправляем данные
                        return fetch(`/api/matches/${matchId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        throw new Error('Ошибка получения данных матча');
                    }
                })
                .then(response => {
                    console.log('Статус ответа:', response.status);
                    console.log('Заголовки ответа:', response.headers);
                    return response.json();
                })
                .then(data => {
                    console.log('Данные ответа:', data);
                    if (data.success) {
                        // Результат матча сохранен
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка при сохранении результата:', error);
                    alert('Ошибка при сохранении результата: ' + error.message);
                });
            } else {
                alert('Ошибка: не удалось найти участников матча');
            }
        });
    }
});

// Функция удаления матча
function deleteMatch(matchId) {
    if (confirm('Вы уверены, что хотите удалить этот матч? Это действие нельзя отменить.')) {
        fetch(`/api/matches/${matchId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Матч успешно удален!');
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка при удалении матча: ' + error);
        });
    }
}

// Функция создания недостающих матчей
function createMissingMatches() {
    if (confirm('Создать все недостающие матчи для турнира? Это добавит матчи между участниками, которые еще не играли друг с другом.')) {
        fetch(`/api/tournaments/{{ tournament.id }}/create-missing-matches`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при создании матчей');
        });
    }
}

// Функция отладки турнирной таблицы
function debugChessboard() {
    fetch(`/api/tournaments/{{ tournament.id }}/debug-chessboard`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при создании отладочного файла');
    });
}

// Функция пересчета расписания
function rescheduleTournament() {
    if (confirm('Вы уверены, что хотите пересчитать расписание? Все существующие матчи будут удалены и созданы заново. Это действие нельзя отменить.')) {
        const csrfToken = getCSRFToken();
        console.log('Отправляем запрос с CSRF токеном:', csrfToken);
        
        fetch(`/api/tournaments/{{ tournament.id }}/reschedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Ошибка сервера: ' + response.status);
                });
            }
        })
        .then(data => {
            alert(data.message || 'Расписание успешно пересчитано!');
            location.reload();
        })
        .catch(error => {
            console.error('Ошибка при пересчете расписания:', error);
            alert('Ошибка при пересчете расписания: ' + error.message);
        });
    }
}

// Функция удаления участника
function deleteParticipant(participantId, participantName) {
    if (confirm(`Вы уверены, что хотите удалить участника "${participantName}"? Это действие нельзя отменить.`)) {
        fetch(`/api/tournaments/{{ tournament.id }}/participants/${participantId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            console.log('Статус ответа:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Данные ответа:', data);
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка при удалении участника:', error);
            alert('Ошибка при удалении участника: ' + error.message);
        });
    }
}

// Обработка формы регистрации пользователя
document.addEventListener('DOMContentLoaded', function() {
    const registerUserForm = document.getElementById('registerUserForm');
    if (registerUserForm) {
        registerUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }
            
            const formData = {
                username: document.getElementById('username').value,
                password: password
            };
            
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Участник успешно создан! Теперь вы можете войти в систему.');
                    bootstrap.Modal.getInstance(document.getElementById('registerUserModal')).hide();
                    // Перенаправляем на страницу входа
                    window.location.href = '/login';
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при регистрации: ' + error);
            });
        });
    }
});


function resetSetsForm() {
    console.log('Сброс формы сетов...');
    // Показываем все сеты сразу
    const set1 = document.getElementById('set1Container');
    const set2 = document.getElementById('set2Container');
    const set3 = document.getElementById('set3Container');
    
    if (set1) set1.style.display = 'block';
    if (set2) set2.style.display = 'block';
    if (set3) set3.style.display = 'block';
    
    console.log('Все сеты отображены');
    
    // Сбрасываем значения всех полей сетов
    const defaultScore = {{ tournament.points_to_win }};
    document.getElementById('set1Score1').value = defaultScore;
    document.getElementById('set1Score2').value = defaultScore;
    document.getElementById('set2Score1').value = defaultScore;
    document.getElementById('set2Score2').value = defaultScore;
    document.getElementById('set3Score1').value = '';
    document.getElementById('set3Score2').value = '';
    
    // Добавляем обработчики событий для полей сетов
    addSetEventListeners();
    
    // Принудительно разблокируем все поля при сбросе формы
    for (let i = 1; i <= 3; i++) {
        const score1Input = document.getElementById(`set${i}Score1`);
        const score2Input = document.getElementById(`set${i}Score2`);
        if (score1Input && score2Input) {
            score1Input.readOnly = false;
            score2Input.readOnly = false;
            score1Input.classList.remove('bg-light');
            score2Input.classList.remove('bg-light');
        }
    }
    
    // Обновляем блокировку редактирования при загрузке
    updateSetEditability();
}


function validateSetScore(setNumber) {
    console.log(`validateSetScore вызвана для сета ${setNumber}`);
    const score1 = parseInt(document.getElementById(`set${setNumber}Score1`).value) || 0;
    const score2 = parseInt(document.getElementById(`set${setNumber}Score2`).value) || 0;
    const pointsToWin = {{ tournament.points_to_win }};
    console.log(`validateSetScore: score1=${score1}, score2=${score2}, pointsToWin=${pointsToWin}`);
    
    if (score1 > 0 && score2 > 0) {
        const difference = Math.abs(score1 - score2);
        
        // Проверяем валидность счета
        if (score1 > pointsToWin || score2 > pointsToWin) {
            const maxScore = Math.max(score1, score2);
            const minScore = Math.min(score1, score2);
            
            // Специальное правило: если оба участника набрали "очков для победы", то это равный счет (например, 11:11)
            if (score1 === pointsToWin && score2 === pointsToWin) {
                // Равный счет разрешен, но не будет отображаться в таблице
                console.log(`Равный счет ${score1}:${score2} разрешен, но не будет отображаться в таблице`);
                return;
            } else if ((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1))) {
                // Специальное правило: если один участник набрал "очков для победы", а другой на 1 меньше, то сет продолжается (например, 11:10)
                console.log(`Счет ${score1}:${score2} разрешен - сет продолжается (один участник набрал ${pointsToWin}, другой на 1 меньше)`);
                return;
            } else if (((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) {
                // Специальное правило: если оба участника набрали больше или равно "очков для победы" и разница = 1, то сет продолжается (например, 12:11)
                console.log(`Счет ${score1}:${score2} разрешен - сет продолжается`);
                return;
            } else if (minScore >= (pointsToWin - 1) && !(((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) && !((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1)))) {
                // Если у проигравшего очков больше или равно "очков для победы", то разница должна быть ровно 2
                if (difference !== 2) {
                    alert(`Неверный счет! Если у проигравшего (${minScore}) очков больше или равно "очков для победы" (${pointsToWin}), то разница должна быть ровно 2 очка.`);
                    return;
                }
            } else {
                // Если у проигравшего очков меньше "очков для победы", то максимальный счет должен быть равен "очков для победы"
                // НО только если разница очков >= 2 (сет завершен)
                if (maxScore > pointsToWin && difference >= 2) {
                    const correctMaxScore = pointsToWin;
                    const correctMinScore = minScore;
                    
                    if (score1 > score2) {
                        document.getElementById(`set${setNumber}Score1`).value = correctMaxScore;
                        document.getElementById(`set${setNumber}Score2`).value = correctMinScore;
                    } else {
                        document.getElementById(`set${setNumber}Score1`).value = correctMinScore;
                        document.getElementById(`set${setNumber}Score2`).value = correctMaxScore;
                    }
                    
                    alert(`Неверный счет! Если у проигравшего (${minScore}) очков меньше "очков для победы" (${pointsToWin}), то максимальный счет победителя должен быть ${pointsToWin}. Исправлено на ${correctMaxScore}:${correctMinScore}`);
                } else if (maxScore > pointsToWin && difference < 2) {
                    // Если разница меньше 2, то сет еще не завершен, разрешаем ввод
                    console.log(`Сет ${setNumber}: счет ${score1}:${score2} - сет продолжается (разница ${difference} < 2)`);
                }
            }
        }
    }
}

function addSetEventListeners() {
    // Обработчики для сета 1
    document.getElementById('set1Score1').addEventListener('input', function() {
        checkSetCompletion(1);
        updateSetsWon(); // Обновляем статус 3-го сета
        updateSetEditability(); // Обновляем блокировку редактирования
    });
    document.getElementById('set1Score2').addEventListener('input', function() {
        checkSetCompletion(1);
        updateSetsWon(); // Обновляем статус 3-го сета
        updateSetEditability(); // Обновляем блокировку редактирования
    });
    
    // Обработчики для сета 2
    document.getElementById('set2Score1').addEventListener('input', function() {
        checkSetCompletion(2);
        updateSetsWon(); // Обновляем статус 3-го сета
        updateSetEditability(); // Обновляем блокировку редактирования
    });
    document.getElementById('set2Score2').addEventListener('input', function() {
        checkSetCompletion(2);
        updateSetsWon(); // Обновляем статус 3-го сета
        updateSetEditability(); // Обновляем блокировку редактирования
    });
    
    // Обработчики для сета 3
    document.getElementById('set3Score1').addEventListener('input', function() {
        checkSetCompletion(3);
    });
    document.getElementById('set3Score2').addEventListener('input', function() {
        checkSetCompletion(3);
    });
}


function checkSetCompletion(setNumber) {
    console.log(`Проверка завершения сета ${setNumber}...`);
    const score1 = parseInt(document.getElementById(`set${setNumber}Score1`).value) || 0;
    const score2 = parseInt(document.getElementById(`set${setNumber}Score2`).value) || 0;
    const pointsToWin = {{ tournament.points_to_win }};
    
    console.log(`Счет сета ${setNumber}: ${score1}-${score2}, нужно: ${pointsToWin}`);
    
    // Проверяем, что оба участника набрали очки
    if (score1 > 0 && score2 > 0) {
        // Определяем победителя сета
        const difference = Math.abs(score1 - score2);
        const setCompleted = difference >= 2 && (score1 >= pointsToWin || score2 >= pointsToWin);
        
        if (setCompleted) {
            const winner = score1 > score2 ? 1 : 2;
            console.log(`Сет ${setNumber} завершен! Победитель: Участник ${winner}`);
            
            // Подсчитываем выигранные сеты
            updateSetsWon();
            
            // Проверяем, нужно ли заблокировать третий сет
            // Третий сет всегда доступен
        } else if (difference < 2 && (score1 >= pointsToWin || score2 >= pointsToWin)) {
            console.log(`Сет ${setNumber}: недостаточная разница очков (${difference} < 2)`);
        }
    }
}

function checkThirdSetLock() {
    // Третий сет всегда доступен для редактирования
    const set3Container = document.getElementById('set3Container');
    const set3Score1 = document.getElementById('set3Score1');
    const set3Score2 = document.getElementById('set3Score2');
    
    if (set3Container && set3Score1 && set3Score2) {
        set3Container.style.opacity = '1';
        set3Score1.disabled = false;
        set3Score2.disabled = false;
    }
}

function updateSetsWon() {
    console.log('updateSetsWon вызвана');
    let setsWon1 = 0;
    let setsWon2 = 0;
    
    // Подсчитываем выигранные сеты для каждого участника
    for (let i = 1; i <= 3; i++) {
        const container = document.getElementById(`set${i}Container`);
        if (container.style.display !== 'none') {
            const score1 = parseInt(document.getElementById(`set${i}Score1`).value) || 0;
            const score2 = parseInt(document.getElementById(`set${i}Score2`).value) || 0;
            const pointsToWin = {{ tournament.points_to_win }};
            
            if (score1 > 0 && score2 > 0) {
                const difference = Math.abs(score1 - score2);
                console.log(`updateSetsWon: Сет ${i}, счет ${score1}:${score2}, difference: ${difference}`);
                
                // Проверяем валидность счета
                if (score1 > pointsToWin || score2 > pointsToWin) {
                    const maxScore = Math.max(score1, score2);
                    const minScore = Math.min(score1, score2);
                    
                    console.log(`updateSetsWon: Проверка условий для ${score1}:${score2}`);
                    console.log(`updateSetsWon: score1 > pointsToWin: ${score1 > pointsToWin}, score2 > pointsToWin: ${score2 > pointsToWin}, difference === 1: ${difference === 1}`);
                    
                    // Специальное правило: если оба участника набрали "очков для победы", то это равный счет (например, 11:11)
                    if (score1 === pointsToWin && score2 === pointsToWin) {
                        // Равный счет разрешен, но не будет отображаться в таблице
                        console.log(`Равный счет ${score1}:${score2} разрешен, но не будет отображаться в таблице`);
                    } else if ((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1))) {
                        // Специальное правило: если один участник набрал "очков для победы", а другой на 1 меньше, то сет продолжается (например, 11:10)
                        console.log(`updateSetsWon: Счет ${score1}:${score2} разрешен - сет продолжается (один участник набрал ${pointsToWin}, другой на 1 меньше)`);
                    } else if (((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) {
                        // Специальное правило: если оба участника набрали больше или равно "очков для победы" и разница = 1, то сет продолжается (например, 12:11)
                        console.log(`updateSetsWon: Счет ${score1}:${score2} разрешен - сет продолжается`);
                    } else if (minScore >= (pointsToWin - 1) && !(((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) && !((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1)))) {
                        // Если у проигравшего очков больше или равно ("очков для победы" - 1), то разница должна быть ровно 2
                        if (difference !== 2) {
                            console.warn(`updateSetsWon: Неверный счет! Если у проигравшего (${minScore}) очков больше или равно (${pointsToWin - 1}), то разница должна быть ровно 2 очка.`);
                            // НЕ возвращаемся - продолжаем обработку
                        }
                    } else {
                        // Если у проигравшего очков меньше "очков для победы", то максимальный счет должен быть равен "очков для победы"
                        if (maxScore > pointsToWin) {
                            console.warn(`Неверный счет! Если у проигравшего (${minScore}) очков меньше "очков для победы" (${pointsToWin}), то максимальный счет победителя должен быть ${pointsToWin}.`);
                            return;
                        }
                    }
                }
                
                // Сет завершен, если кто-то набрал необходимое количество очков И разница больше 1
                // Исключаем случаи 11:10, 12:11, 11:11
                // И проверяем, что у проигравшего достаточно очков для валидного завершения
                const loserScore = Math.min(score1, score2);
                const winnerScore = Math.max(score1, score2);
                const isValidScore = loserScore >= (pointsToWin - 1) || (winnerScore <= pointsToWin && loserScore >= (pointsToWin - 2));
                
                const setCompleted = (score1 >= pointsToWin || score2 >= pointsToWin) && 
                                   difference >= 2 && 
                                   isValidScore &&
                                   !(score1 === pointsToWin && score2 === pointsToWin) &&
                                   !(((score1 > pointsToWin && score2 >= pointsToWin) || (score2 > pointsToWin && score1 >= pointsToWin)) && difference === 1) &&
                                   !((score1 === pointsToWin && score2 === (pointsToWin - 1)) || (score2 === pointsToWin && score1 === (pointsToWin - 1)));
                
                if (setCompleted) {
                    if (score1 > score2) {
                        setsWon1++;
                    } else {
                        setsWon2++;
                    }
                }
            }
        }
    }
    
    console.log(`Сеты выиграны: Участник 1 - ${setsWon1}, Участник 2 - ${setsWon2}`);
    
    // Определяем победителя матча (нужно выиграть 2 сета)
    const setsToWin = {{ tournament.sets_to_win }};
    let matchWinner = null;
    let matchCompleted = false;
    
    if (setsWon1 >= setsToWin) {
        matchWinner = 1;
        matchCompleted = true;
        console.log('Победитель матча: Участник 1');
    } else if (setsWon2 >= setsToWin) {
        matchWinner = 2;
        matchCompleted = true;
        console.log('Победитель матча: Участник 2');
    }
    
    // Обновляем отображение
    updateSetsDisplay(setsWon1, setsWon2, matchWinner, matchCompleted);
    
    // Если матч завершен, предлагаем сохранить результат
    if (matchCompleted) {
        showMatchCompletionPrompt(matchWinner);
    }
}

function updateSetsDisplay(setsWon1, setsWon2, matchWinner, matchCompleted = false) {
    // Обновляем информационную панель с количеством выигранных сетов
    const infoElement = document.querySelector('.mb-3 small');
    if (infoElement) {
        const originalText = `Сетов для победы: <strong>{{ tournament.sets_to_win }}</strong> | Очков для победы в сете: <strong>{{ tournament.points_to_win }}</strong>`;
        let setsInfo = ` | Выиграно сетов: <strong>${setsWon1}:${setsWon2}</strong>`;
        
        if (matchWinner) {
            setsInfo += ` | <span class="text-success">Победитель: Участник ${matchWinner}</span>`;
        }
        
        infoElement.innerHTML = originalText + setsInfo;
    }
    
    // Третий сет всегда отображается
    const set3Container = document.getElementById('set3Container');
    if (set3Container) {
        set3Container.style.display = 'block';
        
        // Блокируем 3-й сет если:
        // 1. Матч завершен (кто-то выиграл 2 сета)
        // 2. Первые два сета не завершены
        const set3Score1 = document.getElementById('set3Score1');
        const set3Score2 = document.getElementById('set3Score2');
        
        if (set3Score1 && set3Score2) {
            // Проверяем, завершены ли первые два сета
            const set1Completed = isSetCompleted(1);
            const set2Completed = isSetCompleted(2);
            const firstTwoSetsCompleted = set1Completed && set2Completed;
            
            // Блокируем если матч завершен ИЛИ первые два сета не завершены
            const shouldBlockSet3 = matchCompleted || !firstTwoSetsCompleted;
            
            if (shouldBlockSet3) {
                set3Score1.disabled = true;
                set3Score2.disabled = true;
                set3Score1.style.backgroundColor = '#f8f9fa';
                set3Score2.style.backgroundColor = '#f8f9fa';
                
                if (matchCompleted) {
                    set3Score1.title = 'Матч завершен - редактирование заблокировано';
                    set3Score2.title = 'Матч завершен - редактирование заблокировано';
                } else {
                    set3Score1.title = 'Сначала завершите первые два сета';
                    set3Score2.title = 'Сначала завершите первые два сета';
                }
            } else {
                // Разблокируем 3-й сет только если первые два завершены и матч не завершен
                set3Score1.disabled = false;
                set3Score2.disabled = false;
                set3Score1.style.backgroundColor = '';
                set3Score2.style.backgroundColor = '';
                set3Score1.title = '';
                set3Score2.title = '';
            }
        }
    }
}

// Функция для проверки завершения сета
function isSetCompleted(setNumber) {
    const score1 = parseInt(document.getElementById(`set${setNumber}Score1`).value) || 0;
    const score2 = parseInt(document.getElementById(`set${setNumber}Score2`).value) || 0;
    const pointsToWin = {{ tournament.points_to_win }};
    
    if (score1 > 0 && score2 > 0) {
        const difference = Math.abs(score1 - score2);
        // Сет завершен, если кто-то набрал необходимое количество очков И разница больше 1
        return (score1 >= pointsToWin || score2 >= pointsToWin) && difference > 1;
    }
    
    return false;
}

// Функция для показа предложения сохранить результат при завершении матча
function showMatchCompletionPrompt(winner) {
    // Проверяем, не показывали ли уже это предложение для текущего матча
    const currentMatchId = document.getElementById('matchResultModal').getAttribute('data-match-id');
    const promptKey = `match_completion_prompt_${currentMatchId}`;
    
    if (sessionStorage.getItem(promptKey)) {
        return; // Уже показывали предложение для этого матча
    }
    
    // Получаем имена участников
    const participant1Name = document.getElementById('participant1Name').value;
    const participant2Name = document.getElementById('participant2Name').value;
    const winnerName = winner === 1 ? participant1Name : participant2Name;
    
    // Показываем предложение сохранить результат
    const saveResult = confirm(
        `Матч завершен! Победитель: ${winnerName}\n\n` +
        `Хотите сохранить результат матча сейчас?\n\n` +
        `Нажмите "OK" для сохранения или "Отмена" чтобы продолжить редактирование.`
    );
    
    if (saveResult) {
        // Автоматически сохраняем результат
        document.getElementById('matchResultForm').dispatchEvent(new Event('submit'));
    }
    
    // Помечаем, что предложение уже показывали
    sessionStorage.setItem(promptKey, 'true');
}

// Функция для сброса флага предложения при открытии модального окна
function resetMatchCompletionPrompt() {
    const currentMatchId = document.getElementById('matchResultModal').getAttribute('data-match-id');
    if (currentMatchId) {
        const promptKey = `match_completion_prompt_${currentMatchId}`;
        sessionStorage.removeItem(promptKey);
    }
}


// Принудительное обновление кэша
console.log('Версия формы: 3.7 - Полная логика сетов с отображением в таблице и расписании');
console.log('Проверка элементов формы:');
console.log('set1Container:', document.getElementById('set1Container') ? 'найден' : 'НЕ НАЙДЕН');
console.log('set2Container:', document.getElementById('set2Container') ? 'найден' : 'НЕ НАЙДЕН');
console.log('set3Container:', document.getElementById('set3Container') ? 'найден' : 'НЕ НАЙДЕН');

// Функция для получения CSRF токена

// Функция для составления расписания
function generateSchedule() {
    if (confirm('Это действие УДАЛИТ результаты прошедших матчей. Составить новое расписание для турнира?')) {
        const csrfToken = getCSRFToken();
        
        fetch(`/api/tournaments/{{ tournament.id }}/generate-schedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Расписание успешно составлено!');
                location.reload(); // Перезагружаем страницу для отображения новых матчей
            } else {
                alert('Ошибка при составлении расписания: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при составлении расписания. Попробуйте еще раз.');
        });
    }
}

// Функция для выгрузки турнира в Excel
function exportTournament() {
    if (confirm('Отправить данные турнира на email администратора в формате Excel?')) {
        const csrfToken = getCSRFToken();
        
        fetch(`/api/tournaments/{{ tournament.id }}/export`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Данные турнира успешно отправлены на email администратора!');
            } else {
                alert('Ошибка при выгрузке: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при выгрузке. Попробуйте еще раз.');
        });
    }
}

// Функция для добавления опоздавшего участника
function addLateParticipant() {
    const name = document.getElementById('lateParticipantName').value.trim();
    
    if (!name) {
        alert('Пожалуйста, введите имя участника');
        return;
    }
    
    if (confirm(`Добавить опоздавшего участника "${name}" в турнир?\n\nРезультаты прошедших матчей будут сохранены.`)) {
        const csrfToken = getCSRFToken();
        
        // Показываем индикатор загрузки
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Добавление...';
        button.disabled = true;
        
        fetch(`/api/tournaments/{{ tournament.id }}/add-late-participant`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                name: name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Участник "${name}" успешно добавлен в турнир!\nРезультаты матчей сохранены.`);
                location.reload(); // Перезагружаем страницу для отображения нового участника
            } else {
                alert('Ошибка при добавлении участника: ' + (data.error || 'Неизвестная ошибка'));
                // Восстанавливаем кнопку
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при добавлении участника. Попробуйте еще раз.');
            // Восстанавливаем кнопку
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Функции для работы со списком игроков
let allPlayers = [];
let selectedPlayers = new Set();

// Загрузка списка игроков
async function loadPlayers() {
    try {
        console.log('Загружаем список игроков...');
        const response = await fetch('/api/players');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Получены данные игроков:', data);
        
        if (data.success) {
            allPlayers = data.players;
            console.log('Найдено игроков:', allPlayers.length);
            displayPlayers(allPlayers);
        } else {
            console.error('Ошибка загрузки списка игроков:', data.error);
            showPlayersMessage('Ошибка загрузки списка игроков: ' + data.error);
        }
    } catch (error) {
        console.error('Ошибка при загрузке списка игроков:', error);
        showPlayersMessage('Ошибка при загрузке списка игроков: ' + error.message);
    }
}

// Отображение списка игроков
function displayPlayers(players) {
    console.log('Отображаем игроков:', players);
    const tbody = document.getElementById('playersListTableBody');
    const noMessage = document.getElementById('noPlayersMessage');
    
    if (!tbody) {
        console.error('Элемент playersListTableBody не найден');
        return;
    }
    
    if (players.length === 0) {
        console.log('Список игроков пуст');
        tbody.innerHTML = '';
        noMessage.style.display = 'block';
        return;
    }
    
    console.log(`Отображаем ${players.length} игроков`);
    noMessage.style.display = 'none';
    tbody.innerHTML = '';
    
    players.forEach(player => {
        const row = document.createElement('tr');
        const isSelected = selectedPlayers.has(player.id);
        
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input player-checkbox" 
                       value="${player.id}" ${isSelected ? 'checked' : ''}>
            </td>
            <td>${player.name}</td>
            <td>${player.last_used_at ? new Date(player.last_used_at).toLocaleDateString('ru-RU') : 'Никогда'}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-primary add-single-player" 
                        data-player-id="${player.id}" data-player-name="${player.name}">
                    <i class="fas fa-plus"></i> Добавить
                </button>
            </td>
        `;
        
        // Добавляем обработчик события для чекбокса
        const checkbox = row.querySelector('.player-checkbox');
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedPlayers.add(parseInt(this.value));
            } else {
                selectedPlayers.delete(parseInt(this.value));
            }
            updateAddButtonState();
        });
        
        tbody.appendChild(row);
    });
    
    updateAddButtonState();
}

// Показать сообщение о пустом списке
function showPlayersMessage(message) {
    const tbody = document.getElementById('playersListTableBody');
    const noMessage = document.getElementById('noPlayersMessage');
    
    tbody.innerHTML = '';
    noMessage.innerHTML = `<i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>${message}</p>`;
    noMessage.style.display = 'block';
}

// Поиск игроков
async function searchPlayers(query) {
    if (!query.trim()) {
        displayPlayers(allPlayers);
        return;
    }
    
    try {
        console.log('Поиск игроков по запросу:', query);
        const response = await fetch(`/api/players/search?q=${encodeURIComponent(query)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Результаты поиска:', data);
        
        if (data.success) {
            displayPlayers(data.players);
        } else {
            console.error('Ошибка поиска игроков:', data.error);
        }
    } catch (error) {
        console.error('Ошибка при поиске игроков:', error);
        // При ошибке поиска показываем всех игроков
        displayPlayers(allPlayers);
    }
}

// Обновление состояния кнопки добавления
function updateAddButtonState() {
    const addBtn = document.getElementById('addSelectedPlayersBtn');
    const selectedCount = document.getElementById('selectedCount');
    
    addBtn.disabled = selectedPlayers.size === 0;
    
    if (selectedCount) {
        selectedCount.textContent = selectedPlayers.size;
    }
}

// Добавление выбранных игроков
async function addSelectedPlayers() {
    if (selectedPlayers.size === 0) return;
    
    console.log('=== НАЧАЛО ДОБАВЛЕНИЯ ВЫБРАННЫХ ИГРОКОВ ===');
    console.log('Выбранные игроки (ID):', Array.from(selectedPlayers));
    console.log('Все игроки:', allPlayers);
    
    const addBtn = document.getElementById('addSelectedPlayersBtn');
    const originalText = addBtn.innerHTML;
    
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Добавление...';
    addBtn.disabled = true;
    
    try {
        const results = [];
        const errors = [];
        
        // Обрабатываем каждого игрока отдельно
        for (const playerId of selectedPlayers) {
            console.log(`Обрабатываем игрока с ID: ${playerId}`);
            const player = allPlayers.find(p => p.id === playerId);
            console.log('Найденный игрок:', player);
            
            if (player) {
                try {
                    console.log(`Пытаемся добавить игрока "${player.name}"...`);
                    await addPlayerToTournament(player.name);
                    results.push({ player: player.name, success: true });
                    console.log(`✅ Игрок "${player.name}" успешно добавлен`);
                } catch (error) {
                    console.error(`❌ Ошибка при добавлении игрока "${player.name}":`, error);
                    errors.push({ player: player.name, error: error.message });
                }
            } else {
                console.error(`❌ Игрок с ID ${playerId} не найден в списке allPlayers`);
                errors.push({ player: `ID:${playerId}`, error: 'Игрок не найден в списке' });
            }
        }
        
        console.log('Результаты добавления:', results);
        console.log('Ошибки:', errors);
        
        // Очищаем выбор только если хотя бы один игрок был добавлен
        if (results.length > 0) {
            selectedPlayers.clear();
            document.querySelectorAll('.player-checkbox').forEach(cb => cb.checked = false);
            updateAddButtonState();
            console.log('Выбор очищен');
        }
        
        // Показываем соответствующие уведомления
        if (results.length > 0 && errors.length === 0) {
            showNotification(`Все ${results.length} игроков успешно добавлены в турнир!`, 'success');
        } else if (results.length > 0 && errors.length > 0) {
            showNotification(`Добавлено ${results.length} игроков. ${errors.length} игроков уже участвуют в турнире.`, 'warning');
        } else if (errors.length > 0) {
            showNotification('Все выбранные игроки уже участвуют в турнире', 'warning');
        }
        
        console.log('=== КОНЕЦ ДОБАВЛЕНИЯ ВЫБРАННЫХ ИГРОКОВ ===');
        
        // Перезагружаем страницу только если хотя бы один игрок был добавлен
        if (results.length > 0) {
            console.log('🔄 Перезагружаем страницу для обновления списка участников...');
            setTimeout(() => {
                location.reload();
            }, 1000); // Небольшая задержка для показа уведомления
        }
        
    } catch (error) {
        console.error('Критическая ошибка при добавлении игроков:', error);
        showNotification('Ошибка при добавлении игроков', 'error');
    } finally {
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
    }
}

// Добавление одного игрока
async function addSinglePlayer(playerId, playerName) {
    const addBtn = event.target;
    const originalText = addBtn.innerHTML;
    
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    addBtn.disabled = true;
    
    try {
        await addPlayerToTournament(playerName);
        showNotification(`Игрок "${playerName}" добавлен в турнир!`, 'success');
    } catch (error) {
        console.error('Ошибка при добавлении игрока:', error);
        
        // Показываем соответствующее сообщение об ошибке
        if (error.message && error.message.includes('уже участвует в турнире')) {
            showNotification('Игрок уже участвует в турнире', 'warning');
        } else {
            showNotification('Ошибка при добавлении игрока', 'error');
        }
    } finally {
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
    }
}

// Очистка выбора
function clearPlayerSelection() {
    selectedPlayers.clear();
    document.querySelectorAll('.player-checkbox').forEach(cb => cb.checked = false);
    updateAddButtonState();
}

// Показать уведомление
function showNotification(message, type = 'info') {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Добавляем на страницу
    document.body.appendChild(notification);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Добавление игрока в турнир
async function addPlayerToTournament(playerName) {
    console.log(`🔄 Начинаем добавление игрока "${playerName}" в турнир {{ tournament.id }}`);
    
    try {
        const csrfToken = getCSRFToken();
        console.log('CSRF Token для добавления игрока:', csrfToken);
        console.log('Добавляем игрока:', playerName, 'в турнир: {{ tournament.id }}');
        
        const response = await fetch('/api/tournaments/{{ tournament.id }}/participants', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                name: playerName,
                is_team: false
            })
        });
        
        console.log(`📡 Ответ сервера для "${playerName}":`, response.status, response.statusText);
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error(`❌ Ошибка сервера для "${playerName}":`, errorData);
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`✅ Данные ответа для "${playerName}":`, data);
        
        if (data.success) {
            console.log(`🎉 Игрок "${playerName}" успешно добавлен!`);
            return data; // Возвращаем данные вместо перезагрузки страницы
        } else {
            console.error(`❌ Неуспешный ответ для "${playerName}":`, data);
            throw new Error(data.error || 'Неизвестная ошибка');
        }
        
    } catch (error) {
        console.error(`💥 Ошибка при добавлении игрока "${playerName}" в турнир:`, error);
        
        // Проверяем, является ли ошибка о том, что участник уже существует
        if (error.message && error.message.includes('уже существует в турнире')) {
            throw new Error('Игрок уже участвует в турнире');
        }
        
        throw error;
    }
}

// Обработчики событий для вкладки игроков
document.addEventListener('DOMContentLoaded', function() {
    // Функция для управления видимостью кнопок в модальном окне
    function toggleAddButton() {
        const playersTab = document.getElementById('players-tab');
        const waitingTab = document.getElementById('waiting-tab');
        const addButton = document.querySelector('#addParticipantModal .modal-footer .btn-primary');
        const addSelectedWaitingBtn = document.getElementById('addSelectedWaitingBtn');
        
        // Управление основной кнопкой "Добавить"
        if (addButton) {
            if ((playersTab && playersTab.classList.contains('active')) || 
                (waitingTab && waitingTab.classList.contains('active'))) {
                addButton.style.display = 'none';
            } else {
                addButton.style.display = 'inline-block';
            }
        }
        
        // Управление кнопкой "Принять выбранных" из вкладки "Лист ожидания"
        if (addSelectedWaitingBtn) {
            if (waitingTab && waitingTab.classList.contains('active')) {
                addSelectedWaitingBtn.style.display = 'inline-block';
            } else {
                addSelectedWaitingBtn.style.display = 'none';
            }
        }
    }
    
    // Обработчики для переключения вкладок
    const tabButtons = document.querySelectorAll('#addParticipantTabs button[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function() {
            toggleAddButton();
        });
    });
    
    // Инициализация при загрузке
    toggleAddButton();
    
    // Обработчик для открытия модального окна
    const addParticipantModal = document.getElementById('addParticipantModal');
    if (addParticipantModal) {
        addParticipantModal.addEventListener('shown.bs.modal', function() {
            toggleAddButton();
        });
    }
    
    // Обработчик поиска
    const searchInput = document.getElementById('playerSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchPlayers(this.value);
            }, 300);
        });
    }
    
    // Обработчик выбора всех игроков
    const selectAllCheckbox = document.getElementById('selectAllPlayers');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.player-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
                if (this.checked) {
                    selectedPlayers.add(parseInt(cb.value));
                } else {
                    selectedPlayers.delete(parseInt(cb.value));
                }
            });
            updateAddButtonState();
        });
    }
    
    // Обработчик добавления выбранных игроков
    const addSelectedBtn = document.getElementById('addSelectedPlayersBtn');
    if (addSelectedBtn) {
        addSelectedBtn.addEventListener('click', addSelectedPlayers);
    }
    
    // Обработчик очистки выбора
    const clearBtn = document.getElementById('clearPlayerSelectionBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', clearPlayerSelection);
    }
    
    // Обработчик клика по вкладке игроков
    const playersTab = document.getElementById('players-tab');
    if (playersTab) {
        playersTab.addEventListener('click', function() {
            console.log('Клик по вкладке игроков');
            loadPlayers();
        });
    } else {
        console.error('Элемент players-tab не найден');
    }
    
    // Обработчики для чекбоксов игроков
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('player-checkbox')) {
            const playerId = parseInt(e.target.value);
            if (e.target.checked) {
                selectedPlayers.add(playerId);
            } else {
                selectedPlayers.delete(playerId);
            }
            updateAddButtonState();
        }
    });
    
    // Обработчики для кнопок добавления одного игрока
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-single-player') || e.target.closest('.add-single-player')) {
            const button = e.target.closest('.add-single-player');
            const playerId = parseInt(button.dataset.playerId);
            const playerName = button.dataset.playerName;
            addSinglePlayer(playerId, playerName);
        }
    });
});
</script>
    </div>
</div>
{% endblock %}
