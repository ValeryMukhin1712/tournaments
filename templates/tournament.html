{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Турнирная система v2.1{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Турниры</a></li>
                <li class="breadcrumb-item active">{{ tournament.name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">{{ tournament.name }} <small class="text-muted">v2.1</small></h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-table-tennis me-1"></i>{{ tournament.sport_type }} • 
                    <i class="fas fa-calendar me-1"></i>{{ tournament.start_date.strftime('%d.%m.%Y') }} - {{ tournament.end_date.strftime('%d.%m.%Y') }}
                </p>
            </div>
            <div class="d-flex gap-2">

                                 {% if current_user.is_authenticated %}
                     {% if current_user.role in ['администратор', 'доверенный_участник'] %}
                     <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addParticipantModal">
                         <i class="fas fa-user-plus me-2"></i>Добавить участника
                     </button>
                     {% endif %}
                     {% if current_user.role == 'администратор' %}
                     {% if has_missing_matches %}
                     <button class="btn btn-info me-2" onclick="createMissingMatches()">
                         <i class="fas fa-plus-circle me-2"></i>Создать недостающие матчи
                     </button>
                     {% endif %}
                     <button class="btn btn-secondary me-2" onclick="debugChessboard()">
                         <i class="fas fa-bug me-2"></i>Отладка таблицы
                     </button>
                     <button class="btn btn-warning" onclick="rescheduleTournament()">
                         <i class="fas fa-sync-alt me-2"></i>Пересчитать расписание
                     </button>
                     {% endif %}
                 {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Статистика участников -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Статистика участников</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                                                 <thead>
                             <tr>
                                 <th>Место</th>
                                 <th>Участник</th>
                                 <th>Игр</th>
                                 <th>Побед</th>
                                 <th>Ничьих</th>
                                 <th>Поражений</th>
                                 <th>Очки</th>
                                 <th>Разница мячей</th>
                                 <th>Действия</th>
                             </tr>
                         </thead>
                        <tbody>
                            {% for participant in participants %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ participant.name }}</strong>
                                    {% if participant.is_team %}
                                        <span class="badge bg-info ms-2">Команда</span>
                                    {% endif %}
                                </td>
                                                                 <td>{{ statistics[participant.id]['games'] }}</td>
                                 <td>{{ statistics[participant.id]['wins'] }}</td>
                                 <td>{{ statistics[participant.id]['draws'] }}</td>
                                 <td>{{ statistics[participant.id]['losses'] }}</td>
                                 <td>{{ statistics[participant.id]['points'] }}</td>
                                 <td>{{ statistics[participant.id]['goal_difference'] }}</td>
                                <td>
                                    {% if current_user.is_authenticated and current_user.role in ['администратор', 'доверенный_участник'] %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteParticipant({{ participant.id }}, '{{ participant.name }}')" title="Удалить участника">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Турнирная таблица -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Турнирная таблица</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th class="bg-light">Участник</th>
                                <th class="text-center bg-light">Очки</th>
                                <th class="text-center bg-light">Место</th>
                                {% for participant in participants %}
                                <th class="text-center bg-light">{{ participant.name[:15] }}{% if participant.name|length > 15 %}...{% endif %}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for p1_data in participants_with_stats %}
                            {% set p1 = p1_data.participant %}
                            {% set p1_stats = p1_data.stats %}
                            {% set p1_position = p1_data.position %}
                            <tr>
                                <td class="bg-light fw-bold">{{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}</td>
                                <td class="text-center bg-light fw-bold text-primary">{{ p1_stats.points }}</td>
                                <td class="text-center bg-light fw-bold text-success">{{ p1_position }}</td>
                                {% for p2 in participants %}
                                <td class="text-center position-relative" style="height: 80px; width: 120px; vertical-align: middle;">
                                    {% if p1.id == p2.id %}
                                        <span class="text-muted">—</span>
                                    {% else %}
                                        {% set cell_data = chessboard[p1.id][p2.id] %}
                                        {% if cell_data.type == 'result' %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="badge bg-success mb-1">{{ cell_data.value }}</span>
                                                {% if cell_data.editable %}
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        onclick="openMatchResultModal({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')"
                                                        title="Редактировать результат">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        {% elif cell_data.type == 'upcoming' %}
                                              {% set court_colors = {
                                                  1: 'primary',
                                                  2: 'info', 
                                                  3: 'success',
                                                  4: 'warning',
                                                  5: 'danger',
                                                  6: 'secondary',
                                                  7: 'dark',
                                                  8: 'light'
                                              } %}
                                              {% set court_color = court_colors.get(cell_data.court, 'secondary') %}
                                              
                                              <div class="text-center position-relative">
                                                  <!-- Основной контейнер с цветом площадки -->
                                                  <div class="{% if cell_data.is_next %}border border-warning border-1 rounded p-1 bg-warning bg-opacity-15 shadow-sm{% elif cell_data.is_second %}border border-success border-1 rounded p-1 bg-success bg-opacity-15 shadow-sm{% else %}border border-{{ court_color }} border-1 rounded p-1 bg-{{ court_color }} bg-opacity-10{% endif %}" style="height: 70px; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                                      <!-- Верхняя часть -->
                                                      <div>
                                                          <!-- Номер корта крупным полупрозрачным шрифтом -->
                                                          <div class="text-center mb-1">
                                                              <span style="font-size: 1.5rem; font-weight: bold; opacity: 0.3; color: {{ court_color }};">{{ cell_data.court }}</span>
                                                          </div>
                                                      </div>
                                                      
                                                      <!-- Время матча - внизу -->
                                                      <div class="mt-auto">
                                                          <small class="d-block text-dark fw-bold text-center" style="font-size: 0.6rem; background-color: rgba(255, 255, 255, 0.95); padding: 1px 3px; border-radius: 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ cell_data.date.strftime('%d.%m') }} {{ cell_data.time.strftime('%H:%M') }}</small>
                                                      </div>
                                                  </div>
                                                  
                                                  <!-- Дополнительные индикаторы для ближайших матчей -->
                                                  {% if cell_data.is_next %}
                                                      <div class="position-absolute top-0 start-0 translate-middle">
                                                          <span class="badge bg-warning text-dark rounded-pill" style="font-size: 0.6rem; padding: 2px 6px;">1</span>
                                                      </div>
                                                  {% elif cell_data.is_second %}
                                                      <div class="position-absolute top-0 start-0 translate-middle">
                                                          <span class="badge bg-success text-white rounded-pill" style="font-size: 0.6rem; padding: 2px 6px;">2</span>
                                                      </div>
                                                  {% endif %}
                                              </div>
                                        {% elif cell_data.type == 'empty' %}
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="openMatchResultModal({{ cell_data.match_id }}, '{{ p1.name }}', '{{ p2.name }}')"
                                                    style="min-width: 60px;">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Расписание матчей -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Расписание матчей</h5>
            </div>
            <div class="card-body">
                {% if schedule_display %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">№</th>
                                    <th style="width: 100px;">Время</th>
                                    <th style="width: 80px;">Площадка</th>
                                    <th>Участники</th>
                                    <th style="width: 100px;">Счет</th>
                                    <th style="width: 120px;">Статус</th>
                                    <th style="width: 80px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date_str, day_data in schedule_display.items() %}
                                <tr class="table-info">
                                    <td colspan="7" class="fw-bold text-center py-2">
                                        <i class="fas fa-calendar-day me-2"></i>{{ day_data.date_display }}
                                    </td>
                                </tr>
                                {% for match in day_data.matches %}
                                <tr>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ match.global_number }}</span>
                                    </td>
                                    <td class="fw-bold text-primary">{{ match.time }}</td>
                                    <td class="text-center">
                                        {% if match.court > 0 %}
                                            {% set court_colors = {
                                                1: 'primary',
                                                2: 'info', 
                                                3: 'success',
                                                4: 'warning',
                                                5: 'danger',
                                                6: 'secondary',
                                                7: 'dark',
                                                8: 'light'
                                            } %}
                                            {% set court_color = court_colors.get(match.court, 'secondary') %}
                                            <span class="badge bg-{{ court_color }}">
                                                Пл. {{ match.court }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ match.participant1 }}</strong> vs <strong>{{ match.participant2 }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {% if match.score %}
                                            <span class="badge bg-success">{{ match.score }}</span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if match.status == 'завершен' %}bg-success
                                            {% elif match.status == 'в процессе' %}bg-warning
                                            {% elif match.status == 'запланирован' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ match.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if match.status == 'запланирован' or match.status == 'в процессе' %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="openMatchResultModal({{ match.id }}, '{{ match.participant1 }}', '{{ match.participant2 }}', 0, 0)"
                                                title="Редактировать матч">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="mb-0">Расписание матчей пока не составлено</p>
                        <small>Нажмите "Пересчитать расписание" для создания расписания</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Модальное окно для ввода результата матча -->
<div class="modal fade" id="matchResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Результат</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" form="matchResultForm" class="btn btn-primary btn-sm">Сохранить</button>
                </div>
            </div>
            <div class="modal-body">
                <form id="matchResultForm">
                    <input type="hidden" id="matchId" name="match_id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Участник 1</label>
                            <input type="text" class="form-control" id="participant1Name" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Участник 2</label>
                            <input type="text" class="form-control" id="participant2Name" readonly>
                        </div>
                    </div>
                    
                    <!-- Сет 1 -->
                    <div class="mb-3" id="set1Container">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">Сет 1</span>
                            <small class="text-muted">Очки для победы: {{ tournament.points_to_win }}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set1Score1" name="set1_score1" min="0" max="{{ tournament.points_to_win }}" value="{{ tournament.points_to_win }}">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set1Score2" name="set1_score2" min="0" max="{{ tournament.points_to_win }}" value="{{ tournament.points_to_win }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Сет 2 -->
                    <div class="mb-3" id="set2Container" style="display: none;">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-info me-2">Сет 2</span>
                            <small class="text-muted">Очки для победы: {{ tournament.points_to_win }}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set2Score1" name="set2_score1" min="0" max="{{ tournament.points_to_win }}" value="{{ tournament.points_to_win }}">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set2Score2" name="set2_score2" min="0" max="{{ tournament.points_to_win }}" value="{{ tournament.points_to_win }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Сет 3 -->
                    <div class="mb-3" id="set3Container" style="display: none;">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-warning me-2">Сет 3</span>
                            <small class="text-muted">Очки для победы: {{ tournament.points_to_win }}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set3Score1" name="set3_score1" min="0" max="{{ tournament.points_to_win }}" value="{{ tournament.points_to_win }}">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control set-score" id="set3Score2" name="set3_score2" min="0" max="{{ tournament.points_to_win }}" value="{{ tournament.points_to_win }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Сетов для победы: <strong>{{ tournament.sets_to_win }}</strong> | Очков для победы в сете: <strong>{{ tournament.points_to_win }}</strong>
                        </small>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления участника -->
{% if current_user.is_authenticated and current_user.role in ['администратор', 'доверенный_участник'] %}
<div class="modal fade" id="addParticipantModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить участника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Вкладки для разных способов добавления -->
                <ul class="nav nav-tabs" id="addParticipantTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                            <i class="fas fa-edit me-2"></i>Ручной ввод
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Из списка пользователей
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="addParticipantTabContent">
                    <!-- Вкладка ручного ввода -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel">
                        <form id="addParticipantForm">
                            <div class="mb-3">
                                <label for="participantName" class="form-label">Имя участника или название команды</label>
                                <input type="text" class="form-control" id="participantName" required>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isTeam">
                                    <label class="form-check-label" for="isTeam">
                                        Это команда
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Вкладка выбора из списка пользователей -->
                    <div class="tab-pane fade" id="users" role="tabpanel">
                        <div class="mb-3">
                            <label for="userSearch" class="form-label">Поиск пользователей</label>
                            <input type="text" class="form-control" id="userSearch" placeholder="Введите имя пользователя для поиска...">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isTeamFromUser">
                                <label class="form-check-label" for="isTeamFromUser">
                                    Добавлять как команду
                                </label>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-hover" id="usersTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Выбрать</th>
                                        <th>Имя пользователя</th>
                                        <th>Роль</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="noUsersMessage" class="text-center text-muted py-3" style="display: none;">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <p>Пользователи не найдены</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" id="addSelectedUsersBtn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-plus me-2"></i>Добавить выбранных
                </button>
                <button type="submit" form="addParticipantForm" class="btn btn-primary">Добавить</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно регистрации пользователя -->
<div class="modal fade" id="registerUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Регистрация нового пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Имя пользователя</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="registerUserForm" class="btn btn-primary">Зарегистрироваться</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Добавляем обработчики кликов на все ячейки шахматки
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.table-bordered');
    if (table) {
        table.addEventListener('click', function(e) {
            const cell = e.target.closest('td');
            if (cell && !cell.querySelector('button')) {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const cellIndex = cell.cellIndex;
                
                if (rowIndex > 0 && cellIndex > 2) { // Пропускаем заголовки и столбцы "Очки" и "Место"
                    const participants = {{ participants_data|tojson }};
                    const p1 = participants[rowIndex - 1];
                    const p2 = participants[cellIndex - 3]; // Учитываем сдвиг на 2 столбца (Очки и Место)
                    
                    if (p1 && p2 && p1.id !== p2.id) {
                        openMatchModal(p1.id, p2.id, p1.name, p2.name);
                    }
                }
            }
        });
    }
});

function openMatchResultModal(matchId, p1Name, p2Name) {
    console.log('Открытие формы результата матча:', p1Name, 'vs', p2Name);
    
    // Заполняем форму
    document.getElementById('matchId').value = matchId;
    document.getElementById('participant1Name').value = p1Name;
    document.getElementById('participant2Name').value = p2Name;
    
    // Сброс формы сетов
    resetSetsForm();
    
    // Получаем данные матча
    fetch(`/api/matches/${matchId}`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Заполняем сеты данными из матча
                const defaultScore = {{ tournament.points_to_win }};
                
                // Если есть существующие результаты, заполняем их
                if (data.match.score1 !== null && data.match.score2 !== null) {
                    document.getElementById('set1Score1').value = data.match.score1;
                    document.getElementById('set1Score2').value = data.match.score2;
                } else {
                    // Иначе используем значения по умолчанию
                    document.getElementById('set1Score1').value = defaultScore;
                    document.getElementById('set1Score2').value = defaultScore;
                }
                
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке данных матча:', error);
            // В случае ошибки используем значения по умолчанию
            const defaultScore = {{ tournament.points_to_win }};
            document.getElementById('set1Score1').value = defaultScore;
            document.getElementById('set1Score2').value = defaultScore;
        });
    
    new bootstrap.Modal(document.getElementById('matchResultModal')).show();
}


function editMatch(matchId) {
    // Редактирование матча из расписания
    // Получаем данные матча для отображения имен участников
    fetch(`/api/matches/${matchId}`, {
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Находим участников по ID
                const participants = {{ participants_data|tojson }};
                const p1 = participants.find(p => p.id === data.match.participant1_id);
                const p2 = participants.find(p => p.id === data.match.participant2_id);
                
                if (p1 && p2) {
                    openMatchResultModal(matchId, p1.name, p2.name);
                } else {
                    openMatchResultModal(matchId, 'Участник 1', 'Участник 2');
                }
            }
        })
        .catch(error => {
            openMatchResultModal(matchId, 'Участник 1', 'Участник 2');
        });
}


// Обработка формы добавления участника
document.addEventListener('DOMContentLoaded', function() {
    const addParticipantForm = document.getElementById('addParticipantForm');
    if (addParticipantForm) {
        addParticipantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('participantName').value,
                is_team: document.getElementById('isTeam').checked
            };
            
            fetch('/api/tournaments/{{ tournament.id }}/participants', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Участник добавлен!');
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при добавлении участника: ' + error);
            });
        });
    }
    
    // Инициализация функциональности добавления пользователей из списка
    initializeUserSelection();
});

// Функция инициализации выбора пользователей
function initializeUserSelection() {
    const usersTab = document.getElementById('users-tab');
    const userSearch = document.getElementById('userSearch');
    const addSelectedUsersBtn = document.getElementById('addSelectedUsersBtn');
    
    if (usersTab) {
        // Загружаем пользователей при переключении на вкладку
        usersTab.addEventListener('click', function() {
            loadUsers();
        });
        
        // Поиск пользователей
        if (userSearch) {
            userSearch.addEventListener('input', function() {
                filterUsers(this.value);
            });
        }
        
        // Добавление выбранных пользователей
        if (addSelectedUsersBtn) {
            addSelectedUsersBtn.addEventListener('click', function() {
                addSelectedUsers();
            });
        }
    }
}

// Загрузка списка пользователей
function loadUsers() {
        fetch('/api/users?tournament_id={{ tournament.id }}', {
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Ошибка сервера: ' + response.status);
            }
        })
        .then(data => {
            displayUsers(data);
        })
        .catch(error => {
            console.error('Ошибка при загрузке пользователей:', error);
            alert('Ошибка при загрузке пользователей: ' + error.message);
        });
}

// Отображение пользователей в таблице
function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    const noUsersMessage = document.getElementById('noUsersMessage');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (users.length === 0) {
        noUsersMessage.style.display = 'block';
        return;
    }
    
    noUsersMessage.style.display = 'none';
    
    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}" data-username="${user.username}">
            </td>
            <td>${user.username}</td>
            <td><span class="badge bg-secondary">${user.role}</span></td>
        `;
        tbody.appendChild(row);
    });
    
    // Добавляем обработчики для чекбоксов
    const checkboxes = tbody.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAddButton);
    });
}

// Фильтрация пользователей
function filterUsers(searchTerm) {
    const rows = document.getElementById('usersTableBody').querySelectorAll('tr');
    const noUsersMessage = document.getElementById('noUsersMessage');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        if (username.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    noUsersMessage.style.display = visibleCount === 0 ? 'block' : 'none';
}

// Обновление кнопки добавления
function updateAddButton() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const addSelectedUsersBtn = document.getElementById('addSelectedUsersBtn');
    
    if (addSelectedUsersBtn) {
        if (checkboxes.length > 0) {
            addSelectedUsersBtn.style.display = 'inline-block';
            addSelectedUsersBtn.textContent = `Добавить выбранных (${checkboxes.length})`;
        } else {
            addSelectedUsersBtn.style.display = 'none';
        }
    }
}

// Добавление выбранных пользователей
function addSelectedUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const isTeam = document.getElementById('isTeamFromUser').checked;
    
    if (checkboxes.length === 0) {
        alert('Выберите хотя бы одного пользователя');
        return;
    }
    
    const selectedUsers = Array.from(checkboxes).map(checkbox => ({
        id: checkbox.value,
        username: checkbox.dataset.username
    }));
    
    // Добавляем пользователей параллельно
    const promises = selectedUsers.map(user => {
        const formData = {
            user_id: user.id,
            name: user.username,
            is_team: isTeam
        };
        
        return fetch('/api/tournaments/{{ tournament.id }}/participants', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Ошибка сервера: ' + response.status);
                });
            }
        })
        .then(data => {
            return { success: true, user: user.username };
        })
        .catch(error => {
            console.error(`Ошибка добавления ${user.username}:`, error);
            return { success: false, user: user.username, error: error.message };
        });
    });
    
    // Ждем завершения всех запросов
    Promise.all(promises).then(results => {
        const addedCount = results.filter(r => r.success).length;
        const errorCount = results.filter(r => !r.success).length;
        const errors = results.filter(r => !r.success);
        
        let message = '';
        if (addedCount > 0) {
            message += `Успешно добавлено: ${addedCount} пользователей. `;
        }
        if (errorCount > 0) {
            message += `Ошибок: ${errorCount}. `;
            // Показываем детали ошибок
            const duplicateErrors = errors.filter(e => e.error && e.error.includes('уже существует'));
            const userExistsErrors = errors.filter(e => e.error && e.error.includes('уже участвует'));
            
            if (duplicateErrors.length > 0) {
                message += `Дубликаты: ${duplicateErrors.map(e => e.user).join(', ')}. `;
            }
            if (userExistsErrors.length > 0) {
                message += `Уже в турнире: ${userExistsErrors.map(e => e.user).join(', ')}. `;
            }
        }
        
        if (message) {
            alert(message);
        }
        
        if (addedCount > 0) {
            location.reload();
        }
    });
}

// Обработка формы результата матча
document.addEventListener('DOMContentLoaded', function() {
    const matchResultForm = document.getElementById('matchResultForm');
    if (matchResultForm) {
        matchResultForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const matchId = document.getElementById('matchId').value;
            
            // Собираем данные сетов
            const setsData = [];
            for (let i = 1; i <= 3; i++) {
                const container = document.getElementById(`set${i}Container`);
                if (container.style.display !== 'none') {
                    const score1 = parseInt(document.getElementById(`set${i}Score1`).value) || 0;
                    const score2 = parseInt(document.getElementById(`set${i}Score2`).value) || 0;
                    
                    if (score1 > 0 || score2 > 0) {
                        setsData.push({
                            set_number: i,
                            score1: score1,
                            score2: score2
                        });
                    }
                }
            }
            
            const formData = {
                sets: setsData
            };
            
            console.log('Отправка данных:', formData);
            console.log('Match ID:', matchId);
            
            fetch(`/api/matches/${matchId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Статус ответа:', response.status);
                console.log('Заголовки ответа:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Данные ответа:', data);
                if (data.success) {
                    alert('Результат матча сохранен!');
                    location.reload();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении результата:', error);
                alert('Ошибка при сохранении результата: ' + error.message);
            });
        });
    }
});

// Функция удаления матча
function deleteMatch(matchId) {
    if (confirm('Вы уверены, что хотите удалить этот матч? Это действие нельзя отменить.')) {
        fetch(`/api/matches/${matchId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Матч успешно удален!');
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка при удалении матча: ' + error);
        });
    }
}

// Функция создания недостающих матчей
function createMissingMatches() {
    if (confirm('Создать все недостающие матчи для турнира? Это добавит матчи между участниками, которые еще не играли друг с другом.')) {
        fetch(`/api/tournaments/{{ tournament.id }}/create-missing-matches`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при создании матчей');
        });
    }
}

// Функция отладки турнирной таблицы
function debugChessboard() {
    fetch(`/api/tournaments/{{ tournament.id }}/debug-chessboard`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при создании отладочного файла');
    });
}

// Функция пересчета расписания
function rescheduleTournament() {
    if (confirm('Вы уверены, что хотите пересчитать расписание? Все существующие матчи будут удалены и созданы заново. Это действие нельзя отменить.')) {
        fetch(`/api/tournaments/{{ tournament.id }}/reschedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Ошибка сервера: ' + response.status);
                });
            }
        })
        .then(data => {
            alert(data.message || 'Расписание успешно пересчитано!');
            location.reload();
        })
        .catch(error => {
            console.error('Ошибка при пересчете расписания:', error);
            alert('Ошибка при пересчете расписания: ' + error.message);
        });
    }
}

// Функция удаления участника
function deleteParticipant(participantId, participantName) {
    if (confirm(`Вы уверены, что хотите удалить участника "${participantName}"? Это действие нельзя отменить.`)) {
        fetch(`/api/tournaments/{{ tournament.id }}/participants/${participantId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Ошибка сервера: ' + response.status);
            }
        })
        .then(data => {
            alert('Участник успешно удален!');
            location.reload();
        })
        .catch(error => {
            console.error('Ошибка при удалении участника:', error);
            alert('Ошибка при удалении участника: ' + error.message);
        });
    }
}

// Обработка формы регистрации пользователя
document.addEventListener('DOMContentLoaded', function() {
    const registerUserForm = document.getElementById('registerUserForm');
    if (registerUserForm) {
        registerUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }
            
            const formData = {
                username: document.getElementById('username').value,
                password: password
            };
            
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Пользователь успешно создан! Теперь вы можете войти в систему.');
                    bootstrap.Modal.getInstance(document.getElementById('registerUserModal')).hide();
                    // Перенаправляем на страницу входа
                    window.location.href = '/login';
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка при регистрации: ' + error);
            });
        });
    }
});


function resetSetsForm() {
    console.log('Сброс формы сетов...');
    // Скрываем все сеты кроме первого
    const set1 = document.getElementById('set1Container');
    const set2 = document.getElementById('set2Container');
    const set3 = document.getElementById('set3Container');
    
    if (set1) set1.style.display = 'block';
    if (set2) set2.style.display = 'none';
    if (set3) set3.style.display = 'none';
    
    console.log('set1Container отображен:', set1 ? 'да' : 'НЕ НАЙДЕН');
    console.log('set2Container скрыт:', set2 ? 'да' : 'НЕ НАЙДЕН');
    console.log('set3Container скрыт:', set3 ? 'да' : 'НЕ НАЙДЕН');
    
    // Сбрасываем значения всех полей сетов
    const defaultScore = {{ tournament.points_to_win }};
    for (let i = 1; i <= 3; i++) {
        document.getElementById(`set${i}Score1`).value = defaultScore;
        document.getElementById(`set${i}Score2`).value = defaultScore;
    }
    
    // Добавляем обработчики событий для полей сетов
    addSetEventListeners();
}


function addSetEventListeners() {
    // Обработчики для сета 1
    document.getElementById('set1Score1').addEventListener('input', function() {
        checkSetCompletion(1);
    });
    document.getElementById('set1Score2').addEventListener('input', function() {
        checkSetCompletion(1);
    });
    
    // Обработчики для сета 2
    document.getElementById('set2Score1').addEventListener('input', function() {
        checkSetCompletion(2);
    });
    document.getElementById('set2Score2').addEventListener('input', function() {
        checkSetCompletion(2);
    });
    
    // Обработчики для сета 3
    document.getElementById('set3Score1').addEventListener('input', function() {
        checkSetCompletion(3);
    });
    document.getElementById('set3Score2').addEventListener('input', function() {
        checkSetCompletion(3);
    });
}


function checkSetCompletion(setNumber) {
    console.log(`Проверка завершения сета ${setNumber}...`);
    const score1 = parseInt(document.getElementById(`set${setNumber}Score1`).value) || 0;
    const score2 = parseInt(document.getElementById(`set${setNumber}Score2`).value) || 0;
    const pointsToWin = {{ tournament.points_to_win }};
    
    console.log(`Счет сета ${setNumber}: ${score1}-${score2}, нужно: ${pointsToWin}`);
    
    // Проверяем, завершен ли сет (один из участников набрал нужное количество очков)
    const setCompleted = (score1 >= pointsToWin || score2 >= pointsToWin) && 
                        (score1 !== score2) && 
                        (score1 > 0 && score2 > 0);
    
    if (setCompleted && setNumber < 3) {
        // Показываем следующий сет
        const nextSet = setNumber + 1;
        const nextContainer = document.getElementById(`set${nextSet}Container`);
        if (nextContainer) {
            nextContainer.style.display = 'block';
            console.log(`Показан сет ${nextSet}`);
        } else {
            console.error(`Сет ${nextSet} не найден!`);
        }
    }
}


// Принудительное обновление кэша
console.log('Версия формы: 3.3 - Минималистичная форма только с сетами');
console.log('Проверка элементов формы:');
console.log('set1Container:', document.getElementById('set1Container') ? 'найден' : 'НЕ НАЙДЕН');
console.log('set2Container:', document.getElementById('set2Container') ? 'найден' : 'НЕ НАЙДЕН');
console.log('set3Container:', document.getElementById('set3Container') ? 'найден' : 'НЕ НАЙДЕН');
</script>
{% endblock %}
