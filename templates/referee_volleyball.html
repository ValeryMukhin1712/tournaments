<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Судейство волейбола</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .referee-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .referee-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 900px;
            width: 100%;
            text-align: center;
        }
        
        .volleyball-court {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid #dc3545;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            position: relative;
        }
        
        .court-center-line {
            display: none;
        }
        
        .court-net {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 60px;
            background: #dc3545;
            border-radius: 2px;
        }
        
        .team-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
/* Переключение сторон команд */
.team-section.swapped { flex-direction: row-reverse; }
        
        .team-info {
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            margin: 0 10px;
        }
        /* Красная команда (A) */
        .team-info.team-a { background: rgba(220, 53, 69, 0.1); }
        .team-info.team-a .team-name { color: #dc3545; }
        .team-info.team-a .score-display { color: #dc3545; }
        /* Синяя команда (B) */
        .team-info.team-b { background: rgba(0, 123, 255, 0.1); }
        .team-info.team-b .team-name { color: #007bff; }
        .team-info.team-b .score-display { color: #007bff; }
        
        .team-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .score-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .set-scores {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .set-score {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 50px;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn-volleyball {
            background: #dc3545;
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-volleyball:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .btn-volleyball-blue {
            background: #0d6efd;
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-volleyball-blue:hover {
            background: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
        }
        
        .btn-secondary-volleyball {
            background: #6c757d;
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .btn-secondary-volleyball:hover {
            background: #5a6268;
        }
        
        .match-info {
            background: rgba(220, 53, 69, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .match-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .current-set {
            font-size: 1.2rem;
            color: #666;
        }
        
        .serve-indicator {
            position: absolute;
            top: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            animation: pulse 2s infinite;
        }
        /* Позиции индикатора подачи */
        .serve-indicator.pos-left { left: 20px; right: auto; }
        .serve-indicator.pos-right { right: 20px; left: auto; }
        
        .serve-indicator.team-a {
            background: #dc3545;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .serve-indicator.team-b {
            background: #007bff;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            text-decoration: none;
        }
        
        @media (max-width: 768px) {
            .team-section {
                flex-direction: column;
                gap: 20px;
            }
            
            .team-info {
                margin: 0;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-volleyball, .btn-secondary-volleyball {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <a href="/referee" class="back-button">
        <i class="fas fa-arrow-left me-2"></i>Назад
    </a>
    
    <div class="referee-container">
        <div class="referee-card">
            <div class="match-info">
                <h1 class="match-title">
                    <i class="fas fa-volleyball-ball me-3"></i>Судейство волейбола
                </h1>
                <div class="current-set">Сет 1 из 3</div>
                <div class="serve-indicator team-a pos-left" id="serveIndicator">
                    <i class="fas fa-volleyball-ball me-2"></i>Подача: Команда А
                </div>
            </div>
            
            <div class="volleyball-court">
                <div class="court-center-line"></div>
                <div class="court-net"></div>
                
                <div class="team-section">
                    <div class="team-info team-a">
                        <div class="team-name">Команда А</div>
                        <div class="score-display" id="teamAScore">0</div>
                    </div>
                    
                    <div class="team-info team-b">
                        <div class="team-name">Команда Б</div>
                        <div class="score-display" id="teamBScore">0</div>
                    </div>
                </div>
                
                <div class="set-scores">
                    <div class="set-score">Сет 1: 0-0</div>
                    <div class="set-score">Сет 2: 0-0</div>
                    <div class="set-score">Сет 3: 0-0</div>
                </div>
            </div>
            
            <div class="control-buttons" id="controlButtonsContainer">
                <button class="btn btn-volleyball" id="btnPointA" onclick="addPoint('A')">
                    <i class="fas fa-plus me-2"></i>Очко команде А
                </button>
                <button class="btn btn-volleyball-blue" id="btnPointB" onclick="addPoint('B')">
                    <i class="fas fa-plus me-2"></i>Очко команде Б
                </button>
                <button class="btn btn-secondary-volleyball" onclick="undoLastPoint()">
                    <i class="fas fa-undo me-2"></i>Отменить
                </button>
                <button class="btn btn-secondary-volleyball" onclick="resetMatch()">
                    <i class="fas fa-refresh me-2"></i>Сброс
                </button>
                <button class="btn btn-secondary-volleyball" onclick="swapTeamsSides()">
                    <i class="fas fa-exchange-alt me-2"></i>Поменять стороны команд
                </button>
                <button class="btn btn-secondary-volleyball" onclick="swapServe()">
                    <i class="fas fa-retweet me-2"></i>Поменять подающую сторону
                </button>
                <button class="btn btn-success" onclick="saveToTournament()" id="btnSaveToTournament" style="display: none; font-weight: bold; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);">
                    <i class="fas fa-trophy me-2"></i>🏆 Сохранить в турнир
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSet = 1;
        let teamAScore = 0;
        let teamBScore = 0;
        let setScores = [[0, 0], [0, 0], [0, 0]];
        let gameHistory = [];
        let servingTeam = 'A'; // Команда, которая подает
        let sidesSwapped = false; // Флаг обмена сторон
        
        function addPoint(team) {
            if (team === 'A') {
                teamAScore++;
            } else {
                teamBScore++;
            }
            
            console.log('[Volleyball] addPoint(): команда', team, ', новый счет:', teamAScore, ':', teamBScore);
            
            // Команда, которая выиграла очко, получает право подачи
            servingTeam = team;
            
            gameHistory.push({
                team: team,
                set: currentSet,
                score: [teamAScore, teamBScore]
            });
            
            updateDisplay();
            checkSetEnd();
        }
        
        function updateDisplay() {
            document.getElementById('teamAScore').textContent = teamAScore;
            document.getElementById('teamBScore').textContent = teamBScore;
            
            // Обновляем счет сетов
            setScores[currentSet - 1] = [teamAScore, teamBScore];
            updateSetScores();
            
            // Обновляем указатель подачи
            updateServeIndicator();
        }
        
        function updateServeIndicator() {
            const indicator = document.getElementById('serveIndicator');
            const nameA = window.team1Name || 'Команда А';
            const nameB = window.team2Name || 'Команда Б';
            if (servingTeam === 'A') {
                indicator.className = 'serve-indicator team-a ' + (sidesSwapped ? 'pos-right' : 'pos-left');
                indicator.innerHTML = '<i class="fas fa-volleyball-ball me-2"></i>Подача: ' + nameA;
            } else {
                indicator.className = 'serve-indicator team-b ' + (sidesSwapped ? 'pos-left' : 'pos-right');
                indicator.innerHTML = '<i class="fas fa-volleyball-ball me-2"></i>Подача: ' + nameB;
            }
        }

        // Обмен сторон команд (лево/право)
        function swapTeamsSides() {
            const section = document.querySelector('.team-section');
            if (section) {
                sidesSwapped = !sidesSwapped;
                section.classList.toggle('swapped', sidesSwapped);
                updateServeIndicator();
                
                // Меняем кнопки местами при смене сторон
                swapPointButtons();
            }
        }
        
        // Функция для смены кнопок добавления очков местами
        function swapPointButtons() {
            const container = document.getElementById('controlButtonsContainer');
            const btnA = document.getElementById('btnPointA');
            const btnB = document.getElementById('btnPointB');
            
            if (container && btnA && btnB) {
                // Если стороны поменяны, меняем порядок кнопок
                if (sidesSwapped) {
                    // Кнопка B становится первой
                    container.insertBefore(btnB, btnA);
                } else {
                    // Кнопка A становится первой
                    container.insertBefore(btnA, btnB);
                }
            }
        }

        // Обмен подающей стороны между командами
        function swapServe() {
            servingTeam = (servingTeam === 'A') ? 'B' : 'A';
            updateServeIndicator();
        }
        
        function updateSetScores() {
            const setElements = document.querySelectorAll('.set-score');
            setElements.forEach((element, index) => {
                if (index < setScores.length) {
                    element.textContent = `Сет ${index + 1}: ${setScores[index][0]}-${setScores[index][1]}`;
                }
            });
        }
        
        function checkSetEnd() {
            const maxScore = 25;
            const minAdvantage = 2;
            
            if (teamAScore >= maxScore || teamBScore >= maxScore) {
                if (Math.abs(teamAScore - teamBScore) >= minAdvantage) {
                    endSet();
                }
            }
        }
        
        function endSet() {
            setScores[currentSet - 1] = [teamAScore, teamBScore];
            
            // Проверяем, закончен ли матч
            const setsWonA = setScores.filter(score => score[0] > score[1]).length;
            const setsWonB = setScores.filter(score => score[1] > score[0]).length;
            
            if (setsWonA >= 2 || setsWonB >= 2) {
                const nameA = window.team1Name || 'Команда А';
                const nameB = window.team2Name || 'Команда Б';
                alert(`Матч завершен! Победитель: ${setsWonA >= 2 ? nameA : nameB}`);
                return;
            }
            
            // Переходим к следующему сету
            currentSet++;
            teamAScore = 0;
            teamBScore = 0;
            
            document.querySelector('.current-set').textContent = `Сет ${currentSet} из 3`;
            updateDisplay();
        }
        
        function undoLastPoint() {
            if (gameHistory.length > 0) {
                const lastAction = gameHistory.pop();
                if (lastAction.team === 'A') {
                    teamAScore--;
                } else {
                    teamBScore--;
                }
                
                // Восстанавливаем указатель подачи на основе предыдущего действия
                if (gameHistory.length > 0) {
                    const previousAction = gameHistory[gameHistory.length - 1];
                    servingTeam = previousAction.team;
                } else {
                    // Если это первое действие, команда А подает
                    servingTeam = 'A';
                }
                
                updateDisplay();
            }
        }
        
        function resetMatch() {
            if (confirm('Вы уверены, что хотите сбросить матч?')) {
                currentSet = 1;
                teamAScore = 0;
                teamBScore = 0;
                setScores = [[0, 0], [0, 0], [0, 0]];
                gameHistory = [];
                servingTeam = 'A'; // Сбрасываем подачу на команду А
                document.querySelector('.current-set').textContent = 'Сет 1 из 3';
                updateDisplay();
            }
        }
        
        function saveToTournament() {
            if (!window.matchId) {
                alert('ID матча не найден. Убедитесь, что вы открыли страницу судейства из турнирной таблицы.');
                return;
            }
            
            // Формируем данные для сохранения
            const sets = [];
            const defaultScore = 25; // волейбол: значение "по умолчанию" для неинициализированного счёта
            
            // Фиксируем текущий прогресс в массиве setScores перед сбором
            setScores[currentSet - 1] = [teamAScore, teamBScore];
            console.log('[Volleyball] saveToTournament(): текущий счет сета', currentSet, ':', teamAScore, ':', teamBScore);
            console.log('[Volleyball] saveToTournament(): массив setScores:', JSON.stringify(setScores));
            
            for (let i = 0; i < setScores.length; i++) {
                const [s1, s2] = setScores[i];
                console.log('[Volleyball] saveToTournament(): проверяем сет', (i+1), ':', s1, ':', s2);
                // Пропускаем неигранные сеты и защиту от 25:25 (маркер по умолчанию)
                if ((s1 === 0 && s2 === 0) || (s1 === defaultScore && s2 === defaultScore)) {
                    console.log('[Volleyball] saveToTournament(): сет', (i+1), 'пропущен (0:0 или 25:25)');
                    continue;
                }
                console.log('[Volleyball] saveToTournament(): сет', (i+1), 'добавлен в отправку');
                sets.push({
                    set_number: i + 1,
                    score1: s1,
                    score2: s2,
                    completed: true
                });
            }
            
            const resultData = {
                sets: sets,
                matchId: window.matchId
            };
            
            console.log('[Volleyball] saveToTournament(): отправляем данные', resultData);
            
            // Отправляем запрос на сохранение
            fetch(`/api/matches/${window.matchId}/save-referee-result`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify(resultData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Результат успешно сохранен в турнир!');
                    // НЕ отправляем postMessage родителю, так как результат уже сохранен через API
                    // Автоотправка формы в родителе может перезаписать корректный результат
                    console.log('[Volleyball] ✅ Результат сохранен на сервере, пропускаем postMessage');
                    
                    // Закрываем окно судейства и обновляем родительскую страницу
                    try { 
                        if (window.opener && !window.opener.closed) {
                            console.log('[Volleyball] Обновляем страницу турнира');
                            window.opener.location.reload();
                        } else if (window.parent && window.parent !== window) {
                            console.log('[Volleyball] Обновляем родительскую страницу');
                            window.parent.location.reload();
                        }
                        window.close(); 
                    } catch(_) {}
                } else {
                    alert('Ошибка при сохранении: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('[Volleyball] Ошибка при сохранении в турнир:', error);
                alert('Ошибка при сохранении результата в турнир');
            });
        }
        
        // Инициализация
        updateDisplay();
        
        // Показываем кнопку сохранения в турнир
        function showSaveButton() {
            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get('match_id');
            const team1Name = urlParams.get('team1_name');
            const team2Name = urlParams.get('team2_name');
            const setParam = urlParams.get('set');
            const s1Param = urlParams.get('score1');
            const s2Param = urlParams.get('score2');
            console.log('[Volleyball] URL параметры:', window.location.search);
            console.log('[Volleyball] matchId из URL:', matchId);
            console.log('[Volleyball] Команда 1:', team1Name);
            console.log('[Volleyball] Команда 2:', team2Name);
            console.log('[Volleyball] Параметры счёта:', s1Param, s2Param, 'сет:', setParam);
            
            if (matchId) {
                window.matchId = matchId;
                const btn = document.getElementById('btnSaveToTournament');
                if (btn) {
                    btn.style.display = 'inline-block';
                    console.log('[Volleyball] Кнопка сохранения показана');
                } else {
                    console.error('[Volleyball] Кнопка btnSaveToTournament не найдена');
                }
                
                // Загружаем данные матча из базы для восстановления всех сетов
                // Добавляем timestamp для предотвращения кеширования
                fetch(`/api/matches/${matchId}?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('[Volleyball] Полный ответ API:', data);
                        if (!data.success || !data.match) {
                            console.error('[Volleyball] Ошибка: нет данных матча в ответе');
                            return;
                        }
                        
                        const matchData = data.match;
                        console.log('[Volleyball] Данные матча из БД:', matchData);
                        console.log('[Volleyball] Сеты из БД: set1=', matchData.set1_score1, ':', matchData.set1_score2, 
                                    'set2=', matchData.set2_score1, ':', matchData.set2_score2,
                                    'set3=', matchData.set3_score1, ':', matchData.set3_score2);
                        
                        // Восстанавливаем счет всех сетов
                        if (matchData.set1_score1 !== null && matchData.set1_score2 !== null) {
                            setScores[0] = [matchData.set1_score1, matchData.set1_score2];
                            console.log('[Volleyball] Восстановлен сет 1:', setScores[0]);
                        }
                        if (matchData.set2_score1 !== null && matchData.set2_score2 !== null) {
                            setScores[1] = [matchData.set2_score1, matchData.set2_score2];
                            console.log('[Volleyball] Восстановлен сет 2:', setScores[1]);
                        }
                        if (matchData.set3_score1 !== null && matchData.set3_score2 !== null) {
                            setScores[2] = [matchData.set3_score1, matchData.set3_score2];
                            console.log('[Volleyball] Восстановлен сет 3:', setScores[2]);
                        }
                        console.log('[Volleyball] Все восстановленные сеты:', setScores);
                        
                        // Обновляем текущий счет для активного сета
                        const setParam = new URLSearchParams(window.location.search).get('set');
                        const currentSetNum = setParam ? parseInt(setParam, 10) : 1;
                        console.log('[Volleyball] Текущий номер сета из URL:', currentSetNum);
                        
                        if (currentSetNum >= 1 && currentSetNum <= 3 && setScores[currentSetNum - 1]) {
                            teamAScore = setScores[currentSetNum - 1][0] || 0;
                            teamBScore = setScores[currentSetNum - 1][1] || 0;
                            console.log('[Volleyball] Установлен текущий счет сета', currentSetNum, ':', teamAScore, ':', teamBScore);
                        } else {
                            console.log('[Volleyball] Счет для сета', currentSetNum, 'не найден, используется 0:0');
                        }
                        
                        updateSetScores();
                        updateDisplay();
                    })
                    .catch(error => {
                        console.error('[Volleyball] Ошибка загрузки данных матча:', error);
                    });
            } else {
                console.log('[Volleyball] matchId не найден в URL');
            }
            
            // Обновляем названия команд, если они переданы
            if (team1Name && team2Name) {
                window.team1Name = team1Name;
                window.team2Name = team2Name;
                updateTeamNames(team1Name, team2Name);
                // Обновляем индикатор подачи с новыми названиями сразу
                updateServeIndicator();
            }

            // Устанавливаем номер текущего сета из URL
            const setNum = setParam !== null ? parseInt(setParam, 10) : null;
            if (setNum && setNum >= 1 && setNum <= 3) {
                currentSet = setNum;
                document.querySelector('.current-set').textContent = `Сет ${currentSet} из 3`;
                console.log('[Volleyball] Установлен текущий сет:', currentSet);
            }
            
            // Счет берем ТОЛЬКО из БД (уже загружен выше через fetch)
            // URL параметры score1/score2 игнорируются, так как они могут быть устаревшими
            console.log('[Volleyball] Счет будет загружен из БД через fetch');
        }
        
        // Функция для обновления названий команд
        function updateTeamNames(team1Name, team2Name) {
            console.log('[Volleyball] Обновляем названия команд:', team1Name, 'vs', team2Name);
            
            // Обновляем заголовки команд
            const teamNameNodes = document.querySelectorAll('.team-name');
            const team1Title = teamNameNodes && teamNameNodes[0];
            const team2Title = teamNameNodes && teamNameNodes[1];
            
            if (team1Title) {
                team1Title.textContent = team1Name;
                console.log('[Volleyball] Обновлен заголовок команды A:', team1Name);
            }
            
            if (team2Title) {
                team2Title.textContent = team2Name;
                console.log('[Volleyball] Обновлен заголовок команды B:', team2Name);
            }

            // Обновляем текст кнопок начисления очков
            const btnA = document.getElementById('btnPointA');
            const btnB = document.getElementById('btnPointB');
            if (btnA) btnA.innerHTML = '<i class="fas fa-plus me-2"></i>Очко команде ' + team1Name;
            if (btnB) btnB.innerHTML = '<i class="fas fa-plus me-2"></i>Очко команде ' + team2Name;
        }
        
        // Пробуем показать кнопку сразу и через небольшую задержку
        showSaveButton();
        setTimeout(showSaveButton, 100);
    </script>
</body>
</html>
