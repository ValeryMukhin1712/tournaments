{% extends "base.html" %}

{% block title %}–°–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—Ç—á–∏ - –¢—É—Ä–Ω–∏—Ä–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç v2.1{% endblock %}

{% block content %}
<style>
.main-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px var(--shadow-color);
    margin: 2rem auto;
    padding: 2rem;
    transition: all 0.3s ease;
}

.hero-title {
    background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px var(--shadow-color);
}

.card-modern {
    background: linear-gradient(145deg, var(--bg-card), var(--bg-primary));
    border: 2px solid var(--border-color);
    border-radius: 15px;
    box-shadow: 0 10px 30px var(--shadow-color);
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.table-modern {
    margin-bottom: 0;
}

.table-modern thead th {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    border: none;
    font-weight: 600;
    padding: 1rem;
    text-align: center;
}

.table-modern tbody td {
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
}

.table-modern tbody tr:hover {
    background-color: var(--bg-card-hover);
    transition: background-color 0.2s ease;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-–∑–∞–≤–µ—Ä—à–µ–Ω {
    background-color: #28a745;
    color: white;
}

.status-–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ, .status-–∏–≥—Ä–∞—é—Ç {
    background-color: #ffc107;
    color: #000;
}

.status-–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω {
    background-color: #6c757d;
    color: white;
}

.btn-gradient {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    border: none;
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px var(--shadow-hover);
    color: white;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>

<div class="container">
    <div class="main-container">
        <div class="text-center mb-5">
            <h1 class="hero-title display-4">
                <i class="fas fa-table-tennis me-3"></i>
                –°–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—Ç—á–∏
            </h1>
            <p class="lead text-muted">–°–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π –±–µ–∑ —Ç—É—Ä–Ω–∏—Ä–∞</p>
        </div>
        
        <div class="card card-modern">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                <h5 class="mb-2 mb-md-0">
                    <i class="fas fa-list me-2"></i>–í—Å–µ–≥–æ –º–∞—Ç—á–µ–π: {{ matches_count }}
                </h5>
                <div>
                    {% if admin %}
                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-gradient btn-sm me-2">
                            <i class="fas fa-arrow-left me-1"></i>–ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏
                        </a>
                    {% endif %}
                    <a href="{{ url_for('tournaments_list') }}" class="btn btn-gradient btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>–ù–∞–∑–∞–¥ –∫ —Ç—É—Ä–Ω–∏—Ä–∞–º
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if matches %}
                    <div class="table-responsive">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ò–≥—Ä–æ–∫ 1</th>
                                    <th>–ò–≥—Ä–æ–∫ 2</th>
                                    <th>–°—á–µ—Ç</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th class="d-none d-md-table-cell">–î–∞—Ç–∞</th>
                                    <th class="d-none d-md-table-cell">–í—Ä–µ–º—è</th>
                                    <th class="d-none d-lg-table-cell">–ü–ª–æ—â–∞–¥–∫–∞</th>
                                    <th class="d-none d-lg-table-cell">–°–æ–∑–¥–∞–Ω</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for match in matches %}
                                <tr class="free-match-row" data-match-id="{{ match.id }}">
                                    <td><strong>#{{ match.id }}</strong></td>
                                    <td><strong>{{ match.player1_name }}</strong></td>
                                    <td><strong>{{ match.player2_name }}</strong></td>
                                    <td class="match-score-cell" data-match-id="{{ match.id }}">
                                        {% if match.score and match.score != '0:0' %}
                                            <span class="badge bg-primary">{{ match.score }}</span>
                                        {% elif match.set1_score1 is not none and match.set1_score2 is not none %}
                                            <span class="badge bg-primary">{{ match.set1_score1 }}:{{ match.set1_score2 }}</span>
                                        {% elif match.sets_won_1 or match.sets_won_2 %}
                                            <span class="badge bg-primary">{{ match.sets_won_1 or 0 }}:{{ match.sets_won_2 or 0 }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="match-status-cell" data-match-id="{{ match.id }}">
                                        <span class="status-badge status-{{ match.status }}">
                                            {{ match.status }}
                                        </span>
                                    </td>
                                    <td class="d-none d-md-table-cell">{{ match.match_date }}</td>
                                    <td class="d-none d-md-table-cell">{{ match.match_time }}</td>
                                    <td class="d-none d-lg-table-cell">{{ match.court_number }}</td>
                                    <td class="d-none d-lg-table-cell">
                                        <small class="text-muted">{{ match.created_at }}</small>
                                    </td>
                                    <td>
                                        {% if match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç', '–∑–∞–≤–µ—Ä—à–µ–Ω'] %}
                                        <button class="btn btn-sm btn-outline-warning" 
                                                onclick="event.stopPropagation(); openRallyJournalModalV2({{ match.id }}, '{{ match.player1_name }}', '{{ match.player2_name }}')"
                                                title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π">
                                            <i class="fas fa-book-open"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h4>–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π</h4>
                        <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—Ç—á–∏ (–±–µ–∑ —Ç—É—Ä–Ω–∏—Ä–∞) –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π -->
<div class="modal fade" id="rallyJournalModalV2" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i>–ñ—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                </h5>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-success me-2" id="exportRallyJournalBtnV2" onclick="exportRallyJournalToExcel()" title="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel" style="display: none;">
                        <i class="fas fa-file-excel me-1"></i>–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
            </div>
            <div class="modal-body">
                <div id="rallyJournalContentV2">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="updateRallyJournalBtnV2" onclick="updateRallyJournalV2()">
                    <i class="fas fa-sync-alt me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
function openRallyJournalModalV2(matchId, player1, player2) {
    console.log('[Rally Journal V2] –û—Ç–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –º–∞—Ç—á–∞:', matchId);
    
    const modal = document.getElementById('rallyJournalModalV2');
    if (!modal) {
        console.error('[Rally Journal V2] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    const modalTitle = modal.querySelector('.modal-title');
    if (!modalTitle) {
        console.error('[Rally Journal V2] –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    modalTitle.innerHTML = `<i class="fas fa-book me-2"></i>–ñ—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: <span style="color: #007bff; font-style: italic;">${player1}</span> vs <span style="color: #dc3545; font-style: italic;">${player2}</span>`;
    
    modal.setAttribute('data-match-id', matchId);
    modal.setAttribute('data-participant1', player1);
    modal.setAttribute('data-participant2', player2);
    modal.setAttribute('data-tournament-name', '–°–≤–æ–±–æ–¥–Ω—ã–π –º–∞—Ç—á');
    
    const exportBtn = document.getElementById('exportRallyJournalBtnV2');
    if (exportBtn) {
        exportBtn.style.display = 'inline-block';
    }
    
    const content = document.getElementById('rallyJournalContentV2');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
        </div>
    `;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    loadRallyJournalV2(matchId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–¥–∏–∑–∞–π–Ω –∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 18)
async function loadRallyJournalV2(matchId) {
    try {
        const modal = document.getElementById('rallyJournalModalV2');
        if (!modal) {
            console.warn('[Rally Journal V2] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        const participant1 = modal.getAttribute('data-participant1') || '';
        const participant2 = modal.getAttribute('data-participant2') || '';
        
        const normalizeName = (name) => {
            if (!name) return '';
            return name.trim().toLowerCase().replace(/\s+/g, ' ');
        };
        
        const getParticipantColor = (serverName) => {
            if (!serverName || !participant1 || !participant2) return null;
            const serverParts = serverName.split(' - ');
            const serverNameOnly = serverParts[0].trim();
            const normalizedServerName = normalizeName(serverNameOnly);
            const normalizedP1 = normalizeName(participant1);
            const normalizedP2 = normalizeName(participant2);
            const p1Parts = normalizedP1.split(' - ').map(p => p.trim()).filter(p => p);
            const p2Parts = normalizedP2.split(' - ').map(p => p.trim()).filter(p => p);
            const isParticipant1 = normalizedServerName === normalizedP1 || 
                                  (p1Parts.length > 0 && p1Parts.some(part => normalizedServerName.includes(part) || part.includes(normalizedServerName)));
            const isParticipant2 = normalizedServerName === normalizedP2 || 
                                  (p2Parts.length > 0 && p2Parts.some(part => normalizedServerName.includes(part) || part.includes(normalizedServerName)));
            if (isParticipant1) return '#007bff';
            if (isParticipant2) return '#dc3545';
            return null;
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–∫–∏ (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä.18)
        const getArrowDirection = (serverName, score, result) => {
            if (!serverName || !score || result === undefined) return null;
            
            const serverColor = getParticipantColor(serverName);
            if (!serverColor) return null;
            
            const isParticipant1 = serverColor === '#007bff';
            const isParticipant2 = serverColor === '#dc3545';
            
            const scoreParts = score.split(':');
            if (scoreParts.length !== 2) return null;
            
            const leftScore = parseInt(scoreParts[0]) || 0;
            const rightScore = parseInt(scoreParts[1]) || 0;
            
            const resultValue = result ? 1 : 0;
            void resultValue; // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —è–≤–Ω–æ, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            
            let isEven;
            if (isParticipant1) {
                isEven = (leftScore) % 2 === 0;
            } else if (isParticipant2) {
                isEven = (rightScore) % 2 === 0;
            } else {
                return null;
            }
            
            return {
                arrow: isEven ? '‚Üó' : '‚Üò',
                color: isEven ? '#ff69b4' : '#00bfff'
            };
        };
        
        console.log(`[Rally Journal V2] –ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –º–∞—Ç—á–∞ ${matchId}`);
        
        // –ö–∞–∫ –Ω–∞ —Å—Ç—Ä.18: –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –∏ –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞
        const [ralliesResponse, matchResponse] = await Promise.all([
            fetch(`/api/matches/${matchId}/rallies?_t=${Date.now()}`),
            fetch(`/api/matches/${matchId}?_t=${Date.now()}`)
        ]);
        
        if (!ralliesResponse.ok) {
            throw new Error(`HTTP error! status: ${ralliesResponse.status}`);
        }
        
        const data = await ralliesResponse.json();
        const matchData = matchResponse.ok ? await matchResponse.json() : null;
        const content = document.getElementById('rallyJournalContentV2');
        
        if (!data.success) {
            content.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π'}
                </div>
            `;
            return;
        }
        
        const match = matchData && matchData.success ? matchData.match : null;
        const setScores = {};
        if (match) {
            setScores[1] = match.set1_score1 !== null && match.set1_score2 !== null ? 
                { score1: match.set1_score1, score2: match.set1_score2 } : null;
            setScores[2] = match.set2_score1 !== null && match.set2_score2 !== null ? 
                { score1: match.set2_score1, score2: match.set2_score2 } : null;
            setScores[3] = match.set3_score1 !== null && match.set3_score2 !== null ? 
                { score1: match.set3_score1, score2: match.set3_score2 } : null;
        }
        
        const rallies = data.rallies || [];
        console.log(`[Rally Journal V2] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: ${rallies.length} –¥–ª—è –º–∞—Ç—á–∞ ${matchId}`);
        
        if (rallies.length === 0) {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –í —ç—Ç–æ–º –º–∞—Ç—á–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                </div>
            `;
            return;
        }
        
        const ralliesBySet = {};
        rallies.forEach(rally => {
            const setNum = rally.set_number || 1;
            if (!ralliesBySet[setNum]) {
                ralliesBySet[setNum] = [];
            }
            ralliesBySet[setNum].push(rally);
        });
        
        let html = '<div class="rally-journal">';
        const setNumbers = Object.keys(ralliesBySet).sort((a, b) => parseInt(a) - parseInt(b));
        
        setNumbers.forEach(setNum => {
            const setRallies = ralliesBySet[setNum];
            const setNumInt = parseInt(setNum);
            const finalScore = setScores[setNumInt];
            let scoreBadge = '';
            if (finalScore && finalScore.score1 !== null && finalScore.score2 !== null) {
                scoreBadge = `<span class="badge bg-primary ms-2">${finalScore.score1}:${finalScore.score2}</span>`;
            }
            html += `
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-trophy me-2"></i>–°–µ—Ç ${setNum}
                        ${scoreBadge}
                        <span class="badge bg-secondary ms-2">${setRallies.length} —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</span>
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">‚Ññ</th>
                                    <th style="width: 120px;">–í—Ä–µ–º—è</th>
                                    <th>–ü–æ–¥–∞—é—â–∏–π</th>
                                    <th>–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π</th>
                                    <th style="width: 100px;" class="text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                    <th colspan="2" style="width: 100px;" class="text-center">–°—á—ë—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            let computedScoreLeft = 0;
            let computedScoreRight = 0;
            
            setRallies.forEach((rally, index) => {
                const rallyTime = new Date(rally.rally_datetime || rally.rally_date + ' ' + rally.rally_time);
                let timeIntervalStr = '0 —Å';
                if (index > 0) {
                    const prevRally = setRallies[index - 1];
                    const prevRallyTime = new Date(prevRally.rally_datetime || prevRally.rally_date + ' ' + prevRally.rally_time);
                    const intervalSeconds = Math.round((rallyTime - prevRallyTime) / 1000);
                    timeIntervalStr = `${intervalSeconds} —Å`;
                }
                
                const resultBadge = rally.server_won 
                    ? '<span class="badge bg-success">1</span>'
                    : '<span class="badge bg-danger">0</span>';
                
                const swapCount = rally.swap_count !== undefined && rally.swap_count !== null ? rally.swap_count : 0;
                const serverColor = getParticipantColor(rally.server_name);
                const receiverColor = getParticipantColor(rally.receiver_name);
                const isServerParticipant1 = serverColor === '#007bff';
                const isServerParticipant2 = serverColor === '#dc3545';
                const isReceiverParticipant1 = receiverColor === '#007bff';
                const isReceiverParticipant2 = receiverColor === '#dc3545';
                
                const scoreBeforeLeft = computedScoreLeft;
                const scoreBeforeRight = computedScoreRight;
                
                let participant1ScoreBefore, participant2ScoreBefore;
                if (swapCount % 2 === 0) {
                    participant1ScoreBefore = scoreBeforeLeft;
                    participant2ScoreBefore = scoreBeforeRight;
                } else {
                    participant1ScoreBefore = scoreBeforeRight;
                    participant2ScoreBefore = scoreBeforeLeft;
                }
                
                if (rally.server_won) {
                    if (isServerParticipant1) {
                        participant1ScoreBefore++;
                    } else if (isServerParticipant2) {
                        participant2ScoreBefore++;
                    }
                } else {
                    if (isReceiverParticipant1) {
                        participant1ScoreBefore++;
                    } else if (isReceiverParticipant2) {
                        participant2ScoreBefore++;
                    }
                }
                
                if (swapCount % 2 === 0) {
                    computedScoreLeft = participant1ScoreBefore;
                    computedScoreRight = participant2ScoreBefore;
                } else {
                    computedScoreLeft = participant2ScoreBefore;
                    computedScoreRight = participant1ScoreBefore;
                }
                
                let scoreBefore = '';
                if (swapCount % 2 === 0) {
                    scoreBefore = `${scoreBeforeLeft}:${scoreBeforeRight}`;
                } else {
                    scoreBefore = `${scoreBeforeRight}:${scoreBeforeLeft}`;
                }
                
                let serverNameHtml = '';
                if (rally.server_name) {
                    const serverParts = rally.server_name.split(' - ');
                    const serverNameColor = getParticipantColor(rally.server_name);
                    const nameColorStyle = serverNameColor ? `color: ${serverNameColor};` : '';
                    
                    const resultValueForArrow = rally.server_won ? 1 : 0;
                    const arrowInfo = getArrowDirection(rally.server_name, scoreBefore, resultValueForArrow);
                    
                    if (arrowInfo && serverParts.length >= 1) {
                        const serverNameOnly = serverParts[0].trim();
                        const arrow = arrowInfo.arrow;
                        const arrowColor = arrowInfo.color;
                        serverNameHtml = `<strong style="font-style: italic; ${nameColorStyle}">${serverNameOnly}</strong> <span style="font-style: italic; color: ${arrowColor}; font-size: 80%; font-weight: 900; text-shadow: 1px 0 0 ${arrowColor}, -1px 0 0 ${arrowColor}, 0 1px 0 ${arrowColor}, 0 -1px 0 ${arrowColor}, 0.7px 0.7px 0 ${arrowColor}, -0.7px -0.7px 0 ${arrowColor}, 0.7px -0.7px 0 ${arrowColor}, -0.7px 0.7px 0 ${arrowColor}, 1px 0.5px 0 ${arrowColor}, -1px -0.5px 0 ${arrowColor}, 0.5px 1px 0 ${arrowColor}, -0.5px -1px 0 ${arrowColor};"> ${arrow}</span>`;
                    } else {
                        serverNameHtml = `<strong style="font-style: italic; ${nameColorStyle}">${rally.server_name}</strong>`;
                    }
                } else {
                    serverNameHtml = '<strong style="font-style: italic;">–ù–µ —É–∫–∞–∑–∞–Ω</strong>';
                }
                
                const receiverNameHtml = `<strong style="font-style: italic;">${rally.receiver_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>`;
                
                let scoreLeft = '';
                let scoreRight = '';
                
                if (swapCount % 2 === 0) {
                    if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                        scoreLeft = String(computedScoreLeft).padStart(2, ' ');
                        scoreRight = '  ';
                    } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                        scoreLeft = '  ';
                        scoreRight = String(computedScoreRight).padStart(2, ' ');
                    }
                } else {
                    if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                        scoreLeft = '  ';
                        scoreRight = String(computedScoreRight).padStart(2, ' ');
                    } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                        scoreLeft = String(computedScoreLeft).padStart(2, ' ');
                        scoreRight = '  ';
                    }
                }
                
                const scoreLeftHtml = scoreLeft.trim() !== '' 
                    ? `<strong style="display: inline-block; border: 1px solid #d0d0d0; padding: 2px 4px; border-radius: 2px;">${scoreLeft}</strong>`
                    : '';
                const scoreRightHtml = scoreRight.trim() !== '' 
                    ? `<strong style="display: inline-block; border: 1px solid #d0d0d0; padding: 2px 4px; border-radius: 2px;">${scoreRight}</strong>`
                    : '';
                
                html += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center"><small>${timeIntervalStr}</small></td>
                        <td>${serverNameHtml}</td>
                        <td>${receiverNameHtml}</td>
                        <td class="text-center">${resultBadge}</td>
                        <td class="text-center" style="width: 2ch; font-family: monospace; padding: 2px;">${scoreLeftHtml}</td>
                        <td class="text-center" style="width: 2ch; font-family: monospace; padding: 2px; padding-left: 0.5ch;">${scoreRightHtml}</td>
                    </tr>
                `;
            });
            
            if (setRallies.length > 0) {
                const lastRally = setRallies[setRallies.length - 1];
                const lastSwapCount = lastRally.swap_count !== undefined && lastRally.swap_count !== null ? lastRally.swap_count : 0;
                let currentBlueScore, currentRedScore;
                if (lastSwapCount % 2 === 0) {
                    currentBlueScore = computedScoreLeft;
                    currentRedScore = computedScoreRight;
                } else {
                    currentBlueScore = computedScoreRight;
                    currentRedScore = computedScoreLeft;
                }
                html += `
                    <tr style="background-color: #e9ecef;">
                        <td colspan="5"></td>
                        <td colspan="2" class="text-center" style="font-family: monospace; padding: 2px;">
                            <strong style="font-size: 140%; font-style: italic; font-weight: 900; color: #007bff;">${String(currentBlueScore).padStart(2, ' ')}</strong>
                            <span style="font-size: 140%; font-style: italic; font-weight: 900;"> : </span>
                            <strong style="font-size: 140%; font-style: italic; font-weight: 900; color: #dc3545;">${String(currentRedScore).padStart(2, ' ')}</strong>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
        
        if (modal) {
            modal.setAttribute('data-rallies', JSON.stringify(rallies));
        }
        
        console.log('[Rally Journal V2] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:', rallies.length);
        
    } catch (error) {
        console.error('[Rally Journal V2] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞:', error);
        const content = document.getElementById('rallyJournalContentV2');
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: ${error.message}
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä.18)
function updateRallyJournalV2() {
    const modal = document.getElementById('rallyJournalModalV2');
    if (!modal) {
        console.error('[Rally Journal V2] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    
    const matchId = modal.getAttribute('data-match-id');
    if (!matchId) {
        console.error('[Rally Journal V2] MatchId –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    console.log(`[Rally Journal V2] üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –º–∞—Ç—á–∞ ${matchId}`);
    
    const content = document.getElementById('rallyJournalContentV2');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
            </div>
            <p class="mt-2 text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
        </div>
    `;
    
    loadRallyJournalV2(matchId);
}

// –í—ã–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –≤ Excel
async function exportRallyJournalToExcel() {
    try {
        const modalV2 = document.getElementById('rallyJournalModalV2');
        if (!modalV2) {
            alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        const matchId = modalV2.getAttribute('data-match-id');
        if (!matchId) {
            alert('–ù–µ —É–∫–∞–∑–∞–Ω ID –º–∞—Ç—á–∞');
            return;
        }
        
        const response = await fetch(`/api/matches/${matchId}/rallies?_t=${Date.now()}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (!data.success || !data.rallies) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π');
        }
        
        const rallies = data.rallies;
        if (!rallies || rallies.length === 0) {
            alert('–ù–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        const participant1 = modalV2.getAttribute('data-participant1') || '';
        const participant2 = modalV2.getAttribute('data-participant2') || '';
        
        const getParticipantColor = (serverName) => {
            if (!serverName || !participant1 || !participant2) return null;
            const serverParts = serverName.split(' - ');
            const serverNameOnly = serverParts[0].trim();
            const normalizedServerName = serverNameOnly.toLowerCase().trim();
            const normalizedP1 = participant1.toLowerCase().trim();
            const normalizedP2 = participant2.toLowerCase().trim();
            
            if (normalizedServerName === normalizedP1 || normalizedServerName.includes(normalizedP1) || normalizedP1.includes(normalizedServerName)) {
                return '#007bff';
            }
            if (normalizedServerName === normalizedP2 || normalizedServerName.includes(normalizedP2) || normalizedP2.includes(normalizedServerName)) {
                return '#dc3545';
            }
            return null;
        };
        
        const ralliesBySet = {};
        rallies.forEach(rally => {
            const setNum = rally.set_number;
            if (!ralliesBySet[setNum]) {
                ralliesBySet[setNum] = [];
            }
            ralliesBySet[setNum].push(rally);
        });
        
        let csvContent = '\uFEFF';
        csvContent += '‚Ññ,–°–µ—Ç,–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫),–ü–æ–¥–∞—é—â–∏–π,–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π,–†–µ–∑—É–ª—å—Ç–∞—Ç,–°—á—ë—Ç (–ª–µ–≤–∞—è),–°—á—ë—Ç (–ø—Ä–∞–≤–∞—è)\n';
        
        let processedCount = 0;
        const setNumbers = Object.keys(ralliesBySet).sort((a, b) => parseInt(a) - parseInt(b));
        
        setNumbers.forEach(setNum => {
            const setRallies = ralliesBySet[setNum];
            let computedScoreLeft = 0;
            let computedScoreRight = 0;
            
            setRallies.forEach((rally, index) => {
                try {
                    if (!rally || !rally.rally_datetime || !rally.score) {
                        return;
                    }
                    
                    const rallyTime = new Date(rally.rally_datetime);
                    if (isNaN(rallyTime.getTime())) {
                        return;
                    }
                    
                    let timeIntervalStr = '0';
                    if (index > 0) {
                        const prevRally = setRallies[index - 1];
                        const prevRallyTime = new Date(prevRally.rally_datetime);
                        const intervalSeconds = Math.round((rallyTime - prevRallyTime) / 1000);
                        timeIntervalStr = String(intervalSeconds);
                    }
                    
                    const result = rally.server_won ? '1' : '0';
                    const serverName = rally.server_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    const receiverName = rally.receiver_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    
                    const swapCount = rally.swap_count !== undefined && rally.swap_count !== null ? rally.swap_count : 0;
                    const serverColor = getParticipantColor(rally.server_name);
                    const receiverColor = getParticipantColor(rally.receiver_name);
                    const isServerParticipant1 = serverColor === '#007bff';
                    const isServerParticipant2 = serverColor === '#dc3545';
                    const isReceiverParticipant1 = receiverColor === '#007bff';
                    const isReceiverParticipant2 = receiverColor === '#dc3545';
                    
                    const scoreBeforeLeft = computedScoreLeft;
                    const scoreBeforeRight = computedScoreRight;
                    
                    let participant1ScoreBefore, participant2ScoreBefore;
                    if (swapCount % 2 === 0) {
                        participant1ScoreBefore = scoreBeforeLeft;
                        participant2ScoreBefore = scoreBeforeRight;
                    } else {
                        participant1ScoreBefore = scoreBeforeRight;
                        participant2ScoreBefore = scoreBeforeLeft;
                    }
                    
                    if (rally.server_won) {
                        if (isServerParticipant1) {
                            participant1ScoreBefore++;
                        } else if (isServerParticipant2) {
                            participant2ScoreBefore++;
                        }
                    } else {
                        if (isReceiverParticipant1) {
                            participant1ScoreBefore++;
                        } else if (isReceiverParticipant2) {
                            participant2ScoreBefore++;
                        }
                    }
                    
                    if (swapCount % 2 === 0) {
                        computedScoreLeft = participant1ScoreBefore;
                        computedScoreRight = participant2ScoreBefore;
                    } else {
                        computedScoreLeft = participant2ScoreBefore;
                        computedScoreRight = participant1ScoreBefore;
                    }
                    
                    let scoreLeft = '';
                    let scoreRight = '';
                    
                    if (swapCount % 2 === 0) {
                        if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                            scoreLeft = String(computedScoreLeft);
                            scoreRight = '';
                        } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                            scoreLeft = '';
                            scoreRight = String(computedScoreRight);
                        }
                    } else {
                        if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                            scoreLeft = '';
                            scoreRight = String(computedScoreRight);
                        } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                            scoreLeft = String(computedScoreLeft);
                            scoreRight = '';
                        }
                    }
                    
                    csvContent += `${processedCount + 1},${setNum},${timeIntervalStr},"${serverName}","${receiverName}",${result},"${scoreLeft}","${scoreRight}"\n`;
                    processedCount++;
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ ${index + 1} —Å–µ—Ç–∞ ${setNum}:`, error);
                }
            });
        });
        
        const fileName = `free_match_${matchId}_journal.csv`;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`–£—Å–ø–µ—à–Ω–æ! –ñ—É—Ä–Ω–∞–ª –º–∞—Ç—á–∞ ${matchId} –≤—ã–≥—Ä—É–∂–µ–Ω –≤ Excel.`);
    } catch (error) {
        console.error('[Rally Journal] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞: ' + error.message);
    }
}

// ===== –û–ù–õ–ê–ô–ù –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ß–ï–¢–ê =====

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ç—á–∞
async function refreshFreeMatchScore(matchId) {
    try {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ matchId - —ç—Ç–æ —á–∏—Å–ª–æ
        const matchIdNum = parseInt(matchId);
        if (isNaN(matchIdNum)) {
            console.warn(`[FreeMatches] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π matchId: ${matchId}`);
            return;
        }
        
        console.log(`[FreeMatches] üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –º–∞—Ç—á–∞ ${matchIdNum}`);
        
        const response = await fetch(`/api/matches/${matchIdNum}?_t=${Date.now()}`, {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`[FreeMatches] ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞ ${matchIdNum}, —Å—Ç–∞—Ç—É—Å: ${response.status}, –æ—à–∏–±–∫–∞: ${errorText}`);
            // –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Å—á–µ—Ç - –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            return;
        }
        
        const data = await response.json();
        if (!data) {
            console.error(`[FreeMatches] ‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API –¥–ª—è –º–∞—Ç—á–∞ ${matchIdNum}`);
            return;
        }
        console.log(`[FreeMatches] üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞ ${matchIdNum}:`, data);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å data.match –∏–ª–∏ data –Ω–∞–ø—Ä—è–º—É—é
        let matchData = null;
        if (data.success && data.match) {
            matchData = data.match;
        } else if (data.match) {
            matchData = data.match;
        } else if (data.id) {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –æ–±–µ—Ä—Ç–∫–∏
            matchData = data;
        }
        
        if (!matchData) {
            console.error(`[FreeMatches] ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞ ${matchIdNum} –∏–∑ –æ—Ç–≤–µ—Ç–∞:`, data);
            return;
        }
        
        // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –º–∞—Ç—á–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è data-–∞—Ç—Ä–∏–±—É—Ç–∞)
        const matchRow = document.querySelector(`tr.free-match-row[data-match-id="${matchIdNum}"]`);
        if (!matchRow) {
            console.warn(`[FreeMatches] –°—Ç—Ä–æ–∫–∞ –º–∞—Ç—á–∞ ${matchIdNum} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM`);
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
        const scoreCell = matchRow.querySelector('.match-score-cell');
        if (scoreCell) {
            let score = matchData.score;
            // –î–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—á–µ—Ç —Å–µ—Ç–∞ 1
            if (!score && matchData.set1_score1 !== null && matchData.set1_score2 !== null) {
                score = `${matchData.set1_score1}:${matchData.set1_score2}`;
            } else if (!score && (matchData.sets_won_1 || matchData.sets_won_2)) {
                score = `${matchData.sets_won_1 || 0}:${matchData.sets_won_2 || 0}`;
            }
            
            console.log(`[FreeMatches] üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è –º–∞—Ç—á–∞ ${matchIdNum}:`, {
                'score': score,
                'set1_score1': matchData.set1_score1,
                'set1_score2': matchData.set1_score2,
                'sets_won_1': matchData.sets_won_1,
                'sets_won_2': matchData.sets_won_2
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            const currentContent = scoreCell.innerHTML.trim();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—á–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö API
            let displayScore = null;
            if (score && score !== '0:0') {
                displayScore = score;
            } else if (matchData.set1_score1 !== null && matchData.set1_score2 !== null) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—á–µ—Ç —Å–µ—Ç–∞, –Ω–æ –Ω–µ—Ç –æ–±—â–µ–≥–æ —Å—á–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—á–µ—Ç —Å–µ—Ç–∞
                displayScore = `${matchData.set1_score1}:${matchData.set1_score2}`;
            } else if (matchData.sets_won_1 || matchData.sets_won_2) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å sets_won, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                displayScore = `${matchData.sets_won_1 || 0}:${matchData.sets_won_2 || 0}`;
            }
            
            // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (displayScore) {
                scoreCell.innerHTML = `<span class="badge bg-primary">${displayScore}</span>`;
                console.log(`[FreeMatches] ‚úÖ –°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: ${displayScore} (–±—ã–ª–æ: ${currentContent})`);
            } else {
                // –ï—Å–ª–∏ —Å—á–µ—Ç –ø—É—Å—Ç–æ–π –≤ API, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                const hasCurrentScore = currentContent && 
                                       !currentContent.includes('text-muted') && 
                                       currentContent !== '<span class="text-muted">-</span>' &&
                                       currentContent !== '-';
                
                if (!hasCurrentScore) {
                    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å—á–µ—Ç–∞ –Ω–µ –±—ã–ª–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "-"
                    scoreCell.innerHTML = '<span class="text-muted">-</span>';
                    console.log(`[FreeMatches] ‚ö†Ô∏è –°—á–µ—Ç –ø—É—Å—Ç–æ–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º "-"`);
                } else {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç, –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Å—á–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω
                    console.log(`[FreeMatches] ‚ö†Ô∏è –°—á–µ—Ç –ø—É—Å—Ç–æ–π –≤ API, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π: ${currentContent}`);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        const statusCell = matchRow.querySelector('.match-status-cell');
        if (statusCell && matchData.status) {
            const statusBadge = statusCell.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge status-${matchData.status}`;
                statusBadge.textContent = matchData.status;
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∂—É—Ä–Ω–∞–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        const actionCell = matchRow.querySelector('td:last-child');
        if (actionCell) {
            if (matchData.status && ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç', '–∑–∞–≤–µ—Ä—à–µ–Ω'].includes(matchData.status)) {
                if (!actionCell.querySelector('button')) {
                    const player1 = matchRow.querySelector('td:nth-child(2) strong').textContent;
                    const player2 = matchRow.querySelector('td:nth-child(3) strong').textContent;
                    actionCell.innerHTML = `
                        <button class="btn btn-sm btn-outline-warning" 
                                onclick="event.stopPropagation(); openRallyJournalModalV2(${matchId}, '${player1}', '${player2}')"
                                title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π">
                            <i class="fas fa-book-open"></i>
                        </button>
                    `;
                }
            } else {
                actionCell.innerHTML = '<span class="text-muted">‚Äî</span>';
            }
        }
    } catch (error) {
        console.error(`[FreeMatches] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞ –º–∞—Ç—á–∞ ${matchId}:`, error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 18)
let freeMatchAutoRefreshInterval = null;
const refreshIntervalSeconds = 3; // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
let updateCounter = 0; // –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

function startFreeMatchScoreAutoRefresh() {
    console.log('[FreeMatches] üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞');
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
    if (freeMatchAutoRefreshInterval) {
        console.log('[FreeMatches] ‚ö†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞');
        clearInterval(freeMatchAutoRefreshInterval);
        freeMatchAutoRefreshInterval = null;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const tableRows = document.querySelectorAll('tr.free-match-row[data-match-id]');
    console.log(`[FreeMatches] üìã –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –º–∞—Ç—á–µ–π –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º: ${tableRows.length}`);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
    freeMatchAutoRefreshInterval = setInterval(function() {
        updateCounter++;
        console.log(`[FreeMatches] ‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö #${updateCounter} (–∫–∞–∂–¥—ã–µ ${refreshIntervalSeconds} —Å–µ–∫)...`);
        console.log(`[FreeMatches] üìä –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${new Date().toLocaleTimeString()}`);
        updateFreeMatchesData();
    }, refreshIntervalSeconds * 1000);
    
    console.log(`[FreeMatches] ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∂–¥—ã–µ ${refreshIntervalSeconds} —Å–µ–∫—É–Ω–¥)`);
    console.log(`[FreeMatches] üî¢ ID –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞: ${freeMatchAutoRefreshInterval}`);
    
    // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
    console.log('[FreeMatches] üöÄ –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É...');
    updateFreeMatchesData();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ updateTournamentData)
function updateFreeMatchesData() {
    console.log(`[FreeMatches] üîÑ –ó–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π`);
    const url = `/api/free-matches/updates?_t=${Date.now()}`;
    console.log(`[FreeMatches] üì° URL –∑–∞–ø—Ä–æ—Å–∞: ${url}`);
    
    fetch(url, {
        cache: 'no-store',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
        }
    })
        .then(response => {
            console.log(`[FreeMatches] üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`[FreeMatches] üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:`, data);
            if (data.success) {
                console.log(`[FreeMatches] ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${data.matches.length} –º–∞—Ç—á–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`);
                if (data.matches.length > 0) {
                    console.log(`[FreeMatches] üìã –ü–µ—Ä–≤—ã–π –º–∞—Ç—á:`, JSON.stringify(data.matches[0]));
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç –º–∞—Ç—á–µ–π
                updateFreeMatches(data.matches);
            } else {
                console.error('[FreeMatches] ‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', data.error);
            }
        })
        .catch(error => {
            console.error('[FreeMatches] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ updateMatches)
function updateFreeMatches(matches) {
    console.log(`[FreeMatches] üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${matches.length} –º–∞—Ç—á–µ–π`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –º–∞—Ç—á–µ–π –µ—Å—Ç—å –≤ DOM
    const allRows = document.querySelectorAll('tr.free-match-row[data-match-id]');
    console.log(`[FreeMatches] üìã –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –º–∞—Ç—á–µ–π –≤ DOM: ${allRows.length}`);
    
    matches.forEach(match => {
        const matchId = String(match.id);
        const selector = `tr.free-match-row[data-match-id="${matchId}"]`;
        console.log(`[FreeMatches] üîç –ü–æ–∏—Å–∫ –º–∞—Ç—á–∞ ${matchId} —Å —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º: ${selector}`);
        
        let matchRow = document.querySelector(selector);
        
        if (matchRow) {
            console.log(`[FreeMatches] ‚úÖ –ù–∞–π–¥–µ–Ω –º–∞—Ç—á ${match.id}: ${match.player1_name} vs ${match.player2_name}, —Å—Ç–∞—Ç—É—Å: ${match.status}, —Å—á—ë—Ç: ${match.score || '–Ω–µ—Ç'}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç
            const scoreCell = matchRow.querySelector('.match-score-cell');
            if (scoreCell) {
                const currentScore = scoreCell.innerHTML.trim();
                console.log(`[FreeMatches] üìä –¢–µ–∫—É—â–∏–π —Å—á–µ—Ç –≤ DOM: "${currentScore}"`);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—á–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                let displayScore = null;
                if (match.score && match.score !== '0:0') {
                    displayScore = match.score;
                } else if (match.set1_score1 !== null && match.set1_score2 !== null) {
                    displayScore = `${match.set1_score1}:${match.set1_score2}`;
                } else if (match.sets_won_1 || match.sets_won_2) {
                    displayScore = `${match.sets_won_1 || 0}:${match.sets_won_2 || 0}`;
                }
                
                console.log(`[FreeMatches] üéØ –ù–æ–≤—ã–π —Å—á–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: "${displayScore}"`);
                
                // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (displayScore) {
                    const newScoreHTML = `<span class="badge bg-primary">${displayScore}</span>`;
                    scoreCell.innerHTML = newScoreHTML;
                    console.log(`[FreeMatches] ‚úÖ –°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: "${currentScore}" -> "${displayScore}"`);
                } else {
                    // –ï—Å–ª–∏ —Å—á–µ—Ç –ø—É—Å—Ç–æ–π –≤ API, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    const hasCurrentScore = currentScore && 
                                           !currentScore.includes('text-muted') && 
                                           currentScore !== '<span class="text-muted">-</span>' &&
                                           currentScore !== '-';
                    
                    if (!hasCurrentScore) {
                        scoreCell.innerHTML = '<span class="text-muted">-</span>';
                        console.log(`[FreeMatches] ‚ö†Ô∏è –°—á–µ—Ç –ø—É—Å—Ç–æ–π, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω "-"`);
                    } else {
                        console.log(`[FreeMatches] ‚ö†Ô∏è –°—á–µ—Ç –ø—É—Å—Ç–æ–π –≤ API, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π: "${currentScore}"`);
                    }
                }
            } else {
                console.warn(`[FreeMatches] ‚ö†Ô∏è –Ø—á–µ–π–∫–∞ —Å–æ —Å—á–µ—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –º–∞—Ç—á–∞ ${match.id}`);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const statusCell = matchRow.querySelector('.match-status-cell');
            if (statusCell && match.status) {
                const statusBadge = statusCell.querySelector('.status-badge');
                if (statusBadge) {
                    const oldStatus = statusBadge.textContent.trim();
                    statusBadge.className = `status-badge status-${match.status}`;
                    statusBadge.textContent = match.status;
                    if (oldStatus !== match.status) {
                        console.log(`[FreeMatches] ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: "${oldStatus}" -> "${match.status}"`);
                    }
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∂—É—Ä–Ω–∞–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            const actionCell = matchRow.querySelector('td:last-child');
            if (actionCell) {
                if (match.status && ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç', '–∑–∞–≤–µ—Ä—à–µ–Ω'].includes(match.status)) {
                    if (!actionCell.querySelector('button')) {
                        const player1 = match.player1_name || matchRow.querySelector('td:nth-child(2) strong')?.textContent || '–ò–≥—Ä–æ–∫ 1';
                        const player2 = match.player2_name || matchRow.querySelector('td:nth-child(3) strong')?.textContent || '–ò–≥—Ä–æ–∫ 2';
                        actionCell.innerHTML = `
                            <button class="btn btn-sm btn-outline-warning" 
                                    onclick="event.stopPropagation(); openRallyJournalModalV2(${match.id}, '${player1}', '${player2}')"
                                    title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π">
                                <i class="fas fa-book-open"></i>
                            </button>
                        `;
                        console.log(`[FreeMatches] ‚úÖ –ö–Ω–æ–ø–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è –º–∞—Ç—á–∞ ${match.id}`);
                    }
                } else {
                    if (actionCell.querySelector('button')) {
                        actionCell.innerHTML = '<span class="text-muted">‚Äî</span>';
                        console.log(`[FreeMatches] ‚úÖ –ö–Ω–æ–ø–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è –º–∞—Ç—á–∞ ${match.id}`);
                    }
                }
            }
        } else {
            console.warn(`[FreeMatches] ‚ö†Ô∏è –ú–∞—Ç—á ${match.id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM. –°–µ–ª–µ–∫—Ç–æ—Ä: ${selector}`);
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
            const allRows = document.querySelectorAll('tr.free-match-row');
            console.log(`[FreeMatches] üîç –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ: ${allRows.length}`);
            allRows.forEach((row, index) => {
                const rowMatchId = row.getAttribute('data-match-id');
                console.log(`[FreeMatches] üìã –°—Ç—Ä–æ–∫–∞ ${index}: data-match-id="${rowMatchId}"`);
            });
        }
    });
    
    console.log(`[FreeMatches] ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);
}

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function stopFreeMatchAutoRefresh() {
    if (freeMatchAutoRefreshInterval) {
        clearInterval(freeMatchAutoRefreshInterval);
        freeMatchAutoRefreshInterval = null;
        console.log('[FreeMatches] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
}

// BroadcastChannel –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
let freeMatchScoreUpdateChannel = null;

function setupFreeMatchScoreUpdateListener() {
    try {
        freeMatchScoreUpdateChannel = new BroadcastChannel('match-score-updates');
        freeMatchScoreUpdateChannel.onmessage = function(event) {
            const data = event.data;
            if (data.type === 'score-updated' && data.matchId) {
                console.log(`[FreeMatches] üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–ª—è –º–∞—Ç—á–∞ ${data.matchId}`, data);
                // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á—ë—Ç–∞
                console.log('[FreeMatches] üîÑ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á—ë—Ç–∞');
                updateFreeMatchesData();
                
                // –ï—Å–ª–∏ –∂—É—Ä–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ç—á–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Ç–æ–∂–µ
                const modal = document.getElementById('rallyJournalModalV2');
                if (modal) {
                    const modalStyle = window.getComputedStyle(modal);
                    const isModalVisible = modalStyle.display !== 'none' && !modal.classList.contains('d-none');
                    const modalMatchId = modal.getAttribute('data-match-id');
                    
                    if (isModalVisible && modalMatchId && parseInt(modalMatchId) === parseInt(data.matchId)) {
                        console.log(`[FreeMatches] üìñ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –º–∞—Ç—á–∞ ${data.matchId} (rallySaved: ${data.rallySaved || false})`);
                        // –ï—Å–ª–∏ –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Ä–æ–∑—ã–≥—Ä—ã—à, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
                        const delay = data.rallySaved ? 1000 : 500;
                        setTimeout(() => {
                            loadRallyJournalV2(data.matchId);
                        }, delay);
                    }
                }
            }
        };
        console.log('[FreeMatches] üì° –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –∏ –∂—É—Ä–Ω–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    } catch (error) {
        console.warn('[FreeMatches] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å BroadcastChannel:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function initializeFreeMatchesAutoRefresh() {
    console.log('[FreeMatches] üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    const tableRows = document.querySelectorAll('tr.free-match-row[data-match-id]');
    console.log(`[FreeMatches] üìã –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –º–∞—Ç—á–µ–π: ${tableRows.length}`);
    
    if (tableRows.length === 0) {
        console.warn('[FreeMatches] ‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ç—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 500–º—Å...');
        setTimeout(initializeFreeMatchesAutoRefresh, 500);
        return;
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
    setupFreeMatchScoreUpdateListener();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    console.log('[FreeMatches] üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
    startFreeMatchScoreAutoRefresh();
    
    console.log('[FreeMatches] ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[FreeMatches] üöÄ DOMContentLoaded - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
    initializeFreeMatchesAutoRefresh();
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        stopFreeMatchAutoRefresh();
    });
});

// –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ DOMContentLoaded —É–∂–µ –ø—Ä–æ—à–µ–ª)
if (document.readyState === 'loading') {
    console.log('[FreeMatches] üìã DOM –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥–µ–º DOMContentLoaded');
} else {
    console.log('[FreeMatches] üìã DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É');
    setTimeout(initializeFreeMatchesAutoRefresh, 100);
}
</script>

{% endblock %}

