<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>судейство - бадминтон</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }
        
        .container {
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        /* Панель управления слева */
        .control-panel {
            width: 80px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 2px solid #2E7D32;
            display: flex;
            flex-direction: column;
            padding: 8px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }
        
        .navigation-buttons {
            margin-bottom: 8px;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .control-panel button {
            width: 64px;
            height: 64px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .control-panel button:hover {
            background: #e0e0e0;
        }
        
        .control-panel .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .control-panel .btn-primary:hover {
            background: #0056b3;
        }
        
        .control-panel .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .control-panel .btn-warning:hover {
            background: #e0a800;
        }
        
        .control-panel .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .control-panel .btn-info:hover {
            background: #138496;
        }
        
        .control-panel .btn-success {
            background: #28a745;
            color: white;
        }
        
        .control-panel .btn-success:hover {
            background: #218838;
        }
        
        .control-panel .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .control-panel .btn-danger:hover {
            background: #c82333;
        }
        
        .control-panel .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .control-panel .btn-secondary:hover {
            background: #5a6268;
        }
        
        .save-result-btn {
            background: #ff6b6b;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        
        .save-result-btn:hover {
            background: #ee5a52;
        }
        
        /* Основная область корта */
        .court-area {
            flex: 1;
            position: relative;
            background: #ADDFAD;
            overflow: hidden;
        }
        
        /* Сетка корта */
        .court-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(to right, transparent 0, transparent 49px, rgba(255, 0, 0, 0.3) 49px, rgba(255, 0, 0, 0.3) 50px),
                repeating-linear-gradient(to bottom, transparent 0, transparent 49px, rgba(255, 0, 0, 0.3) 49px, rgba(255, 0, 0, 0.3) 50px);
        }
        
        /* Маркировка линий разметки */
        .grid-label {
            position: absolute;
            color: rgba(255, 0, 0, 0.7);
            font-weight: bold;
            font-size: 14px;
            z-index: 5;
            pointer-events: none;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        }
        
        /* Вертикальные линии - цифры (сверху) */
        .grid-label.vertical {
            top: 5px;
            transform: translateX(-50%);
        }
        
        /* Горизонтальные линии - буквы (слева) */
        .grid-label.horizontal {
            left: 5px;
            transform: translateY(-50%);
        }
        
        /* Центральная линия (сетка) */
        .net {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: white;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        /* Контейнер счета */
        .scoreboard {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }
        
        .score {
            font-size: 240px; /* Увеличено в 2 раза (было 120px) */
            font-weight: bold;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            user-select: none; /* Предотвращает выделение текста при клике */
        }
        
        .score-left {
            color: #0066ff;
        }
        
        .score-right {
            color: #ff3333;
        }
        
        .reset-btn {
            background: #ff3333;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .reset-btn:hover {
            background: #cc0000;
        }
        
        .reset-btn-text {
            display: inline;
        }
        
        /* Поля для имен игроков */
        .player-name {
            position: fixed;
            background: #D0F0C0;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 48px; /* Увеличено в 2 раза (было 24px) */
            font-weight: bold;
            border: none;
            width: 15vw; /* 15% от ширины viewport (родительского элемента) */
            text-align: left; /* Выравнивание по левой границе */
            z-index: 100;
            white-space: nowrap; /* Не переносить текст */
            overflow: hidden; /* Скрываем переполнение */
            text-overflow: ellipsis; /* Многоточие при переполнении */
        }
        
        .player-name:focus {
            outline: 2px solid #4CAF50;
        }
        
        /* КРИТИЧЕСКОЕ ПРАВИЛО: Позиционирование полей имен относительно линий разметки */
        #top_left_player_input {
            position: fixed !important;
            left: 10% !important;
            color: #0066ff !important;
        }
        
        #bottom_left_player_input {
            position: fixed !important;
            left: 10% !important;
            color: #0066ff !important;
        }
        
        #name_top_right {
            position: fixed !important;
            right: 10% !important;
            color: #ff3333 !important;
        }
        
        #name_bottom_right {
            position: fixed !important;
            right: 10% !important;
            color: #ff3333 !important;
        }
        
        /* Индикаторы подачи */
        .server-indicator {
            position: fixed;
            display: none;
            z-index: 200;
            pointer-events: none;
        }
        
        .server-indicator img {
            width: 40px;
            height: 40px;
        }
        
        /* Режим просмотра */
        .view-mode .control-panel {
            display: none;
        }
        
        .view-mode .score {
            font-size: 300px !important; /* Увеличено в 2 раза (было 150px) */
        }
        
        .view-mode .player-name {
            font-size: 72px !important; /* Увеличено в 2 раза (было 36px) */
        }
        
        /* Медиа-запрос для маленьких экранов (Viewport 791 x 303 и менее) с DevicePixelRatio 1.2 */
        @media screen and (max-width: 791px) and (max-height: 303px) and (-webkit-min-device-pixel-ratio: 1.2) and (-webkit-max-device-pixel-ratio: 2.74),
               screen and (max-width: 791px) and (max-height: 303px) and (min-resolution: 1.2dppx) and (max-resolution: 2.74dppx) {
            /* Кнопка обнулить - круг с крестиком диаметром 50px */
            .reset-btn {
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                min-width: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
            }
            
            .reset-btn i {
                margin: 0 !important;
            }
            
            .reset-btn-text {
                display: none !important;
            }
            
            /* Уменьшаем шрифт счёта на 30% (240px * 0.7 = 168px) */
            .score {
                font-size: 168px !important;
            }
            
            .view-mode .score {
                font-size: 210px !important; /* 300px * 0.7 = 210px */
            }
            
            /* Уменьшаем шрифт имён игроков на 25% (48px * 0.75 = 36px) */
            .player-name {
                font-size: 36px !important;
            }
            
            .view-mode .player-name {
                font-size: 54px !important; /* 72px * 0.75 = 54px */
            }
            
            /* Увеличиваем ширину полей имён игроков в 1.5 раза (15vw * 1.5 = 22.5vw) */
            .player-name {
                width: 22.5vw !important;
            }
            
            /* Опускаем нижние поля имён еще на 5% (было 9%, теперь 4%) */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: calc(10% - 6%) !important; /* Было 10%, теперь 4% от низа (опущено на 6%) */
            }
            
            /* Уменьшаем кнопки в левой панели для размещения всех на экране */
            .control-panel {
                padding: 2px !important; /* Еще больше уменьшаем padding */
            }
            
            .control-panel button {
                width: 36px !important;
                height: 36px !important;
                font-size: 14px !important;
            }
            
            .navigation-buttons {
                margin-bottom: 2px !important;
            }
            
            .controls {
                gap: 2px !important;
            }
            
            /* Уменьшаем ширину панели для экономии места */
            .control-panel {
                width: 44px !important; /* Было 80px, уменьшаем до 44px (36px кнопка + 4px padding с каждой стороны) */
            }
            
            /* Делаем окно с информацией об экране более прозрачным */
            .debug-screen-info {
                background: rgba(11, 112, 54, 0.5) !important; /* Было 0.9, теперь 0.5 - более прозрачное */
                top: 50px !important; /* Окно ниже чекбокса */
            }
            
            /* Чекбокс для маленьких экранов */
            .screen-info-checkbox-container {
                top: 8px !important;
                padding: 6px 12px !important;
            }
            
            .screen-info-checkbox-container label {
                font-size: 12px !important;
            }
            
            .screen-info-checkbox-container input[type="checkbox"] {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* Поднимаем цифры счёта на 5% */
            .scoreboard {
                top: 45% !important; /* Было 50%, теперь 45% (поднято на 5%) */
            }
        }
        
        /* Медиа-запрос для маленьких экранов (Viewport 791 x 303 и менее) с DevicePixelRatio 2.75 */
        @media screen and (max-width: 791px) and (max-height: 303px) and (-webkit-min-device-pixel-ratio: 2.75),
               screen and (max-width: 791px) and (max-height: 303px) and (min-resolution: 2.75dppx) {
            /* Кнопка обнулить - круг с крестиком диаметром 50px */
            .reset-btn {
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                min-width: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
            }
            
            .reset-btn i {
                margin: 0 !important;
            }
            
            .reset-btn-text {
                display: none !important;
            }
            
            /* Уменьшаем шрифт счёта на 25% (168px * 0.75 = 126px) */
            .score {
                font-size: 126px !important;
            }
            
            .view-mode .score {
                font-size: 158px !important; /* 210px * 0.75 = 157.5px, округлено до 158px */
            }
            
            /* Уменьшаем шрифт имён игроков на 20% (36px * 0.8 = 28.8px, округлено до 29px) */
            .player-name {
                font-size: 29px !important;
            }
            
            .view-mode .player-name {
                font-size: 43px !important; /* 54px * 0.8 = 43.2px, округлено до 43px */
            }
            
            /* Увеличиваем ширину полей имён игроков в 1.5 раза (15vw * 1.5 = 22.5vw) */
            .player-name {
                width: 22.5vw !important;
            }
            
            /* Опускаем нижние поля имён еще на 5% (было 4%, теперь 1%) */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: 1% !important; /* Было calc(10% - 6%) = 4%, опущено на 5% до 1% */
            }
            
            /* Уменьшаем кнопки в левой панели для размещения всех на экране */
            .control-panel {
                padding: 1px !important; /* Еще больше уменьшаем padding */
            }
            
            .control-panel button {
                width: 32px !important; /* Уменьшено с 36px до 32px */
                height: 32px !important; /* Уменьшено с 36px до 32px */
                font-size: 12px !important; /* Уменьшено с 14px до 12px */
            }
            
            .navigation-buttons {
                margin-bottom: 1px !important; /* Уменьшено с 2px до 1px */
            }
            
            .controls {
                gap: 1px !important; /* Уменьшено с 2px до 1px */
            }
            
            /* Уменьшаем ширину панели для экономии места */
            .control-panel {
                width: 38px !important; /* 32px кнопка + 3px padding с каждой стороны (1px padding + 1px gap) */
            }
            
            /* Делаем окно с информацией об экране более прозрачным */
            .debug-screen-info {
                background: rgba(11, 112, 54, 0.5) !important; /* Было 0.9, теперь 0.5 - более прозрачное */
                top: 50px !important; /* Окно ниже чекбокса */
            }
            
            /* Чекбокс для маленьких экранов */
            .screen-info-checkbox-container {
                top: 8px !important;
                padding: 6px 12px !important;
            }
            
            .screen-info-checkbox-container label {
                font-size: 12px !important;
            }
            
            .screen-info-checkbox-container input[type="checkbox"] {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* Поднимаем цифры счёта на 5% */
            .scoreboard {
                top: 45% !important; /* Было 50%, теперь 45% (поднято на 5%) */
            }
        }
        
        /* Медиа-запрос для маленьких экранов (Viewport 792 x 304 и менее) с DevicePixelRatio 2.75 */
        @media screen and (max-width: 792px) and (max-height: 304px) and (-webkit-min-device-pixel-ratio: 2.75),
               screen and (max-width: 792px) and (max-height: 304px) and (min-resolution: 2.75dppx) {
            /* Кнопка обнулить - круг с крестиком диаметром 50px */
            .reset-btn {
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                min-width: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
            }
            
            .reset-btn i {
                margin: 0 !important;
            }
            
            .reset-btn-text {
                display: none !important;
            }
            
            /* Уменьшаем шрифт счёта на 25% (240px * 0.75 = 180px) */
            .score {
                font-size: 180px !important;
            }
            
            .view-mode .score {
                font-size: 214px !important; /* 225px * 0.95 = 213.75px, округлено до 214px (уменьшено на 5%) */
            }
            
            /* Уменьшаем шрифт имён игроков на 20% (48px * 0.8 = 38.4px, округлено до 38px) */
            .player-name {
                font-size: 38px !important;
            }
            
            .view-mode .player-name {
                font-size: 58px !important; /* 72px * 0.8 = 57.6px, округлено до 58px */
            }
            
            /* Увеличиваем ширину полей имён игроков в 1.5 раза (15vw * 1.5 = 22.5vw) */
            .player-name {
                width: 22.5vw !important;
            }
            
            /* Опускаем нижние поля имён еще на 5% (от базового значения 10%) */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: calc(10% - 5%) !important; /* Базовое 10%, опущено на 5% = 5% */
            }
            
            /* Уменьшаем кнопки в левой панели для размещения всех на экране */
            .control-panel {
                padding: 1px !important;
            }
            
            .control-panel button {
                width: 32px !important;
                height: 32px !important;
                font-size: 12px !important;
            }
            
            .navigation-buttons {
                margin-bottom: 1px !important;
            }
            
            .controls {
                gap: 1px !important;
            }
            
            /* Уменьшаем ширину панели для экономии места */
            .control-panel {
                width: 38px !important; /* 32px кнопка + 3px padding с каждой стороны */
            }
            
            /* Делаем окно с информацией об экране более прозрачным */
            .debug-screen-info {
                background: rgba(11, 112, 54, 0.5) !important;
                top: 50px !important; /* Окно ниже чекбокса */
            }
            
            /* Чекбокс для маленьких экранов */
            .screen-info-checkbox-container {
                top: 8px !important;
                padding: 6px 12px !important;
            }
            
            .screen-info-checkbox-container label {
                font-size: 12px !important;
            }
            
            .screen-info-checkbox-container input[type="checkbox"] {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* Поднимаем цифры счёта на 5% */
            .scoreboard {
                top: 45% !important; /* Было 50%, теперь 45% (поднято на 5%) */
            }
            
            /* Поднимаем цифры счёта на 2% в режиме просмотра (было 50%, теперь 48%) */
            .view-mode .scoreboard {
                top: 48% !important;
            }
            
            /* Делаем фон полей имён игроков прозрачным */
            .player-name {
                background: transparent !important;
            }
        }
        
        /* Медиа-запрос для маленьких экранов (Viewport 792 x 304 и менее) с DevicePixelRatio 1.20 */
        @media screen and (max-width: 792px) and (max-height: 304px) and (-webkit-min-device-pixel-ratio: 1.2) and (-webkit-max-device-pixel-ratio: 2.74),
               screen and (max-width: 792px) and (max-height: 304px) and (min-resolution: 1.2dppx) and (max-resolution: 2.74dppx) {
            /* Кнопка обнулить - круг с крестиком диаметром 50px */
            .reset-btn {
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                min-width: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
            }
            
            .reset-btn i {
                margin: 0 !important;
            }
            
            .reset-btn-text {
                display: none !important;
            }
            
            /* Уменьшаем шрифт счёта на 25% (240px * 0.75 = 180px) */
            .score {
                font-size: 180px !important;
            }
            
            .view-mode .score {
                font-size: 214px !important; /* 225px * 0.95 = 213.75px, округлено до 214px (уменьшено на 5%) */
            }
            
            /* Уменьшаем шрифт имён игроков на 20% (48px * 0.8 = 38.4px, округлено до 38px) */
            .player-name {
                font-size: 38px !important;
            }
            
            .view-mode .player-name {
                font-size: 58px !important; /* 72px * 0.8 = 57.6px, округлено до 58px */
            }
            
            /* Увеличиваем ширину полей имён игроков в 1.5 раза (15vw * 1.5 = 22.5vw) */
            .player-name {
                width: 22.5vw !important;
            }
            
            /* Опускаем нижние поля имён еще на 5% (от базового значения 10%) */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: calc(10% - 5%) !important; /* Базовое 10%, опущено на 5% = 5% */
            }
            
            /* Уменьшаем кнопки в левой панели для размещения всех на экране */
            .control-panel {
                padding: 1px !important;
            }
            
            .control-panel button {
                width: 32px !important;
                height: 32px !important;
                font-size: 12px !important;
            }
            
            .navigation-buttons {
                margin-bottom: 1px !important;
            }
            
            .controls {
                gap: 1px !important;
            }
            
            /* Уменьшаем ширину панели для экономии места */
            .control-panel {
                width: 38px !important; /* 32px кнопка + 3px padding с каждой стороны */
            }
            
            /* Делаем окно с информацией об экране более прозрачным */
            .debug-screen-info {
                background: rgba(11, 112, 54, 0.5) !important;
                top: 50px !important; /* Окно ниже чекбокса */
            }
            
            /* Чекбокс для маленьких экранов */
            .screen-info-checkbox-container {
                top: 8px !important;
                padding: 6px 12px !important;
            }
            
            .screen-info-checkbox-container label {
                font-size: 12px !important;
            }
            
            .screen-info-checkbox-container input[type="checkbox"] {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* Поднимаем цифры счёта на 5% */
            .scoreboard {
                top: 45% !important; /* Было 50%, теперь 45% (поднято на 5%) */
            }
            
            /* Поднимаем цифры счёта на 2% в режиме просмотра (было 50%, теперь 48%) */
            .view-mode .scoreboard {
                top: 48% !important;
            }
            
            /* Делаем фон полей имён игроков прозрачным */
            .player-name {
                background: transparent !important;
            }
        }
        
        /* Медиа-запрос для маленьких экранов (Viewport 793 x 305 и менее) с DevicePixelRatio 2.75 */
        @media screen and (max-width: 793px) and (max-height: 305px) and (-webkit-min-device-pixel-ratio: 2.75),
               screen and (max-width: 793px) and (max-height: 305px) and (min-resolution: 2.75dppx) {
            /* Кнопка обнулить - круг с крестиком диаметром 50px */
            .reset-btn {
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                min-width: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
            }
            
            .reset-btn i {
                margin: 0 !important;
            }
            
            .reset-btn-text {
                display: none !important;
            }
            
            /* Уменьшаем шрифт счёта на 25% (240px * 0.75 = 180px) */
            .score {
                font-size: 180px !important;
            }
            
            .view-mode .score {
                font-size: 225px !important; /* 300px * 0.75 = 225px */
            }
            
            /* Уменьшаем шрифт имён игроков на 20% (48px * 0.8 = 38.4px, округлено до 38px) */
            .player-name {
                font-size: 38px !important;
            }
            
            .view-mode .player-name {
                font-size: 58px !important; /* 72px * 0.8 = 57.6px, округлено до 58px */
            }
            
            /* Увеличиваем ширину полей имён игроков в 1.5 раза (15vw * 1.5 = 22.5vw) */
            .player-name {
                width: 22.5vw !important;
            }
            
            /* Опускаем нижние поля имён еще на 5% (от базового значения 10%) */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: calc(10% - 5%) !important; /* Базовое 10%, опущено на 5% = 5% */
            }
            
            /* Уменьшаем кнопки в левой панели для размещения всех на экране */
            .control-panel {
                padding: 1px !important;
            }
            
            .control-panel button {
                width: 32px !important;
                height: 32px !important;
                font-size: 12px !important;
            }
            
            .navigation-buttons {
                margin-bottom: 1px !important;
            }
            
            .controls {
                gap: 1px !important;
            }
            
            /* Уменьшаем ширину панели для экономии места */
            .control-panel {
                width: 38px !important; /* 32px кнопка + 3px padding с каждой стороны */
            }
            
            /* Делаем окно с информацией об экране более прозрачным */
            .debug-screen-info {
                background: rgba(11, 112, 54, 0.5) !important;
            }
            
            /* Поднимаем цифры счёта на 5% */
            .scoreboard {
                top: 45% !important; /* Было 50%, теперь 45% (поднято на 5%) */
            }
            
            /* Настройки для режима просмотра */
            /* Убираем кнопку "Обнулить" в режиме просмотра */
            .view-mode .reset-btn {
                display: none !important;
            }
            
            /* Увеличиваем шрифт счёта на 15% в режиме просмотра (225px * 1.15 = 258.75px, округлено до 259px) */
            .view-mode .score {
                font-size: 259px !important;
            }
            
            /* Уменьшаем шрифт имён игроков на 30% в режиме просмотра (58px * 0.7 = 40.6px, округлено до 41px) */
            .view-mode .player-name {
                font-size: 41px !important;
            }
            
            /* Размещаем имена игроков в углы экрана в режиме просмотра */
            .view-mode #top_left_player_input {
                top: 0 !important;
                left: 0 !important;
                transform: none !important;
            }
            
            .view-mode #name_top_right {
                top: 0 !important;
                right: 0 !important;
                transform: none !important;
            }
            
            .view-mode #bottom_left_player_input {
                bottom: 0 !important;
                left: 0 !important;
                transform: none !important;
            }
            
            .view-mode #name_bottom_right {
                bottom: 0 !important;
                right: 0 !important;
                transform: none !important;
            }
            
            /* Кнопка Back в режиме просмотра - круг диаметром 50px со стрелкой, внизу по середине */
            .view-mode .back-btn-view {
                position: fixed !important;
                bottom: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                background: rgba(102, 102, 102, 0.8) !important;
                color: white !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
                cursor: pointer !important;
                z-index: 1000 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            }
            
            .view-mode .back-btn-view:hover {
                background: rgba(102, 102, 102, 1) !important;
            }
        }
        
        /* Медиа-запрос для маленьких экранов (Viewport 793 x 305 и менее) с DevicePixelRatio 1.20 */
        @media screen and (max-width: 793px) and (max-height: 305px) and (-webkit-min-device-pixel-ratio: 1.2) and (-webkit-max-device-pixel-ratio: 2.74),
               screen and (max-width: 793px) and (max-height: 305px) and (min-resolution: 1.2dppx) and (max-resolution: 2.74dppx) {
            /* Кнопка обнулить - круг с крестиком диаметром 50px */
            .reset-btn {
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                min-width: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
            }
            
            .reset-btn i {
                margin: 0 !important;
            }
            
            .reset-btn-text {
                display: none !important;
            }
            
            /* Уменьшаем шрифт счёта на 25% (240px * 0.75 = 180px) */
            .score {
                font-size: 180px !important;
            }
            
            .view-mode .score {
                font-size: 225px !important; /* 300px * 0.75 = 225px */
            }
            
            /* Уменьшаем шрифт имён игроков на 20% (48px * 0.8 = 38.4px, округлено до 38px) */
            .player-name {
                font-size: 38px !important;
            }
            
            .view-mode .player-name {
                font-size: 58px !important; /* 72px * 0.8 = 57.6px, округлено до 58px */
            }
            
            /* Увеличиваем ширину полей имён игроков в 1.5 раза (15vw * 1.5 = 22.5vw) */
            .player-name {
                width: 22.5vw !important;
            }
            
            /* Опускаем нижние поля имён еще на 5% (от базового значения 10%) */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: calc(10% - 5%) !important; /* Базовое 10%, опущено на 5% = 5% */
            }
            
            /* Уменьшаем кнопки в левой панели для размещения всех на экране */
            .control-panel {
                padding: 1px !important;
            }
            
            .control-panel button {
                width: 32px !important;
                height: 32px !important;
                font-size: 12px !important;
            }
            
            .navigation-buttons {
                margin-bottom: 1px !important;
            }
            
            .controls {
                gap: 1px !important;
            }
            
            /* Уменьшаем ширину панели для экономии места */
            .control-panel {
                width: 38px !important; /* 32px кнопка + 3px padding с каждой стороны */
            }
            
            /* Делаем окно с информацией об экране более прозрачным */
            .debug-screen-info {
                background: rgba(11, 112, 54, 0.5) !important;
            }
            
            /* Поднимаем цифры счёта на 5% */
            .scoreboard {
                top: 45% !important; /* Было 50%, теперь 45% (поднято на 5%) */
            }
            
            /* Настройки для режима просмотра */
            /* Убираем кнопку "Обнулить" в режиме просмотра */
            .view-mode .reset-btn {
                display: none !important;
            }
            
            /* Увеличиваем шрифт счёта на 15% в режиме просмотра (225px * 1.15 = 258.75px, округлено до 259px) */
            .view-mode .score {
                font-size: 259px !important;
            }
            
            /* Уменьшаем шрифт имён игроков на 30% в режиме просмотра (58px * 0.7 = 40.6px, округлено до 41px) */
            .view-mode .player-name {
                font-size: 41px !important;
            }
            
            /* Размещаем имена игроков в углы экрана в режиме просмотра */
            .view-mode #top_left_player_input {
                top: 0 !important;
                left: 0 !important;
                transform: none !important;
            }
            
            .view-mode #name_top_right {
                top: 0 !important;
                right: 0 !important;
                transform: none !important;
            }
            
            .view-mode #bottom_left_player_input {
                bottom: 0 !important;
                left: 0 !important;
                transform: none !important;
            }
            
            .view-mode #name_bottom_right {
                bottom: 0 !important;
                right: 0 !important;
                transform: none !important;
            }
            
            /* Кнопка Back в режиме просмотра - круг диаметром 50px со стрелкой, внизу по середине */
            .view-mode .back-btn-view {
                position: fixed !important;
                bottom: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                background: rgba(102, 102, 102, 0.8) !important;
                color: white !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 24px !important;
                cursor: pointer !important;
                z-index: 1000 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            }
            
            .view-mode .back-btn-view:hover {
                background: rgba(102, 102, 102, 1) !important;
            }
        }
        
        /* Медиа-запрос для Redme 4x (Viewport 642 x 281 и меньше) с DevicePixelRatio 2.00 */
        @media screen and (max-width: 642px) and (max-height: 281px) and (-webkit-min-device-pixel-ratio: 2.0) and (-webkit-max-device-pixel-ratio: 2.0),
               screen and (max-width: 642px) and (max-height: 281px) and (min-resolution: 2.0dppx) and (max-resolution: 2.0dppx) {
            /* Уменьшаем шрифт имён игроков на 20% (48px * 0.8 = 38.4px, округлено до 38px) */
            .player-name {
                font-size: 38px !important;
            }
            
            .view-mode .player-name {
                font-size: 58px !important; /* 72px * 0.8 = 57.6px, округлено до 58px */
            }
            
            /* Поднимаем верхние имена на 10px */
            #top_left_player_input,
            #name_top_right {
                transform: translateY(-10px) !important;
            }
            
            /* Настройки чекбокса: без надписи, уменьшенный размер, расширяющееся поле до 80px */
            .screen-info-checkbox-container {
                width: auto !important;
                max-width: 80px !important;
                padding: 6px 8px !important;
            }
            
            .screen-info-checkbox-container label {
                font-size: 0 !important; /* Скрываем текст */
                line-height: 0 !important;
                gap: 0 !important;
            }
            
            /* Уменьшаем размер чекбокса на 20% (18px * 0.8 = 14.4px, округлено до 14px) */
            .screen-info-checkbox-container input[type="checkbox"] {
                width: 14px !important;
                height: 14px !important;
            }
            
            /* Поля имён игроков расширяющиеся в зависимости от длины имени: минимум 18vw, максимум 30vw */
            .player-name {
                width: auto !important;
                min-width: 18vw !important;
                max-width: 30vw !important;
                text-align: center !important; /* Выравнивание по центру */
            }
            
            /* Сдвигаем правые поля вправо на 5% (было 10%, теперь 5%) */
            #name_top_right,
            #name_bottom_right {
                right: 5% !important;
            }
        }
        
        /* Медиа-запрос для Redme 4x (Viewport 642 x 281 и меньше) с DevicePixelRatio 1.20 */
        @media screen and (max-width: 642px) and (max-height: 281px) and (-webkit-min-device-pixel-ratio: 1.2) and (-webkit-max-device-pixel-ratio: 1.2),
               screen and (max-width: 642px) and (max-height: 281px) and (min-resolution: 1.2dppx) and (max-resolution: 1.2dppx) {
            /* Уменьшаем шрифт имён игроков на 20% (48px * 0.8 = 38.4px, округлено до 38px) */
            .player-name {
                font-size: 38px !important;
            }
            
            .view-mode .player-name {
                font-size: 58px !important; /* 72px * 0.8 = 57.6px, округлено до 58px */
            }
            
            /* Поднимаем верхние имена на 10px */
            #top_left_player_input,
            #name_top_right {
                transform: translateY(-10px) !important;
            }
            
            /* Настройки чекбокса: без надписи, уменьшенный размер, расширяющееся поле до 80px */
            .screen-info-checkbox-container {
                width: auto !important;
                max-width: 80px !important;
                padding: 6px 8px !important;
            }
            
            .screen-info-checkbox-container label {
                font-size: 0 !important; /* Скрываем текст */
                line-height: 0 !important;
                gap: 0 !important;
            }
            
            /* Уменьшаем размер чекбокса на 20% (18px * 0.8 = 14.4px, округлено до 14px) */
            .screen-info-checkbox-container input[type="checkbox"] {
                width: 14px !important;
                height: 14px !important;
            }
            
            /* Поля имён игроков расширяющиеся в зависимости от длины имени: минимум 18vw, максимум 30vw */
            .player-name {
                width: auto !important;
                min-width: 18vw !important;
                max-width: 30vw !important;
                text-align: center !important; /* Выравнивание по центру */
            }
            
            /* Сдвигаем правые поля вправо на 5% (было 10%, теперь 5%) */
            #name_top_right,
            #name_bottom_right {
                right: 5% !important;
            }
        }
        
        /* Медиа-запрос для Viewport 643 x 285 и меньше с DevicePixelRatio 2.00 */
        @media screen and (max-width: 643px) and (max-height: 285px) and (-webkit-min-device-pixel-ratio: 2.0) and (-webkit-max-device-pixel-ratio: 2.0),
               screen and (max-width: 643px) and (max-height: 285px) and (min-resolution: 2.0dppx) and (max-resolution: 2.0dppx) {
            /* Уменьшаем шрифт имён игроков на 50% (48px * 0.5 = 24px) */
            .player-name {
                font-size: 24px !important;
            }
            
            .view-mode .player-name {
                font-size: 36px !important; /* 72px * 0.5 = 36px */
            }
        }
        
        /* Медиа-запрос для Viewport 643 x 285 и меньше с DevicePixelRatio 1.20 */
        @media screen and (max-width: 643px) and (max-height: 285px) and (-webkit-min-device-pixel-ratio: 1.2) and (-webkit-max-device-pixel-ratio: 1.2),
               screen and (max-width: 643px) and (max-height: 285px) and (min-resolution: 1.2dppx) and (max-resolution: 1.2dppx) {
            /* Уменьшаем шрифт имён игроков на 50% (48px * 0.5 = 24px) */
            .player-name {
                font-size: 24px !important;
            }
            
            .view-mode .player-name {
                font-size: 36px !important; /* 72px * 0.5 = 36px */
            }
        }
        
        /* Медиа-запрос для Viewport 796 x 307 и более */
        @media screen and (min-width: 796px) and (min-height: 307px) {
            /* Опускаем нижние поля имён на 100px выше нижней границы экрана */
            #bottom_left_player_input,
            #name_bottom_right {
                bottom: 100px !important;
            }
        }
        
        /* Кнопка возврата */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 100px;
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
        }
        
        /* Чекбокс для показа свойств экрана */
        .screen-info-checkbox-container {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .screen-info-checkbox-container label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #2E7D32;
            user-select: none;
        }
        
        .screen-info-checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2E7D32;
        }
        
        /* Блок информации о размере экрана */
        .debug-screen-info {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(11, 112, 54, 0.9);
            border: 2px solid #2E7D32;
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: #fff;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: none;
        }
        
        .debug-screen-info.visible {
            display: block;
        }
        
        .debug-screen-info .debug-title {
            font-weight: bold;
            color: #d4edda;
            border-bottom: 1px solid #2E7D32;
            padding-bottom: 5px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .debug-screen-info .debug-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-screen-info .debug-label {
            color: #d4edda;
            margin-right: 10px;
        }
        
        .debug-screen-info .debug-value {
            color: #fff;
            font-weight: bold;
            text-align: right;
        }
        
        .debug-screen-info .debug-important {
            background: rgba(46, 125, 50, 0.3);
            padding: 3px 5px;
            border-radius: 4px;
            margin: 3px 0;
        }
        
        .debug-screen-info .debug-note {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 10px;
            color: #d4edda;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Чекбокс для показа свойств экрана -->
    <div class="screen-info-checkbox-container">
        <label for="showScreenInfo">
            <input type="checkbox" id="showScreenInfo">
            Показать свойства экрана
        </label>
    </div>
    
    <div class="container">
        <!-- Панель управления -->
        <div class="control-panel">
            <!-- Кнопки навигации -->
            <div class="navigation-buttons">
                <button id="btnBack" class="btn-secondary" title="Назад" onclick="handleBack()">←</button>
            </div>
            
            <!-- Кнопки управления -->
            <div class="controls">
                <button id="btnViewMode" class="btn-primary" title="Режим просмотра для игроков">👁️</button>
                <button id="btnUndo" class="btn-warning" title="Отменить">↶</button>
                <button id="btnMoveShuttlecock" class="btn-info" title="Переместить подачу">↻</button>
                <button id="btnSwapTeams" class="btn-success" title="Поменять команды местами">⇄</button>
                <button id="btnSwapLeftTeam" class="btn-info" title="Поменять игроков в левой команде">⇅</button>
                <button id="btnSwapRightTeam" class="btn-danger" title="Поменять игроков в правой команде">⇅</button>
                <button id="btnToggleJournal" class="btn-secondary" title="Журнал подач">📋</button>
                <button id="btnSaveResult" class="save-result-btn" style="display: none;" title="Сохранить счёт">↓</button>
            </div>
        </div>
        
        <!-- Область корта -->
        <div class="court-area">
            <!-- Сетка -->
            <div class="court-grid"></div>
            
            <!-- Маркировка вертикальных линий (цифры) -->
            <div id="vertical-labels"></div>
            
            <!-- Маркировка горизонтальных линий (буквы) -->
            <div id="horizontal-labels"></div>
            
            <!-- Сетка (центральная линия) -->
            <div class="net"></div>
            
            <!-- Левая половина корта -->
            <div id="court_left" style="position: absolute; left: 0; top: 0; width: 50%; height: 100%; cursor: pointer;" title="Кликните для увеличения счета левой команды"></div>
            
            <!-- Правая половина корта -->
            <div id="court_right" style="position: absolute; right: 0; top: 0; width: 50%; height: 100%; cursor: pointer;" title="Кликните для увеличения счета правой команды"></div>
            
            <!-- Счет -->
        <div class="scoreboard">
            <div class="score score-left" id="scoreLeft">0</div>
            <button class="reset-btn" onclick="resetScore()" title="Обнулить счёт">
                <i class="fas fa-times"></i>
                <span class="reset-btn-text">Обнулить</span>
            </button>
            <div class="score score-right" id="scoreRight">0</div>
        </div>
        <!-- Временное отображение swap_count и teamsSwapped для отладки -->
        <div id="swapCountDisplay" style="position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 15px; border-radius: 5px; font-size: 18px; font-weight: bold; z-index: 10000;">
            swap_count: <span id="swapCountValue">0</span><br>
            teamsSwapped: <span id="teamsSwappedValue">false</span>
        </div>
        <!-- Кнопка Back для режима просмотра -->
        <button class="back-btn-view" onclick="handleBack()" title="Назад" style="display: none;">
            <i class="fas fa-arrow-left"></i>
        </button>
            
            <!-- Поля для имен игроков -->
            {# Упрощенная обработка participant1 #}
            {# Алгоритм: если есть тире "-", разделяем на части; если нет - дублируем имя в оба поля #}
            {% if '-' in participant1 %}
                {# Если есть тире, разделяем на части #}
                {# Поддержка форматов: "Маша - Оля" или "Маша-Оля" #}
                {% if ' - ' in participant1 %}
                    {% set p1_parts = participant1.split(' - ', 1) %}
                {% else %}
                    {% set p1_parts = participant1.split('-', 1) %}
                {% endif %}
                {# Пример: "Маша - Оля" -> нижний левый: Маша, верхний левый: Оля #}
                <input type="text" 
                       class="player-name" 
                       id="top_left_player_input" 
                       placeholder="Игрок 1" 
                       value="{{ p1_parts[1].strip() if p1_parts|length > 1 else participant1 }}">
                <input type="text" 
                       class="player-name" 
                       id="bottom_left_player_input" 
                       placeholder="Игрок 1" 
                       value="{{ p1_parts[0].strip() if p1_parts|length > 1 else participant1 }}">
            {% else %}
                {# Если нет тире, показываем имя в обоих полях #}
                <input type="text" 
                       class="player-name" 
                       id="top_left_player_input" 
                       placeholder="Игрок 1" 
                       value="{{ participant1 }}">
                <input type="text" 
                       class="player-name" 
                       id="bottom_left_player_input" 
                       placeholder="Игрок 1" 
                       value="{{ participant1 }}">
            {% endif %}
            
            {# Упрощенная обработка participant2 #}
            {# Алгоритм: если есть тире "-", разделяем на части; если нет - дублируем имя в оба поля #}
            {% if '-' in participant2 %}
                {# Если есть тире, разделяем на части #}
                {# Поддержка форматов: "Надя - Галя" или "Надя-Галя" #}
                {% if ' - ' in participant2 %}
                    {% set p2_parts = participant2.split(' - ', 1) %}
                {% else %}
                    {% set p2_parts = participant2.split('-', 1) %}
                {% endif %}
                {# Пример: "Надя - Галя" -> верхний правый: Надя, нижний правый: Галя #}
                <input type="text" 
                       class="player-name" 
                       id="name_top_right" 
                       placeholder="Игрок 2" 
                       value="{{ p2_parts[0].strip() if p2_parts|length > 1 else participant2 }}">
                <input type="text" 
                       class="player-name" 
                       id="name_bottom_right" 
                       placeholder="Игрок 2" 
                       value="{{ p2_parts[1].strip() if p2_parts|length > 1 else participant2 }}">
            {% else %}
                {# Если нет тире, показываем имя в обоих полях #}
                <input type="text" 
                       class="player-name" 
                       id="name_top_right" 
                       placeholder="Игрок 2" 
                       value="{{ participant2 }}">
                <input type="text" 
                       class="player-name" 
                       id="name_bottom_right" 
                       placeholder="Игрок 2" 
                       value="{{ participant2 }}">
            {% endif %}
            
            <!-- Индикаторы подачи -->
            <div class="server-indicator" id="server_top_left">
                <img src="/static/referee/img_01.png" alt="Подающий">
            </div>
            <div class="server-indicator" id="server_bottom_left">
                <img src="/static/referee/img_01.png" alt="Подающий">
            </div>
            <div class="server-indicator" id="server_top_right">
                <img src="/static/referee/img_01.png" alt="Подающий">
            </div>
            <div class="server-indicator" id="server_bottom_right">
                <img src="/static/referee/img_01.png" alt="Подающий">
            </div>
        </div>
    </div>
    
    <!-- Блок информации о размере экрана -->
    <div id="debugScreenInfo" class="debug-screen-info">
        <div class="debug-title">📱 Размеры экрана</div>
        <div class="debug-item debug-important">
            <span class="debug-label">Viewport ⭐:</span>
            <span class="debug-value" id="debugViewportSize">-</span>
        </div>
        <div class="debug-item debug-important">
            <span class="debug-label">Window:</span>
            <span class="debug-value" id="debugWindowSize">-</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">Screen:</span>
            <span class="debug-value" id="debugScreenSize">-</span>
        </div>
        <div class="debug-item debug-important">
            <span class="debug-label">Ориентация:</span>
            <span class="debug-value" id="debugOrientation">-</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">Device Pixel Ratio:</span>
            <span class="debug-value" id="debugDPR">-</span>
        </div>
        <div class="debug-note">
            ⭐ Viewport - основное значение для CSS (vw/vh, медиа-запросы)
        </div>
    </div>
    
    <script>
        // Переменные
        let scoreLeft = 0;
        let scoreRight = 0;
        let teamsSwapped = false; // Флаг для отслеживания, были ли команды поменяны местами
        let swap_count = 0; // Счётчик смен половин корта (инициализируется при открытии страницы для сета)
        let gameHistory = [];
        let shuttlecockPosition = 'bottom_left'; // Позиция воланчика
        let isViewMode = false;
        let journalVisible = false;
        
        // Переменные для хранения исходного состояния перед отражением
        let originalState = {
            scoreLeft: 0,
            scoreRight: 0,
            topLeftName: '',
            bottomLeftName: '',
            topRightName: '',
            bottomRightName: '',
            shuttlecockPosition: '',
            topLeftColor: '',
            bottomLeftColor: '',
            topRightColor: '',
            bottomRightColor: '',
            scoreLeftColor: '',
            scoreRightColor: ''
        };
        
        // Сохранение состояния игры для отмены
        function saveGameState() {
            gameHistory.push({
                scoreLeft: scoreLeft,
                scoreRight: scoreRight,
                swap_count: swap_count,
                shuttlecockPosition: shuttlecockPosition,
                teamsSwapped: teamsSwapped
            });
            // Ограничиваем историю 50 записями
            if (gameHistory.length > 50) {
                gameHistory.shift();
            }
        }
        
        // Обновление счета
        // Переменная для отслеживания таймера сохранения (debounce)
        let saveScoreTimeout = null;
        
        // Функция для сохранения счёта в базу данных
        function saveScoreToDatabase() {
            // Получаем параметры из URL
            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get('match_id');
            const setNumber = urlParams.get('set') || '1';
            
            // Если нет match_id, значит это не матч из турнира, не сохраняем
            if (!matchId || matchId === '') {
                return;
            }
            
            // Получаем текущий счёт
            // ВАЖНО: Логика записи счёта:
            //        - Если слева синий цвет → Участнику 1 (participant1, score1) записать счёт с левой половины корта
            //        - Если слева красный цвет → Участнику 2 (participant2, score2) записать счёт с левой половины корта
            //        - Если справа синий цвет → Участнику 1 (participant1, score1) записать счёт с правой половины корта
            //        - Если справа красный цвет → Участнику 2 (participant2, score2) записать счёт с правой половины корта
            //        Для страницы "Демонстрация" или "Просмотр" (view-mode) - наоборот, так как это зеркальная страница
            
            // Определяем, какой счёт синий, а какой красный по цвету на экране
            const scoreLeftEl = document.getElementById('scoreLeft');
            const scoreRightEl = document.getElementById('scoreRight');
            
            if (!scoreLeftEl || !scoreRightEl) {
                console.error('[Referee] ❌ Элементы счёта не найдены');
                return;
            }
            
            // Проверяем классы элементов напрямую (более надёжный способ)
            // score-left = синий цвет (#0066ff), score-right = красный цвет (#ff3333)
            const leftScoreClasses = scoreLeftEl.className || '';
            const rightScoreClasses = scoreRightEl.className || '';
            
            // Получаем цвет счёта с экрана (для логирования)
            const leftScoreColor = window.getComputedStyle(scoreLeftEl).color;
            const rightScoreColor = window.getComputedStyle(scoreRightEl).color;
            
            // ВАЖНО: Классы элементов НЕ меняются при переключении команд!
            // scoreLeft всегда имеет класс 'score-left' (синий)
            // scoreRight всегда имеет класс 'score-right' (красный)
            // Но при переключении команд значения scoreLeft и scoreRight меняются местами!
            
            // Определяем режим просмотра (зеркальная страница)
            const isViewMode = document.body.classList.contains('view-mode');
            
            // Определяем счёт для participant1 (score1) и participant2 (score2)
            // Используем swap_count для определения соответствия
            // Если swap_count % 2 == 0: левый счёт → participant1, правый → participant2
            // Если swap_count % 2 == 1: правый счёт → participant1, левый → participant2
            let score1, score2;
            
            if (swap_count % 2 == 0) {
                // Чётное количество смен: левый счёт → participant1, правый → participant2
                score1 = scoreLeft;
                score2 = scoreRight;
            } else {
                // Нечётное количество смен: правый счёт → participant1, левый → participant2
                score1 = scoreRight;
                score2 = scoreLeft;
            }
            
            // Получаем имена для логирования
            const topLeftName = document.getElementById('top_left_player_input')?.value || '';
            const bottomLeftName = document.getElementById('bottom_left_player_input')?.value || '';
            const topRightName = document.getElementById('name_top_right')?.value || '';
            const bottomRightName = document.getElementById('name_bottom_right')?.value || '';
            
            let leftTeamName = topLeftName;
            if (bottomLeftName && bottomLeftName !== topLeftName) {
                leftTeamName = `${bottomLeftName} - ${topLeftName}`;
            } else if (!leftTeamName) {
                leftTeamName = bottomLeftName;
            }
            
            let rightTeamName = topRightName;
            if (bottomRightName && bottomRightName !== topRightName) {
                rightTeamName = `${topRightName} - ${bottomRightName}`;
            } else if (!rightTeamName) {
                rightTeamName = bottomRightName;
            }
            
            // Логирование для отладки
            console.log('[Referee] 💾 Сохранение счёта в БД:', {
                swap_count,
                swap_count_mod_2: swap_count % 2,
                teamsSwapped,
                'Текущий счёт на экране': `scoreLeft = ${scoreLeft}, scoreRight = ${scoreRight}`,
                'Команды на экране': `Слева: ${leftTeamName}, Справа: ${rightTeamName}`,
                'Логика применения': swap_count % 2 == 0 ? 'Чётное: score1=scoreLeft, score2=scoreRight' : 'Нечётное: score1=scoreRight, score2=scoreLeft',
                'Сохранение в БД': `score1 (participant1) = ${score1}, score2 (participant2) = ${score2}`,
                'Проверка': swap_count % 2 == 1 ? `При swap_count=1: score1 должен быть правым (${scoreRight}), score2 должен быть левым (${scoreLeft})` : 'OK',
                'Победитель': score1 > score2 ? 'participant1' : score2 > score1 ? 'participant2' : 'Ничья'
            });
            
            // Получаем CSRF токен
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken) {
                console.warn('[Referee] CSRF токен не найден');
                return;
            }
            
            // Подготавливаем данные для отправки
            const data = {
                score1: score1,
                score2: score2,
                set_number: parseInt(setNumber) || 1
            };
            
            // Детальное логирование перед отправкой
            console.log('[Referee] 📤 Отправка данных в БД:', {
                swap_count,
                swap_count_mod_2: swap_count % 2,
                'scoreLeft на экране': scoreLeft,
                'scoreRight на экране': scoreRight,
                'score1 (participant1)': score1,
                'score2 (participant2)': score2,
                'Проверка логики': swap_count % 2 == 1 ? 
                    `При swap_count=1: score1 должен быть scoreRight (${scoreRight}), score2 должен быть scoreLeft (${scoreLeft})` :
                    `При swap_count=0: score1 должен быть scoreLeft (${scoreLeft}), score2 должен быть scoreRight (${scoreRight})`,
                'Отправляемые данные': data
            });
            
            // Отправляем запрос на сохранение
            fetch(`/api/matches/${matchId}/auto-save-score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('[Referee] ✅ Счёт сохранён в БД:', result.message);
                    console.log('[Referee] 📊 Текущий счёт:', score1, ':', score2, 'для матча', matchId, 'сет', setNumber);
                    
                    // Получаем параметры из URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const matchIdFromUrl = urlParams.get('match_id') || '';
                    const setNumberFromUrl = urlParams.get('set') || '1';
                    
                    // Получаем текущий счёт
                    let currentScoreLeft = scoreLeft;
                    let currentScoreRight = scoreRight;
                    
                    // Формируем имена участников из полей
                    const topLeftName = document.getElementById('top_left_player_input').value || '';
                    const bottomLeftName = document.getElementById('bottom_left_player_input').value || '';
                    const topRightName = document.getElementById('name_top_right').value || '';
                    const bottomRightName = document.getElementById('name_bottom_right').value || '';
                    
                    // Если верхнее и нижнее имена разные, объединяем через " - "
                    let participant1Name = topLeftName;
                    if (bottomLeftName && bottomLeftName !== topLeftName) {
                        participant1Name = bottomLeftName + ' - ' + topLeftName;
                    }
                    
                    let participant2Name = topRightName;
                    if (bottomRightName && bottomRightName !== topRightName) {
                        participant2Name = topRightName + ' - ' + bottomRightName;
                    }
                    
                    // Отправляем результат в родительское окно (форму Результат), если оно открыто
                    // Это обновит таблицы Расписание и Турнирная через механизм формы Результат
                    // Используем отдельный тип сообщения для автообновления, чтобы не закрывать окно
                    if (window.opener && !window.opener.closed) {
                        try {
                            const resultData = {
                                type: 'refereeResultAutoUpdate', // Отдельный тип для автообновления
                                result: {
                                    match_id: matchIdFromUrl,
                                    setNumber: setNumberFromUrl,
                                    scoreLeft: currentScoreLeft,
                                    scoreRight: currentScoreRight,
                                    participant1: participant1Name,
                                    participant2: participant2Name,
                                    tournament_name: urlParams.get('tournament') || ''
                                }
                            };
                            
                            window.opener.postMessage(resultData, window.location.origin);
                            console.log('[Referee] 📤 Результат отправлен в родительское окно для автообновления таблиц (без закрытия окна)');
                            console.log('[Referee] 📤 Данные:', resultData);
                        } catch (error) {
                            console.warn('[Referee] ⚠️ Не удалось отправить результат в родительское окно:', error);
                        }
                    } else {
                        console.log('[Referee] ℹ️ window.opener не доступен (страница открыта напрямую, не через window.open)');
                    }
                    
                    // Отправляем сообщение другим вкладкам о том, что счёт обновлен
                    // Это работает даже если window.opener недоступен
                    try {
                        const broadcastChannel = new BroadcastChannel('match-score-updates');
                        broadcastChannel.postMessage({
                            type: 'score-updated',
                            matchId: matchIdFromUrl,
                            setNumber: parseInt(setNumberFromUrl) || 1,
                            score1: score1,
                            score2: score2,
                            timestamp: Date.now()
                        });
                        console.log('[Referee] 📡 Сообщение об обновлении счёта отправлено другим вкладкам через BroadcastChannel');
                        console.log('[Referee] 📡 Данные:', { matchId: matchIdFromUrl, setNumber: setNumberFromUrl, score1, score2 });
                        broadcastChannel.close();
                    } catch (error) {
                        console.warn('[Referee] ⚠️ Не удалось отправить сообщение через BroadcastChannel:', error);
                    }
                } else {
                    console.warn('[Referee] ⚠️ Ошибка сохранения счёта:', result.error);
                }
            })
            .catch(error => {
                console.error('[Referee] ❌ Ошибка при сохранении счёта:', error);
            });
        }
        
        function updateScore() {
            document.getElementById('scoreLeft').textContent = scoreLeft;
            document.getElementById('scoreRight').textContent = scoreRight;
            // Временное отображение swap_count и teamsSwapped для отладки
            const swapCountElement = document.getElementById('swapCountValue');
            if (swapCountElement) {
                swapCountElement.textContent = swap_count + ' (mod 2: ' + (swap_count % 2) + ')';
            }
            const teamsSwappedElement = document.getElementById('teamsSwappedValue');
            if (teamsSwappedElement) {
                teamsSwappedElement.textContent = teamsSwapped ? 'true' : 'false';
            }
            updateShuttlecockPosition();
            checkVictory();
            
            // Сохраняем счёт в базу данных с задержкой (debounce)
            // Очищаем предыдущий таймер
            if (saveScoreTimeout) {
                clearTimeout(saveScoreTimeout);
            }
            
            // Устанавливаем новый таймер на 500мс (сохраняем через 0.5 секунды после последнего изменения)
            saveScoreTimeout = setTimeout(function() {
                saveScoreToDatabase();
            }, 500);
        }
        
        // Функция определения победителя
        function checkVictory() {
            const pointsToWin = 21; // Можно сделать настраиваемым
            const maxPoints = 30; // Максимальный счёт для бадминтона
            
            // ВАЖНО: Логика определения счёта:
            //        - Если слева синий цвет → Участнику 1 (participant1, score1) счёт с левой половины корта
            //        - Если слева красный цвет → Участнику 2 (participant2, score2) счёт с левой половины корта
            //        - Если справа синий цвет → Участнику 1 (participant1, score1) счёт с правой половины корта
            //        - Если справа красный цвет → Участнику 2 (participant2, score2) счёт с правой половины корта
            //        Для страницы "Демонстрация" или "Просмотр" (view-mode) - наоборот
            
            // Определяем, какой счёт синий, а какой красный по цвету на экране
            const scoreLeftEl = document.getElementById('scoreLeft');
            const scoreRightEl = document.getElementById('scoreRight');
            
            if (!scoreLeftEl || !scoreRightEl) {
                console.error('[Referee] ❌ Элементы счёта не найдены в checkVictory');
                return false;
            }
            
            // Проверяем классы элементов напрямую (более надёжный способ)
            // score-left = синий цвет (#0066ff), score-right = красный цвет (#ff3333)
            const leftScoreClasses = scoreLeftEl.className || '';
            const rightScoreClasses = scoreRightEl.className || '';
            
            // Получаем цвет счёта с экрана (для логирования)
            const leftScoreColor = window.getComputedStyle(scoreLeftEl).color;
            const rightScoreColor = window.getComputedStyle(scoreRightEl).color;
            
            // Используем swap_count для определения соответствия
            // Если swap_count % 2 == 0: левый счёт → participant1 (синий), правый → participant2 (красный)
            // Если swap_count % 2 == 1: правый счёт → participant1 (синий), левый → participant2 (красный)
            let blueTeamScore, redTeamScore; // blueTeamScore = participant1, redTeamScore = participant2
            
            if (swap_count % 2 == 0) {
                // Чётное количество смен: левый счёт → participant1 (синий), правый → participant2 (красный)
                blueTeamScore = scoreLeft;
                redTeamScore = scoreRight;
            } else {
                // Нечётное количество смен: правый счёт → participant1 (синий), левый → participant2 (красный)
                blueTeamScore = scoreRight;
                redTeamScore = scoreLeft;
            }
            
            const scoreDiff = Math.abs(blueTeamScore - redTeamScore);
            
            console.log('checkVictory: Проверка победы:', { 
                swap_count,
                swap_count_mod_2: swap_count % 2,
                scoreLeft, 
                scoreRight, 
                blueTeamScore,
                redTeamScore,
                scoreDiff 
            });
            
            // Специальное условие для бадминтона: если одна сторона набрала 30 очков - победа
            // (независимо от счёта соперника, который может быть 29 или 28)
            if (blueTeamScore >= maxPoints) {
                // Показываем сообщение о победе
                showVictoryMessage('Победа Синей команды!', scoreLeft, scoreRight);
                console.log(`Победа Синей команды по правилу 30 очков: ${blueTeamScore}:${redTeamScore}`);
                return true;
            }
            
            if (redTeamScore >= maxPoints) {
                // Показываем сообщение о победе
                showVictoryMessage('Победа Красной команды!', scoreLeft, scoreRight);
                console.log(`Победа Красной команды по правилу 30 очков: ${blueTeamScore}:${redTeamScore}`);
                return true;
            }
            
            // Обычное условие победы: набрать нужное количество очков И разница больше 1
            if (blueTeamScore >= pointsToWin && scoreDiff > 1) {
                // Показываем сообщение о победе
                showVictoryMessage('Победа Синей команды!', scoreLeft, scoreRight);
                return true;
            }
            
            if (redTeamScore >= pointsToWin && scoreDiff > 1) {
                // Показываем сообщение о победе
                showVictoryMessage('Победа Красной команды!', scoreLeft, scoreRight);
                return true;
            }
            
            return false;
        }
        
        // Функция показа сообщения о победе
        function showVictoryMessage(message, scoreLeft, scoreRight) {
            // Создаем модальное окно с сообщением о победе
            const modal = document.createElement('div');
            modal.id = 'victory-modal-' + Date.now();
            modal.className = 'victory-modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.8) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
            `;
            
            // Используем текущие значения счета
            const displayScoreLeft = scoreLeft !== undefined && scoreLeft !== null ? scoreLeft : 0;
            const displayScoreRight = scoreRight !== undefined && scoreRight !== null ? scoreRight : 0;
            
            // Создаем HTML
            content.innerHTML = `
                <h2 style="color: #4CAF50; margin-bottom: 20px;">${message}</h2>
                <div style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">
                    Счет: ${displayScoreLeft} : ${displayScoreRight}
                </div>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: #4CAF50; color: white; border: none; padding: 10px 20px; 
                               border-radius: 5px; cursor: pointer; font-size: 16px;">
                    OK
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            console.log('showVictoryMessage: Отображено сообщение о победе:', { message, displayScoreLeft, displayScoreRight });
        }
        
        // Обновление позиции индикатора подачи
        function updateShuttlecockPosition() {
            // Скрываем все индикаторы
            document.querySelectorAll('.server-indicator').forEach(ind => {
                ind.style.display = 'none';
            });
            
            // Показываем нужный индикатор
            const indicator = document.getElementById('server_' + shuttlecockPosition);
            if (indicator) {
                indicator.style.display = 'block';
                // Позиционируем индикатор рядом с соответствующим полем имени
                const nameField = document.getElementById(
                    shuttlecockPosition === 'top_left' ? 'top_left_player_input' :
                    shuttlecockPosition === 'bottom_left' ? 'bottom_left_player_input' :
                    shuttlecockPosition === 'top_right' ? 'name_top_right' : 'name_bottom_right'
                );
                if (nameField) {
                    const rect = nameField.getBoundingClientRect();
                    const indicatorWidth = 40; // Ширина индикатора
                    const gap = 10; // Отступ от поля
                    
                    // Для правых полей размещаем индикатор слева, для левых - справа
                    if (shuttlecockPosition === 'top_right' || shuttlecockPosition === 'bottom_right') {
                        // Правые поля: индикатор слева от поля
                        indicator.style.left = (rect.left - indicatorWidth - gap) + 'px';
                    } else {
                        // Левые поля: индикатор справа от поля
                        indicator.style.left = (rect.right + gap) + 'px';
                    }
                    // Вертикальное выравнивание по центру поля
                    indicator.style.top = (rect.top + rect.height / 2 - indicatorWidth / 2) + 'px';
                }
            }
        }
        
        // Сброс счета
        function resetScore() {
            saveGameState();
            scoreLeft = 0;
            scoreRight = 0;
            updateScore();
        }
        
        // Функция для обмена игроков в команде
        function swapPlayersInTeam(isLeftTeam) {
            if (isLeftTeam) {
                // Меняем местами игроков левой команды
                const tempName = document.getElementById('top_left_player_input').value;
                document.getElementById('top_left_player_input').value = document.getElementById('bottom_left_player_input').value;
                document.getElementById('bottom_left_player_input').value = tempName;
            } else {
                // Меняем местами игроков правой команды
                const tempName = document.getElementById('name_top_right').value;
                document.getElementById('name_top_right').value = document.getElementById('name_bottom_right').value;
                document.getElementById('name_bottom_right').value = tempName;
            }
        }
        
        // Функция для перемещения индикатора подачи при выигрыше очка
        // Функция для сохранения розыгрыша в базу данных
        async function saveRallyToDatabase(scoringTeam, previousScoreLeft, previousScoreRight, servingPositionBefore) {
            // Получаем параметры из URL
            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get('match_id');
            const setNumber = urlParams.get('set') || '1';
            
            // Если нет match_id, значит это не матч из турнира, не сохраняем
            if (!matchId || matchId === '') {
                console.log('[Rally] ℹ️ Нет match_id, пропускаем сохранение розыгрыша');
                return;
            }
            
            console.log('[Rally] 🔄 Начало сохранения розыгрыша:', {
                matchId,
                setNumber,
                scoringTeam,
                previousScoreLeft,
                previousScoreRight,
                servingPositionBefore
            });
            
            try {
                // Получаем данные матча для tournament_id и court_number
                const matchResponse = await fetch(`/api/matches/${matchId}?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                const matchData = await matchResponse.json();
                if (!matchData.success || !matchData.match) {
                    console.warn('[Rally] Не удалось получить данные матча');
                    return;
                }
                
                const tournamentId = matchData.match.tournament_id;
                const courtNumber = matchData.match.court_number;
                
                // Проверка типа спорта выполняется на сервере в API endpoint
                // Здесь просто сохраняем данные, сервер проверит, что это бадминтон
                
                // Получаем исходные имена участников из URL (до переключения команд)
                const originalParticipant1 = urlParams.get('p1') || urlParams.get('team1_name') || '';
                const originalParticipant2 = urlParams.get('p2') || urlParams.get('team2_name') || '';
                
                // Получаем текущие имена игроков из полей ввода (могут быть поменяны местами)
                const topLeftName = document.getElementById('top_left_player_input')?.value || '';
                const bottomLeftName = document.getElementById('bottom_left_player_input')?.value || '';
                const topRightName = document.getElementById('name_top_right')?.value || '';
                const bottomRightName = document.getElementById('name_bottom_right')?.value || '';
                
                // Определяем, где сейчас находится participant1 (синяя команда) и participant2 (красная команда)
                // Формируем имена команд для сравнения
                let leftTeamName = topLeftName;
                if (bottomLeftName && bottomLeftName !== topLeftName) {
                    leftTeamName = `${bottomLeftName} - ${topLeftName}`;
                } else if (!leftTeamName) {
                    leftTeamName = bottomLeftName;
                }
                
                let rightTeamName = topRightName;
                if (bottomRightName && bottomRightName !== topRightName) {
                    rightTeamName = `${topRightName} - ${bottomRightName}`;
                } else if (!rightTeamName) {
                    rightTeamName = bottomRightName;
                }
                
                // Используем swap_count для определения соответствия
                // Если swap_count % 2 == 0: левый счёт → participant1, правый → participant2
                // Если swap_count % 2 == 1: правый счёт → participant1, левый → participant2
                let participant1Name, participant2Name; // participant1 = синий, participant2 = красный
                let isParticipant1OnLeft, isParticipant1OnRight;
                
                if (swap_count % 2 == 0) {
                    // Чётное количество смен: левый счёт → participant1, правый → participant2
                    participant1Name = leftTeamName || originalParticipant1;
                    participant2Name = rightTeamName || originalParticipant2;
                    isParticipant1OnLeft = true;
                    isParticipant1OnRight = false;
                } else {
                    // Нечётное количество смен: правый счёт → participant1, левый → participant2
                    participant1Name = rightTeamName || originalParticipant1;
                    participant2Name = leftTeamName || originalParticipant2;
                    isParticipant1OnLeft = false;
                    isParticipant1OnRight = true;
                }
                
                // Определяем подающего и принимающего на основе позиции относительно сетки
                // Позиции относительно сетки:
                // - top_left (левый верхний) = левый квадрат относительно сетки
                // - bottom_left (левый нижний) = правый квадрат относительно сетки (на левой стороне корта)
                // - top_right (правый верхний) = левый квадрат относительно сетки (на правой стороне корта)
                // - bottom_right (правый нижний) = правый квадрат относительно сетки
                
                let serverName = '';
                let receiverName = '';
                let servePosition = ''; // "слева" или "справа" относительно сетки
                
                // Определяем подающего и принимающего на основе позиции относительно сетки
                // Используем уже определённые participant1Name (синяя) и participant2Name (красная)
                // Определяем, на какой стороне корта находится подающий
                const servedFromLeftSide = (servingPositionBefore === 'bottom_left' || servingPositionBefore === 'top_left');
                const servedFromRightSide = (servingPositionBefore === 'top_right' || servingPositionBefore === 'bottom_right');
                
                // Определяем, кто подаёт и кто принимает
                if (servedFromLeftSide) {
                    // Подача с левой стороны корта
                    // Определяем, кто находится слева: participant1 (синяя) или participant2 (красная)
                    if (isParticipant1OnLeft) {
                        // Слева participant1 (синяя)
                        serverName = participant1Name;
                        receiverName = participant2Name;
                    } else {
                        // Слева participant2 (красная)
                        serverName = participant2Name;
                        receiverName = participant1Name;
                    }
                } else if (servedFromRightSide) {
                    // Подача с правой стороны корта
                    // Определяем, кто находится справа: participant1 (синяя) или participant2 (красная)
                    if (isParticipant1OnRight) {
                        // Справа participant1 (синяя)
                        serverName = participant1Name;
                        receiverName = participant2Name;
                    } else {
                        // Справа participant2 (красная)
                        serverName = participant2Name;
                        receiverName = participant1Name;
                    }
                } else {
                    // Если позиция не определена, используем исходные имена
                    servePosition = '';
                    serverName = participant1Name || 'Игрок 1';
                    receiverName = participant2Name || 'Игрок 2';
                }
                
                // Определяем позицию подачи (слева или справа относительно сетки)
                if (servingPositionBefore === 'bottom_left' || servingPositionBefore === 'bottom_right') {
                    servePosition = 'справа'; // Правый квадрат относительно сетки
                } else if (servingPositionBefore === 'top_left' || servingPositionBefore === 'top_right') {
                    servePosition = 'слева'; // Левый квадрат относительно сетки
                }
                
                // Добавляем информацию о позиции подачи к имени подающего
                // Формат: "Имя - позиция" (без скобок, через дефис)
                if (servePosition) {
                    serverName = `${serverName} - ${servePosition}`;
                }
                
                // Определяем, выиграл ли подающий
                // Подающий выиграл, если команда, с которой он подавал, выиграла розыгрыш
                // Используем уже определённые serverName и receiverName
                // serverName соответствует participant1 (синяя) или participant2 (красная)
                let serverWon = false;
                
                // Определяем, какая команда выиграла розыгрыш (левая или правая сторона корта)
                const leftTeamScored = (scoringTeam === 'left');
                const rightTeamScored = (scoringTeam === 'right');
                
                // Определяем, кто подавал: participant1 (синяя) или participant2 (красная)
                // Функция для нормализации имени (убираем пробелы, приводим к нижнему регистру)
                const normalizeName = (name) => {
                    if (!name) return '';
                    return name.trim().toLowerCase().replace(/\s+/g, ' ');
                };
                
                const normalizedServerName = normalizeName(serverName.split(' - ')[0]); // Убираем позицию из имени
                const normalizedP1 = normalizeName(originalParticipant1);
                const p1Parts = normalizedP1.split(' - ').map(p => p.trim()).filter(p => p);
                const isServerParticipant1 = normalizedServerName === normalizedP1 || 
                                            (p1Parts.length > 0 && p1Parts.some(part => normalizedServerName.includes(part)));
                
                // Определяем, на какой стороне корта находится participant1 (синяя)
                const participant1OnLeft = isParticipant1OnLeft;
                const participant1OnRight = isParticipant1OnRight;
                
                // Определяем, выиграл ли подающий
                if (isServerParticipant1) {
                    // Подавал participant1 (синяя)
                    if (participant1OnLeft) {
                        // participant1 (синяя) слева → выиграл, если выиграла левая сторона
                        serverWon = leftTeamScored;
                    } else if (participant1OnRight) {
                        // participant1 (синяя) справа → выиграл, если выиграла правая сторона
                        serverWon = rightTeamScored;
                    }
                } else {
                    // Подавал participant2 (красная)
                    if (participant1OnLeft) {
                        // participant1 (синяя) слева → participant2 (красная) справа → выиграл, если выиграла правая сторона
                        serverWon = rightTeamScored;
                    } else if (participant1OnRight) {
                        // participant1 (синяя) справа → participant2 (красная) слева → выиграл, если выиграла левая сторона
                        serverWon = leftTeamScored;
                    }
                }
                
                // Формируем текущий счёт с учётом swap_count
                // Если swap_count % 2 == 0: левый счёт → participant1, правый → participant2
                // Если swap_count % 2 == 1: правый счёт → participant1, левый → participant2
                let score1, score2;
                
                if (swap_count % 2 == 0) {
                    // Чётное количество смен: левый счёт → participant1, правый → participant2
                    score1 = scoreLeft;
                    score2 = scoreRight;
                } else {
                    // Нечётное количество смен: правый счёт → participant1, левый → participant2
                    score1 = scoreRight;
                    score2 = scoreLeft;
                }
                
                const currentScore = `${score1}:${score2}`;
                
                // Логирование для отладки
                console.log('[Rally] 💾 Сохранение розыгрыша:', {
                    swap_count,
                    swap_count_mod_2: swap_count % 2,
                    'Счёт на экране': `${scoreLeft}:${scoreRight}`,
                    'Счёт в БД': currentScore,
                    'participant1Name': participant1Name,
                    'participant2Name': participant2Name,
                    'isParticipant1OnLeft': isParticipant1OnLeft,
                    'isParticipant1OnRight': isParticipant1OnRight,
                    scoringTeam,
                    servedFromLeftSide,
                    servedFromRightSide,
                    serverWon,
                    serverName,
                    receiverName,
                    'score1': score1,
                    'score2': score2
                });
                
                // Получаем CSRF токен
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                if (!csrfToken) {
                    console.warn('[Rally] CSRF токен не найден');
                    return;
                }
                
                // Отправляем запрос на сохранение розыгрыша
                const rallyData = {
                    match_id: parseInt(matchId),
                    tournament_id: tournamentId,
                    set_number: parseInt(setNumber) || 1,
                    court_number: courtNumber,
                    server_name: serverName,
                    receiver_name: receiverName,
                    server_won: serverWon,
                    score: currentScore
                };
                
                console.log('[Rally] 📤 Отправка данных розыгрыша:', rallyData);
                
                const response = await fetch('/api/rallies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(rallyData)
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('[Rally] ✅ Розыгрыш сохранён:', result.rally);
                } else {
                    console.warn('[Rally] ⚠️ Ошибка сохранения розыгрыша:', result.error);
                    console.warn('[Rally] ⚠️ Отправленные данные:', rallyData);
                }
                
            } catch (error) {
                console.error('[Rally] ❌ Ошибка при сохранении розыгрыша:', error);
                console.error('[Rally] ❌ Stack trace:', error.stack);
            }
        }
        
        function handlePointScored(scoringTeam) {
            // Определяем, какая команда подавала
            const isServingLeft = shuttlecockPosition === 'top_left' || shuttlecockPosition === 'bottom_left';
            const isServingRight = shuttlecockPosition === 'top_right' || shuttlecockPosition === 'bottom_right';
            
            if (scoringTeam === 'left') {
                // Левая команда выиграла очко
                if (isServingLeft) {
                    // Подавала левая команда - игроки меняются местами, индикатор переходит с подававшим
                    swapPlayersInTeam(true);
                    // Индикатор остается на той же стороне, но переходит на другую позицию (top <-> bottom)
                    if (shuttlecockPosition === 'top_left') {
                        shuttlecockPosition = 'bottom_left';
                    } else {
                        shuttlecockPosition = 'top_left';
                    }
                } else {
                    // Подавала правая команда - подача переходит на левую сторону
                    // К правому игроку (top_left), если счет четный, к левому (bottom_left), если нечетный
                    if (scoreLeft % 2 === 0) {
                        shuttlecockPosition = 'top_left';
                    } else {
                        shuttlecockPosition = 'bottom_left';
                    }
                }
            } else {
                // Правая команда выиграла очко
                if (isServingRight) {
                    // Подавала правая команда - игроки меняются местами, индикатор переходит с подававшим
                    swapPlayersInTeam(false);
                    // Индикатор остается на той же стороне, но переходит на другую позицию (top <-> bottom)
                    if (shuttlecockPosition === 'top_right') {
                        shuttlecockPosition = 'bottom_right';
                    } else {
                        shuttlecockPosition = 'top_right';
                    }
                } else {
                    // Подавала левая команда - подача переходит на правую сторону
                    // К правому игроку (top_right), если счет четный, к левому (bottom_right), если нечетный
                    if (scoreRight % 2 === 0) {
                        shuttlecockPosition = 'top_right';
                    } else {
                        shuttlecockPosition = 'bottom_right';
                    }
                }
            }
        }
        
        // Увеличение счета левой команды
        document.getElementById('court_left')?.addEventListener('click', function(e) {
            if (e.target.closest('.scoreboard') || e.target.closest('.player-name')) return;
            saveGameState();
            const previousScoreLeft = scoreLeft;
            const previousScoreRight = scoreRight;
            const servingPositionBefore = shuttlecockPosition; // Сохраняем позицию ДО изменения
            scoreLeft++;
            handlePointScored('left');
            updateScore();
            // Сохраняем розыгрыш
            saveRallyToDatabase('left', previousScoreLeft, previousScoreRight, servingPositionBefore);
        });
        
        // Увеличение счета правой команды
        document.getElementById('court_right')?.addEventListener('click', function(e) {
            if (e.target.closest('.scoreboard') || e.target.closest('.player-name')) return;
            saveGameState();
            const previousScoreLeft = scoreLeft;
            const previousScoreRight = scoreRight;
            const servingPositionBefore = shuttlecockPosition; // Сохраняем позицию ДО изменения
            scoreRight++;
            handlePointScored('right');
            updateScore();
            // Сохраняем розыгрыш
            saveRallyToDatabase('right', previousScoreLeft, previousScoreRight, servingPositionBefore);
        });
        
        // Увеличение счета при клике на цифры счёта (работает в режиме просмотра)
        document.getElementById('scoreLeft')?.addEventListener('click', function(e) {
            e.stopPropagation(); // Останавливаем всплытие события
            saveGameState();
            const previousScoreLeft = scoreLeft;
            const previousScoreRight = scoreRight;
            const servingPositionBefore = shuttlecockPosition; // Сохраняем позицию ДО изменения
            scoreLeft++;
            handlePointScored('left');
            updateScore();
            // Сохраняем розыгрыш
            saveRallyToDatabase('left', previousScoreLeft, previousScoreRight, servingPositionBefore);
        });
        
        document.getElementById('scoreRight')?.addEventListener('click', function(e) {
            e.stopPropagation(); // Останавливаем всплытие события
            saveGameState();
            const previousScoreLeft = scoreLeft;
            const previousScoreRight = scoreRight;
            const servingPositionBefore = shuttlecockPosition; // Сохраняем позицию ДО изменения
            scoreRight++;
            handlePointScored('right');
            updateScore();
            // Сохраняем розыгрыш
            saveRallyToDatabase('right', previousScoreLeft, previousScoreRight, servingPositionBefore);
        });
        
        // Поменять команды местами
        function swapTeams() {
            saveGameState();
            
            // Увеличиваем счётчик смен половин корта
            swap_count++;
            
            // Переключаем флаг перестановки команд
            const wasSwapped = teamsSwapped;
            teamsSwapped = !teamsSwapped;
            
            // Меняем счет местами
            const tempScore = scoreLeft;
            scoreLeft = scoreRight;
            scoreRight = tempScore;
            
            // Логирование для отладки
            console.log('[Referee] 🔄 Переключение команд:', {
                'swap_count': swap_count,
                'swap_count % 2': swap_count % 2,
                'Было переключено': wasSwapped,
                'Стало переключено': teamsSwapped,
                'Новый счёт': `${scoreLeft} : ${scoreRight}`,
                'Примечание': swap_count % 2 == 0 ? 
                    'Чётное: левый→p1, правый→p2' :
                    'Нечётное: правый→p1, левый→p2'
            });
            
            // Меняем имена по диагонали: top_left <-> bottom_right, bottom_left <-> top_right
            const tempNameTopLeft = document.getElementById('top_left_player_input').value;
            const tempNameBottomLeft = document.getElementById('bottom_left_player_input').value;
            const tempNameTopRight = document.getElementById('name_top_right').value;
            const tempNameBottomRight = document.getElementById('name_bottom_right').value;
            
            document.getElementById('top_left_player_input').value = tempNameBottomRight;
            document.getElementById('bottom_left_player_input').value = tempNameTopRight;
            document.getElementById('name_top_right').value = tempNameBottomLeft;
            document.getElementById('name_bottom_right').value = tempNameTopLeft;
            
            // Меняем цвета счетов (левая половина <-> правая половина)
            const scoreLeftEl = document.getElementById('scoreLeft');
            const scoreRightEl = document.getElementById('scoreRight');
            
            // Получаем текущие цвета счетов
            const leftScoreColor = window.getComputedStyle(scoreLeftEl).color;
            const rightScoreColor = window.getComputedStyle(scoreRightEl).color;
            
            // Меняем цвета счетов местами
            scoreLeftEl.style.setProperty('color', rightScoreColor, 'important');
            scoreRightEl.style.setProperty('color', leftScoreColor, 'important');
            
            // Меняем цвета имен игроков (левая половина <-> правая половина)
            const topLeftName = document.getElementById('top_left_player_input');
            const bottomLeftName = document.getElementById('bottom_left_player_input');
            const topRightName = document.getElementById('name_top_right');
            const bottomRightName = document.getElementById('name_bottom_right');
            
            // Получаем текущие цвета имен игроков
            const topLeftColor = window.getComputedStyle(topLeftName).color;
            const bottomLeftColor = window.getComputedStyle(bottomLeftName).color;
            const topRightColor = window.getComputedStyle(topRightName).color;
            const bottomRightColor = window.getComputedStyle(bottomRightName).color;
            
            // Меняем цвета: левые <-> правые
            topLeftName.style.setProperty('color', topRightColor, 'important');
            bottomLeftName.style.setProperty('color', bottomRightColor, 'important');
            topRightName.style.setProperty('color', topLeftColor, 'important');
            bottomRightName.style.setProperty('color', bottomLeftColor, 'important');
            
            // Переносим метку подачи на другую сторону по диагонали
            // При переключении команд метка подачи должна перейти на противоположную сторону по диагонали:
            // top_left → bottom_right
            // bottom_left → top_right
            // top_right → bottom_left
            // bottom_right → top_left
            if (shuttlecockPosition === 'top_left') {
                shuttlecockPosition = 'bottom_right';
            } else if (shuttlecockPosition === 'bottom_left') {
                shuttlecockPosition = 'top_right';
            } else if (shuttlecockPosition === 'top_right') {
                shuttlecockPosition = 'bottom_left';
            } else if (shuttlecockPosition === 'bottom_right') {
                shuttlecockPosition = 'top_left';
            }
            
            // Обновляем отображение метки подачи
            updateShuttlecockPosition();
            
            updateScore();
        }
        
        // Отменить последнее действие
        function undoLastAction() {
            if (gameHistory.length === 0) {
                alert('Нет действий для отмены');
                return;
            }
            
            const previousState = gameHistory.pop();
            scoreLeft = previousState.scoreLeft;
            scoreRight = previousState.scoreRight;
            shuttlecockPosition = previousState.shuttlecockPosition;
            teamsSwapped = previousState.teamsSwapped !== undefined ? previousState.teamsSwapped : false;
            updateScore();
        }
        
        // Переместить подачу
        function moveShuttlecockBetweenSides() {
            saveGameState();
            if (shuttlecockPosition === 'top_right') {
                shuttlecockPosition = 'top_left';
            } else if (shuttlecockPosition === 'top_left') {
                shuttlecockPosition = 'bottom_left';
            } else if (shuttlecockPosition === 'bottom_left') {
                shuttlecockPosition = 'bottom_right';
            } else if (shuttlecockPosition === 'bottom_right') {
                shuttlecockPosition = 'top_right';
            }
            updateShuttlecockPosition();
        }
        
        // Поменять игроков в левой команде
        function swapLeftTeam() {
            saveGameState();
            const topLeftName = document.getElementById('top_left_player_input').value;
            const bottomLeftName = document.getElementById('bottom_left_player_input').value;
            document.getElementById('top_left_player_input').value = bottomLeftName;
            document.getElementById('bottom_left_player_input').value = topLeftName;
        }
        
        // Поменять игроков в правой команде
        function swapRightTeam() {
            saveGameState();
            const topRightName = document.getElementById('name_top_right').value;
            const bottomRightName = document.getElementById('name_bottom_right').value;
            document.getElementById('name_top_right').value = bottomRightName;
            document.getElementById('name_bottom_right').value = topRightName;
        }
        
        // Функция для отражения элементов относительно центра
        function mirrorElementsForViewMode() {
            // Сохраняем исходное состояние
            originalState.scoreLeft = scoreLeft;
            originalState.scoreRight = scoreRight;
            originalState.topLeftName = document.getElementById('top_left_player_input').value;
            originalState.bottomLeftName = document.getElementById('bottom_left_player_input').value;
            originalState.topRightName = document.getElementById('name_top_right').value;
            originalState.bottomRightName = document.getElementById('name_bottom_right').value;
            originalState.shuttlecockPosition = shuttlecockPosition;
            
            // Сохраняем цвета
            const topLeftEl = document.getElementById('top_left_player_input');
            const bottomLeftEl = document.getElementById('bottom_left_player_input');
            const topRightEl = document.getElementById('name_top_right');
            const bottomRightEl = document.getElementById('name_bottom_right');
            const scoreLeftEl = document.getElementById('scoreLeft');
            const scoreRightEl = document.getElementById('scoreRight');
            
            originalState.topLeftColor = window.getComputedStyle(topLeftEl).color;
            originalState.bottomLeftColor = window.getComputedStyle(bottomLeftEl).color;
            originalState.topRightColor = window.getComputedStyle(topRightEl).color;
            originalState.bottomRightColor = window.getComputedStyle(bottomRightEl).color;
            originalState.scoreLeftColor = window.getComputedStyle(scoreLeftEl).color;
            originalState.scoreRightColor = window.getComputedStyle(scoreRightEl).color;
            
            // Меняем местами счёт
            const tempScore = scoreLeft;
            scoreLeft = scoreRight;
            scoreRight = tempScore;
            
            // Меняем местами имена по диагонали: top_left <-> bottom_right, bottom_left <-> top_right
            const tempTopLeft = originalState.topLeftName;
            const tempBottomLeft = originalState.bottomLeftName;
            const tempTopRight = originalState.topRightName;
            const tempBottomRight = originalState.bottomRightName;
            
            document.getElementById('top_left_player_input').value = tempBottomRight;
            document.getElementById('bottom_left_player_input').value = tempTopRight;
            document.getElementById('name_top_right').value = tempBottomLeft;
            document.getElementById('name_bottom_right').value = tempTopLeft;
            
            // Меняем местами цвета счёта
            scoreLeftEl.style.setProperty('color', originalState.scoreRightColor, 'important');
            scoreRightEl.style.setProperty('color', originalState.scoreLeftColor, 'important');
            
            // Меняем местами цвета имён игроков
            topLeftEl.style.setProperty('color', originalState.bottomRightColor, 'important');
            bottomLeftEl.style.setProperty('color', originalState.topRightColor, 'important');
            topRightEl.style.setProperty('color', originalState.bottomLeftColor, 'important');
            bottomRightEl.style.setProperty('color', originalState.topLeftColor, 'important');
            
            // Перемещаем индикатор подачи на новое место
            // Отражение позиций:
            // top_left -> bottom_right
            // bottom_left -> top_right
            // top_right -> bottom_left
            // bottom_right -> top_left
            const positionMap = {
                'top_left': 'bottom_right',
                'bottom_left': 'top_right',
                'top_right': 'bottom_left',
                'bottom_right': 'top_left'
            };
            shuttlecockPosition = positionMap[originalState.shuttlecockPosition] || originalState.shuttlecockPosition;
            
            // Обновляем отображение
            updateScore();
            updateShuttlecockPosition();
        }
        
        // Функция для восстановления исходного состояния (без счёта, так как счёт применяется отдельно)
        function restoreOriginalState() {
            // Восстанавливаем имена
            document.getElementById('top_left_player_input').value = originalState.topLeftName;
            document.getElementById('bottom_left_player_input').value = originalState.bottomLeftName;
            document.getElementById('name_top_right').value = originalState.topRightName;
            document.getElementById('name_bottom_right').value = originalState.bottomRightName;
            
            // Восстанавливаем цвета счёта
            const scoreLeftEl = document.getElementById('scoreLeft');
            const scoreRightEl = document.getElementById('scoreRight');
            scoreLeftEl.style.setProperty('color', originalState.scoreLeftColor, 'important');
            scoreRightEl.style.setProperty('color', originalState.scoreRightColor, 'important');
            
            // Восстанавливаем цвета имён
            const topLeftEl = document.getElementById('top_left_player_input');
            const bottomLeftEl = document.getElementById('bottom_left_player_input');
            const topRightEl = document.getElementById('name_top_right');
            const bottomRightEl = document.getElementById('name_bottom_right');
            
            topLeftEl.style.setProperty('color', originalState.topLeftColor, 'important');
            bottomLeftEl.style.setProperty('color', originalState.bottomLeftColor, 'important');
            topRightEl.style.setProperty('color', originalState.topRightColor, 'important');
            bottomRightEl.style.setProperty('color', originalState.bottomRightColor, 'important');
            
            // Восстанавливаем позицию индикатора подачи
            shuttlecockPosition = originalState.shuttlecockPosition;
            
            // Обновляем отображение индикатора
            updateShuttlecockPosition();
        }
        
        // Переключить режим просмотра
        function toggleViewMode() {
            isViewMode = !isViewMode;
            document.body.classList.toggle('view-mode', isViewMode);
            
            // Показываем/скрываем кнопку Back для режима просмотра
            const backBtn = document.querySelector('.back-btn-view');
            if (backBtn) {
                // Проверяем, попадаем ли мы под медиа-запрос для 793x305
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const isSmallScreen = viewportWidth <= 793 && viewportHeight <= 305;
                
                if (isViewMode && isSmallScreen) {
                    backBtn.style.display = 'flex';
                } else {
                    backBtn.style.display = 'none';
                }
            }
            
            if (isViewMode) {
                // Сохраняем и отражаем элементы относительно центра
                mirrorElementsForViewMode();
                
                // Увеличиваем размер счета и имен
                document.querySelectorAll('.score').forEach(score => {
                    score.style.fontSize = '300px'; /* Увеличено в 2 раза (было 150px) */
                });
                document.querySelectorAll('.player-name').forEach(name => {
                    name.style.fontSize = '72px'; /* Увеличено в 2 раза (было 36px) */
                    name.readOnly = true;
                });
            } else {
                // Сохраняем текущий отражённый счёт перед восстановлением
                // В режиме просмотра счёт был отражён (левый стал правым, правый стал левым)
                const mirroredScoreLeft = scoreLeft;  // Это был правый счёт в исходном состоянии
                const mirroredScoreRight = scoreRight; // Это был левый счёт в исходном состоянии
                
                // Восстанавливаем исходное состояние (имена, цвета, позиция индикатора)
                restoreOriginalState();
                
                // Применяем отражённый счёт к исходным командам (меняем местами обратно)
                // mirroredScoreLeft (был правым) -> scoreRight
                // mirroredScoreRight (был левым) -> scoreLeft
                scoreLeft = mirroredScoreRight;
                scoreRight = mirroredScoreLeft;
                
                // Обновляем отображение счёта
                updateScore();
                
                // Возвращаем обычные размеры
                document.querySelectorAll('.score').forEach(score => {
                    score.style.fontSize = '240px'; /* Увеличено в 2 раза (было 120px) */
                });
                document.querySelectorAll('.player-name').forEach(name => {
                    name.style.fontSize = '48px'; /* Увеличено в 2 раза (было 24px) */
                    name.readOnly = false;
                });
            }
        }
        
        // Переключить журнал (заглушка)
        function toggleJournal() {
            journalVisible = !journalVisible;
            alert('Журнал подач: ' + (journalVisible ? 'включен' : 'выключен') + '\n(Функция в разработке)');
        }
        
        // Сохранить результат (заглушка)
        // Функция для отправки счёта в родительское окно
        function sendResultToParent() {
            // Проверяем, открыто ли окно через window.open
            if (window.opener && !window.opener.closed) {
                // Получаем параметры из URL для передачи обратно
                const urlParams = new URLSearchParams(window.location.search);
                const matchId = urlParams.get('match_id') || '';
                const setNumber = urlParams.get('set') || '1';
                
                // Получаем текущий счёт
                let currentScoreLeft = scoreLeft;
                let currentScoreRight = scoreRight;
                
                // Формируем имена участников из полей
                const topLeftName = document.getElementById('top_left_player_input').value || '';
                const bottomLeftName = document.getElementById('bottom_left_player_input').value || '';
                const topRightName = document.getElementById('name_top_right').value || '';
                const bottomRightName = document.getElementById('name_bottom_right').value || '';
                
                // Если верхнее и нижнее имена разные, объединяем через " - "
                let participant1Name = topLeftName;
                if (bottomLeftName && bottomLeftName !== topLeftName) {
                    participant1Name = bottomLeftName + ' - ' + topLeftName;
                }
                
                let participant2Name = topRightName;
                if (bottomRightName && bottomRightName !== topRightName) {
                    participant2Name = topRightName + ' - ' + bottomRightName;
                }
                
                // Отправляем счёт в родительское окно через postMessage
                const resultData = {
                    type: 'refereeResult',
                    result: {
                        match_id: matchId,
                        setNumber: setNumber,
                        scoreLeft: currentScoreLeft,
                        scoreRight: currentScoreRight,
                        participant1: participant1Name,
                        participant2: participant2Name,
                        tournament_name: urlParams.get('tournament') || ''
                    }
                };
                
                console.log('[Referee] Отправляем результат в родительское окно:', resultData);
                try {
                    window.opener.postMessage(resultData, window.location.origin);
                    console.log('[Referee] ✅ Результат отправлен успешно');
                    return true;
                } catch (e) {
                    console.error('[Referee] ❌ Ошибка при отправке результата:', e);
                    return false;
                }
            }
            return false;
        }
        
        function saveResult() {
            // Отправляем результат в родительское окно
            if (sendResultToParent()) {
                alert('Результат сохранён и передан в форму Результат:\n' + 
                      'Левые: ' + scoreLeft + '\n' +
                      'Правые: ' + scoreRight);
            } else {
                alert('Сохранение результата:\n' + 
                      'Левые: ' + scoreLeft + '\n' +
                      'Правые: ' + scoreRight + '\n' +
                      '\nПримечание: Страница не открыта из формы Результат.');
            }
        }
        
        // Назад
        function handleBack() {
            // Для кнопки Back в режиме просмотра выходим из режима просмотра
            if (document.body.classList.contains('view-mode')) {
                // Выходим из режима просмотра, оставаясь на той же странице судейства
                toggleViewMode();
            } else {
                // Если страница открыта из формы Результат (через window.open)
                if (window.opener && !window.opener.closed) {
                    // Отправляем счёт в родительское окно
                    sendResultToParent();
                    
                    // Закрываем окно судейства
                    window.close();
                } else {
                    // Если не открыто через window.open, используем обычное поведение
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.location.href = '/referee';
                    }
                }
            }
        }
        
        // Позиционирование полей имен относительно линий разметки
        function positionPlayerNameFields() {
            const courtArea = document.querySelector('.court-area');
            if (!courtArea) return;
            
            // Получаем размеры viewport
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            
            const courtHeight = courtArea.offsetHeight;
            const lineSpacing = 50; // Расстояние между линиями в пикселях
            
            // Линия "a" находится на позиции 0 (0 * lineSpacing)
            // Линия "g" находится на позиции 6 (6 * lineSpacing = 300px)
            const lineAPosition = 0 * lineSpacing; // 0px
            const lineGPosition = 6 * lineSpacing; // 300px
            
            // Вычисляем 5% от высоты корта
            const offsetPercent = courtHeight * 0.05;
            
            // Верхние поля: на 5% ниже линии "a"
            const topFieldsPosition = lineAPosition + offsetPercent;
            
            // Нижние поля: на 5% выше линии "g" (от верха корта)
            // Но нужно учитывать, что bottom считается от низа, поэтому:
            // bottom = courtHeight - lineGPosition - offsetPercent
            // Для viewport 796 x 307 и более устанавливаем bottom: 100px
            let bottomFieldsPosition;
            if (viewportWidth >= 796 && viewportHeight >= 307) {
                bottomFieldsPosition = 100; // 100px выше нижней границы экрана
            } else {
                bottomFieldsPosition = courtHeight - lineGPosition - offsetPercent;
            }
            
            // Применяем позиции
            const topLeftField = document.getElementById('top_left_player_input');
            const topRightField = document.getElementById('name_top_right');
            const bottomLeftField = document.getElementById('bottom_left_player_input');
            const bottomRightField = document.getElementById('name_bottom_right');
            
            if (topLeftField) {
                topLeftField.style.top = topFieldsPosition + 'px';
            }
            if (topRightField) {
                topRightField.style.top = topFieldsPosition + 'px';
            }
            if (bottomLeftField) {
                bottomLeftField.style.bottom = bottomFieldsPosition + 'px';
            }
            if (bottomRightField) {
                bottomRightField.style.bottom = bottomFieldsPosition + 'px';
            }
        }
        
        // Создание маркировки линий разметки
        function createGridLabels() {
            const courtArea = document.querySelector('.court-area');
            if (!courtArea) return;
            
            const verticalLabelsContainer = document.getElementById('vertical-labels');
            const horizontalLabelsContainer = document.getElementById('horizontal-labels');
            if (!verticalLabelsContainer || !horizontalLabelsContainer) return;
            
            // Очищаем существующие метки
            verticalLabelsContainer.innerHTML = '';
            horizontalLabelsContainer.innerHTML = '';
            
            const courtWidth = courtArea.offsetWidth;
            const courtHeight = courtArea.offsetHeight;
            const lineSpacing = 50; // Расстояние между линиями в пикселях
            
            // Создаем метки для вертикальных линий (цифры)
            const verticalLinesCount = Math.floor(courtWidth / lineSpacing);
            for (let i = 1; i <= verticalLinesCount; i++) {
                const label = document.createElement('div');
                label.className = 'grid-label vertical';
                label.textContent = i;
                label.style.left = (i * lineSpacing) + 'px';
                verticalLabelsContainer.appendChild(label);
            }
            
            // Создаем метки для горизонтальных линий (буквы)
            const horizontalLinesCount = Math.floor(courtHeight / lineSpacing);
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            for (let i = 0; i < horizontalLinesCount && i < letters.length; i++) {
                const label = document.createElement('div');
                label.className = 'grid-label horizontal';
                label.textContent = letters[i];
                label.style.top = (i * lineSpacing) + 'px';
                horizontalLabelsContainer.appendChild(label);
            }
            
            // После создания линий позиционируем поля имен
            positionPlayerNameFields();
        }
        
        // Обновление информации о размере экрана
        function updateDebugScreenInfo() {
            const debugElement = document.getElementById('debugScreenInfo');
            if (!debugElement) return;
            
            // Получаем размеры
            // Viewport - это то, что используется CSS для vw/vh единиц и медиа-запросов
            const viewportWidth = document.documentElement.clientWidth || window.innerWidth;
            const viewportHeight = document.documentElement.clientHeight || window.innerHeight;
            
            // Window - внутренние размеры окна браузера (обычно совпадает с viewport)
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // Screen - физические размеры экрана устройства (редко используется в CSS)
            const screenWidth = screen.width;
            const screenHeight = screen.height;
            
            // Device Pixel Ratio - отношение физических пикселей к CSS пикселям (влияет на четкость, но не на размеры)
            const devicePixelRatio = window.devicePixelRatio || 1;
            
            // Определяем ориентацию (важно для медиа-запросов @media (orientation: landscape/portrait))
            let orientation = 'Неизвестно';
            if (viewportHeight > viewportWidth) {
                orientation = 'Портретная (Portrait)';
            } else if (viewportWidth > viewportHeight) {
                orientation = 'Альбомная (Landscape)';
            } else {
                orientation = 'Квадратная';
            }
            
            // Обновляем значения (порядок важен - сначала Viewport как основное)
            document.getElementById('debugViewportSize').textContent = `${viewportWidth} × ${viewportHeight} px`;
            document.getElementById('debugWindowSize').textContent = `${windowWidth} × ${windowHeight} px`;
            document.getElementById('debugScreenSize').textContent = `${screenWidth} × ${screenHeight} px`;
            document.getElementById('debugOrientation').textContent = orientation;
            document.getElementById('debugDPR').textContent = devicePixelRatio.toFixed(2);
        }
        
        // Инициализация обработчиков событий
        // Автоматическая передача счёта при закрытии окна
        window.addEventListener('beforeunload', function(e) {
            // Если страница открыта из формы Результат, передаем счёт при закрытии
            if (window.opener && !window.opener.closed) {
                // Используем sendBeacon для надежной передачи данных при закрытии окна
                try {
                    sendResultToParent();
                } catch (err) {
                    console.error('[Referee] Ошибка при передаче счёта при закрытии окна:', err);
                }
            }
        });
        
        // Функция для загрузки счёта из базы данных
        async function loadScoreFromDatabase() {
            // Получаем параметры из URL
            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get('match_id');
            const setNumber = urlParams.get('set') || '1';
            
            // Если нет match_id, значит это не матч из турнира, используем счёт из URL или 0:0
            if (!matchId || matchId === '') {
                // Пробуем загрузить из URL параметров
                const score1Param = urlParams.get('score1');
                const score2Param = urlParams.get('score2');
                
                if (score1Param !== null && score2Param !== null) {
                    scoreLeft = parseInt(score1Param, 10) || 0;
                    scoreRight = parseInt(score2Param, 10) || 0;
                    
                    // Если счёт по умолчанию 21:21, устанавливаем 0:0
                    if (scoreLeft === 21 && scoreRight === 21) {
                        scoreLeft = 0;
                        scoreRight = 0;
                        console.log('[Referee] 🔄 Счёт 21:21 заменён на 0:0 (из URL параметров)');
                    }
                    
                    console.log('[Referee] Счёт загружен из URL параметров:', scoreLeft, ':', scoreRight);
                    updateScore();
                    return;
                }
                
                // Если нет параметров, оставляем 0:0
                return;
            }
            
            // Загружаем счёт из базы данных
            try {
                const response = await fetch(`/api/matches/${matchId}?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.match) {
                    let currentScore1, currentScore2;
                    
                    // Получаем счёт для соответствующего сета из базы данных
                    const setNum = parseInt(setNumber) || 1;
                    
                    if (setNum === 1) {
                        currentScore1 = data.match.set1_score1 !== null ? data.match.set1_score1 : 0;
                        currentScore2 = data.match.set1_score2 !== null ? data.match.set1_score2 : 0;
                    } else if (setNum === 2) {
                        currentScore1 = data.match.set2_score1 !== null ? data.match.set2_score1 : 0;
                        currentScore2 = data.match.set2_score2 !== null ? data.match.set2_score2 : 0;
                    } else if (setNum === 3) {
                        currentScore1 = data.match.set3_score1 !== null ? data.match.set3_score1 : 0;
                        currentScore2 = data.match.set3_score2 !== null ? data.match.set3_score2 : 0;
                    } else {
                        currentScore1 = 0;
                        currentScore2 = 0;
                    }
                    
                    // Устанавливаем счёт
                    // score1 в БД = левая команда (participant1) = scoreLeft
                    // score2 в БД = правая команда (participant2) = scoreRight
                    scoreLeft = currentScore1;
                    scoreRight = currentScore2;
                    
                    // Если счёт по умолчанию 21:21, устанавливаем 0:0
                    if (scoreLeft === 21 && scoreRight === 21) {
                        scoreLeft = 0;
                        scoreRight = 0;
                        console.log(`[Referee] 🔄 Счёт 21:21 заменён на 0:0 для матча ${matchId}, сет ${setNum}`);
                    }
                    
                    console.log(`[Referee] ✅ Счёт загружен из БД для матча ${matchId}, сет ${setNum}:`, scoreLeft, ':', scoreRight);
                    updateScore();
                } else {
                    console.warn('[Referee] ⚠️ Не удалось загрузить данные матча из БД');
                    
                    // Пробуем загрузить из URL параметров как резервный вариант
                    const score1Param = urlParams.get('score1');
                    const score2Param = urlParams.get('score2');
                    
                    if (score1Param !== null && score2Param !== null) {
                        scoreLeft = parseInt(score1Param, 10) || 0;
                        scoreRight = parseInt(score2Param, 10) || 0;
                        
                        // Если счёт по умолчанию 21:21, устанавливаем 0:0
                        if (scoreLeft === 21 && scoreRight === 21) {
                            scoreLeft = 0;
                            scoreRight = 0;
                            console.log('[Referee] 🔄 Счёт 21:21 заменён на 0:0 (из URL параметров, резервный вариант)');
                        }
                        
                        console.log('[Referee] Счёт загружен из URL параметров (резервный вариант):', scoreLeft, ':', scoreRight);
                        updateScore();
                    }
                }
            } catch (error) {
                console.error('[Referee] ❌ Ошибка при загрузке счёта из БД:', error);
                
                // Пробуем загрузить из URL параметров как резервный вариант
                const score1Param = urlParams.get('score1');
                const score2Param = urlParams.get('score2');
                
                if (score1Param !== null && score2Param !== null) {
                    scoreLeft = parseInt(score1Param, 10) || 0;
                    scoreRight = parseInt(score2Param, 10) || 0;
                    
                    // Если счёт по умолчанию 21:21, устанавливаем 0:0
                    if (scoreLeft === 21 && scoreRight === 21) {
                        scoreLeft = 0;
                        scoreRight = 0;
                        console.log('[Referee] 🔄 Счёт 21:21 заменён на 0:0 (из URL параметров, резервный вариант)');
                    }
                    
                    console.log('[Referee] Счёт загружен из URL параметров (резервный вариант):', scoreLeft, ':', scoreRight);
                    updateScore();
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем счёт из базы данных или URL параметров
            loadScoreFromDatabase().then(() => {
                // После загрузки счёта обновляем отображение
                updateScore();
            });
            
            // Создаем маркировку линий разметки
            createGridLabels();
            
            // Привязываем обработчики к кнопкам
            document.getElementById('btnUndo')?.addEventListener('click', undoLastAction);
            document.getElementById('btnMoveShuttlecock')?.addEventListener('click', moveShuttlecockBetweenSides);
            document.getElementById('btnSwapTeams')?.addEventListener('click', swapTeams);
            document.getElementById('btnSwapLeftTeam')?.addEventListener('click', swapLeftTeam);
            document.getElementById('btnSwapRightTeam')?.addEventListener('click', swapRightTeam);
            document.getElementById('btnViewMode')?.addEventListener('click', toggleViewMode);
            document.getElementById('btnToggleJournal')?.addEventListener('click', toggleJournal);
            document.getElementById('btnSaveResult')?.addEventListener('click', saveResult);
            
            // Инициализация блока информации о размере экрана
            updateDebugScreenInfo();
            
            // Обработчик для чекбокса показа свойств экрана
            const showScreenInfoCheckbox = document.getElementById('showScreenInfo');
            const debugScreenInfo = document.getElementById('debugScreenInfo');
            
            if (showScreenInfoCheckbox && debugScreenInfo) {
                showScreenInfoCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        debugScreenInfo.classList.add('visible');
                        updateDebugScreenInfo();
                    } else {
                        debugScreenInfo.classList.remove('visible');
                    }
                });
            }
            
            // Обновляем информацию при изменении размера окна
            window.addEventListener('resize', function() {
                if (debugScreenInfo && debugScreenInfo.classList.contains('visible')) {
                    updateDebugScreenInfo();
                }
                createGridLabels(); // Пересоздаем метки при изменении размера
                positionPlayerNameFields(); // Обновляем позиции полей
            });
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (debugScreenInfo && debugScreenInfo.classList.contains('visible')) {
                        updateDebugScreenInfo();
                    }
                    createGridLabels(); // Пересоздаем метки при изменении ориентации
                    positionPlayerNameFields(); // Обновляем позиции полей
                }, 100);
            });
            
            console.log('Страница судейства загружена');
        });
    </script>
</body>
</html>

