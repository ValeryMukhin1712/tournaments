{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—É—Ä–Ω–∏—Ä–∞ - {{ tournament.name }}{% endblock %}

{% block content %}
<style>
/* –ê–Ω–∏–º–∞—Ü–∏—è pulse –¥–ª—è –±–ª–∏–∂–∞–π—à–∏—Ö –º–∞—Ç—á–µ–π */
@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.8;
        transform: scale(1.02);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Å–∫—Ä–æ–ª–ª–µ */
#tournament-table {
    position: relative;
}

#tournament-table thead th:first-child,
#tournament-table tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    background-color: #f8f9fa !important;
    border-right: 2px solid #dee2e6;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è */
@media (max-width: 768px) {
    #tournament-table thead th:first-child,
    #tournament-table tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 15;
        background-color: #f8f9fa !important;
        border-right: 2px solid #dee2e6;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        min-width: 80px;
        max-width: 120px;
    }
    
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è */
    #tournament-table thead th:nth-child(2),
    #tournament-table tbody td:nth-child(2) {
        position: relative;
        z-index: 5;
    }
}

/* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 550px) {
    #tournament-table thead th:first-child,
    #tournament-table tbody td:first-child {
        min-width: 60px;
        max-width: 100px;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
<div class="container-fluid">
<div class="row">
    <div class="col-12">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
                <div class="mb-3 mb-sm-0">
                    <h1 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        {{ tournament.name }}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if is_viewer_mode %}
                            –†–µ–∂–∏–º –∑—Ä–∏—Ç–µ–ª—è
                        {% else %}
                            –†–µ–∂–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
                        {% endif %}
                        <span id="autoRefreshIndicator" class="badge bg-success ms-2" style="display: none;">
                            <i class="fas fa-sync-alt fa-spin me-1"></i>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                        </span>
                        
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                        <div class="btn-group ms-3" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAutoRefresh()" id="toggleRefreshBtn">
                                <i class="fas fa-pause" id="toggleIcon"></i> <span id="toggleText">–ü–∞—É–∑–∞</span>
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-clock me-1"></i><span id="intervalText">3 —Å–µ–∫</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(3)">3 —Å–µ–∫—É–Ω–¥—ã</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(5)">5 —Å–µ–∫—É–Ω–¥</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(10)">10 —Å–µ–∫—É–Ω–¥</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(15)">15 —Å–µ–∫—É–Ω–¥</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(20)">20 —Å–µ–∫—É–Ω–¥</a></li>
                                </ul>
                            </div>
                        </div>
                    </p>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–µ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–µ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>–°–ø–æ—Ä—Ç:</strong> {{ tournament.sport_type or '–¢–µ–Ω–Ω–∏—Å' }}</p>
                                    <p><strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> 
                    {% if tournament.start_date %}
                        {{ tournament.start_date.strftime('%d.%m.%Y') }}
                    {% else %}
                                            –ù–µ —É–∫–∞–∑–∞–Ω–∞
                    {% endif %}
                </p>
            </div>
                                <div class="col-md-6">
                                    <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ participants_with_stats_chessboard|length }}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                        {% if tournament.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-flag-checkered me-1"></i>–ó–∞–≤–µ—Ä—à–µ–Ω
                                            </span>
                                        {% elif tournament.status == '–∞–∫—Ç–∏–≤–µ–Ω' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-play me-1"></i>–ê–∫—Ç–∏–≤–µ–Ω
                                            </span>
                                        {% else %}
                                            {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–∞—á–∞–≤—à–∏–µ—Å—è –º–∞—Ç—á–∏ #}
                                            {% set has_playing = matches|selectattr('status', 'equalto', '–∏–≥—Ä–∞—é—Ç')|list|length > 0 %}
                                            {% set has_in_progress = matches|selectattr('status', 'equalto', '–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ')|list|length > 0 %}
                                            {% set has_in_progress2 = matches|selectattr('status', 'equalto', '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ')|list|length > 0 %}
                                            {% if has_playing or has_in_progress or has_in_progress2 %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-play me-1"></i>–ù–∞—á–∞–ª—Å—è
                                                </span>
                                            {% else %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-user-plus me-1"></i>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                                            </span>
                                            {% endif %}
                                        {% endif %}
                                    </p>
            </div>
        </div>
        {% if tournament.description %}
                            <div class="mt-3">
                                <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                                <p class="mt-1">{{ tournament.description }}</p>
        </div>
        {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π -->
            {% if schedule_display %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>
                                –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π
                </h5>
            </div>
            <div class="card-body">
                            {% if schedule_display %}
                    <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                <tr>
                                                <th class="d-none d-sm-table-cell" style="width: 60px;">‚Ññ</th>
                                                <th style="width: 80px;">–í—Ä–µ–º—è</th>
                                                <th class="d-none d-md-table-cell" style="width: 100px;">–ü–ª–æ—â–∞–¥–∫–∞</th>
                                                <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                                                <th style="width: 100px;">–°—á–µ—Ç</th>
                                                <th class="d-none d-md-table-cell" style="width: 120px;">–°—Ç–∞—Ç—É—Å</th>
                                                <th style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                            {% for date_str, day_data in schedule_display.items() %}
                                            <tr class="table-info">
                                                <td colspan="7" class="fw-bold text-center py-2">
                                                    <i class="fas fa-calendar-day me-2"></i>{{ day_data.date_display }}
                                    </td>
                                            </tr>
                                            {% for match in day_data.matches %}
                                            <tr {% if match.is_participant_match %}class="table-primary"{% endif %} data-match-id="{{ match.id }}" data-p1-id="{{ match.participant1_id }}" data-p2-id="{{ match.participant2_id }}">
                                                <td class="d-none d-sm-table-cell text-center">
                                                    <span class="badge bg-primary">{{ match.global_number or loop.index }}</span>
                                                </td>
                                                <td class="fw-bold text-primary">{{ match.time }}</td>
                                                <td class="d-none d-md-table-cell text-center">
                                                    {% if match.court and match.court > 0 %}
                                                        {% set court_colors = {
                                                            1: 'primary',
                                                            2: 'info', 
                                                            3: 'success',
                                                            4: 'warning',
                                                            5: 'danger',
                                                            6: 'secondary',
                                                            7: 'dark',
                                                            8: 'light'
                                                        } %}
                                                        {% set court_color = court_colors.get(match.court, 'secondary') %}
                                                        <span class="badge bg-{{ court_color }}">
                                                            –ü–ª. {{ match.court }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{ match.participant1 }}</strong> vs <strong>{{ match.participant2 }}</strong>
                                                    {% if match.is_participant_match and not is_viewer_mode %}
                                                        <span class="badge bg-primary ms-2 rounded-pill">–í–∞—à –º–∞—Ç—á</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center" data-match-score-cell>
                                                    {% if match.score and match.status != '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}
                                                        {% if match.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' %}
                                                            {% set score_parts = match.score.split(':') %}
                                                            {% set score1 = score_parts[0]|int %}
                                                            {% set score2 = score_parts[1]|int %}
                                                            {% if score1 > score2 %}
                                                                <span class="badge bg-success text-white match-score">{{ match.score }}</span>
                                                            {% else %}
                                                                <span class="badge bg-danger text-white match-score">{{ match.score }}</span>
                                                            {% endif %}
                                                        {% elif match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'] %}
                                                            <span class="badge bg-warning text-dark match-score" style="background-color: #ffc107 !important; color: #000 !important;">{{ match.score }}</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark match-score">{{ match.score }}</span>
                                                        {% endif %}
                                                        {% if match.sets_details %}
                                                            <br><small class="text-muted match-sets-details" {% if match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'] %}style="background-color: #ffc107; padding: 2px 4px; border-radius: 3px;"{% endif %}>{{ match.sets_details }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted match-score">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                                <td class="d-none d-md-table-cell text-center" data-match-status-cell>
                                                    <span class="badge rounded-pill match-status
                                                        {% if match.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' %}bg-success
                                                        {% elif match.status == '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}bg-info
                                                        {% else %}bg-secondary{% endif %}"
                                                        {% if match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'] %}style="background-color: #ffc107 !important; color: #000 !important;"{% endif %}>
                                                        {{ match.status }}
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    {% if match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç', '–∑–∞–≤–µ—Ä—à–µ–Ω'] %}
                                                    <button class="btn btn-sm btn-outline-warning" 
                                                            onclick="event.stopPropagation(); openRallyJournalModalV2({{ match.id }}, '{{ match.participant1 }}', '{{ match.participant2 }}')"
                                                            title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π">
                                                        <i class="fas fa-book-open"></i>
                                                    </button>
                                                    {% else %}
                                                    <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>
                                </div>
                {% endif %}
            </div>
        </div>
                </div>
            </div>
            {% endif %}


            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞ -->
            {% if tournament.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' and not has_unfinished %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-body text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                                <h1 class="display-4 fw-bold text-success mb-3" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                                    üèÜ –¢—É—Ä–Ω–∏—Ä –∑–∞–≤–µ—Ä—à—ë–Ω! üèÜ
                                </h1>
                                <p class="lead text-muted">–í—Å–µ –º–∞—Ç—á–∏ —Å—ã–≥—Ä–∞–Ω—ã. –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</p>
                            </div>
                            
                            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π -->
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead class="table-success">
                                                <tr>
                                                    <th class="text-center" style="width: 60px;">–ú–µ—Å—Ç–æ</th>
                                                    <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                                    <th class="text-center">–û—á–∫–∏</th>
                                                    <th class="text-center">–ü–æ–±–µ–¥</th>
                                                    <th class="text-center">–ù–∏—á—å–∏—Ö</th>
                                                    <th class="text-center">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</th>
                                                    <th class="text-center">–†–∞–∑–Ω–∏—Ü–∞ –æ—á–∫–æ–≤</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for participant_data in participants %}
                                                {% set participant = participant_data.participant %}
                                                {% set stats = participant_data.stats %}
                                                {% set position = participant_data.position %}
                                                <tr class="{% if position == 1 %}table-warning fw-bold{% elif position <= 3 %}table-light{% endif %}">
                                                    <td class="text-center">
                                                        {% if position == 1 %}
                                                            <span class="badge bg-warning text-dark fs-6">ü•á</span>
                                                        {% elif position == 2 %}
                                                            <span class="badge bg-secondary fs-6">ü•à</span>
                                                        {% elif position == 3 %}
                                                            <span class="badge bg-warning text-dark fs-6">ü•â</span>
                                                        {% else %}
                                                            <span class="badge bg-light text-dark">{{ position }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="fw-bold">{{ participant.name }}</td>
                                                    <td class="text-center fw-bold text-primary">{{ stats.points }}</td>
                                                    <td class="text-center">{{ stats.wins }}</td>
                                                    <td class="text-center">{{ stats.draws }}</td>
                                                    <td class="text-center">{{ stats.losses }}</td>
                                                    <td class="text-center {% if stats.goal_difference > 0 %}text-success{% elif stats.goal_difference < 0 %}text-danger{% endif %}">
                                                        {{ stats.goal_difference }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è -->
                            {% if participants|length > 0 %}
                            {% set winner = participants[0] %}
                            <div class="mt-4">
                                <div class="alert alert-warning border-warning">
                                    <h4 class="alert-heading mb-3">
                                        <i class="fas fa-crown me-2"></i>
                                        –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è!
                                    </h4>
                                    <h3 class="text-warning fw-bold mb-2">{{ winner.participant.name }}</h3>
                                    <p class="mb-0">—Å –ø–æ–±–µ–¥–æ–π –≤ —Ç—É—Ä–Ω–∏—Ä–µ "{{ tournament.name }}"!</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card card-modern">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-modern" id="statisticsTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                –ú–µ—Å—Ç–æ
                                            </th>
                                            <th>
                                                –£—á–∞—Å—Ç–Ω–∏–∫
                                            </th>
                                            <th>
                                                –ò–≥—Ä
                                            </th>
                                            <th>
                                                –ü–æ–±–µ–¥
                                            </th>
                                            <th>
                                                –ü–æ—Ä–∞–∂–µ–Ω–∏–π
                                            </th>
                                            <th>
                                                –û—á–∫–∏<br><small>–≤ —Ç—É—Ä–Ω–∏—Ä–µ</small>
                                            </th>
                                            <th>
                                                –†–∞–∑–Ω–∏—Ü–∞ +/-<br><small>—Å–µ—Ç–æ–≤</small>
                                            </th>
                                            <th>
                                                –†–∞–∑–Ω–∏—Ü–∞ –æ—á–∫–æ–≤<br><small>–≤ —Å–µ—Ç–∞—Ö</small>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p1_data in participants_with_stats %}
                                        {% set participant = p1_data.participant %}
                                        {% set participant_stats = p1_data.stats %}
                                        {% set participant_position = p1_data.position %}
                                        <tr class="{% if p1_data.is_late_participant %}table-warning{% endif %}" data-participant-id="{{ participant.id }}">
                                            <td data-stat-position>{{ participant_position }}</td>
                                            <td>
                                                <strong>{{ participant.name }}</strong>
                                                {% if participant.is_team and tournament.sport_type != '–ë–∞–¥–º–∏–Ω—Ç–æ–Ω dbl' and tournament.sport_type != '–±–∞–¥–º–∏–Ω—Ç–æ–Ω dbl' and tournament.sport_type != '–ë–∞–¥–º–∏–Ω—Ç–æ–Ω –ø–∞—Ä–∞' and tournament.sport_type != '–±–∞–¥–º–∏–Ω—Ç–æ–Ω –ø–∞—Ä–∞' %}
                                                    <span class="badge bg-info ms-2">–ö–æ–º–∞–Ω–¥–∞</span>
                                                {% endif %}
                                            </td>
                                            <td data-stat-games>{{ participant_stats.games }}</td>
                                            <td data-stat-wins>{{ participant_stats.wins }}</td>
                                            <td data-stat-losses>{{ participant_stats.losses }}</td>
                                            <td data-stat-points>{{ participant_stats.points }}</td>
                                            <td data-stat-sets-diff>
                                                {% if participant_stats.sets_difference > 0 %}+{% endif %}{{ participant_stats.sets_difference }}
                                            </td>
                                            <td data-stat-goal-diff>
                                                {% if participant_stats.goal_difference > 0 %}+{% endif %}{{ participant_stats.goal_difference }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-table me-2"></i>–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="tournament-table">
                        <thead>
                            <tr>
                                            <th class="bg-light">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                            <th class="text-center bg-light">–û—á–∫–∏</th>
                                            <th class="text-center bg-light">–ú–µ—Å—Ç–æ</th>
                                {% for participant_data in participants_with_stats_chessboard %}
                                {% set participant = participant_data.participant %}
                                            <th class="text-center {% if participant_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %}">
                                                {{ participant.name[:15] }}{% if participant.name|length > 15 %}...{% endif %}
                                            </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                                        {% for p1_data in participants_with_stats_chessboard %}
                                        {% set p1 = p1_data.participant %}
                                        {% set p1_stats = p1_data.stats %}
                                        {% set p1_position = p1_data.position %}
                                        <tr>
                                            <td class="{% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold">
                                                {{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}
                                            </td>
                                            <td class="text-center {% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold text-primary" data-chessboard-points data-participant-id="{{ p1.id }}">{{ p1_stats.points }}</td>
                                            <td class="text-center {% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold text-success" data-chessboard-position data-participant-id="{{ p1.id }}">{{ p1_position }}</td>
                                            {% for p2_data in participants_with_stats_chessboard %}
                                            {% set p2 = p2_data.participant %}
                                            <td class="text-center position-relative {% if p1_data.is_late_participant or p2_data.is_late_participant %}bg-success bg-opacity-25{% endif %}" style="height: 80px; width: 120px; vertical-align: middle;" data-chessboard-cell data-p1-id="{{ p1.id }}" data-p2-id="{{ p2.id }}">
                                                {% if p1.id == p2.id %}
                                                    <span class="text-muted">‚Äî</span>
                                                {% else %}
                                                    {% set cell_data = chessboard[p1.id][p2.id] %}
                                                    {% if cell_data.type == 'result' %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            {% if cell_data.is_winner %}
                                                                <span class="badge bg-success text-white mb-1 chessboard-score">{{ cell_data.value }}</span>
                                    {% else %}
                                                                <span class="badge bg-danger text-white mb-1 chessboard-score">{{ cell_data.value }}</span>
                                                            {% endif %}
                                                            {% if cell_data.sets_details %}
                                                            <small class="text-muted chessboard-sets-details">{{ cell_data.sets_details }}</small>
                                                            {% endif %}
                                                        </div>
                                                    {% elif cell_data.type == 'in_progress' %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            <span class="badge bg-warning text-dark mb-1 chessboard-score" style="background-color: #ffc107 !important;">{{ cell_data.value }}</span>
                                                            {% if cell_data.sets_details %}
                                                            <small class="text-muted chessboard-sets-details">{{ cell_data.sets_details }}</small>
                                        {% endif %}
                                                        </div>
                                                    {% elif cell_data.type == 'upcoming' %}
                                                        {% set court_colors = {
                                                            1: 'primary',
                                                            2: 'info', 
                                                            3: 'success',
                                                            4: 'warning',
                                                            5: 'danger',
                                                            6: 'secondary',
                                                            7: 'dark',
                                                            8: 'light'
                                                        } %}
                                                        {% set is_next_match = cell_data.get('is_next_match', False) %}
                                                        {% set court_color = court_colors.get(cell_data.court, 'secondary') %}
                                                        
                                                        <div class="text-center position-relative {% if is_next_match %}border border-warning border-3 rounded bg-warning bg-opacity-10{% endif %}" 
                                                             style="{% if is_next_match %}animation: pulse 2s infinite;{% endif %}">
                                                            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ü–≤–µ—Ç–æ–º –ø–ª–æ—â–∞–¥–∫–∏ -->
                                                            <div class="{% if cell_data.is_next %}border border-warning border-1 rounded p-1 bg-warning bg-opacity-15 shadow-sm{% elif cell_data.is_second %}border border-success border-1 rounded p-1 bg-success bg-opacity-15 shadow-sm{% else %}border border-{{ court_color }} border-1 rounded p-1 bg-{{ court_color }} bg-opacity-10{% endif %}" style="height: 70px; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                                                <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å -->
                                                                <div>
                                                                    <!-- –ù–æ–º–µ—Ä –∫–æ—Ä—Ç–∞ –∫—Ä—É–ø–Ω—ã–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º -->
                                                                    <div class="text-center mb-1">
                                                                        <span style="font-size: 1.5rem; font-weight: bold; opacity: 0.3; color: {{ court_color }};">{{ cell_data.court }}</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- –í—Ä–µ–º—è –º–∞—Ç—á–∞ - –≤–Ω–∏–∑—É -->
                                                                <div class="mt-auto">
                                                                    <small class="d-block text-dark fw-bold text-center match-time" style="font-size: 0.6rem; background-color: rgba(255, 255, 255, 0.95); padding: 1px 3px; border-radius: 2px; max-width: 100%;">
                                                                        {% if cell_data.time %}
                                                                            {{ cell_data.time.strftime('%H:%M') }}
                                                    {% else %}
                                                                            –í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ
                                                                        {% endif %}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% elif cell_data.type == 'empty' %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                            {% endif %}
                                        </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
let autoRefreshInterval;
let refreshIntervalSeconds = 3; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let isAutoRefreshActive = true;
let lastUpdateTime = Date.now(); // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

function startAutoRefresh() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const indicator = document.getElementById('autoRefreshIndicator');
    if (indicator) {
        indicator.style.display = 'inline-block';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    updateToggleButton();
    
    // –ü–æ–ª—É—á–∞–µ–º ID —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ URL
    const urlParts = window.location.pathname.split('/').filter(part => part);
    let tournamentId = urlParts[urlParts.length - 1];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ tournamentId - —ç—Ç–æ —á–∏—Å–ª–æ
    if (!tournamentId || isNaN(tournamentId)) {
        console.error(`[startAutoRefresh] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ URL: ${window.location.pathname}`);
        return;
    }
    
    console.log(`[startAutoRefresh] ID —Ç—É—Ä–Ω–∏—Ä–∞: ${tournamentId}, URL: ${window.location.pathname}`);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    // –ù–∞—á–∏–Ω–∞–µ–º —Å –æ–±—ã—á–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞, –∑–∞—Ç–µ–º –∞–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    autoRefreshInterval = setInterval(function() {
        console.log(`[startAutoRefresh] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∂–¥—ã–µ ${refreshIntervalSeconds} —Å–µ–∫)...`);
        updateTournamentData(tournamentId);
    }, refreshIntervalSeconds * 1000);
    
    console.log(`[startAutoRefresh] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∂–¥—ã–µ ${refreshIntervalSeconds} —Å–µ–∫—É–Ω–¥)`);
    
    // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π
    updateTournamentData(tournamentId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞
function updateTournamentData(tournamentId) {
    console.log(`[updateTournamentData] –ó–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–∞ ${tournamentId}`);
    fetch(`/api/tournaments/${tournamentId}/updates`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log(`[updateTournamentData] –ü–æ–ª—É—á–µ–Ω–æ ${data.matches.length} –º–∞—Ç—á–µ–π –∏ ${data.participants_stats.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`);
                // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞—Ç—á–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                if (data.matches.length > 0) {
                    console.log('[updateTournamentData] –ü–µ—Ä–≤—ã–π –º–∞—Ç—á:', JSON.stringify(data.matches[0]));
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç –º–∞—Ç—á–µ–π
                updateMatches(data.matches);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                updateParticipantsStats(data.participants_stats);
                
                lastUpdateTime = Date.now();
                console.log('[updateTournamentData] –î–∞–Ω–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            } else {
                console.error('[updateTournamentData] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', data.error);
            }
        })
        .catch(error => {
            console.error('[updateTournamentData] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
        });
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç–∞ –º–∞—Ç—á–µ–π
function updateMatches(matches) {
    console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${matches.length} –º–∞—Ç—á–µ–π`);
    matches.forEach(match => {
        // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É –º–∞—Ç—á–∞ –ø–æ ID –∏–ª–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (–≤ –æ–±–æ–∏—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö)
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ID –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        const matchId = String(match.id);
        const p1Id = String(match.participant1_id);
        const p2Id = String(match.participant2_id);
        
        let matchRow = document.querySelector('tr[data-match-id="' + matchId + '"]');
        if (!matchRow) {
            matchRow = document.querySelector('tr[data-p1-id="' + p1Id + '"][data-p2-id="' + p2Id + '"]');
        }
        if (!matchRow) {
            // –ü—Ä–æ–±—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            matchRow = document.querySelector('tr[data-p1-id="' + p2Id + '"][data-p2-id="' + p1Id + '"]');
        }
        
        // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º —Å data-–∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
        if (!matchRow) {
            const allMatchRows = document.querySelectorAll('tr[data-match-id], tr[data-p1-id]');
            for (let row of allMatchRows) {
                const rowMatchId = row.getAttribute('data-match-id');
                const rowP1Id = row.getAttribute('data-p1-id');
                const rowP2Id = row.getAttribute('data-p2-id');
                if (rowMatchId === matchId || 
                    (rowP1Id === p1Id && rowP2Id === p2Id) ||
                    (rowP1Id === p2Id && rowP2Id === p1Id)) {
                    matchRow = row;
                    console.log('[updateMatches] –ú–∞—Ç—á –Ω–∞–π–¥–µ–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º:', matchId);
                    break;
                }
            }
        }
        
        if (matchRow) {
            console.log('[updateMatches] –ù–∞–π–¥–µ–Ω –º–∞—Ç—á', match.id, ':', match.participant1_name, 'vs', match.participant2_name, ', —Å—Ç–∞—Ç—É—Å:', match.status, ', —Å—á—ë—Ç:', match.score || '–Ω–µ—Ç');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç
            const scoreCell = matchRow.querySelector('[data-match-score-cell]');
            if (scoreCell) {
                const currentScoreEl = scoreCell.querySelector('.match-score');
                const currentScore = currentScoreEl ? currentScoreEl.textContent.trim() : (scoreCell.textContent.includes('‚Äî') ? '‚Äî' : '');
                const newScore = match.score || '‚Äî';
                
                // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º sets_details - –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Å—á—ë—Ç
                const currentSetsDetailsEl = scoreCell.querySelector('.match-sets-details');
                const currentSetsDetails = currentSetsDetailsEl ? currentSetsDetailsEl.textContent.trim() : '';
                const newSetsDetails = match.sets_details || '';
                
                console.log(`[updateMatches] –ú–∞—Ç—á ${match.id}: —Ç–µ–∫—É—â–∏–π —Å—á—ë—Ç="${currentScore}", –Ω–æ–≤—ã–π —Å—á—ë—Ç="${newScore}", —Å—Ç–∞—Ç—É—Å="${match.status}"`);
                console.log(`[updateMatches] –ú–∞—Ç—á ${match.id}: —Ç–µ–∫—É—â–∏–µ –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤="${currentSetsDetails}", –Ω–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏="${newSetsDetails}"`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ —Å—á—ë—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è, –∏–ª–∏ –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –∏–ª–∏ –µ—Å–ª–∏ –º–∞—Ç—á –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏ —Å—á—ë—Ç –µ—â–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
                const scoreChanged = currentScore !== newScore;
                const setsDetailsChanged = currentSetsDetails !== newSetsDetails;
                const shouldUpdate = scoreChanged || setsDetailsChanged || 
                                    (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status) && (currentScore === '‚Äî' || !currentScoreEl));
                
                console.log(`[updateMatches] shouldUpdate=${shouldUpdate}, scoreChanged=${scoreChanged}, setsDetailsChanged=${setsDetailsChanged}`);
                
                if (shouldUpdate) {
                    console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç–∞: "${currentScore}" -> "${newScore}"`);
                    console.log(`[updateMatches] –î–µ—Ç–∞–ª–∏: match.id=${match.id}, match.status=${match.status}, match.sets_won_1=${match.sets_won_1}, match.sets_won_2=${match.sets_won_2}`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç
                    const scoreBadge = scoreCell.querySelector('.match-score');
                    if (scoreBadge) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –±–µ–π–¥–∂–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                        scoreBadge.className = 'badge match-score';
                        if (match.status === '–∑–∞–≤–µ—Ä—à–µ–Ω') {
                            const scoreParts = newScore.split(':');
                            const score1 = parseInt(scoreParts[0]);
                            const score2 = parseInt(scoreParts[1]);
                            if (score1 > score2) {
                                scoreBadge.className += ' bg-success text-white';
                            } else {
                                scoreBadge.className += ' bg-danger text-white';
                            }
                        } else if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                            scoreBadge.className += ' bg-warning text-dark';
                            scoreBadge.style.cssText = 'background-color: #ffc107 !important; color: #000 !important;';
                        } else {
                            scoreBadge.className += ' bg-warning text-dark';
                        }
                        scoreBadge.textContent = newScore;
                    } else {
                        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –±–µ–π–¥–∂, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        scoreCell.innerHTML = '';
                        if (newScore !== '‚Äî') {
                            let badgeClass = 'badge match-score';
                            if (match.status === '–∑–∞–≤–µ—Ä—à–µ–Ω') {
                                const scoreParts = newScore.split(':');
                                const score1 = parseInt(scoreParts[0]);
                                const score2 = parseInt(scoreParts[1]);
                                badgeClass += score1 > score2 ? ' bg-success text-white' : ' bg-danger text-white';
                            } else if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                                badgeClass += ' bg-warning text-dark';
                            } else {
                                badgeClass += ' bg-warning text-dark';
                            }
                            const badge = document.createElement('span');
                            badge.className = badgeClass;
                            badge.textContent = newScore;
                            if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                                badge.style.cssText = 'background-color: #ffc107 !important; color: #000 !important;';
                            }
                            scoreCell.appendChild(badge);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å
                            if (match.sets_details) {
                                const setsDetails = document.createElement('br');
                                const setsSmall = document.createElement('small');
                                setsSmall.className = 'text-muted match-sets-details';
                                setsSmall.textContent = match.sets_details;
                                if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                                    setsSmall.style.cssText = 'background-color: #ffc107; padding: 2px 4px; border-radius: 3px;';
                                }
                                scoreCell.appendChild(setsDetails);
                                scoreCell.appendChild(setsSmall);
                            }
                        } else {
                            const span = document.createElement('span');
                            span.className = 'text-muted match-score';
                            span.textContent = '‚Äî';
                            scoreCell.appendChild(span);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ (–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
                    const setsDetailsEl = scoreCell.querySelector('.match-sets-details');
                    if (match.sets_details) {
                        if (setsDetailsEl) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                            if (setsDetailsEl.textContent.trim() !== match.sets_details) {
                                setsDetailsEl.textContent = match.sets_details;
                                console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤: "${setsDetailsEl.textContent.trim()}" -> "${match.sets_details}"`);
                            }
                        } else {
                            // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤
                            const br = document.createElement('br');
                            const small = document.createElement('small');
                            small.className = 'text-muted match-sets-details';
                            small.textContent = match.sets_details;
                            if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                                small.style.cssText = 'background-color: #ffc107; padding: 2px 4px; border-radius: 3px;';
                            }
                            scoreCell.appendChild(br);
                            scoreCell.appendChild(small);
                            console.log(`[updateMatches] –°–æ–∑–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤: "${match.sets_details}"`);
                        }
                    } else if (setsDetailsEl) {
                        setsDetailsEl.remove();
                        const brBefore = setsDetailsEl.previousSibling;
                        if (brBefore && brBefore.tagName === 'BR') {
                            brBefore.remove();
                        }
                    }
                } else {
                    // –î–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
                    if (setsDetailsChanged && match.sets_details) {
                        const setsDetailsEl = scoreCell.querySelector('.match-sets-details');
                        if (setsDetailsEl) {
                            setsDetailsEl.textContent = match.sets_details;
                            console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤: "${match.sets_details}"`);
                        } else if (match.sets_details) {
                            // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤
                            const br = document.createElement('br');
                            const small = document.createElement('small');
                            small.className = 'text-muted match-sets-details';
                            small.textContent = match.sets_details;
                            if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                                small.style.cssText = 'background-color: #ffc107; padding: 2px 4px; border-radius: 3px;';
                            }
                            const scoreBadge = scoreCell.querySelector('.match-score');
                            if (scoreBadge && scoreBadge.nextSibling) {
                                scoreCell.insertBefore(br, scoreBadge.nextSibling);
                                scoreCell.insertBefore(small, br.nextSibling);
                            } else {
                                scoreCell.appendChild(br);
                                scoreCell.appendChild(small);
                            }
                            console.log(`[updateMatches] –°–æ–∑–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—á—ë—Ç–∞): "${match.sets_details}"`);
                        }
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                const statusCell = matchRow.querySelector('[data-match-status-cell]');
                if (statusCell) {
                    const statusBadge = statusCell.querySelector('.match-status');
                    if (statusBadge && statusBadge.textContent.trim() !== match.status) {
                        statusBadge.className = 'badge rounded-pill match-status';
                        if (match.status === '–∑–∞–≤–µ—Ä—à–µ–Ω') {
                            statusBadge.className += ' bg-success';
                        } else if (match.status === '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω') {
                            statusBadge.className += ' bg-info';
                        } else {
                            statusBadge.className += ' bg-secondary';
                        }
                        if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                            statusBadge.style.cssText = 'background-color: #ffc107 !important; color: #000 !important;';
                        } else {
                            statusBadge.style.cssText = '';
                        }
                        statusBadge.textContent = match.status;
                    }
                }
            } else {
                console.log('[updateMatches] –Ø—á–µ–π–∫–∞ —Å—á—ë—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –º–∞—Ç—á–∞', match.id);
            }
        } else {
            console.log('[updateMatches] –°—Ç—Ä–æ–∫–∞ –º–∞—Ç—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ID=', match.id, ', p1=', match.participant1_id, '(', match.participant1_name, '), p2=', match.participant2_id, '(', match.participant2_name, ')');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞—Ö–º–∞—Ç–∫—É (—Ç—É—Ä–Ω–∏—Ä–Ω—É—é —Ç–∞–±–ª–∏—Ü—É) –¥–ª—è –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
        // –ò—â–µ–º —è—á–µ–π–∫—É —à–∞—Ö–º–∞—Ç–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ç—á–∞
        const chessboardCell1 = document.querySelector('td[data-chessboard-cell][data-p1-id="' + match.participant1_id + '"][data-p2-id="' + match.participant2_id + '"]');
        const chessboardCell2 = document.querySelector('td[data-chessboard-cell][data-p1-id="' + match.participant2_id + '"][data-p2-id="' + match.participant1_id + '"]');
        const chessboardCell = chessboardCell1 || chessboardCell2;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞—Ö–º–∞—Ç–∫—É –¥–ª—è –≤—Å–µ—Ö –º–∞—Ç—á–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
        if (chessboardCell) {
            const currentScoreEl = chessboardCell.querySelector('.chessboard-score');
            const currentScore = currentScoreEl ? currentScoreEl.textContent.trim() : '';
            const newScore = match.score || '';
            const currentSetsDetailsEl = chessboardCell.querySelector('.chessboard-sets-details');
            const currentSetsDetails = currentSetsDetailsEl ? currentSetsDetailsEl.textContent.trim() : '';
            const newSetsDetails = match.sets_details || '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å—á—ë—Ç, –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤, –∏–ª–∏ –µ—Å–ª–∏ –º–∞—Ç—á –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
            const scoreChanged = currentScore !== newScore;
            const setsDetailsChanged = currentSetsDetails !== newSetsDetails;
            const isInProgress = ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status);
            const isCompleted = match.status === '–∑–∞–≤–µ—Ä—à–µ–Ω';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏: —Å—á—ë—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è, –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –∏–ª–∏ –º–∞—Ç—á –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ/–∑–∞–≤–µ—Ä—à–µ–Ω –∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Ç—á–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ –º–∞—Ç—á–∞
            const shouldUpdate = scoreChanged || setsDetailsChanged || 
                                (isInProgress && (newScore || newSetsDetails)) ||
                                (isCompleted && newScore);
            
            console.log(`[updateMatches] –®–∞—Ö–º–∞—Ç–∫–∞ –¥–ª—è –º–∞—Ç—á–∞ ${match.id}: currentScore="${currentScore}", newScore="${newScore}", currentSets="${currentSetsDetails}", newSets="${newSetsDetails}", shouldUpdate=${shouldUpdate}, status=${match.status}`);
            
            if (shouldUpdate) {
                console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞—Ö–º–∞—Ç–∫–∏ –¥–ª—è –º–∞—Ç—á–∞ ${match.id}: —Å—á—ë—Ç="${currentScore}"->"${newScore}", –¥–µ—Ç–∞–ª–∏="${currentSetsDetails}"->"${newSetsDetails}"`);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –≤—ã–∏–≥—Ä–∞–ª (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –±–µ–π–¥–∂–∞) - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—á—ë—Ç
                let isRowWinner = false;
                if (newScore && newScore.includes(':')) {
                    const scoreParts = newScore.split(':');
                    const score1 = parseInt(scoreParts[0]) || 0;
                    const score2 = parseInt(scoreParts[1]) || 0;
                    const isP1Winner = score1 > score2;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ –≤ —Å—Ç—Ä–æ–∫–µ (p1) –∏ –∫–∞–∫–æ–π –≤ —Å—Ç–æ–ª–±—Ü–µ (p2)
                    const cellP1Id = parseInt(chessboardCell.getAttribute('data-p1-id'));
                    const cellP2Id = parseInt(chessboardCell.getAttribute('data-p2-id'));
                    const isP1InRow = cellP1Id === match.participant1_id;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ç—Ä–æ–∫–∏
                    isRowWinner = isP1InRow ? isP1Winner : !isP1Winner;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –±–µ–π–¥–∂
                let scoreBadge = chessboardCell.querySelector('.chessboard-score');
                if (!scoreBadge) {
                    // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    const container = document.createElement('div');
                    container.className = 'd-flex flex-column align-items-center';
                    chessboardCell.innerHTML = '';
                    chessboardCell.appendChild(container);
                    scoreBadge = document.createElement('span');
                    scoreBadge.className = 'badge mb-1 chessboard-score';
                    container.appendChild(scoreBadge);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∏ —Ç–µ–∫—Å—Ç –±–µ–π–¥–∂–∞
                scoreBadge.className = 'badge mb-1 chessboard-score';
                if (match.status === '–∑–∞–≤–µ—Ä—à–µ–Ω') {
                    if (isRowWinner) {
                        scoreBadge.className += ' bg-success text-white';
                    } else {
                        scoreBadge.className += ' bg-danger text-white';
                    }
                    scoreBadge.style.cssText = '';
                } else if (['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'].includes(match.status)) {
                    scoreBadge.className += ' bg-warning text-dark';
                    scoreBadge.style.cssText = 'background-color: #ffc107 !important; color: #000 !important;';
                } else {
                    scoreBadge.className += ' bg-warning text-dark';
                    scoreBadge.style.cssText = '';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—á—ë—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–í –ø—Ä–æ—Ü–µ—Å—Å–µ"
                // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω)
                if (newScore) {
                    scoreBadge.textContent = newScore;
                    console.log(`[updateMatches] –û–±–Ω–æ–≤–ª—ë–Ω —Å—á—ë—Ç –≤ —à–∞—Ö–º–∞—Ç–∫–µ: "${scoreBadge.textContent}"`);
                } else if (isInProgress) {
                    scoreBadge.textContent = '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                } else {
                    scoreBadge.textContent = '‚Äî';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ (–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
                let setsDetailsEl = chessboardCell.querySelector('.chessboard-sets-details');
                if (match.sets_details) {
                    if (setsDetailsEl) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                        if (setsDetailsEl.textContent.trim() !== match.sets_details) {
                            setsDetailsEl.textContent = match.sets_details;
                            console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ –≤ —à–∞—Ö–º–∞—Ç–∫–µ: "${match.sets_details}"`);
                        }
                    } else {
                        // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤
                        const container = chessboardCell.querySelector('.d-flex') || chessboardCell;
                        const small = document.createElement('small');
                        small.className = 'text-muted chessboard-sets-details';
                        if (isInProgress) {
                            small.style.cssText = 'background-color: #ffc107; padding: 2px 4px; border-radius: 3px;';
                        }
                        small.textContent = match.sets_details;
                        container.appendChild(small);
                        console.log(`[updateMatches] –°–æ–∑–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤ –≤ —à–∞—Ö–º–∞—Ç–∫–µ: "${match.sets_details}"`);
                    }
                } else if (setsDetailsEl && !isInProgress) {
                    // –£–¥–∞–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–∞—Ç—á –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
                    setsDetailsEl.remove();
                }
            } else if (setsDetailsChanged && match.sets_details) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
                let setsDetailsEl = chessboardCell.querySelector('.chessboard-sets-details');
                if (setsDetailsEl) {
                    setsDetailsEl.textContent = match.sets_details;
                    console.log(`[updateMatches] –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ —Å–µ—Ç–æ–≤ –≤ —à–∞—Ö–º–∞—Ç–∫–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á—ë—Ç–∞): "${match.sets_details}"`);
                } else {
                    // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤
                    const container = chessboardCell.querySelector('.d-flex') || chessboardCell;
                    if (container) {
                        const small = document.createElement('small');
                        small.className = 'text-muted chessboard-sets-details';
                        if (isInProgress) {
                            small.style.cssText = 'background-color: #ffc107; padding: 2px 4px; border-radius: 3px;';
                        }
                        small.textContent = match.sets_details;
                        container.appendChild(small);
                        console.log(`[updateMatches] –°–æ–∑–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–µ—Ç–æ–≤ –≤ —à–∞—Ö–º–∞—Ç–∫–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á—ë—Ç–∞): "${match.sets_details}"`);
                    }
                }
            }
        } else if (chessboardCell) {
            console.log(`[updateMatches] –®–∞—Ö–º–∞—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ –º–∞—Ç—á ${match.id} –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: score=${match.score}, sets_details=${match.sets_details}, status=${match.status}`);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
function updateParticipantsStats(participantsStats) {
    participantsStats.forEach(participantStat => {
        const participantRow = document.querySelector('tr[data-participant-id="' + participantStat.id + '"]');
        if (participantRow) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
            const positionCell = participantRow.querySelector('[data-stat-position]');
            if (positionCell && positionCell.textContent.trim() != participantStat.position) {
                positionCell.textContent = participantStat.position;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä—ã
            const gamesCell = participantRow.querySelector('[data-stat-games]');
            if (gamesCell && gamesCell.textContent.trim() != participantStat.games) {
                gamesCell.textContent = participantStat.games;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–±–µ–¥—ã
            const winsCell = participantRow.querySelector('[data-stat-wins]');
            if (winsCell && winsCell.textContent.trim() != participantStat.wins) {
                winsCell.textContent = participantStat.wins;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä–∞–∂–µ–Ω–∏—è
            const lossesCell = participantRow.querySelector('[data-stat-losses]');
            if (lossesCell && lossesCell.textContent.trim() != participantStat.losses) {
                lossesCell.textContent = participantStat.losses;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏
            const pointsCell = participantRow.querySelector('[data-stat-points]');
            if (pointsCell && pointsCell.textContent.trim() != participantStat.points) {
                pointsCell.textContent = participantStat.points;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —Å–µ—Ç–æ–≤
            const setsDiffCell = participantRow.querySelector('[data-stat-sets-diff]');
            if (setsDiffCell) {
                const newValue = participantStat.sets_difference > 0 ? '+' + participantStat.sets_difference : participantStat.sets_difference;
                if (setsDiffCell.textContent.trim() != newValue) {
                    setsDiffCell.textContent = newValue;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –æ—á–∫–æ–≤
            const goalDiffCell = participantRow.querySelector('[data-stat-goal-diff]');
            if (goalDiffCell) {
                const newValue = participantStat.goal_difference > 0 ? '+' + participantStat.goal_difference : participantStat.goal_difference;
                if (goalDiffCell.textContent.trim() != newValue) {
                    goalDiffCell.textContent = newValue;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏ –≤ —à–∞—Ö–º–∞—Ç–∫–µ
            const chessboardPoints = document.querySelector('td[data-chessboard-points][data-participant-id="' + participantStat.id + '"]');
            if (chessboardPoints && chessboardPoints.textContent.trim() != participantStat.points) {
                chessboardPoints.textContent = participantStat.points;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —à–∞—Ö–º–∞—Ç–∫–µ
            const chessboardPosition = document.querySelector('td[data-chessboard-position][data-participant-id="' + participantStat.id + '"]');
            if (chessboardPosition && chessboardPosition.textContent.trim() != participantStat.position) {
                chessboardPosition.textContent = participantStat.position;
            }
        }
    });
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const indicator = document.getElementById('autoRefreshIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        updateToggleButton();
        
        console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function setRefreshInterval(seconds) {
    refreshIntervalSeconds = seconds;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
    const intervalText = document.getElementById('intervalText');
    if (intervalText) {
        intervalText.textContent = `${seconds} —Å–µ–∫`;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    saveRefreshSettings();
    
    // –ï—Å–ª–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
    if (isAutoRefreshActive && autoRefreshInterval) {
        startAutoRefresh();
    }
    
    console.log(`–ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${seconds} —Å–µ–∫—É–Ω–¥`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function toggleAutoRefresh() {
    if (isAutoRefreshActive) {
        stopAutoRefresh();
        isAutoRefreshActive = false;
    } else {
        startAutoRefresh();
        isAutoRefreshActive = true;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    saveRefreshSettings();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function updateToggleButton() {
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (isAutoRefreshActive && autoRefreshInterval) {
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–∞—É–∑–∞"
        if (toggleIcon) toggleIcon.className = 'fas fa-pause';
        if (toggleText) toggleText.textContent = '–ü–∞—É–∑–∞';
    } else {
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å–∫"
        if (toggleIcon) toggleIcon.className = 'fas fa-play';
        if (toggleText) toggleText.textContent = '–ó–∞–ø—É—Å–∫';
    }
}

// BroadcastChannel –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
let scoreUpdateChannel = null;

function setupScoreUpdateListener() {
    try {
        scoreUpdateChannel = new BroadcastChannel('match-score-updates');
        scoreUpdateChannel.onmessage = function(event) {
            const data = event.data;
            if (data.type === 'score-updated' && data.matchId) {
                console.log(`[TournamentView] üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á—ë—Ç–∞ –¥–ª—è –º–∞—Ç—á–∞ ${data.matchId}`);
                // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á—ë—Ç–∞
                console.log('[TournamentView] üîÑ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á—ë—Ç–∞');
                // –ü–æ–ª—É—á–∞–µ–º ID —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ URL
                const urlParts = window.location.pathname.split('/').filter(part => part);
                let tournamentId = urlParts[urlParts.length - 1];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ tournamentId - —ç—Ç–æ —á–∏—Å–ª–æ
                if (tournamentId && !isNaN(tournamentId)) {
                    updateTournamentData(tournamentId);
                } else {
                    console.error(`[TournamentView] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ URL: ${window.location.pathname}`);
                }
            }
        };
        console.log('[TournamentView] üì° –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    } catch (error) {
        console.warn('[TournamentView] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å BroadcastChannel:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
    setupScoreUpdateListener();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ)
    loadRefreshSettings();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
    if (isAutoRefreshActive) {
        console.log('[DOMContentLoaded] –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
        startAutoRefresh();
    } else {
        console.log('[DOMContentLoaded] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        updateToggleButton();
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
        if (scoreUpdateChannel) {
            scoreUpdateChannel.close();
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
function loadRefreshSettings() {
    const savedInterval = localStorage.getItem('autoRefreshInterval');
    const savedState = localStorage.getItem('autoRefreshActive');
    
    if (savedInterval) {
        refreshIntervalSeconds = parseInt(savedInterval);
        const intervalText = document.getElementById('intervalText');
        if (intervalText) {
            intervalText.textContent = `${refreshIntervalSeconds} —Å–µ–∫`;
        }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ —è–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
    if (savedState !== null && savedState !== undefined) {
        isAutoRefreshActive = savedState === 'true';
    } else {
        // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∞–∫—Ç–∏–≤–Ω–æ)
        isAutoRefreshActive = true;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
function saveRefreshSettings() {
    localStorage.setItem('autoRefreshInterval', refreshIntervalSeconds.toString());
    localStorage.setItem('autoRefreshActive', isAutoRefreshActive.toString());
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
function openRallyJournalModal(matchId, participant1, participant2) {
    console.log('[Rally Journal] –û—Ç–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –º–∞—Ç—á–∞:', matchId);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const modal = document.getElementById('rallyJournalModal');
    if (!modal) {
        console.error('[Rally Journal] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    const modalTitle = modal.querySelector('.modal-title');
    if (!modalTitle) {
        console.error('[Rally Journal] –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    modalTitle.innerHTML = `<i class="fas fa-book me-2"></i>–ñ—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: <span style="color: #007bff; font-style: italic;">${participant1}</span> vs <span style="color: #dc3545; font-style: italic;">${participant2}</span>`;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º matchId –∏ –∏–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ loadRallyJournal
    modal.setAttribute('data-match-id', matchId);
    modal.setAttribute('data-participant1', participant1);
    modal.setAttribute('data-participant2', participant2);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–≥—Ä—É–∑–∫–∏ –≤ Excel
    const exportBtn = document.getElementById('exportRallyJournalBtn');
    if (exportBtn) {
        exportBtn.style.display = 'inline-block';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const content = document.getElementById('rallyJournalContent');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
        </div>
    `;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
    loadRallyJournal(matchId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
async function loadRallyJournal(matchId) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const modal = document.getElementById('rallyJournalModal');
        if (!modal) {
            console.warn('[Rally Journal] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        const participant1 = modal.getAttribute('data-participant1') || '';
        const participant2 = modal.getAttribute('data-participant2') || '';
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
        const normalizeName = (name) => {
            if (!name) return '';
            return name.trim().toLowerCase().replace(/\s+/g, ' ');
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –∫ –∫–∞–∫–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∏–º—è
        const getParticipantColor = (serverName) => {
            if (!serverName || !participant1 || !participant2) return null;
            
            // –ë–µ—Ä–µ–º –∏–º—è –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å " - —Å–ª–µ–≤–∞" –∏–ª–∏ " - —Å–ø—Ä–∞–≤–∞")
            const serverParts = serverName.split(' - ');
            const serverNameOnly = serverParts[0].trim();
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º–µ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const normalizedServerName = normalizeName(serverNameOnly);
            const normalizedP1 = normalizeName(participant1);
            const normalizedP2 = normalizeName(participant2);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ —á–∞—Å—Ç–µ–π
            const p1Parts = normalizedP1.split(' - ').map(p => p.trim()).filter(p => p);
            const p2Parts = normalizedP2.split(' - ').map(p => p.trim()).filter(p => p);
            
            const isParticipant1 = normalizedServerName === normalizedP1 || 
                                  (p1Parts.length > 0 && p1Parts.some(part => normalizedServerName.includes(part) || part.includes(normalizedServerName)));
            const isParticipant2 = normalizedServerName === normalizedP2 || 
                                  (p2Parts.length > 0 && p2Parts.some(part => normalizedServerName.includes(part) || part.includes(normalizedServerName)));
            
            if (isParticipant1) return '#007bff'; // —Å–∏–Ω–∏–π –¥–ª—è participant1
            if (isParticipant2) return '#dc3545'; // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è participant2
            return null; // —Ü–≤–µ—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—á—ë—Ç–∞ –∏ –∫–æ–º–∞–Ω–¥—ã
        // –ê–ª–≥–æ—Ä–∏—Ç–º (–í–†–ï–ú–ï–ù–ù–û –ò–ó–ú–ï–ù–Å–ù –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø):
        // - –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –∏–∑ —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã (participant1) –∏ (–ª–µ–≤–∞—è —á–∞—Å—Ç—å —Å—á—ë—Ç–∞) % 2 === 0 ‚Üí —Ä–æ–∑–æ–≤–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üó)
        // - –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –∏–∑ —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã (participant1) –∏ (–ª–µ–≤–∞—è —á–∞—Å—Ç—å —Å—á—ë—Ç–∞) % 2 !== 0 ‚Üí –≥–æ–ª—É–±–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üò)
        // - –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –∏–∑ –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã (participant2) –∏ (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —Å—á—ë—Ç–∞) % 2 === 0 ‚Üí —Ä–æ–∑–æ–≤–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üó)
        // - –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –∏–∑ –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã (participant2) –∏ (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —Å—á—ë—Ç–∞) % 2 !== 0 ‚Üí –≥–æ–ª—É–±–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üò)
        // –í–ê–ñ–ù–û: –§–æ—Ä–º—É–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ —Å (score + result) –Ω–∞ (score) –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const getArrowDirection = (serverName, score, result) => {
            if (!serverName || !score || result === undefined) return null;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫ –∫–∞–∫–æ–π –∫–æ–º–∞–Ω–¥–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ø–æ–¥–∞—é—â–∏–π
            const serverColor = getParticipantColor(serverName);
            if (!serverColor) return null;
            
            const isParticipant1 = serverColor === '#007bff'; // —Å–∏–Ω–∏–π = participant1
            const isParticipant2 = serverColor === '#dc3545'; // –∫—Ä–∞—Å–Ω—ã–π = participant2
            
            // –ü–∞—Ä—Å–∏–º —Å—á—ë—Ç (—Ñ–æ—Ä–º–∞—Ç "X:Y")
            const scoreParts = score.split(':');
            if (scoreParts.length !== 2) return null;
            
            const leftScore = parseInt(scoreParts[0]) || 0;
            const rightScore = parseInt(scoreParts[1]) || 0;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —á–∏—Å–ª–æ (1 –∏–ª–∏ 0)
            const resultValue = result ? 1 : 0;
            
            let isEven;
            if (isParticipant1) {
                // –î–ª—è —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–µ–≤—É—é —á–∞—Å—Ç—å —Å—á—ë—Ç–∞: score % 2 === 0
                isEven = (leftScore) % 2 === 0;
            } else if (isParticipant2) {
                // –î–ª—è –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å —Å—á—ë—Ç–∞: score % 2 === 0
                isEven = (rightScore) % 2 === 0;
            } else {
                return null;
            }
            
            // –ß—ë—Ç–Ω–æ–µ ‚Üí —Ä–æ–∑–æ–≤–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üó), –Ω–µ—á—ë—Ç–Ω–æ–µ ‚Üí –≥–æ–ª—É–±–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üò)
            return {
                arrow: isEven ? '‚Üó' : '‚Üò',
                color: isEven ? '#ff69b4' : '#00bfff' // —Ä–æ–∑–æ–≤—ã–π –¥–ª—è ‚Üó, –≥–æ–ª—É–±–æ–π –¥–ª—è ‚Üò
            };
        };
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –∏ –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        const [ralliesResponse, matchResponse] = await Promise.all([
            fetch(`/api/matches/${matchId}/rallies`),
            fetch(`/api/matches/${matchId}`)
        ]);
        
        const data = await ralliesResponse.json();
        const matchData = await matchResponse.json();
        
        const content = document.getElementById('rallyJournalContent');
        
        if (!data.success) {
            content.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π'}
                </div>
            `;
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—á—ë—Ç–æ–≤ —Å–µ—Ç–æ–≤
        const match = matchData.success ? matchData.match : null;
        const setScores = {};
        if (match) {
            setScores[1] = match.set1_score1 !== null && match.set1_score2 !== null ? 
                { score1: match.set1_score1, score2: match.set1_score2 } : null;
            setScores[2] = match.set2_score1 !== null && match.set2_score2 !== null ? 
                { score1: match.set2_score1, score2: match.set2_score2 } : null;
            setScores[3] = match.set3_score1 !== null && match.set3_score2 !== null ? 
                { score1: match.set3_score1, score2: match.set3_score2 } : null;
        }
        
        const rallies = data.rallies || [];
        
        if (rallies.length === 0) {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –†–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
                </div>
            `;
            return;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ —Å–µ—Ç–∞–º
        const ralliesBySet = {};
        rallies.forEach(rally => {
            const setNum = rally.set_number;
            if (!ralliesBySet[setNum]) {
                ralliesBySet[setNum] = [];
            }
            ralliesBySet[setNum].push(rally);
        });
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML
        let html = '<div class="rally-journal">';
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ç—ã –ø–æ –Ω–æ–º–µ—Ä—É
        const setNumbers = Object.keys(ralliesBySet).sort((a, b) => parseInt(a) - parseInt(b));
        
        setNumbers.forEach(setNum => {
            const setRallies = ralliesBySet[setNum];
            const setNumInt = parseInt(setNum);
            const finalScore = setScores[setNumInt];
            let scoreBadge = '';
            if (finalScore && finalScore.score1 !== null && finalScore.score2 !== null) {
                scoreBadge = `<span class="badge bg-primary ms-2">${finalScore.score1}:${finalScore.score2}</span>`;
            }
            html += `
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-trophy me-2"></i>–°–µ—Ç ${setNum}
                        ${scoreBadge}
                        <span class="badge bg-secondary ms-2">${setRallies.length} —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</span>
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">‚Ññ</th>
                                    <th style="width: 120px;">–í—Ä–µ–º—è</th>
                                    <th>–ü–æ–¥–∞—é—â–∏–π</th>
                                    <th>–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π</th>
                                    <th style="width: 100px;" class="text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                    <th style="width: 100px;" class="text-center">–°—á—ë—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            setRallies.forEach((rally, index) => {
                const rallyTime = new Date(rally.rally_datetime);
                const timeStr = rallyTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                // –†–µ–∑—É–ª—å—Ç–∞—Ç: 1 –µ—Å–ª–∏ –≤—ã–∏–≥—Ä–∞–ª –ø–æ–¥–∞—é—â–∏–π, 0 –µ—Å–ª–∏ –≤—ã–∏–≥—Ä–∞–ª –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π
                const resultValue = rally.server_won ? '1' : '0';
                const resultBadge = rally.server_won 
                    ? '<span class="badge bg-success">1</span>'
                    : '<span class="badge bg-danger">0</span>';
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (–≤—ã–Ω–æ—Å–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –±–ª–æ–∫–∞ if –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏)
                const resultValueForArrow = rally.server_won ? 1 : 0; // 1 –µ—Å–ª–∏ –ø–æ–¥–∞—é—â–∏–π –≤—ã–∏–≥—Ä–∞–ª, 0 –µ—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä–∞–ª
                
                // –ü–∞—Ä—Å–∏–º —Å—á—ë—Ç –ü–û–°–õ–ï —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                const scoreParts = rally.score.split(':');
                let scoreBefore = rally.score; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—á—ë—Ç –ü–û–°–õ–ï
                
                if (scoreParts.length === 2) {
                    let scoreAfterLeft = parseInt(scoreParts[0]) || 0;
                    let scoreAfterRight = parseInt(scoreParts[1]) || 0;
                    
                    // –ü–æ–ª—É—á–∞–µ–º swap_count –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (–µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω)
                    const swapCount = rally.swap_count !== undefined && rally.swap_count !== null ? rally.swap_count : 0;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –≤—ã–∏–≥—Ä–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à, —á—Ç–æ–±—ã –≤—ã—á–∏—Å–ª–∏—Ç—å —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                    const serverColor = getParticipantColor(rally.server_name);
                    const receiverColor = getParticipantColor(rally.receiver_name);
                    const isServerParticipant1 = serverColor === '#007bff'; // —Å–∏–Ω–∏–π = participant1
                    const isServerParticipant2 = serverColor === '#dc3545'; // –∫—Ä–∞—Å–Ω—ã–π = participant2
                    const isReceiverParticipant1 = receiverColor === '#007bff';
                    const isReceiverParticipant2 = receiverColor === '#dc3545';
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Å—á—ë—Ç (–ª–µ–≤—ã–π –∏–ª–∏ –ø—Ä–∞–≤—ã–π) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç participant1 –Ω–∞ –æ—Å–Ω–æ–≤–µ swap_count
                    let participant1Score, participant2Score;
                    if (swapCount % 2 === 0) {
                        // –ß—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: –ª–µ–≤—ã–π —Å—á—ë—Ç ‚Üí participant1, –ø—Ä–∞–≤—ã–π ‚Üí participant2
                        participant1Score = scoreAfterLeft;
                        participant2Score = scoreAfterRight;
                    } else {
                        // –ù–µ—á—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: –ø—Ä–∞–≤—ã–π —Å—á—ë—Ç ‚Üí participant1, –ª–µ–≤—ã–π ‚Üí participant2
                        participant1Score = scoreAfterRight;
                        participant2Score = scoreAfterLeft;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                    if (rally.server_won) {
                        // –í—ã–∏–≥—Ä–∞–ª –ø–æ–¥–∞—é—â–∏–π - –µ–≥–æ —Å—á—ë—Ç —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1
                        if (isServerParticipant1) {
                            participant1Score = Math.max(0, participant1Score - 1);
                        } else if (isServerParticipant2) {
                            participant2Score = Math.max(0, participant2Score - 1);
                        }
                    } else {
                        // –í—ã–∏–≥—Ä–∞–ª –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π - –µ–≥–æ —Å—á—ë—Ç —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1
                        if (isReceiverParticipant1) {
                            participant1Score = Math.max(0, participant1Score - 1);
                        } else if (isReceiverParticipant2) {
                            participant2Score = Math.max(0, participant2Score - 1);
                        }
                    }
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å —É—á—ë—Ç–æ–º swap_count
                    if (swapCount % 2 === 0) {
                        scoreBefore = `${participant1Score}:${participant2Score}`;
                    } else {
                        scoreBefore = `${participant2Score}:${participant1Score}`;
                    }
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–º—è –ø–æ–¥–∞—é—â–µ–≥–æ: —Ä–∞–∑–¥–µ–ª—è–µ–º –∏–º—è –∏ –ø–æ–∑–∏—Ü–∏—é, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∏
                let serverNameHtml = '';
                if (rally.server_name) {
                    const serverParts = rally.server_name.split(' - ');
                    const serverNameColor = getParticipantColor(rally.server_name);
                    const nameColorStyle = serverNameColor ? `color: ${serverNameColor};` : '';
                    
                    const arrowInfo = getArrowDirection(rally.server_name, scoreBefore, resultValueForArrow);
                    
                    if (arrowInfo && serverParts.length >= 1) {
                        // –ï—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–µ–ª–∫–µ: –∏–º—è –∂–∏—Ä–Ω—ã–º –∫—É—Ä—Å–∏–≤–æ–º —Å —Ü–≤–µ—Ç–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞, –ø–æ–∑–∏—Ü–∏—è —Å—Ç—Ä–µ–ª–æ—á–∫–æ–π 80%
                        // –ß—ë—Ç–Ω—ã–π —Å—á—ë—Ç ‚Üí ‚Üó (—Ä–æ–∑–æ–≤–∞—è —Å—Ç—Ä–µ–ª–∫–∞)
                        // –ù–µ—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç ‚Üí ‚Üò (–≥–æ–ª—É–±–∞—è —Å—Ç—Ä–µ–ª–∫–∞)
                        const serverNameOnly = serverParts[0].trim();
                        const arrow = arrowInfo.arrow;
                        const arrowColor = arrowInfo.color;
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—â–∏–Ω—É —Å—Ç—Ä–µ–ª–∫–∏ –≤ 4 —Ä–∞–∑–∞ —á–µ—Ä–µ–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ text-shadow
                        serverNameHtml = `<strong style="font-style: italic; ${nameColorStyle}">${serverNameOnly}</strong> <span style="font-style: italic; color: ${arrowColor}; font-size: 80%; font-weight: 900; text-shadow: 1px 0 0 ${arrowColor}, -1px 0 0 ${arrowColor}, 0 1px 0 ${arrowColor}, 0 -1px 0 ${arrowColor}, 0.7px 0.7px 0 ${arrowColor}, -0.7px -0.7px 0 ${arrowColor}, 0.7px -0.7px 0 ${arrowColor}, -0.7px 0.7px 0 ${arrowColor}, 1px 0.5px 0 ${arrowColor}, -1px -0.5px 0 ${arrowColor}, 0.5px 1px 0 ${arrowColor}, -0.5px -1px 0 ${arrowColor};"> ${arrow}</span>`;
                    } else {
                        // –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–µ–ª–∫–µ –∏–ª–∏ –ø–æ–∑–∏—Ü–∏–∏: –ø—Ä–æ—Å—Ç–æ –∏–º—è –∂–∏—Ä–Ω—ã–º –∫—É—Ä—Å–∏–≤–æ–º —Å —Ü–≤–µ—Ç–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
                        serverNameHtml = `<strong style="font-style: italic; ${nameColorStyle}">${rally.server_name}</strong>`;
                    }
                } else {
                    serverNameHtml = '<strong style="font-style: italic;">–ù–µ —É–∫–∞–∑–∞–Ω</strong>';
                }
                
                // –ò–º—è –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ: –∂–∏—Ä–Ω—ã–º –∫—É—Ä—Å–∏–≤–æ–º
                const receiverNameHtml = `<strong style="font-style: italic;">${rally.receiver_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>`;
                
                html += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td><small>${timeStr}</small></td>
                        <td>${serverNameHtml}</td>
                        <td>${receiverNameHtml}</td>
                        <td class="text-center">${resultBadge}</td>
                        <td class="text-center"><strong>${scoreBefore}</strong></td>
                    </tr>
                `;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç —Å–µ—Ç–∞ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω
            if (finalScore && finalScore.score1 !== null && finalScore.score2 !== null) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à—ë–Ω –ª–∏ —Å–µ—Ç
                const score1 = finalScore.score1;
                const score2 = finalScore.score2;
                const difference = Math.abs(score1 - score2);
                const pointsToWin = 21; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±–∞–¥–º–∏–Ω—Ç–æ–Ω–∞
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–µ—Ç–µ (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
                const hasRalliesInNextSet = ralliesBySet[setNumInt + 1] && ralliesBySet[setNumInt + 1].length > 0;
                
                // –°–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω, –µ—Å–ª–∏:
                // 1. –ï—Å—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–µ—Ç–µ (–∑–Ω–∞—á–∏—Ç —Ç–µ–∫—É—â–∏–π —Å–µ—Ç —Ç–æ—á–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω)
                // 2. –ò–õ–ò (—Ä–∞–∑–Ω–∏—Ü–∞ >= 2 –ò –æ–¥–∏–Ω –∏–∑ —Å—á—ë—Ç–æ–≤ >= pointsToWin) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –±–∞–¥–º–∏–Ω—Ç–æ–Ω–∞
                // 3. –ò–õ–ò –æ–¥–∏–Ω –∏–∑ —Å—á—ë—Ç–æ–≤ >= 30 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—á—ë—Ç)
                const isSetCompleted = hasRalliesInNextSet || 
                    (difference >= 2 && (score1 >= pointsToWin || score2 >= pointsToWin)) ||
                    (score1 >= 30 || score2 >= 30);
                
                if (isSetCompleted) {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º swap_count –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    const lastRally = setRallies[setRallies.length - 1];
                    const swapCount = lastRally && lastRally.swap_count !== undefined && lastRally.swap_count !== null ? lastRally.swap_count : 0;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Å—á—ë—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç participant1 (—Å–∏–Ω–∏–π) –∏ participant2 (–∫—Ä–∞—Å–Ω—ã–π)
                    let blueScore, redScore;
                    if (swapCount % 2 === 0) {
                        // –ß—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: score1 ‚Üí participant1 (—Å–∏–Ω–∏–π), score2 ‚Üí participant2 (–∫—Ä–∞—Å–Ω—ã–π)
                        blueScore = finalScore.score1;
                        redScore = finalScore.score2;
                    } else {
                        // –ù–µ—á—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: score2 ‚Üí participant1 (—Å–∏–Ω–∏–π), score1 ‚Üí participant2 (–∫—Ä–∞—Å–Ω—ã–π)
                        blueScore = finalScore.score2;
                        redScore = finalScore.score1;
                    }
                    
                    html += `
                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                            <td colspan="5" class="text-end"><strong>–°—á—ë—Ç —Å–µ—Ç–∞:</strong></td>
                            <td class="text-center">
                                <strong>
                                    <span style="color: #007bff;">${blueScore}</span>
                                    <span>:</span>
                                    <span style="color: #dc3545;">${redScore}</span>
                                </strong>
                            </td>
                        </tr>
                    `;
                }
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
        if (modal) {
            modal.setAttribute('data-rallies', JSON.stringify(rallies));
        }
        
        console.log('[Rally Journal] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:', rallies.length);
        
    } catch (error) {
        console.error('[Rally Journal] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞:', error);
        const content = document.getElementById('rallyJournalContent');
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: ${error.message}
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
function updateRallyJournal() {
    const modal = document.getElementById('rallyJournalModal');
    if (!modal) {
        console.error('[Rally Journal] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    
    const matchId = modal.getAttribute('data-match-id');
    if (!matchId) {
        console.error('[Rally Journal] MatchId –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const content = document.getElementById('rallyJournalContent');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
            </div>
            <p class="mt-2 text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
        </div>
    `;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∑–∞–Ω–æ–≤–æ
    loadRallyJournal(matchId);
}

// –í—ã–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –≤ Excel
async function exportRallyJournalToExcel() {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ - –æ–±—ã—á–Ω–æ–µ –∏–ª–∏ V2
        const modal = document.getElementById('rallyJournalModal');
        const modalV2 = document.getElementById('rallyJournalModalV2');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–µ –∏–∑ –Ω–∏—Ö –≤–∏–¥–∏–º–æ
        let activeModal = null;
        if (modalV2 && (modalV2.classList.contains('show') || window.getComputedStyle(modalV2).display !== 'none')) {
            activeModal = modalV2;
        } else if (modal && (modal.classList.contains('show') || window.getComputedStyle(modal).display !== 'none')) {
            activeModal = modal;
        } else {
            // –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ —è–≤–Ω–æ, –ø—Ä–æ–±—É–µ–º –æ–±–∞
            activeModal = modalV2 || modal;
        }
        
        console.log('[exportRallyJournalToExcel] –ê–∫—Ç–∏–≤–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ:', activeModal ? activeModal.id : '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        
        const matchId = activeModal ? activeModal.getAttribute('data-match-id') : null;
        
        if (!matchId) {
            alert('–ù–µ —É–∫–∞–∑–∞–Ω ID –º–∞—Ç—á–∞');
            return;
        }
        
        // –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏–∑ API –ø–µ—Ä–µ–¥ –≤—ã–≥—Ä—É–∑–∫–æ–π
        console.log('[exportRallyJournalToExcel] –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏–∑ API –¥–ª—è –º–∞—Ç—á–∞', matchId);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î
        await new Promise(resolve => setTimeout(resolve, 500));
        
        let rallies;
        let retryCount = 0;
        const maxRetries = 3;
        
        while (retryCount < maxRetries) {
            try {
                const apiUrl = `/api/matches/${matchId}/rallies?_t=${Date.now()}&_r=${Math.random()}&_retry=${retryCount}`;
                console.log(`[exportRallyJournalToExcel] –ó–∞–ø—Ä–æ—Å –∫ API (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}/${maxRetries}):`, apiUrl);
                
                const response = await fetch(apiUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[exportRallyJournalToExcel] –û—Ç–≤–µ—Ç –æ—Ç API:', {
                    success: data.success,
                    count: data.count,
                    ralliesCount: data.rallies ? data.rallies.length : 0,
                    attempt: retryCount + 1
                });
                
                if (!data.success || !data.rallies) {
                    // –ï—Å–ª–∏ API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const ralliesData = activeModal ? activeModal.getAttribute('data-rallies') : null;
                    if (ralliesData) {
                        console.warn('[exportRallyJournalToExcel] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫ –∫–∞–∫ API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ');
                        rallies = JSON.parse(ralliesData);
                        break;
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π');
                    }
                } else {
                    rallies = data.rallies;
                    console.log('[exportRallyJournalToExcel] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏–∑ API:', rallies.length);
                    break;
                }
            } catch (error) {
                retryCount++;
                console.error(`[exportRallyJournalToExcel] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${maxRetries}):`, error);
                
                if (retryCount >= maxRetries) {
                    // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                    const ralliesData = activeModal ? activeModal.getAttribute('data-rallies') : null;
                    if (ralliesData) {
                        console.warn('[exportRallyJournalToExcel] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ API');
                        rallies = JSON.parse(ralliesData);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: ' + error.message);
                        return;
                    }
                } else {
                    // –ñ–¥—ë–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
        }
        
        if (!rallies || rallies.length === 0) {
            alert('–ù–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –∂—É—Ä–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç (V1 –∏–ª–∏ V2)
        const isV2 = activeModal && activeModal.id === 'rallyJournalModalV2';
        console.log('[exportRallyJournalToExcel] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç:', isV2 ? 'V2 (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏, –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Å—á—ë—Ç)' : 'V1 (–≤—Ä–µ–º—è, —Å—á—ë—Ç –¥–æ –ø–æ–¥–∞—á–∏)');
        
        // –°–æ–∑–¥–∞–µ–º CSV —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        let csvContent = '\uFEFF'; // BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏ UTF-8
        
        if (isV2) {
            // –§–æ—Ä–º–∞—Ç V2: –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏ –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Å—á—ë—Ç –≤ –¥–≤—É—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö
            csvContent += '‚Ññ,–°–µ—Ç,–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫),–ü–æ–¥–∞—é—â–∏–π,–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π,–†–µ–∑—É–ª—å—Ç–∞—Ç,–°—á—ë—Ç (–ª–µ–≤–∞—è),–°—á—ë—Ç (–ø—Ä–∞–≤–∞—è)\n';
        } else {
            // –§–æ—Ä–º–∞—Ç V1: –≤—Ä–µ–º—è –∏ —Å—á—ë—Ç –¥–æ –ø–æ–¥–∞—á–∏
            csvContent += '‚Ññ,–°–µ—Ç,–î–∞—Ç–∞,–í—Ä–µ–º—è,–ü–æ–¥–∞—é—â–∏–π,–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π,–†–µ–∑—É–ª—å—Ç–∞—Ç,–°—á—ë—Ç\n';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è scoreBefore
        const participant1 = activeModal ? (activeModal.getAttribute('data-participant1') || '') : '';
        const participant2 = activeModal ? (activeModal.getAttribute('data-participant2') || '') : '';
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        const getParticipantColor = (serverName) => {
            if (!serverName || !participant1 || !participant2) return null;
            const serverParts = serverName.split(' - ');
            const serverNameOnly = serverParts[0].trim();
            const normalizedServerName = serverNameOnly.toLowerCase().trim();
            const normalizedP1 = participant1.toLowerCase().trim();
            const normalizedP2 = participant2.toLowerCase().trim();
            
            if (normalizedServerName === normalizedP1 || normalizedServerName.includes(normalizedP1) || normalizedP1.includes(normalizedServerName)) {
                return '#007bff'; // —Å–∏–Ω–∏–π –¥–ª—è participant1
            }
            if (normalizedServerName === normalizedP2 || normalizedServerName.includes(normalizedP2) || normalizedP2.includes(normalizedServerName)) {
                return '#dc3545'; // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è participant2
            }
            return null;
        };
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ —Å–µ—Ç–∞–º –¥–ª—è V2
        const ralliesBySet = {};
        if (isV2) {
            rallies.forEach(rally => {
                const setNum = rally.set_number;
                if (!ralliesBySet[setNum]) {
                    ralliesBySet[setNum] = [];
                }
                ralliesBySet[setNum].push(rally);
            });
        }
        
        let processedCount = 0;
        
        if (isV2) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ V2: –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Å—á—ë—Ç
            const setNumbers = Object.keys(ralliesBySet).sort((a, b) => parseInt(a) - parseInt(b));
            
            setNumbers.forEach(setNum => {
                const setRallies = ralliesBySet[setNum];
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—á—ë—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å 0:0)
                let computedScoreLeft = 0;
                let computedScoreRight = 0;
                
                setRallies.forEach((rally, index) => {
                    try {
                        if (!rally || !rally.rally_datetime || !rally.score) {
                            console.warn(`[exportRallyJournalToExcel] ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω —Ä–æ–∑—ã–≥—Ä—ã—à ${index + 1} —Å–µ—Ç–∞ ${setNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ`, rally);
                            return;
                        }
                        
                        const rallyTime = new Date(rally.rally_datetime);
                        if (isNaN(rallyTime.getTime())) {
                            console.warn(`[exportRallyJournalToExcel] ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω —Ä–æ–∑—ã–≥—Ä—ã—à ${index + 1} —Å–µ—Ç–∞ ${setNum}: –Ω–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞`, rally.rally_datetime);
                            return;
                        }
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                        let timeIntervalStr = '0';
                        if (index > 0) {
                            const prevRally = setRallies[index - 1];
                            const prevRallyTime = new Date(prevRally.rally_datetime);
                            const intervalSeconds = Math.round((rallyTime - prevRallyTime) / 1000);
                            timeIntervalStr = String(intervalSeconds);
                        }
                        
                        const result = rally.server_won ? '1' : '0';
                        const serverName = rally.server_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                        const receiverName = rally.receiver_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º —Å—á—ë—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–∫–∞–∫ –≤ loadRallyJournalV2)
                        const swapCount = rally.swap_count !== undefined && rally.swap_count !== null ? rally.swap_count : 0;
                        const serverColor = getParticipantColor(rally.server_name);
                        const receiverColor = getParticipantColor(rally.receiver_name);
                        const isServerParticipant1 = serverColor === '#007bff';
                        const isServerParticipant2 = serverColor === '#dc3545';
                        const isReceiverParticipant1 = receiverColor === '#007bff';
                        const isReceiverParticipant2 = receiverColor === '#dc3545';
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                        const scoreBeforeLeft = computedScoreLeft;
                        const scoreBeforeRight = computedScoreRight;
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Å—á—ë—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç participant1 –∏ participant2
                        let participant1ScoreBefore, participant2ScoreBefore;
                        if (swapCount % 2 === 0) {
                            participant1ScoreBefore = scoreBeforeLeft;
                            participant2ScoreBefore = scoreBeforeRight;
                        } else {
                            participant1ScoreBefore = scoreBeforeRight;
                            participant2ScoreBefore = scoreBeforeLeft;
                        }
                        
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç —Ç–æ–≥–æ, –∫—Ç–æ –≤—ã–∏–≥—Ä–∞–ª
                        if (rally.server_won) {
                            if (isServerParticipant1) {
                                participant1ScoreBefore++;
                            } else if (isServerParticipant2) {
                                participant2ScoreBefore++;
                            }
                        } else {
                            if (isReceiverParticipant1) {
                                participant1ScoreBefore++;
                            } else if (isReceiverParticipant2) {
                                participant2ScoreBefore++;
                            }
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π —Å—á—ë—Ç
                        if (swapCount % 2 === 0) {
                            computedScoreLeft = participant1ScoreBefore;
                            computedScoreRight = participant2ScoreBefore;
                        } else {
                            computedScoreLeft = participant2ScoreBefore;
                            computedScoreRight = participant1ScoreBefore;
                        }
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∏–ª–∞ –æ—á–∫–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        let scoreLeft = '';
                        let scoreRight = '';
                        
                        if (swapCount % 2 === 0) {
                            if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                                scoreLeft = String(computedScoreLeft);
                                scoreRight = '';
                            } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                                scoreLeft = '';
                                scoreRight = String(computedScoreRight);
                            }
                        } else {
                            if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                                scoreLeft = '';
                                scoreRight = String(computedScoreRight);
                            } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                                scoreLeft = String(computedScoreLeft);
                                scoreRight = '';
                            }
                        }
                        
                        csvContent += `${processedCount + 1},${setNum},${timeIntervalStr},"${serverName}","${receiverName}",${result},"${scoreLeft}","${scoreRight}"\n`;
                        processedCount++;
                    } catch (error) {
                        console.error(`[exportRallyJournalToExcel] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ ${index + 1} —Å–µ—Ç–∞ ${setNum}:`, error, rally);
                    }
                });
            });
        } else {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ V1: –≤—Ä–µ–º—è –∏ —Å—á—ë—Ç –¥–æ –ø–æ–¥–∞—á–∏
            rallies.forEach((rally, index) => {
                try {
                    if (!rally || !rally.rally_datetime || !rally.score) {
                        console.warn(`[exportRallyJournalToExcel] ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω —Ä–æ–∑—ã–≥—Ä—ã—à ${index + 1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ`, rally);
                        return;
                    }
                    
                    const rallyTime = new Date(rally.rally_datetime);
                    if (isNaN(rallyTime.getTime())) {
                        console.warn(`[exportRallyJournalToExcel] ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω —Ä–æ–∑—ã–≥—Ä—ã—à ${index + 1}: –Ω–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞`, rally.rally_datetime);
                        return;
                    }
                    
                    const dateStr = rallyTime.toLocaleDateString('ru-RU');
                    const timeStr = rallyTime.toLocaleTimeString('ru-RU', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    const result = rally.server_won ? '1' : '0';
                    const serverName = rally.server_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    const receiverName = rally.receiver_name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                    let scoreBefore = rally.score;
                    const scoreParts = rally.score ? rally.score.split(':') : [];
                    if (scoreParts.length === 2) {
                        let scoreAfterLeft = parseInt(scoreParts[0]) || 0;
                        let scoreAfterRight = parseInt(scoreParts[1]) || 0;
                        
                        const swapCount = rally.swap_count !== undefined && rally.swap_count !== null ? rally.swap_count : 0;
                        const serverColor = getParticipantColor(rally.server_name);
                        const receiverColor = getParticipantColor(rally.receiver_name);
                        const isServerParticipant1 = serverColor === '#007bff';
                        const isServerParticipant2 = serverColor === '#dc3545';
                        const isReceiverParticipant1 = receiverColor === '#007bff';
                        const isReceiverParticipant2 = receiverColor === '#dc3545';
                        
                        let participant1Score, participant2Score;
                        if (swapCount % 2 === 0) {
                            participant1Score = scoreAfterLeft;
                            participant2Score = scoreAfterRight;
                        } else {
                            participant1Score = scoreAfterRight;
                            participant2Score = scoreAfterLeft;
                        }
                        
                        if (rally.server_won) {
                            if (isServerParticipant1) {
                                participant1Score = Math.max(0, participant1Score - 1);
                            } else if (isServerParticipant2) {
                                participant2Score = Math.max(0, participant2Score - 1);
                            }
                        } else {
                            if (isReceiverParticipant1) {
                                participant1Score = Math.max(0, participant1Score - 1);
                            } else if (isReceiverParticipant2) {
                                participant2Score = Math.max(0, participant2Score - 1);
                            }
                        }
                        
                        if (swapCount % 2 === 0) {
                            scoreBefore = `${participant1Score}:${participant2Score}`;
                        } else {
                            scoreBefore = `${participant2Score}:${participant1Score}`;
                        }
                    }
                    
                    csvContent += `${index + 1},${rally.set_number},"${dateStr}","${timeStr}","${serverName}","${receiverName}",${result},"${scoreBefore}"\n`;
                    processedCount++;
                } catch (error) {
                    console.error(`[exportRallyJournalToExcel] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ ${index + 1}:`, error, rally);
                }
            });
        }
        
        console.log('[exportRallyJournalToExcel] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:', processedCount, '–∏–∑', rallies.length);
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–ª–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
        let tournamentName = activeModal ? activeModal.getAttribute('data-tournament-name') : null;
        if (!tournamentName) {
            tournamentName = typeof window.tournamentName !== 'undefined' ? window.tournamentName : '{{ tournament.name|default("") }}';
        }
        
        // –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        const sanitizedTournamentName = tournamentName 
            ? tournamentName.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').substring(0, 50)
            : '';
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç—É—Ä–Ω–∏—Ä–∞
        const fileName = sanitizedTournamentName 
            ? `${sanitizedTournamentName}_match_${matchId}_journal.csv`
            : `match_${matchId}_journal.csv`;
        
        // –°–æ–∑–¥–∞–µ–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`–£—Å–ø–µ—à–Ω–æ! –ñ—É—Ä–Ω–∞–ª –º–∞—Ç—á–∞ ${matchId} –≤—ã–≥—Ä—É–∂–µ–Ω –≤ Excel.`);
        console.log('[Rally Journal] –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    } catch (error) {
        console.error('[Rally Journal] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞: ' + error.message);
    }
}

// ==================== –ö–û–ü–ò–Ø –ñ–£–†–ù–ê–õ–ê –†–û–ó–´–ì–†–´–®–ï–ô (–í–ê–†–ò–ê–ù–¢ 2) ====================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–≤–∞—Ä–∏–∞–Ω—Ç 2)
function openRallyJournalModalV2(matchId, participant1, participant2) {
    console.log('[Rally Journal V2] –û—Ç–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –º–∞—Ç—á–∞:', matchId);
    
    const modal = document.getElementById('rallyJournalModalV2');
    if (!modal) {
        console.error('[Rally Journal V2] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    const modalTitle = modal.querySelector('.modal-title');
    if (!modalTitle) {
        console.error('[Rally Journal V2] –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    modalTitle.innerHTML = `<i class="fas fa-book me-2"></i>–ñ—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: <span style="color: #007bff; font-style: italic;">${participant1}</span> vs <span style="color: #dc3545; font-style: italic;">${participant2}</span>`;
    
    modal.setAttribute('data-match-id', matchId);
    modal.setAttribute('data-participant1', participant1);
    modal.setAttribute('data-participant2', participant2);
    modal.setAttribute('data-tournament-name', '{{ tournament.name }}');
    
    const exportBtn = document.getElementById('exportRallyJournalBtnV2');
    if (exportBtn) {
        exportBtn.style.display = 'inline-block';
    }
    
    const content = document.getElementById('rallyJournalContentV2');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
        </div>
    `;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    loadRallyJournalV2(matchId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–≤–∞—Ä–∏–∞–Ω—Ç 2)
async function loadRallyJournalV2(matchId) {
    try {
        const modal = document.getElementById('rallyJournalModalV2');
        if (!modal) {
            console.warn('[Rally Journal V2] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        const participant1 = modal.getAttribute('data-participant1') || '';
        const participant2 = modal.getAttribute('data-participant2') || '';
        
        const normalizeName = (name) => {
            if (!name) return '';
            return name.trim().toLowerCase().replace(/\s+/g, ' ');
        };
        
        const getParticipantColor = (serverName) => {
            if (!serverName || !participant1 || !participant2) return null;
            const serverParts = serverName.split(' - ');
            const serverNameOnly = serverParts[0].trim();
            const normalizedServerName = normalizeName(serverNameOnly);
            const normalizedP1 = normalizeName(participant1);
            const normalizedP2 = normalizeName(participant2);
            const p1Parts = normalizedP1.split(' - ').map(p => p.trim()).filter(p => p);
            const p2Parts = normalizedP2.split(' - ').map(p => p.trim()).filter(p => p);
            const isParticipant1 = normalizedServerName === normalizedP1 || 
                                  (p1Parts.length > 0 && p1Parts.some(part => normalizedServerName.includes(part) || part.includes(normalizedServerName)));
            const isParticipant2 = normalizedServerName === normalizedP2 || 
                                  (p2Parts.length > 0 && p2Parts.some(part => normalizedServerName.includes(part) || part.includes(normalizedServerName)));
            if (isParticipant1) return '#007bff';
            if (isParticipant2) return '#dc3545';
            return null;
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—á—ë—Ç–∞, –∫–æ–º–∞–Ω–¥—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        const getArrowDirection = (serverName, score, result) => {
            if (!serverName || !score || result === undefined) return null;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫ –∫–∞–∫–æ–π –∫–æ–º–∞–Ω–¥–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ø–æ–¥–∞—é—â–∏–π
            const serverColor = getParticipantColor(serverName);
            if (!serverColor) return null;
            
            const isParticipant1 = serverColor === '#007bff'; // —Å–∏–Ω–∏–π = participant1
            const isParticipant2 = serverColor === '#dc3545'; // –∫—Ä–∞—Å–Ω—ã–π = participant2
            
            // –ü–∞—Ä—Å–∏–º —Å—á—ë—Ç (—Ñ–æ—Ä–º–∞—Ç "X:Y")
            const scoreParts = score.split(':');
            if (scoreParts.length !== 2) return null;
            
            const leftScore = parseInt(scoreParts[0]) || 0;
            const rightScore = parseInt(scoreParts[1]) || 0;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —á–∏—Å–ª–æ (1 –∏–ª–∏ 0)
            const resultValue = result ? 1 : 0;
            
            let isEven;
            if (isParticipant1) {
                // –î–ª—è —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–µ–≤—É—é —á–∞—Å—Ç—å —Å—á—ë—Ç–∞: score % 2 === 0
                isEven = (leftScore) % 2 === 0;
            } else if (isParticipant2) {
                // –î–ª—è –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å —Å—á—ë—Ç–∞: score % 2 === 0
                isEven = (rightScore) % 2 === 0;
            } else {
                return null;
            }
            
            // –ß—ë—Ç–Ω–æ–µ ‚Üí —Ä–æ–∑–æ–≤–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üó), –Ω–µ—á—ë—Ç–Ω–æ–µ ‚Üí –≥–æ–ª—É–±–∞—è —Å—Ç—Ä–µ–ª–∫–∞ (‚Üò)
            return {
                arrow: isEven ? '‚Üó' : '‚Üò',
                color: isEven ? '#ff69b4' : '#00bfff' // —Ä–æ–∑–æ–≤—ã–π –¥–ª—è ‚Üó, –≥–æ–ª—É–±–æ–π –¥–ª—è ‚Üò
            };
        };
        
        const [ralliesResponse, matchResponse] = await Promise.all([
            fetch(`/api/matches/${matchId}/rallies`),
            fetch(`/api/matches/${matchId}`)
        ]);
        
        const data = await ralliesResponse.json();
        const matchData = await matchResponse.json();
        const content = document.getElementById('rallyJournalContentV2');
        
        if (!data.success) {
            content.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π'}
                </div>
            `;
            return;
        }
        
        const match = matchData.success ? matchData.match : null;
        const setScores = {};
        if (match) {
            setScores[1] = match.set1_score1 !== null && match.set1_score2 !== null ? 
                { score1: match.set1_score1, score2: match.set1_score2 } : null;
            setScores[2] = match.set2_score1 !== null && match.set2_score2 !== null ? 
                { score1: match.set2_score1, score2: match.set2_score2 } : null;
            setScores[3] = match.set3_score1 !== null && match.set3_score2 !== null ? 
                { score1: match.set3_score1, score2: match.set3_score2 } : null;
        }
        
        const rallies = data.rallies || [];
        
        if (rallies.length === 0) {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –†–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
                </div>
            `;
            return;
        }
        
        const ralliesBySet = {};
        rallies.forEach(rally => {
            const setNum = rally.set_number;
            if (!ralliesBySet[setNum]) {
                ralliesBySet[setNum] = [];
            }
            ralliesBySet[setNum].push(rally);
        });
        
        let html = '<div class="rally-journal">';
        const setNumbers = Object.keys(ralliesBySet).sort((a, b) => parseInt(a) - parseInt(b));
        
        setNumbers.forEach(setNum => {
            const setRallies = ralliesBySet[setNum];
            const setNumInt = parseInt(setNum);
            const finalScore = setScores[setNumInt];
            let scoreBadge = '';
            if (finalScore && finalScore.score1 !== null && finalScore.score2 !== null) {
                scoreBadge = `<span class="badge bg-primary ms-2">${finalScore.score1}:${finalScore.score2}</span>`;
            }
            html += `
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-trophy me-2"></i>–°–µ—Ç ${setNum}
                        ${scoreBadge}
                        <span class="badge bg-secondary ms-2">${setRallies.length} —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</span>
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">‚Ññ</th>
                                    <th style="width: 120px;">–í—Ä–µ–º—è</th>
                                    <th>–ü–æ–¥–∞—é—â–∏–π</th>
                                    <th>–ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π</th>
                                    <th style="width: 100px;" class="text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                    <th colspan="2" style="width: 100px;" class="text-center">–°—á—ë—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            let computedScoreLeft = 0;
            let computedScoreRight = 0;
            
            setRallies.forEach((rally, index) => {
                const rallyTime = new Date(rally.rally_datetime);
                let timeIntervalStr = '0 —Å';
                if (index > 0) {
                    const prevRally = setRallies[index - 1];
                    const prevRallyTime = new Date(prevRally.rally_datetime);
                    const intervalSeconds = Math.round((rallyTime - prevRallyTime) / 1000);
                    timeIntervalStr = `${intervalSeconds} —Å`;
                }
                
                const resultBadge = rally.server_won 
                    ? '<span class="badge bg-success">1</span>'
                    : '<span class="badge bg-danger">0</span>';
                
                const swapCount = rally.swap_count !== undefined && rally.swap_count !== null ? rally.swap_count : 0;
                const serverColor = getParticipantColor(rally.server_name);
                const receiverColor = getParticipantColor(rally.receiver_name);
                const isServerParticipant1 = serverColor === '#007bff';
                const isServerParticipant2 = serverColor === '#dc3545';
                const isReceiverParticipant1 = receiverColor === '#007bff';
                const isReceiverParticipant2 = receiverColor === '#dc3545';
                
                const scoreBeforeLeft = computedScoreLeft;
                const scoreBeforeRight = computedScoreRight;
                
                let participant1ScoreBefore, participant2ScoreBefore;
                if (swapCount % 2 === 0) {
                    participant1ScoreBefore = scoreBeforeLeft;
                    participant2ScoreBefore = scoreBeforeRight;
                } else {
                    participant1ScoreBefore = scoreBeforeRight;
                    participant2ScoreBefore = scoreBeforeLeft;
                }
                
                if (rally.server_won) {
                    if (isServerParticipant1) {
                        participant1ScoreBefore++;
                    } else if (isServerParticipant2) {
                        participant2ScoreBefore++;
                    }
                } else {
                    if (isReceiverParticipant1) {
                        participant1ScoreBefore++;
                    } else if (isReceiverParticipant2) {
                        participant2ScoreBefore++;
                    }
                }
                
                if (swapCount % 2 === 0) {
                    computedScoreLeft = participant1ScoreBefore;
                    computedScoreRight = participant2ScoreBefore;
                } else {
                    computedScoreLeft = participant2ScoreBefore;
                    computedScoreRight = participant1ScoreBefore;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—á—ë—Ç –î–û —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –¥–ª—è —Å—Ç—Ä–µ–ª–æ–∫
                let scoreBefore = '';
                if (swapCount % 2 === 0) {
                    scoreBefore = `${scoreBeforeLeft}:${scoreBeforeRight}`;
                } else {
                    scoreBefore = `${scoreBeforeRight}:${scoreBeforeLeft}`;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–º—è –ø–æ–¥–∞—é—â–µ–≥–æ —Å —Å—Ç—Ä–µ–ª–æ—á–∫–æ–π
                let serverNameHtml = '';
                if (rally.server_name) {
                    const serverParts = rally.server_name.split(' - ');
                    const serverNameColor = getParticipantColor(rally.server_name);
                    const nameColorStyle = serverNameColor ? `color: ${serverNameColor};` : '';
                    
                    const resultValueForArrow = rally.server_won ? 1 : 0;
                    const arrowInfo = getArrowDirection(rally.server_name, scoreBefore, resultValueForArrow);
                    
                    if (arrowInfo && serverParts.length >= 1) {
                        const serverNameOnly = serverParts[0].trim();
                        const arrow = arrowInfo.arrow;
                        const arrowColor = arrowInfo.color;
                        serverNameHtml = `<strong style="font-style: italic; ${nameColorStyle}">${serverNameOnly}</strong> <span style="font-style: italic; color: ${arrowColor}; font-size: 80%; font-weight: 900; text-shadow: 1px 0 0 ${arrowColor}, -1px 0 0 ${arrowColor}, 0 1px 0 ${arrowColor}, 0 -1px 0 ${arrowColor}, 0.7px 0.7px 0 ${arrowColor}, -0.7px -0.7px 0 ${arrowColor}, 0.7px -0.7px 0 ${arrowColor}, -0.7px 0.7px 0 ${arrowColor}, 1px 0.5px 0 ${arrowColor}, -1px -0.5px 0 ${arrowColor}, 0.5px 1px 0 ${arrowColor}, -0.5px -1px 0 ${arrowColor};"> ${arrow}</span>`;
                    } else {
                        serverNameHtml = `<strong style="font-style: italic; ${nameColorStyle}">${rally.server_name}</strong>`;
                    }
                } else {
                    serverNameHtml = '<strong style="font-style: italic;">–ù–µ —É–∫–∞–∑–∞–Ω</strong>';
                }
                
                const receiverNameHtml = `<strong style="font-style: italic;">${rally.receiver_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>`;
                
                let scoreLeft = '';
                let scoreRight = '';
                
                if (swapCount % 2 === 0) {
                    if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                        scoreLeft = String(computedScoreLeft).padStart(2, ' ');
                        scoreRight = '  ';
                    } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                        scoreLeft = '  ';
                        scoreRight = String(computedScoreRight).padStart(2, ' ');
                    }
                } else {
                    if (rally.server_won && isServerParticipant1 || !rally.server_won && isReceiverParticipant1) {
                        scoreLeft = '  ';
                        scoreRight = String(computedScoreRight).padStart(2, ' ');
                    } else if (rally.server_won && isServerParticipant2 || !rally.server_won && isReceiverParticipant2) {
                        scoreLeft = String(computedScoreLeft).padStart(2, ' ');
                        scoreRight = '  ';
                    }
                }
                
                const scoreLeftHtml = scoreLeft.trim() !== '' 
                    ? `<strong style="display: inline-block; border: 1px solid #d0d0d0; padding: 2px 4px; border-radius: 2px;">${scoreLeft}</strong>`
                    : '';
                const scoreRightHtml = scoreRight.trim() !== '' 
                    ? `<strong style="display: inline-block; border: 1px solid #d0d0d0; padding: 2px 4px; border-radius: 2px;">${scoreRight}</strong>`
                    : '';
                
                html += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center"><small>${timeIntervalStr}</small></td>
                        <td>${serverNameHtml}</td>
                        <td>${receiverNameHtml}</td>
                        <td class="text-center">${resultBadge}</td>
                        <td class="text-center" style="width: 2ch; font-family: monospace; padding: 2px;">${scoreLeftHtml}</td>
                        <td class="text-center" style="width: 2ch; font-family: monospace; padding: 2px; padding-left: 0.5ch;">${scoreRightHtml}</td>
                    </tr>
                `;
            });
            
            if (setRallies.length > 0) {
                const lastRally = setRallies[setRallies.length - 1];
                const lastSwapCount = lastRally.swap_count !== undefined && lastRally.swap_count !== null ? lastRally.swap_count : 0;
                let currentBlueScore, currentRedScore;
                if (lastSwapCount % 2 === 0) {
                    currentBlueScore = computedScoreLeft;
                    currentRedScore = computedScoreRight;
                } else {
                    currentBlueScore = computedScoreRight;
                    currentRedScore = computedScoreLeft;
                }
                html += `
                    <tr style="background-color: #e9ecef;">
                        <td colspan="5"></td>
                        <td colspan="2" class="text-center" style="font-family: monospace; padding: 2px;">
                            <strong style="font-size: 140%; font-style: italic; font-weight: 900; color: #007bff;">${String(currentBlueScore).padStart(2, ' ')}</strong>
                            <span style="font-size: 140%; font-style: italic; font-weight: 900;"> : </span>
                            <strong style="font-size: 140%; font-style: italic; font-weight: 900; color: #dc3545;">${String(currentRedScore).padStart(2, ' ')}</strong>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
        
        if (modal) {
            modal.setAttribute('data-rallies', JSON.stringify(rallies));
        }
        
        console.log('[Rally Journal V2] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:', rallies.length);
        
    } catch (error) {
        console.error('[Rally Journal V2] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞:', error);
        const content = document.getElementById('rallyJournalContentV2');
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π: ${error.message}
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–≤–∞—Ä–∏–∞–Ω—Ç 2)
function updateRallyJournalV2() {
    const modal = document.getElementById('rallyJournalModalV2');
    if (!modal) {
        console.error('[Rally Journal V2] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    
    const matchId = modal.getAttribute('data-match-id');
    if (!matchId) {
        console.error('[Rally Journal V2] MatchId –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    const content = document.getElementById('rallyJournalContentV2');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
            </div>
            <p class="mt-2 text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
        </div>
    `;
    
    loadRallyJournalV2(matchId);
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π -->
<div class="modal fade" id="rallyJournalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i>–ñ—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                </h5>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-success me-2" id="exportRallyJournalBtn" onclick="exportRallyJournalToExcel()" title="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel" style="display: none;">
                        <i class="fas fa-file-excel me-1"></i>–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
            </div>
            <div class="modal-body">
                <div id="rallyJournalContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="updateRallyJournalBtn" onclick="updateRallyJournal()">
                    <i class="fas fa-sync-alt me-1"></i>Update
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–í–∞—Ä–∏–∞–Ω—Ç 2) -->
<div class="modal fade" id="rallyJournalModalV2" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i>–ñ—É—Ä–Ω–∞–ª —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                </h5>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-success me-2" id="exportRallyJournalBtnV2" onclick="exportRallyJournalToExcel()" title="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel" style="display: none;">
                        <i class="fas fa-file-excel me-1"></i>–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
            </div>
            <div class="modal-body">
                <div id="rallyJournalContentV2">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="updateRallyJournalBtnV2" onclick="updateRallyJournalV2()">
                    <i class="fas fa-sync-alt me-1"></i>Update
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}