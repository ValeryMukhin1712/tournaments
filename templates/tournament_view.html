{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—É—Ä–Ω–∏—Ä–∞ - {{ tournament.name }}{% endblock %}

{% block content %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Å–∫—Ä–æ–ª–ª–µ */
#tournament-table {
    position: relative;
}

#tournament-table thead th:first-child,
#tournament-table tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    background-color: #f8f9fa !important;
    border-right: 2px solid #dee2e6;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è */
@media (max-width: 768px) {
    #tournament-table thead th:first-child,
    #tournament-table tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 15;
        background-color: #f8f9fa !important;
        border-right: 2px solid #dee2e6;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        min-width: 80px;
        max-width: 120px;
    }
    
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è */
    #tournament-table thead th:nth-child(2),
    #tournament-table tbody td:nth-child(2) {
        position: relative;
        z-index: 5;
    }
}

/* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 550px) {
    #tournament-table thead th:first-child,
    #tournament-table tbody td:first-child {
        min-width: 60px;
        max-width: 100px;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
<div class="container-fluid">
<div class="row">
    <div class="col-12">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
                <div class="mb-3 mb-sm-0">
                    <h1 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        {{ tournament.name }}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if is_viewer_mode %}
                            –†–µ–∂–∏–º –∑—Ä–∏—Ç–µ–ª—è
                        {% else %}
                            –†–µ–∂–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
                        {% endif %}
                        <span id="autoRefreshIndicator" class="badge bg-success ms-2" style="display: none;">
                            <i class="fas fa-sync-alt fa-spin me-1"></i>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                        </span>
                        
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                        <div class="btn-group ms-3" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAutoRefresh()" id="toggleRefreshBtn">
                                <i class="fas fa-pause" id="toggleIcon"></i> <span id="toggleText">–ü–∞—É–∑–∞</span>
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-clock me-1"></i><span id="intervalText">3 —Å–µ–∫</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(3)">3 —Å–µ–∫—É–Ω–¥—ã</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(5)">5 —Å–µ–∫—É–Ω–¥</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(10)">10 —Å–µ–∫—É–Ω–¥</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(15)">15 —Å–µ–∫—É–Ω–¥</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(20)">20 —Å–µ–∫—É–Ω–¥</a></li>
                                </ul>
                            </div>
                        </div>
                    </p>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–µ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–µ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>–°–ø–æ—Ä—Ç:</strong> {{ tournament.sport_type or '–¢–µ–Ω–Ω–∏—Å' }}</p>
                                    <p><strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> 
                    {% if tournament.start_date %}
                        {{ tournament.start_date.strftime('%d.%m.%Y') }}
                    {% else %}
                                            –ù–µ —É–∫–∞–∑–∞–Ω–∞
                    {% endif %}
                </p>
            </div>
                                <div class="col-md-6">
                                    <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ participants_with_stats_chessboard|length }}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                        {% if tournament.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-flag-checkered me-1"></i>–ó–∞–≤–µ—Ä—à–µ–Ω
                                            </span>
                                        {% elif tournament.status == '–∞–∫—Ç–∏–≤–µ–Ω' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-play me-1"></i>–ê–∫—Ç–∏–≤–µ–Ω
                                            </span>
                                        {% else %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-user-plus me-1"></i>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                                            </span>
                                        {% endif %}
                                    </p>
            </div>
        </div>
        {% if tournament.description %}
                            <div class="mt-3">
                                <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                                <p class="mt-1">{{ tournament.description }}</p>
        </div>
        {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π -->
            {% if schedule_display %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>
                                –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π
                </h5>
            </div>
            <div class="card-body">
                            {% if schedule_display %}
                    <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                <tr>
                                                <th class="d-none d-sm-table-cell" style="width: 60px;">‚Ññ</th>
                                                <th style="width: 80px;">–í—Ä–µ–º—è</th>
                                                <th class="d-none d-md-table-cell" style="width: 100px;">–ü–ª–æ—â–∞–¥–∫–∞</th>
                                                <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                                                <th style="width: 100px;">–°—á–µ—Ç</th>
                                                <th class="d-none d-md-table-cell" style="width: 120px;">–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                            {% for date_str, day_data in schedule_display.items() %}
                                            <tr class="table-info">
                                                <td colspan="6" class="fw-bold text-center py-2">
                                                    <i class="fas fa-calendar-day me-2"></i>{{ day_data.date_display }}
                                    </td>
                                            </tr>
                                            {% for match in day_data.matches %}
                                            <tr {% if match.is_participant_match %}class="table-primary"{% endif %}>
                                                <td class="d-none d-sm-table-cell text-center">
                                                    <span class="badge bg-primary">{{ match.global_number or loop.index }}</span>
                                                </td>
                                                <td class="fw-bold text-primary">{{ match.time }}</td>
                                                <td class="d-none d-md-table-cell text-center">
                                                    {% if match.court and match.court > 0 %}
                                                        {% set court_colors = {
                                                            1: 'primary',
                                                            2: 'info', 
                                                            3: 'success',
                                                            4: 'warning',
                                                            5: 'danger',
                                                            6: 'secondary',
                                                            7: 'dark',
                                                            8: 'light'
                                                        } %}
                                                        {% set court_color = court_colors.get(match.court, 'secondary') %}
                                                        <span class="badge bg-{{ court_color }}">
                                                            –ü–ª. {{ match.court }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{ match.participant1 }}</strong> vs <strong>{{ match.participant2 }}</strong>
                                                    {% if match.is_participant_match and not is_viewer_mode %}
                                                        <span class="badge bg-primary ms-2 rounded-pill">–í–∞—à –º–∞—Ç—á</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if match.score and match.status != '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}
                                                        {% if match.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' %}
                                                            {% set score_parts = match.score.split(':') %}
                                                            {% set score1 = score_parts[0]|int %}
                                                            {% set score2 = score_parts[1]|int %}
                                                            {% if score1 > score2 %}
                                                                <span class="badge bg-success text-white">{{ match.score }}</span>
                                                            {% else %}
                                                                <span class="badge bg-danger text-white">{{ match.score }}</span>
                                                            {% endif %}
                                                        {% elif match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'] %}
                                                            <span class="badge bg-warning text-dark" style="background-color: #ffc107 !important; color: #000 !important;">{{ match.score }}</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark">{{ match.score }}</span>
                                                        {% endif %}
                                                        {% if match.sets_details %}
                                                            <br><small class="text-muted" {% if match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'] %}style="background-color: #ffc107; padding: 2px 4px; border-radius: 3px;"{% endif %}>{{ match.sets_details }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                                <td class="d-none d-md-table-cell text-center">
                                                    <span class="badge rounded-pill
                                                        {% if match.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' %}bg-success
                                                        {% elif match.status == '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}bg-info
                                                        {% else %}bg-secondary{% endif %}"
                                                        {% if match.status in ['–≤_–ø—Ä–æ—Ü–µ—Å—Å–µ', '–∏–≥—Ä–∞—é—Ç'] %}style="background-color: #ffc107 !important; color: #000 !important;"{% endif %}>
                                                        {{ match.status }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>
                                </div>
                {% endif %}
            </div>
        </div>
                </div>
            </div>
            {% endif %}


            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞ -->
            {% if tournament.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' and not has_unfinished %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-body text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                                <h1 class="display-4 fw-bold text-success mb-3" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                                    üèÜ –¢—É—Ä–Ω–∏—Ä –∑–∞–≤–µ—Ä—à—ë–Ω! üèÜ
                                </h1>
                                <p class="lead text-muted">–í—Å–µ –º–∞—Ç—á–∏ —Å—ã–≥—Ä–∞–Ω—ã. –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</p>
                            </div>
                            
                            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π -->
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead class="table-success">
                                                <tr>
                                                    <th class="text-center" style="width: 60px;">–ú–µ—Å—Ç–æ</th>
                                                    <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                                    <th class="text-center">–û—á–∫–∏</th>
                                                    <th class="text-center">–ü–æ–±–µ–¥</th>
                                                    <th class="text-center">–ù–∏—á—å–∏—Ö</th>
                                                    <th class="text-center">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</th>
                                                    <th class="text-center">–†–∞–∑–Ω–∏—Ü–∞ –æ—á–∫–æ–≤</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for participant_data in participants %}
                                                {% set participant = participant_data.participant %}
                                                {% set stats = participant_data.stats %}
                                                {% set position = participant_data.position %}
                                                <tr class="{% if position == 1 %}table-warning fw-bold{% elif position <= 3 %}table-light{% endif %}">
                                                    <td class="text-center">
                                                        {% if position == 1 %}
                                                            <span class="badge bg-warning text-dark fs-6">ü•á</span>
                                                        {% elif position == 2 %}
                                                            <span class="badge bg-secondary fs-6">ü•à</span>
                                                        {% elif position == 3 %}
                                                            <span class="badge bg-warning text-dark fs-6">ü•â</span>
                                                        {% else %}
                                                            <span class="badge bg-light text-dark">{{ position }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="fw-bold">{{ participant.name }}</td>
                                                    <td class="text-center fw-bold text-primary">{{ stats.points }}</td>
                                                    <td class="text-center">{{ stats.wins }}</td>
                                                    <td class="text-center">{{ stats.draws }}</td>
                                                    <td class="text-center">{{ stats.losses }}</td>
                                                    <td class="text-center {% if stats.goal_difference > 0 %}text-success{% elif stats.goal_difference < 0 %}text-danger{% endif %}">
                                                        {{ stats.goal_difference }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è -->
                            {% if participants|length > 0 %}
                            {% set winner = participants[0] %}
                            <div class="mt-4">
                                <div class="alert alert-warning border-warning">
                                    <h4 class="alert-heading mb-3">
                                        <i class="fas fa-crown me-2"></i>
                                        –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è!
                                    </h4>
                                    <h3 class="text-warning fw-bold mb-2">{{ winner.participant.name }}</h3>
                                    <p class="mb-0">—Å –ø–æ–±–µ–¥–æ–π –≤ —Ç—É—Ä–Ω–∏—Ä–µ "{{ tournament.name }}"!</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card card-modern">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-modern" id="statisticsTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                –ú–µ—Å—Ç–æ
                                            </th>
                                            <th>
                                                –£—á–∞—Å—Ç–Ω–∏–∫
                                            </th>
                                            <th>
                                                –ò–≥—Ä
                                            </th>
                                            <th>
                                                –ü–æ–±–µ–¥
                                            </th>
                                            <th>
                                                –ü–æ—Ä–∞–∂–µ–Ω–∏–π
                                            </th>
                                            <th>
                                                –û—á–∫–∏<br><small>–≤ —Ç—É—Ä–Ω–∏—Ä–µ</small>
                                            </th>
                                            <th>
                                                –†–∞–∑–Ω–∏—Ü–∞ +/-<br><small>—Å–µ—Ç–æ–≤</small>
                                            </th>
                                            <th>
                                                –†–∞–∑–Ω–∏—Ü–∞ –æ—á–∫–æ–≤<br><small>–≤ —Å–µ—Ç–∞—Ö</small>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p1_data in participants_with_stats %}
                                        {% set participant = p1_data.participant %}
                                        {% set participant_stats = p1_data.stats %}
                                        {% set participant_position = p1_data.position %}
                                        <tr class="{% if p1_data.is_late_participant %}table-warning{% endif %}">
                                            <td>{{ participant_position }}</td>
                                            <td>
                                                <strong>{{ participant.name }}</strong>
                                                {% if participant.is_team %}
                                                    <span class="badge bg-info ms-2">–ö–æ–º–∞–Ω–¥–∞</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ participant_stats.games }}</td>
                                            <td>{{ participant_stats.wins }}</td>
                                            <td>{{ participant_stats.losses }}</td>
                                            <td>{{ participant_stats.points }}</td>
                                            <td>
                                                {% if participant_stats.sets_difference > 0 %}+{% endif %}{{ participant_stats.sets_difference }}
                                            </td>
                                            <td>
                                                {% if participant_stats.goal_difference > 0 %}+{% endif %}{{ participant_stats.goal_difference }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-table me-2"></i>–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="tournament-table">
                        <thead>
                            <tr>
                                            <th class="bg-light">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                            <th class="text-center bg-light">–û—á–∫–∏</th>
                                            <th class="text-center bg-light">–ú–µ—Å—Ç–æ</th>
                                {% for participant_data in participants_with_stats_chessboard %}
                                {% set participant = participant_data.participant %}
                                            <th class="text-center {% if participant_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %}">
                                                {{ participant.name[:15] }}{% if participant.name|length > 15 %}...{% endif %}
                                            </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                                        {% for p1_data in participants_with_stats_chessboard %}
                                        {% set p1 = p1_data.participant %}
                                        {% set p1_stats = p1_data.stats %}
                                        {% set p1_position = p1_data.position %}
                                        <tr>
                                            <td class="{% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold">
                                                {{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}
                                            </td>
                                            <td class="text-center {% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold text-primary">{{ p1_stats.points }}</td>
                                            <td class="text-center {% if p1_data.is_late_participant %}bg-warning{% else %}bg-light{% endif %} fw-bold text-success">{{ p1_position }}</td>
                                            {% for p2_data in participants_with_stats_chessboard %}
                                            {% set p2 = p2_data.participant %}
                                            <td class="text-center position-relative {% if p1_data.is_late_participant or p2_data.is_late_participant %}bg-success bg-opacity-25{% endif %}" style="height: 80px; width: 120px; vertical-align: middle;">
                                                {% if p1.id == p2.id %}
                                                    <span class="text-muted">‚Äî</span>
                                                {% else %}
                                                    {% set cell_data = chessboard[p1.id][p2.id] %}
                                                    {% if cell_data.type == 'result' %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            {% if cell_data.is_winner %}
                                                                <span class="badge bg-success text-white mb-1">{{ cell_data.value }}</span>
                                    {% else %}
                                                                <span class="badge bg-danger text-white mb-1">{{ cell_data.value }}</span>
                                                            {% endif %}
                                                            {% if cell_data.sets_details %}
                                                            <small class="text-muted">{{ cell_data.sets_details }}</small>
                                                            {% endif %}
                                                        </div>
                                                    {% elif cell_data.type == 'in_progress' %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            <span class="badge bg-warning text-dark mb-1" style="background-color: #ffc107 !important;">{{ cell_data.value }}</span>
                                                            {% if cell_data.sets_details %}
                                                            <small class="text-muted">{{ cell_data.sets_details }}</small>
                                        {% endif %}
                                                        </div>
                                                    {% elif cell_data.type == 'upcoming' %}
                                                        {% set court_colors = {
                                                            1: 'primary',
                                                            2: 'info', 
                                                            3: 'success',
                                                            4: 'warning',
                                                            5: 'danger',
                                                            6: 'secondary',
                                                            7: 'dark',
                                                            8: 'light'
                                                        } %}
                                                        {% set court_color = court_colors.get(cell_data.court, 'secondary') %}
                                                        
                                                        <div class="text-center position-relative">
                                                            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ü–≤–µ—Ç–æ–º –ø–ª–æ—â–∞–¥–∫–∏ -->
                                                            <div class="border border-{{ court_color }} border-1 rounded p-1 bg-{{ court_color }} bg-opacity-10" style="height: 70px; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                                                <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å -->
                                                                <div>
                                                                    <!-- –ù–æ–º–µ—Ä –∫–æ—Ä—Ç–∞ –∫—Ä—É–ø–Ω—ã–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º -->
                                                                    <div class="text-center mb-1">
                                                                        <span style="font-size: 1.5rem; font-weight: bold; opacity: 0.3; color: {{ court_color }};">{{ cell_data.court }}</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- –í—Ä–µ–º—è –º–∞—Ç—á–∞ - –≤–Ω–∏–∑—É -->
                                                                <div class="mt-auto">
                                                                    <small class="d-block text-dark fw-bold text-center" style="font-size: 0.6rem; background-color: rgba(255, 255, 255, 0.95); padding: 1px 3px; border-radius: 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                                        {% if cell_data.time %}
                                                                            {{ cell_data.time.strftime('%H:%M') }}
                                                    {% else %}
                                                                            –í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ
                                                                        {% endif %}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% elif cell_data.type == 'empty' %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                            {% endif %}
                                        </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
let autoRefreshInterval;
let refreshIntervalSeconds = 3; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let isAutoRefreshActive = true;

function startAutoRefresh() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const indicator = document.getElementById('autoRefreshIndicator');
    if (indicator) {
        indicator.style.display = 'inline-block';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    updateToggleButton();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    autoRefreshInterval = setInterval(function() {
        console.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∫–∞–∂–¥—ã–µ ${refreshIntervalSeconds} —Å–µ–∫)...`);
        window.location.reload();
    }, refreshIntervalSeconds * 1000);
    
    console.log(`–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∂–¥—ã–µ ${refreshIntervalSeconds} —Å–µ–∫—É–Ω–¥)`);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const indicator = document.getElementById('autoRefreshIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        updateToggleButton();
        
        console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function setRefreshInterval(seconds) {
    refreshIntervalSeconds = seconds;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
    const intervalText = document.getElementById('intervalText');
    if (intervalText) {
        intervalText.textContent = `${seconds} —Å–µ–∫`;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    saveRefreshSettings();
    
    // –ï—Å–ª–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
    if (isAutoRefreshActive && autoRefreshInterval) {
        startAutoRefresh();
    }
    
    console.log(`–ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${seconds} —Å–µ–∫—É–Ω–¥`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function toggleAutoRefresh() {
    if (isAutoRefreshActive) {
        stopAutoRefresh();
        isAutoRefreshActive = false;
    } else {
        startAutoRefresh();
        isAutoRefreshActive = true;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    saveRefreshSettings();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function updateToggleButton() {
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (isAutoRefreshActive && autoRefreshInterval) {
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–∞—É–∑–∞"
        if (toggleIcon) toggleIcon.className = 'fas fa-pause';
        if (toggleText) toggleText.textContent = '–ü–∞—É–∑–∞';
    } else {
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å–∫"
        if (toggleIcon) toggleIcon.className = 'fas fa-play';
        if (toggleText) toggleText.textContent = '–ó–∞–ø—É—Å–∫';
    }
}

// BroadcastChannel –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
let scoreUpdateChannel = null;

function setupScoreUpdateListener() {
    try {
        scoreUpdateChannel = new BroadcastChannel('match-score-updates');
        scoreUpdateChannel.onmessage = function(event) {
            const data = event.data;
            if (data.type === 'score-updated' && data.matchId) {
                console.log(`[TournamentView] üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á—ë—Ç–∞ –¥–ª—è –º–∞—Ç—á–∞ ${data.matchId}`);
                // –ï—Å–ª–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                if (isAutoRefreshActive) {
                    console.log('[TournamentView] üîÑ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á—ë—Ç–∞');
                    location.reload();
                }
            }
        };
        console.log('[TournamentView] üì° –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    } catch (error) {
        console.warn('[TournamentView] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å BroadcastChannel:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—á—ë—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
    setupScoreUpdateListener();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    loadRefreshSettings();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ
    if (isAutoRefreshActive) {
        startAutoRefresh();
    } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        updateToggleButton();
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
        if (scoreUpdateChannel) {
            scoreUpdateChannel.close();
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
function loadRefreshSettings() {
    const savedInterval = localStorage.getItem('autoRefreshInterval');
    const savedState = localStorage.getItem('autoRefreshActive');
    
    if (savedInterval) {
        refreshIntervalSeconds = parseInt(savedInterval);
        const intervalText = document.getElementById('intervalText');
        if (intervalText) {
            intervalText.textContent = `${refreshIntervalSeconds} —Å–µ–∫`;
        }
    }
    
    if (savedState !== null) {
        isAutoRefreshActive = savedState === 'true';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
function saveRefreshSettings() {
    localStorage.setItem('autoRefreshInterval', refreshIntervalSeconds.toString());
    localStorage.setItem('autoRefreshActive', isAutoRefreshActive.toString());
}
</script>

{% endblock %}