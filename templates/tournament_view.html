{% extends "base.html" %}

{% block title %}Просмотр турнира - {{ tournament.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
<div class="row">
    <div class="col-12">
            <!-- Заголовок -->
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
                <div class="mb-3 mb-sm-0">
                    <h1 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        {{ tournament.name }}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if is_viewer_mode %}
                            Режим зрителя
                        {% else %}
                            Режим участника
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if is_viewer_mode %}
                        <a href="{{ url_for('tournaments_list') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i><span class="d-none d-sm-inline">Назад к турнирам</span><span class="d-sm-none">Назад</span>
                        </a>
                    {% else %}
                        <a href="{{ url_for('participant_tournaments') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i><span class="d-none d-sm-inline">Назад к турнирам</span><span class="d-sm-none">Назад</span>
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Информация о турнире -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Информация о турнире
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Спорт:</strong> {{ tournament.sport_type or 'Теннис' }}</p>
                                    <p><strong>Дата начала:</strong> 
                    {% if tournament.start_date %}
                        {{ tournament.start_date.strftime('%d.%m.%Y') }}
                    {% else %}
                                            Не указана
                    {% endif %}
                </p>
            </div>
                                <div class="col-md-6">
                                    <p><strong>Участников:</strong> {{ participants|length }}</p>
                                    <p><strong>Статус:</strong> 
                                        {% if tournament.status == 'завершен' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-flag-checkered me-1"></i>Завершен
                                            </span>
                                        {% elif tournament.status == 'активен' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-play me-1"></i>Активен
                                            </span>
                                        {% else %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-user-plus me-1"></i>Регистрация
                                            </span>
                                        {% endif %}
                                    </p>
            </div>
        </div>
        {% if tournament.description %}
                            <div class="mt-3">
                                <strong>Описание:</strong>
                                <p class="mt-1">{{ tournament.description }}</p>
        </div>
        {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Расписание матчей -->
            {% if schedule_display %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>
                                Расписание матчей
                </h5>
            </div>
            <div class="card-body">
                            {% if schedule_display %}
                    <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                <tr>
                                                <th class="d-none d-sm-table-cell" style="width: 60px;">№</th>
                                                <th style="width: 80px;">Время</th>
                                                <th class="d-none d-md-table-cell" style="width: 100px;">Площадка</th>
                                                <th>Участники</th>
                                                <th style="width: 100px;">Счет</th>
                                                <th class="d-none d-md-table-cell" style="width: 120px;">Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                            {% for date_str, day_data in schedule_display.items() %}
                                            <tr class="table-info">
                                                <td colspan="6" class="fw-bold text-center py-2">
                                                    <i class="fas fa-calendar-day me-2"></i>{{ day_data.date_display }}
                                    </td>
                                            </tr>
                                            {% for match in day_data.matches %}
                                            <tr {% if match.is_participant_match %}class="table-primary"{% endif %}>
                                                <td class="d-none d-sm-table-cell text-center">
                                                    <span class="badge bg-primary">{{ match.global_number or loop.index }}</span>
                                                </td>
                                                <td class="fw-bold text-primary">{{ match.time }}</td>
                                                <td class="d-none d-md-table-cell text-center">
                                                    {% if match.court and match.court > 0 %}
                                                        {% set court_colors = {
                                                            1: 'primary',
                                                            2: 'info', 
                                                            3: 'success',
                                                            4: 'warning',
                                                            5: 'danger',
                                                            6: 'secondary',
                                                            7: 'dark',
                                                            8: 'light'
                                                        } %}
                                                        {% set court_color = court_colors.get(match.court, 'secondary') %}
                                                        <span class="badge bg-{{ court_color }}">
                                                            Пл. {{ match.court }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{ match.participant1 }}</strong> vs <strong>{{ match.participant2 }}</strong>
                                                    {% if match.is_participant_match and not is_viewer_mode %}
                                                        <span class="badge bg-primary ms-2">Ваш матч</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if match.score and match.status != 'запланирован' %}
                                                        {% if match.status == 'завершен' %}
                                                            {% set score_parts = match.score.split(':') %}
                                                            {% set score1 = score_parts[0]|int %}
                                                            {% set score2 = score_parts[1]|int %}
                                                            {% if score1 > score2 %}
                                                                <span class="badge bg-success text-white">{{ match.score }}</span>
                                                            {% else %}
                                                                <span class="badge bg-danger text-white">{{ match.score }}</span>
                                                            {% endif %}
                                                        {% elif match.status in ['в процессе', 'играют'] %}
                                                            <span class="badge bg-warning text-dark" style="background-color: #ffc107 !important; color: #000 !important;">{{ match.score }}</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark">{{ match.score }}</span>
                                                        {% endif %}
                                                        {% if match.sets_details %}
                                                            <br><small class="text-muted" {% if match.status in ['в процессе', 'играют'] %}style="background-color: #ffc107; padding: 2px 4px; border-radius: 3px;"{% endif %}>{{ match.sets_details }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                                <td class="d-none d-md-table-cell text-center">
                                                    <span class="badge 
                                                        {% if match.status == 'завершен' %}bg-success
                                                        {% elif match.status == 'запланирован' %}bg-info
                                                        {% else %}bg-secondary{% endif %}"
                                                        {% if match.status in ['в процессе', 'играют'] %}style="background-color: #ffc107 !important; color: #000 !important;"{% endif %}>
                                                        {{ match.status }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Расписание матчей пока не составлено</p>
                                </div>
                {% endif %}
            </div>
        </div>
                </div>
            </div>
            {% endif %}

            <!-- Сообщение о завершении турнира -->
            {% if tournament.status == 'завершен' and not has_unfinished %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-body text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                                <h1 class="display-4 fw-bold text-success mb-3" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                                    🏆 Турнир завершён! 🏆
                                </h1>
                                <p class="lead text-muted">Все матчи сыграны. Итоговые результаты:</p>
                            </div>
                            
                            <!-- Список победителей -->
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead class="table-success">
                                                <tr>
                                                    <th class="text-center" style="width: 60px;">Место</th>
                                                    <th>Участник</th>
                                                    <th class="text-center">Очки</th>
                                                    <th class="text-center">Побед</th>
                                                    <th class="text-center">Ничьих</th>
                                                    <th class="text-center">Поражений</th>
                                                    <th class="text-center">Разница очков</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for participant_data in participants %}
                                                {% set participant = participant_data.participant %}
                                                {% set stats = participant_data.stats %}
                                                {% set position = participant_data.position %}
                                                <tr class="{% if position == 1 %}table-warning fw-bold{% elif position <= 3 %}table-light{% endif %}">
                                                    <td class="text-center">
                                                        {% if position == 1 %}
                                                            <span class="badge bg-warning text-dark fs-6">🥇</span>
                                                        {% elif position == 2 %}
                                                            <span class="badge bg-secondary fs-6">🥈</span>
                                                        {% elif position == 3 %}
                                                            <span class="badge bg-warning text-dark fs-6">🥉</span>
                                                        {% else %}
                                                            <span class="badge bg-light text-dark">{{ position }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="fw-bold">{{ participant.name }}</td>
                                                    <td class="text-center fw-bold text-primary">{{ stats.points }}</td>
                                                    <td class="text-center">{{ stats.wins }}</td>
                                                    <td class="text-center">{{ stats.draws }}</td>
                                                    <td class="text-center">{{ stats.losses }}</td>
                                                    <td class="text-center {% if stats.goal_difference > 0 %}text-success{% elif stats.goal_difference < 0 %}text-danger{% endif %}">
                                                        {{ stats.goal_difference }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Поздравление победителя -->
                            {% if participants|length > 0 %}
                            {% set winner = participants[0] %}
                            <div class="mt-4">
                                <div class="alert alert-warning border-warning">
                                    <h4 class="alert-heading mb-3">
                                        <i class="fas fa-crown me-2"></i>
                                        Поздравляем победителя!
                                    </h4>
                                    <h3 class="text-warning fw-bold mb-2">{{ winner.participant.name }}</h3>
                                    <p class="mb-0">с победой в турнире "{{ tournament.name }}"!</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Статистика участников -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card card-modern">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Статистика участников
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if participants_with_stats %}
                                <div class="table-responsive">
                                    <table class="table table-modern" id="statisticsTable">
                                        <thead>
                                            <tr>
                                                <th class="sortable d-none d-sm-table-cell" data-column="position">
                                                    Место <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable d-table-cell d-sm-none" data-column="position">
                                                    № <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable" data-column="name">
                                                    Участник <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable d-none d-md-table-cell" data-column="games">
                                                    Игр <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable d-none d-lg-table-cell" data-column="wins">
                                                    Побед <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                
                                                <th class="sortable d-none d-lg-table-cell" data-column="draws">
                                                    Ничьих <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                
                                                <th class="sortable d-none d-lg-table-cell" data-column="losses">
                                                    Поражений <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable" data-column="points">
                                                    Очки<br><small class="d-none d-sm-inline">в турнире</small> <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable d-none d-md-table-cell" data-column="goal_difference">
                                                    Разница очков<br><small>в сетах</small> <i class="fas fa-sort ms-1"></i>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for p1_data in participants_with_stats %}
                                            {% set participant = p1_data.participant %}
                                            {% set participant_stats = p1_data.stats %}
                                            {% set participant_position = p1_data.position %}
                                            <tr class="{% if p1_data.is_late_participant %}table-warning{% endif %}">
                                                <td class="d-none d-sm-table-cell">{{ participant_position }}</td>
                                                <td class="d-table-cell d-sm-none">{{ participant_position }}</td>
                                                <td>
                                                    <strong>{{ participant.name }}</strong>
                                                    {% if participant.is_team %}
                                                        <span class="badge bg-info ms-2">Команда</span>
                                                    {% endif %}
                                                    <div class="d-sm-none mt-1">
                                                        <small class="text-muted">Очки: {{ participant_stats.points }}</small>
                                                    </div>
                                                </td>
                                                <td class="d-none d-md-table-cell">{{ participant_stats.games }}</td>
                                                <td class="d-none d-lg-table-cell">{{ participant_stats.wins }}</td>
                                                <td class="d-none d-lg-table-cell">{{ participant_stats.draws }}</td>
                                                <td class="d-none d-lg-table-cell">{{ participant_stats.losses }}</td>
                                                <td class="d-none d-sm-table-cell">{{ participant_stats.points }}</td>
                                                <td class="d-none d-md-table-cell">
                                                    {% if participant_stats.goal_difference > 0 %}+{% endif %}{{ participant_stats.goal_difference }}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">В турнире пока нет участников</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>


            <!-- Турнирная таблица -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Турнирная таблица</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                            <th class="bg-light">Участник</th>
                                            <th class="text-center bg-light">Очки</th>
                                            <th class="text-center bg-light">Место</th>
                                {% for participant in participants %}
                                            <th class="text-center bg-light">{{ participant.participant.name[:15] }}{% if participant.participant.name|length > 15 %}...{% endif %}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                                        {% for p1_data in participants_with_stats_chessboard %}
                                        {% set p1 = p1_data.participant %}
                                        {% set p1_stats = p1_data.stats %}
                                        {% set p1_position = p1_data.position %}
                                        <tr>
                                            <td class="bg-light fw-bold">{{ p1.name[:15] }}{% if p1.name|length > 15 %}...{% endif %}</td>
                                            <td class="text-center bg-light fw-bold text-primary">{{ p1_stats.points }}</td>
                                            <td class="text-center bg-light fw-bold text-success">{{ p1_position }}</td>
                                            {% for participant_data in participants %}
                                            {% set p2 = participant_data.participant %}
                                            <td class="text-center position-relative" style="height: 80px; width: 120px; vertical-align: middle;">
                                                {% if p1.id == p2.id %}
                                                    <span class="text-muted">—</span>
                                                {% else %}
                                                    {% set cell_data = chessboard[p1.id][p2.id] %}
                                                    {% if cell_data.type == 'result' %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            {% if cell_data.is_winner %}
                                                                <span class="badge bg-success text-white mb-1">{{ cell_data.value }}</span>
                                    {% else %}
                                                                <span class="badge bg-danger text-white mb-1">{{ cell_data.value }}</span>
                                                            {% endif %}
                                                            {% if cell_data.sets_details %}
                                                            <small class="text-muted">{{ cell_data.sets_details }}</small>
                                                            {% endif %}
                                                        </div>
                                                    {% elif cell_data.type == 'in_progress' %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            <span class="badge bg-warning text-dark mb-1" style="background-color: #ffc107 !important;">{{ cell_data.value }}</span>
                                                            {% if cell_data.sets_details %}
                                                            <small class="text-muted">{{ cell_data.sets_details }}</small>
                                        {% endif %}
                                                        </div>
                                                    {% elif cell_data.type == 'upcoming' %}
                                                        {% set court_colors = {
                                                            1: 'primary',
                                                            2: 'info', 
                                                            3: 'success',
                                                            4: 'warning',
                                                            5: 'danger',
                                                            6: 'secondary',
                                                            7: 'dark',
                                                            8: 'light'
                                                        } %}
                                                        {% set court_color = court_colors.get(cell_data.court, 'secondary') %}
                                                        
                                                        <div class="text-center position-relative">
                                                            <!-- Основной контейнер с цветом площадки -->
                                                            <div class="border border-{{ court_color }} border-1 rounded p-1 bg-{{ court_color }} bg-opacity-10" style="height: 70px; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                                                <!-- Верхняя часть -->
                                                                <div>
                                                                    <!-- Номер корта крупным полупрозрачным шрифтом -->
                                                                    <div class="text-center mb-1">
                                                                        <span style="font-size: 1.5rem; font-weight: bold; opacity: 0.3; color: {{ court_color }};">{{ cell_data.court }}</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Время матча - внизу -->
                                                                <div class="mt-auto">
                                                                    <small class="d-block text-dark fw-bold text-center" style="font-size: 0.6rem; background-color: rgba(255, 255, 255, 0.95); padding: 1px 3px; border-radius: 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                                        {% if cell_data.time %}
                                                                            {{ cell_data.time.strftime('%H:%M') }}
                                                    {% else %}
                                                                            Время не указано
                                                                        {% endif %}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% elif cell_data.type == 'empty' %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                            {% endif %}
                                        </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}