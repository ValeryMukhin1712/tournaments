<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Документация системы турниров</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2E7D32;
            text-align: center;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #388E3C;
            border-left: 4px solid #4CAF50;
            padding-left: 15px;
        }
        h3 {
            color: #4CAF50;
        }
        .update-date {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-bottom: 30px;
        }
        .feature-list {
            background: #E8F5E8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .update-info {
            background: #FFF3E0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #FF9800;
            margin: 15px 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
        .version {
            background: #E3F2FD;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Система управления турнирами</h1>
        <p class="update-date">Последнее обновление: 22 октября 2025</p>

        <h2>Обзор системы</h2>
        <p>Веб-приложение для организации и проведения спортивных турниров с поддержкой различных видов спорта, включая бадминтон, теннис и другие.</p>

        <h2>Основные функции</h2>
        <div class="feature-list">
            <ul>
                <li><strong>Создание и управление турнирами</strong> - администраторы могут создавать турниры с различными настройками</li>
                <li><strong>Регистрация участников</strong> - система регистрации с токенами доступа</li>
                <li><strong>Проведение матчей</strong> - интерактивная система ведения матчей</li>
                <li><strong>Журнал матчей</strong> - детальное отслеживание всех действий в матче</li>
                <li><strong>Система рейтингов</strong> - автоматический подсчет очков и позиций</li>
                <li><strong>Уведомления</strong> - отправка уведомлений участникам по email</li>
                <li><strong>Статистика</strong> - подробная аналитика по турнирам и игрокам</li>
            </ul>
        </div>

        <h2>Последние обновления</h2>
        
        <div class="update-info">
            <h3>22 октября 2025 (вечер) - Улучшение UI страниц Судейства и Турнирной таблицы ✅</h3>
            <ul>
                <li><strong>Волейбол - Песочная цветовая схема</strong> - изменена цветовая палитра страницы Судейства для волейбола с красных на песочные тона (#c4915f, #d4a574, #e6c9a8) для более приятного восприятия и снижения нагрузки на глаза</li>
                <li><strong>Волейбол - Цветовое кодирование кнопок</strong> - кнопка "+ Очко команде Б" (правая/синяя команда) теперь имеет синий цвет для лучшей визуальной идентификации</li>
                <li><strong>Волейбол - Автоматическая перестановка кнопок</strong> - при смене сторон команд (кнопка "Поменять стороны команд") кнопки добавления очков автоматически меняются местами для соответствия расположению команд на экране</li>
                <li><strong>Бадминтон - Упрощение интерфейса</strong> - удалена дублирующая кнопка "Сохранить результат в турнир", так как уже есть кнопка "Сохранить счёт в форму результата"</li>
                <li><strong>✅ Турнирная таблица - Промежуточные счета ИСПРАВЛЕНО</strong> - исправлена критическая ошибка: статус 'в процессе' (с пробелом) заменен на 'в_процессе' (с подчеркиванием) во всех проверках. Теперь промежуточные результаты матчей (счет сетов и текущий счет в сете) корректно отображаются в турнирной таблице</li>
                <li><strong>Диагностика</strong> - добавлено подробное логирование формирования данных для турнирной таблицы, включая sets_details для каждого матча</li>
            </ul>
        </div>
        
        <div class="update-info">
            <h3>22 октября 2025 - Исправление сохранения и отображения результатов волейбола ✅ ПОЛНОСТЬЮ РЕШЕНО</h3>
            <ul>
                <li><strong>✅ Проблема 1: Кеширование API</strong> - данные сохранялись в БД правильно, но браузер использовал закешированные старые данные. Добавлены антикеш-заголовки (cache: 'no-store', Cache-Control: 'no-cache') и timestamp в запросы к /api/matches/</li>
                <li><strong>✅ Проблема 2: Форма Результат показывала 25:25</strong> - изменена проверка наличия данных с data.match.score1 на data.match.set1_score1, так как поля score1/score2 используются только для общего счета матча и равны null для незавершенных матчей</li>
                <li><strong>Исправлена логика определения победителя сета</strong> - корректно применяются правила волейбола (25+ очков и разница >= 2 для 1-2 сетов, 15+ очков для 3-го сета) как при сохранении в БД, так и при отображении в турнирной таблице</li>
                <li><strong>Исправлен статус матча "в_процессе"</strong> - все проверки статуса приведены к единому формату (с подчеркиванием вместо пробела) во всех файлах: routes/main.py, templates/tournament.html, templates/tournament_view.html</li>
                <li><strong>Устранен конфликт автоотправки формы</strong> - удалено дублирующее postMessage, которое перезаписывало только что сохраненные данные старыми значениями</li>
                <li><strong>Исправлена загрузка сетов из БД в Судействе</strong> - исправлен доступ к данным матча через data.match вместо прямого data + добавлена защита от кеширования</li>
                <li><strong>Исправлено отображение промежуточных счетов</strong> - в турнирной таблице корректно отображаются детали незавершенных сетов (например, "6:0", "10:0")</li>
                <li><strong>Добавлено детальное логирование для диагностики</strong> - логи позволили быстро выявлять и устранять проблемы на каждом этапе</li>
            </ul>
            <p><strong>✅ ИТОГОВЫЙ РЕЗУЛЬТАТ:</strong> Все проблемы решены! Теперь:</p>
            <ul>
                <li>✅ Счет корректно сохраняется в БД</li>
                <li>✅ Счет отображается в турнирной таблице (детали сетов)</li>
                <li>✅ Счет восстанавливается при повторном открытии страницы Судейства</li>
                <li>✅ Форма Результат показывает реальный счет вместо 25:25</li>
            </ul>
        </div>
        
        <div class="update-info">
            <h3>21 октября 2025 - Улучшения статистики участников</h3>
            <ul>
                <li><strong>Добавлена колонка "Счет в сетах"</strong> - в таблице статистики участников теперь отображается конкретный счет выигранных и проигранных сетов (например, "2:1")</li>
                <li><strong>Улучшена сортировка статистики</strong> - новая колонка поддерживает сортировку по разности выигранных и проигранных сетов</li>
                <li><strong>Обновлена backend логика</strong> - добавлены поля sets_won и sets_lost в статистику участников для корректного отображения счета</li>
                <li><strong>Добавлена таблица статистики для зрителей</strong> - на странице просмотра турнира зрителями (страница 18) теперь отображается полная таблица статистики участников с детальной информацией по сетам</li>
                <li><strong>Исправлено дублирование таблиц статистики</strong> - убрана дублирующая верхняя таблица статистики участников на странице зрителей, оставлена только одна таблица с полной информацией</li>
                <li><strong>Исправлено отображение счета в сетах</strong> - добавлена логика формирования sets_details в функции tournament_spectator для корректного отображения детального счета по сетам в таблице "Расписание матчей" на странице зрителей (страница 18)</li>
                <li><strong>Добавлено автоматическое сохранение счета</strong> - при изменении счета в окне "Судейство" счет автоматически сохраняется в базу данных в реальном времени без необходимости нажимать кнопку "Сохранить"</li>
                <li><strong>Добавлено автоматическое обновление страницы зрителей</strong> - страница зрителей (страница 18) теперь автоматически обновляется каждые 3 секунды, позволяя зрителям видеть актуальную информацию о турнире в реальном времени</li>
                <li><strong>Добавлены настройки автообновления</strong> - пользователи могут настраивать интервал автообновления от 3 до 20 секунд, а также включать/выключать автообновление. Настройки сохраняются в браузере</li>
                <li><strong>Исправлена проблема с CSRF токеном</strong> - добавлено автоматическое обновление CSRF токена при ошибке 400, увеличено время жизни токена до 1 часа, добавлен API endpoint для обновления токена</li>
            </ul>
        </div>
        
        <div class="update-info">
            <h3>21 октября 2025 - Исправление проблем с сохранением счёта</h3>
            <ul>
                <li><strong>Исправлено дублирование отправки формы</strong> - убрана автоотправка из saveResult, оставлена только в applyRefereeResultToSet</li>
                <li><strong>Добавлена защита от повторных вызовов</strong> - флаг isSaving предотвращает множественные отправки</li>
                <li><strong>Убраны мешающие alert сообщения</strong> - удалены уведомления, которые мешали закрытию окна Судейство</li>
                <li><strong>Улучшено закрытие окна</strong> - увеличен таймаут до 1 секунды, добавлено принудительное закрытие</li>
                <li><strong>Исправлена ошибка кодировки Unicode</strong> - убраны эмодзи из логов и диагностических сообщений</li>
                <li><strong>Исправлена ложная ошибка "Failed to fetch"</strong> - добавлена проверка статуса ответа перед парсингом JSON</li>
                <li><strong>Исправлена ошибка при перезагрузке страницы</strong> - заменён location.reload() на безопасный setTimeout с window.location.reload()</li>
                <li><strong>Добавлена фильтрация ошибок перезагрузки</strong> - ошибки AbortError и "Failed to fetch" игнорируются при перезагрузке страницы</li>
                <li><strong>Исправлена передача счёта для разных сетов</strong> - теперь для каждого сета передается соответствующий счёт (set1Score1/2 для 1-го сета, set2Score1/2 для 2-го сета и т.д.)</li>
                <li><strong>Улучшена логика передачи счёта</strong> - счёт передается если он отличается от значения по умолчанию (21:21) или если есть реальный счёт (больше 0)</li>
                <li><strong>Добавлена фильтрация сообщений React DevTools</strong> - убраны спам-сообщения от React DevTools из консоли</li>
                <li><strong>Исправлена передача счёта в судейство</strong> - теперь счёт получается напрямую из базы данных, а не из полей формы, что решает проблему с передачей значения по умолчанию (21:21)</li>
                <li><strong>Исправлена логика передачи счёта</strong> - если счёт равен значению по умолчанию (21:21), он не передается, чтобы страница Судейство открылась с 0:0</li>
                <li><strong>Исправлена логика needSwap при сохранении</strong> - теперь состояние needSwap сохраняется при загрузке формы и используется при сохранении, что предотвращает смену мест команд</li>
                <li><strong>Убрана конфликтующая логика в applyRefereeResultToSet</strong> - удалена сложная логика сопоставления по именам участников, которая конфликтовала с needSwap</li>
                <li><strong>Добавлено сообщение о победе в режиме Просмотр</strong> - теперь при входе в режим Просмотр проверяется победа и показывается сообщение с финальным счётом сета</li>
                <li><strong>Исправлено отображение счёта в сообщении о победе</strong> - добавлена многоуровневая проверка содержимого модального окна, принудительное восстановление содержимого при его исчезновении, детальная диагностика HTML элементов</li>
                <li><strong>Временно отключена проверка одновременных сессий</strong> - закомментированы проверки активных сессий в routes/main.py и utils/session_manager.py для удобства тестирования</li>
                <li><strong>Исправлена ошибка удаления турнира</strong> - добавлено удаление записей из таблицы match_log перед удалением турнира во всех функциях удаления (одиночное, массовое, удаление всех турниров, удаление администратора)</li>
                <li><strong>Исправлено обновление списка участников</strong> - добавлено автоматическое обновление страницы после добавления игрока из списка игроков, чтобы новый участник сразу появлялся в списке</li>
                <li><strong>Исправлен алгоритм ранжирования участников</strong> - улучшена логика определения закольцованных результатов в функции is_circular_head_to_head, теперь при отсутствии личных встреч между участниками с одинаковыми очками используется разность сетов</li>
            </ul>
        </div>
        
        <div class="update-info">
            <h3>20 октября 2025 - Финальная очистка и исправления</h3>
            <ul>
                <li><strong>Исправлена критическая ошибка создания расписания</strong> - добавлен отсутствующий db.session.commit() в функции create_smart_schedule</li>
                <li><strong>Устранена ошибка NOT NULL constraint failed: match_log.match_id</strong> - теперь матчи корректно сохраняются в базу данных</li>
                <li><strong>Исправлен порядок операций</strong> - записи журнала удаляются перед удалением матчей, добавлен промежуточный коммит</li>
                <li><strong>Ядерная очистка базы данных</strong> - полностью удалены ВСЕ 30 записей из таблицы match_log для устранения проблем</li>
                <li><strong>Упрощена логика очистки</strong> - теперь система очищает все записи журнала для турнира перед созданием расписания</li>
                <li><strong>Исправлено удаление участников</strong> - теперь корректно удаляются связанные записи журнала при удалении участников</li>
                <li><strong>Оптимизированы вызовы коммитов</strong> - убраны дублирующие db.session.commit() после вызовов create_smart_schedule</li>
                <li><strong>Улучшена обработка ошибок</strong> - добавлен try-catch блок с rollback при ошибках сохранения</li>
                <li><strong>Удалены отладочные сообщения</strong> - убрано ненужное DEBUG сообщение "Вызываем logMatchAction для +1_right (случай 2)"</li>
                <li><strong>Добавлена передача счёта в судейство</strong> - при открытии страницы судейства из формы результатов передается текущий счёт, если он отличается от значения по умолчанию (0:0)</li>
                <li><strong>Исправлена инициализация счёта в судействе</strong> - счёт из URL параметров теперь корректно устанавливается и отображается на странице судейства</li>
                <li><strong>Добавлено сохранение результатов в турнир</strong> - на всех страницах судейства (бадминтон, волейбол, пинг-понг) добавлена кнопка "Сохранить в турнир" для прямого сохранения результатов в турнирную таблицу</li>
                <li><strong>Указатель подачи для волейбола</strong> - добавлен анимированный индикатор подачи, который показывает какая команда подает (та, что выиграла последнее очко)</li>
                <li><strong>Убраны горизонтальные линии</strong> - удалены лишние горизонтальные линии со страниц судейства волейбола и пинг-понга для более чистого дизайна</li>
                <li><strong>Улучшена логика передачи счёта</strong> - счёт 21:21 (значение по умолчанию для бадминтона) не передается в судейство, только реальный счёт матча</li>
                <li><strong>Исправлена передача счёта для всех сетов</strong> - счёт передается для всех сетов, если он отличается от значения по умолчанию (21:21)</li>
                <li><strong>Окончательное исправление ошибки создания расписания</strong> - исправлен порядок удаления записей: сначала удаляются записи match_log через raw SQL, затем матчи, с промежуточным commit для предотвращения constraint ошибок</li>
                <li><strong>Система работает с чистого листа</strong> - все проблемные записи удалены, система готова к корректной работе</li>
                <li><strong>Полная стабилизация системы</strong> - все операции с участниками и расписанием теперь работают корректно</li>
            </ul>
        </div>
        
        <div class="update-info">
            <h3>19 октября 2025 - Исправление ошибок и улучшения</h3>
            <ul>
                <li><strong>Исправлена ошибка добавления участников</strong> - решена проблема с нарушением ограничения NOT NULL в таблице match_log</li>
                <li><strong>Улучшена функция создания расписания</strong> - теперь корректно удаляются связанные записи журнала при пересоздании матчей</li>
                <li><strong>Стабилизация системы</strong> - устранены ошибки при добавлении игроков в турниры</li>
            </ul>
        </div>
        
        <div class="update-info">
            <h3>18 октября 2025 - Улучшение журнала матчей</h3>
            <ul>
                <li><strong>Добавлены позиции игроков</strong> - теперь в журнале отображаются имена игроков с указанием их позиций на корте</li>
                <li><strong>Визуальные улучшения</strong> - добавлены цветные метки для позиций подающего и принимающего игроков</li>
                <li><strong>Улучшенная навигация</strong> - более четкое отображение направления подачи между игроками</li>
                <li><strong>Обратная совместимость</strong> - система корректно отображает как новые записи с позициями, так и старые записи без них</li>
                <li><strong>Кнопка очистки журнала</strong> - добавлена возможность очистить журнал для начала новой игры</li>
                <li><strong>Исправлен журнал матчей</strong> - теперь в модальном окне журнала матча отображаются позиции игроков рядом с именами</li>
                <li><strong>Цветовая кодировка позиций:</strong>
                    <ul>
                        <li>Оранжевые метки - позиции подающих игроков🥇</li>
                        <li>Синие метки - позиции принимающих игроков🥈</li>
                    </ul>
                </li>
                <li><strong>Позиции на корте:</strong>
                    <ul>
                        <li>Верхний левый</li>
                        <li>Нижний левый</li>
                        <li>Верхний правый</li>
                        <li>Нижний правый</li>
                    </ul>
                </li>
            </ul>
        </div>

        <h2>Технические детали</h2>
        <h3>Архитектура</h3>
        <ul>
            <li><strong>Backend:</strong> Flask (Python)</li>
            <li><strong>База данных:</strong> SQLite (разработка), PostgreSQL (продакшен)</li>
            <li><strong>Frontend:</strong> HTML5, CSS3, JavaScript</li>
            <li><strong>Стилизация:</strong> Bootstrap 5</li>
        </ul>

        <h3>Структура проекта</h3>
        <ul>
            <li><code>app.py</code> - основной файл приложения</li>
            <li><code>models/</code> - модели базы данных</li>
            <li><code>routes/</code> - маршруты приложения</li>
            <li><code>templates/</code> - HTML-шаблоны</li>
            <li><code>static/</code> - статические файлы (CSS, JS, изображения)</li>
            <li><code>Referee/</code> - модуль судейства и журнала матчей</li>
        </ul>

        <h2>Журнал матчей</h2>
        <p>Система журнала матчей была значительно улучшена для лучшего отслеживания действий игроков:</p>
        
        <h3>Новые возможности журнала</h3>
        <ul>
            <li><strong>Отображение позиций:</strong> Каждая запись в журнале теперь показывает позицию игрока на корте</li>
            <li><strong>Цветовая кодировка:</strong>
                <ul>
                    <li>Оранжевые метки - позиция подающего игрока</li>
                    <li>Синие метки - позиция принимающего игрока</li>
                </ul>
            </li>
            <li><strong>Направление подачи:</strong> Четко показано направление подачи с помощью стрелки</li>
            <li><strong>Временные метки:</strong> Точное время каждой подачи</li>
            <li><strong>Счет:</strong> Текущий счет после каждой подачи</li>
        </ul>

        <h2>Установка и запуск</h2>
        <h3>Требования</h3>
        <ul>
            <li>Python 3.8+</li>
            <li>pip (менеджер пакетов Python)</li>
        </ul>

        <h3>Установка зависимостей</h3>
        <code>pip install -r requirements.txt</code>

        <h3>Запуск приложения</h3>
        <code>python app.py</code>

        <h3>Доступ к приложению</h3>
        <ul>
            <li>URL: <code>http://localhost:5000</code></li>
            <li>Администратор: <code>admin</code> / <code>adm555</code></li>
        </ul>

        <h2>Конфигурация</h2>
        <p>Основные настройки находятся в файле <code>config.py</code>:</p>
        <ul>
            <li>Настройки базы данных</li>
            <li>Конфигурация email</li>
            <li>Параметры безопасности</li>
            <li>Настройки турнира</li>
        </ul>

        <h2>Последние обновления (22 октября 2025)</h2>
        <div class="update-info">
            <h3>🆕 Передача названий команд в судейство</h3>
            <p>Добавлена возможность передачи названий команд в формы судейства для всех видов спорта:</p>
            <ul>
                <li><strong>Волейбол:</strong> Названия команд теперь отображаются в заголовках страницы судейства</li>
                <li><strong>Пинг-понг:</strong> Поддержка передачи названий команд через URL параметры</li>
                <li><strong>Бадминтон:</strong> Автоматическое обновление заголовков команд</li>
            </ul>
            
            <h3>🔧 Исправления</h3>
            <ul>
                <li>Исправлена ошибка <code>update_tournament_status is not defined</code> при сохранении результатов</li>
                <li>Улучшена логика показа кнопки "Сохранить в турнир" в судействе</li>
                <li>Добавлена отладочная информация для диагностики проблем с судейством</li>
            </ul>
            
            <h3>📋 Технические детали</h3>
            <p>Новые URL параметры для судейства:</p>
            <ul>
                <li><code>team1_name</code> - название первой команды</li>
                <li><code>team2_name</code> - название второй команды</li>
            </ul>
        </div>

        <div class="version">
            <strong>Версия:</strong> final-v.1<br>
            <strong>Статус:</strong> Активная разработка<br>
            <strong>Поддерживаемые браузеры:</strong> Chrome, Firefox, Safari, Edge
        </div>
    </div>
</body>
</html>
