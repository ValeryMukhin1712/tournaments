# GitHub Actions Deployment Workflow –¥–ª—è Quick Score Tournaments
# 
# –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ê–ö–¢–ò–í–ê–¶–ò–ò:
# 1. –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏–∑ deploy.yml.disabled –≤ deploy.yml
# 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Secrets –≤ GitHub (Settings ‚Üí Secrets and variables ‚Üí Actions):
#    - SERVER_HOST: IP –∏–ª–∏ –¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: quickscore.sytes.net)
#    - SSH_PRIVATE_KEY: –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
# 3. –û—Ç–∫–ª—é—á–∏—Ç–µ Webhook –≤ GitHub (Settings ‚Üí Webhooks), –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
# 4. –°–¥–µ–ª–∞–π—Ç–µ commit –∏ push - –¥–µ–ø–ª–æ–π –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

name: Deploy to VDS

on:
  push:
    branches:
      - main  # –î–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ main –≤–µ—Ç–∫—É
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ VDS —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üîÑ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è Quick Score Tournaments"
            
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            cd ~/quick-score
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            if [ -f "instance/tournament.db" ]; then
              echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
              mkdir -p ~/backups
              cp instance/tournament.db ~/backups/tournament_$(date +%Y%m%d_%H%M%S).db
            fi
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub
            echo "‚¨áÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub..."
            git fetch origin
            git reset --hard origin/main
            
            # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            sudo systemctl restart tournaments
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            sleep 3
            if sudo systemctl is-active --quiet tournaments; then
              echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
              echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: https://quickscore.sytes.net"
            else
              echo "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å"
              sudo systemctl status tournaments --no-pager
              exit 1
            fi

      - name: üìä –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
          fi

# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
#
# 1. –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:
#    on:
#      push:
#        branches: [main]
#        paths:
#          - '**.py'
#          - 'requirements.txt'
#          - 'templates/**'
#
# 2. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:
#    jobs:
#      test:
#        runs-on: ubuntu-latest
#        steps:
#          - uses: actions/checkout@v3
#          - name: Run tests
#            run: |
#              python -m pytest
#      
#      deploy:
#        needs: test  # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
#
# 3. –î–µ–ø–ª–æ–π –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ç–∫–∏:
#    jobs:
#      deploy-production:
#        if: github.ref == 'refs/heads/main'
#        # ... –¥–µ–ø–ª–æ–π –Ω–∞ production
#      
#      deploy-staging:
#        if: github.ref == 'refs/heads/develop'
#        # ... –¥–µ–ø–ª–æ–π –Ω–∞ staging
